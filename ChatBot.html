<!DOCTYPE html>
<html lang="en">
<head>
  <title>Catherine Ann MacDonald - ChatBot</title>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  

<style>
  .jumbotron {
    background-image: url("rexbanner.png");
    background-size: cover;
    background-repeat: no-repeat;
    background-position: center;
    color: white;
  }
</style>
</head>
<body>

<!-- Terminal-style Navigation Bar -->
    <nav style="background: #000; border-bottom: 3px solid #00ff00; padding: 10px 20px; font-family: 'Courier New', monospace;">
      <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;">
        <div id="terminalHeader" style="color: #00ff00; font-size: 18px; font-weight: bold; margin-bottom: 5px;">
          [ TERMINAL SYSTEM ]
        </div>
    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
      <a href="index.html" style="color: #00ff00; text-decoration: none; padding: 5px 10px; border: 1px solid #00ff00; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='transparent'; this.style.color='#00ff00'">[HOME]</a>
    </div>
  </div>
</nav>

<!-- Language Selection Screen -->
<div id="languageScreen" class="container-fluid" style="margin-top:0; padding: 0; height: calc(100vh - 56px); display: flex; justify-content: center; align-items: center; background: #000;">
  <div style="max-width: 700px; width: 90%; background: #000; border: 3px solid #00ff00; padding: 40px; box-shadow: 0 0 30px rgba(0,255,0,0.3);">
    <div style="border-bottom: 2px solid #00ff00; padding-bottom: 15px; margin-bottom: 30px; text-align: center;">
      <pre style="color: #00ff00; margin: 0; font-size: 12px;">
╔═══════════════════════════════════════════╗
║     LANGUAGE SELECTION SYSTEM             ║
║     Select Your Preferred Language        ║
╚═══════════════════════════════════════════╝
      </pre>
    </div>
    
    <div style="color: #00ff00; margin-bottom: 20px; text-align: center; font-family: 'Courier New', monospace; font-size: 16px;">
      🌍 Choose Your Language / Choisissez votre langue / Wählen Sie Ihre Sprache
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
      <button onclick="selectLanguage('en')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇬🇧 English
      </button>
      <button onclick="selectLanguage('es')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇪🇸 Español
      </button>
      <button onclick="selectLanguage('fr')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇫🇷 Français
      </button>
      <button onclick="selectLanguage('de')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇩🇪 Deutsch
      </button>
      <button onclick="selectLanguage('it')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇮🇹 Italiano
      </button>
      <button onclick="selectLanguage('pt')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇵🇹 Português
      </button>
      <button onclick="selectLanguage('ru')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇷🇺 Русский
      </button>
      <button onclick="selectLanguage('ja')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇯🇵 日本語
      </button>
      <button onclick="selectLanguage('zh')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇨🇳 中文
      </button>
      <button onclick="selectLanguage('ko')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇰🇷 한국어
      </button>
      <button onclick="selectLanguage('ar')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇸🇦 العربية
      </button>
      <button onclick="selectLanguage('hi')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇮🇳 हिन्दी
      </button>
    </div>
  </div>
</div>

<!-- Registration Screen (First Time Users) -->
<div id="registrationScreen" class="container-fluid" style="margin-top:0; padding: 0; height: calc(100vh - 56px); display: none; justify-content: center; align-items: center; background: #000;">
  <div style="max-width: 600px; width: 90%; background: #000; border: 3px solid #00ff00; padding: 40px; box-shadow: 0 0 30px rgba(0,255,0,0.3);">
    <div style="border-bottom: 2px solid #00ff00; padding-bottom: 15px; margin-bottom: 30px; text-align: center;">
      <pre style="color: #00ff00; margin: 0; font-size: 12px;">
╔═══════════════════════════════════════════╗
║     NEW USER REGISTRATION                 ║
║     Create Your Account                   ║
╚═══════════════════════════════════════════╝
      </pre>
    </div>
    
    <div style="margin-bottom: 25px;">
      <div style="color: #00ff00; margin-bottom: 10px; font-family: 'Courier New', monospace; font-size: 16px;">
        👋 Welcome to the AI Chat System!
      </div>
      <div style="color: #c0ffc0; margin-bottom: 20px; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.6;">
        Create a username and password to save your conversations and preferences.
        <br><br>Your data will be stored securely and privately.
      </div>
    </div>
    
    <div id="registrationError" style="color: #ff6666; font-family: 'Courier New', monospace; margin-bottom: 15px; display: none;">
      ❌ Error message here
    </div>
    
    <div style="margin-bottom: 15px;">
      <label style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; display: block; margin-bottom: 8px;">
        CREATE USERNAME:
      </label>
      <input type="text" id="regUsername" 
             style="width: 100%; background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 12px; font-family: 'Courier New', monospace; font-size: 16px; outline: none;"
             placeholder="Choose a username..."
             onkeypress="if(event.key==='Enter') document.getElementById('regPassword').focus()">
      <div style="color: #ffff99; font-size: 12px; margin-top: 5px; font-family: 'Courier New', monospace;">
        3-20 characters, letters and numbers only
      </div>
    </div>
    
    <div style="margin-bottom: 15px;">
      <label style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; display: block; margin-bottom: 8px;">
        CREATE PASSWORD:
      </label>
      <input type="password" id="regPassword" 
             style="width: 100%; background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 12px; font-family: 'Courier New', monospace; font-size: 16px; outline: none;"
             placeholder="Choose a password..."
             onkeypress="if(event.key==='Enter') document.getElementById('regPasswordConfirm').focus()">
      <div style="color: #ffff99; font-size: 12px; margin-top: 5px; font-family: 'Courier New', monospace;">
        At least 6 characters
      </div>
    </div>
    
    <div style="margin-bottom: 20px;">
      <label style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; display: block; margin-bottom: 8px;">
        CONFIRM PASSWORD:
      </label>
      <input type="password" id="regPasswordConfirm" 
             style="width: 100%; background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 12px; font-family: 'Courier New', monospace; font-size: 16px; outline: none;"
             placeholder="Re-enter password..."
             onkeypress="if(event.key==='Enter') registerNewUser()">
    </div>
    
    <button onclick="registerNewUser()" 
            style="width: 100%; background: #00ff00; color: #000; border: none; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; font-size: 16px; cursor: pointer; transition: all 0.2s; margin-bottom: 10px;"
            onmouseover="this.style.background='#00cc00'" 
            onmouseout="this.style.background='#00ff00'">
      [ CREATE ACCOUNT ]
    </button>
    
    <div style="text-align: center; margin-top: 15px;">
      <a href="#" onclick="showLoginScreen(); return false;" style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; text-decoration: underline;">
        Already have an account? Login here
      </a>
    </div>
  </div>
</div>

<!-- Login Screen (Returning Users) -->
<div id="passwordScreen" class="container-fluid" style="margin-top:0; padding: 0; height: calc(100vh - 56px); display: none; justify-content: center; align-items: center; background: #000;">
  <div style="max-width: 600px; width: 90%; background: #000; border: 3px solid #00ff00; padding: 40px; box-shadow: 0 0 30px rgba(0,255,0,0.3);">
    <div style="border-bottom: 2px solid #00ff00; padding-bottom: 15px; margin-bottom: 30px; text-align: center;">
      <pre style="color: #00ff00; margin: 0; font-size: 12px;">
╔═══════════════════════════════════════════╗
║     SECURE ACCESS TERMINAL v1.0           ║
║     User Login                            ║
╚═══════════════════════════════════════════╝
      </pre>
    </div>
    
    <div style="margin-bottom: 25px;">
      <div style="color: #00ff00; margin-bottom: 10px; font-family: 'Courier New', monospace; font-size: 16px;">
        🔒 USER LOGIN
      </div>
      <div style="color: #c0ffc0; margin-bottom: 20px; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.6;">
        Welcome back! Login to access your chat history.
      </div>
    </div>
    
    <div id="passwordError" style="color: #ff6666; font-family: 'Courier New', monospace; margin-bottom: 15px; display: none;">
      ❌ ACCESS DENIED: Invalid credentials
    </div>
    
    <div style="margin-bottom: 15px;">
      <label style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; display: block; margin-bottom: 8px;">
        USERNAME:
      </label>
      <input type="text" id="chatUsername" 
             style="width: 100%; background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 12px; font-family: 'Courier New', monospace; font-size: 16px; outline: none;"
             placeholder="Enter username..."
             onkeypress="if(event.key==='Enter') document.getElementById('chatPassword').focus()">
    </div>
    
    <div style="margin-bottom: 20px;">
      <label style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; display: block; margin-bottom: 8px;">
        PASSWORD:
      </label>
      <input type="password" id="chatPassword" 
             style="width: 100%; background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 12px; font-family: 'Courier New', monospace; font-size: 16px; outline: none;"
             placeholder="Enter password..."
             onkeypress="if(event.key==='Enter') checkChatPassword()">
    </div>
    
    <button onclick="checkChatPassword()" 
            style="width: 100%; background: #00ff00; color: #000; border: none; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; font-size: 16px; cursor: pointer; transition: all 0.2s; margin-bottom: 10px;"
            onmouseover="this.style.background='#00cc00'" 
            onmouseout="this.style.background='#00ff00'">
      [ LOGIN ]
    </button>
    
    <div style="text-align: center; margin-top: 15px;">
      <a href="#" onclick="showRegistrationScreen(); return false;" style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; text-decoration: underline;">
        New user? Create an account
      </a>
    </div>
  </div>
</div>

<div class="container-fluid" id="chatContainer" style="margin-top:0; padding: 0; height: calc(100vh - 56px); display: none;">
  <div style="height: 100%; display: flex; flex-direction: column;">
    
    <!-- Terminal Window -->
    <div id="terminal" style="flex: 1; background: #000000; color: #00ff00; font-family: 'Courier New', monospace; padding: 20px; overflow-y: auto; border: 3px solid #333; box-shadow: inset 0 0 50px rgba(0,255,0,0.1);">
      
      <!-- Terminal Header -->
      <div id="terminalHeader" style="border-bottom: 1px solid #00ff00; padding-bottom: 10px; margin-bottom: 20px;">
        <pre style="color: #00ff00; margin: 0;">
╔═══════════════════════════════════════════════════════════════╗
║  CATHERINE MACDONALD INTERACTIVE SYSTEM v1.0                  ║
║  Copyright (c) 2025 - All Rights Reserved                     ║
║  Type 'HELP' for available commands                           ║
╚═══════════════════════════════════════════════════════════════╝
        </pre>
        <div id="modeIndicator" style="text-align: right; color: #00ff00; font-size: 12px; margin-top: 5px;">
          MODE: <span id="modeText">SFW</span> ✓
        </div>
      </div>
      
      <!-- Boot Sequence -->
      <div id="bootSequence" style="display: none;">
        <div style="color: #00ff00;">System initializing...</div>
        <div style="color: #00ff00;">Loading AI modules... [OK]</div>
        <div style="color: #00ff00;">Establishing connection... [OK]</div>
        <div style="color: #00ff00;">Ready for input.</div>
        <div style="color: #00ff00; margin-top: 10px;">═══════════════════════════════════════════════════════════════</div>
      </div>
      
      <!-- Initialization Prompts -->
      <div id="initPrompts" style="margin-top: 20px; display: none;">
        <div style="color: #c0ffc0; margin-bottom: 10px; font-size: 16px; line-height: 1.6;">
          👋 Hello! I'm your AI assistant. This looks like your first time here.
        </div>
        <div style="color: #c0ffc0; margin-bottom: 15px; font-size: 16px; line-height: 1.6;">
          Do you have a saved session from before?
        </div>
        <div style="color: #ffff99; margin-bottom: 15px; font-size: 14px;">
          Type <strong>UPLOAD</strong> if you have a saved file, or <strong>SKIP</strong> to start fresh.
        </div>
      </div>
      
      <!-- File Upload for Journal (Hidden) -->
      <input type="file" id="journalUpload" accept=".json" style="display: none;">
      
      <!-- Journal Export Modal -->
      <div id="journalExportModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: #000; border: 3px solid #00ff00; padding: 30px; max-width: 600px; width: 90%; font-family: 'Courier New', monospace;">
          <div style="color: #00ff00; font-size: 20px; font-weight: bold; margin-bottom: 20px; text-align: center;">
            [ JOURNAL EXPORT ]
          </div>
          <div style="color: #00ff00; margin-bottom: 15px;">
            Ready to save journal data to your device.
          </div>
          <div style="color: #00ff00; margin-bottom: 20px;">
            <strong>Filename:</strong> <span id="exportFilename" style="color: #ffff00;">terminal-journal.json</span>
          </div>
          <div style="color: #00ff00; margin-bottom: 20px;">
            <strong>Total Entries:</strong> <span id="exportCount" style="color: #ffff00;">0</span>
          </div>
          <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
            <button onclick="confirmExport()" style="background: #00ff00; color: #000; border: none; padding: 10px 20px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00cc00'" onmouseout="this.style.background='#00ff00'">
              DOWNLOAD
            </button>
            <button onclick="closeExportModal()" style="background: #ff0000; color: #fff; border: none; padding: 10px 20px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#cc0000'" onmouseout="this.style.background='#ff0000'">
              CANCEL
            </button>
          </div>
        </div>
      </div>
      
      <!-- Chat Messages -->
      <div id="chatMessages" style="margin-top: 20px;"></div>
      
      <!-- Cursor Blink -->
      <div id="cursor" style="display: inline;">
        <span style="color: #00ff00;">&gt; </span>
        <span id="cursorBlink" style="background: #00ff00; color: #000;">█</span>
      </div>
    </div>
    
    <!-- Command Input -->
    <div style="background: #1a1a1a; padding: 15px; border-top: 2px solid #00ff00;">
      <!-- Spell Check Suggestions -->
      <div id="spellSuggestions" style="display: none; background: #000; border: 2px solid #ffff00; padding: 10px; margin-bottom: 10px; border-radius: 5px;">
        <div style="color: #ffff00; font-family: 'Courier New', monospace; font-size: 12px; margin-bottom: 5px;">
          ⚠️ Possible misspellings detected:
        </div>
        <div id="suggestionList" style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px;"></div>
        <div style="margin-top: 8px; display: flex; gap: 10px;">
          <button onclick="acceptCorrections()" style="background: #00ff00; color: #000; border: none; padding: 5px 15px; font-family: 'Courier New', monospace; font-size: 12px; cursor: pointer; border-radius: 3px;">
            FIX ALL
          </button>
          <button onclick="dismissSuggestions()" style="background: #666; color: #fff; border: none; padding: 5px 15px; font-family: 'Courier New', monospace; font-size: 12px; cursor: pointer; border-radius: 3px;">
            IGNORE
          </button>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; align-items: center;">
        <span style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 18px; font-weight: bold;">&gt;</span>
        <input type="text" id="commandInput" 
               style="flex: 1; background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 12px; font-family: 'Courier New', monospace; font-size: 16px; outline: none;"
               placeholder="Type your message or command..."
               onkeypress="if(event.key==='Enter') checkSpellingBeforeSend()"
               oninput="hideSpellSuggestions()"
               autofocus>
        <button onclick="checkSpellingBeforeSend()" 
                style="background: #00ff00; color: #000; border: none; padding: 12px 24px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;"
                onmouseover="this.style.background='#00cc00'" 
                onmouseout="this.style.background='#00ff00'">SEND</button>
      </div>
    </div>
    
  </div>
</div>

<style>
body {
  background: #000;
  color: #00ff00;
  font-family: 'Courier New', monospace;
  margin: 0;
  padding: 0;
  overflow: hidden;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
  20%, 40%, 60%, 80% { transform: translateX(10px); }
}
</style>

<script>
// ========================================
// PASSWORD PROTECTION
// ========================================

const CHAT_PASSWORD = "VoidRules"; // Master password (no longer used for new users)
let currentUser = null;

// User database (stored in localStorage)
function getUserDatabase() {
  return JSON.parse(localStorage.getItem('userDatabase')) || {};
}

function saveUserDatabase(db) {
  localStorage.setItem('userDatabase', JSON.stringify(db));
}

function showRegistrationScreen() {
  document.getElementById('passwordScreen').style.display = 'none';
  document.getElementById('registrationScreen').style.display = 'flex';
  document.getElementById('passwordError').style.display = 'none';
  setTimeout(() => {
    document.getElementById('regUsername').focus();
  }, 100);
}

function showLoginScreen() {
  document.getElementById('registrationScreen').style.display = 'none';
  document.getElementById('passwordScreen').style.display = 'flex';
  document.getElementById('registrationError').style.display = 'none';
  setTimeout(() => {
    document.getElementById('chatUsername').focus();
  }, 100);
}

function registerNewUser() {
  const usernameInput = document.getElementById('regUsername');
  const passwordInput = document.getElementById('regPassword');
  const confirmInput = document.getElementById('regPasswordConfirm');
  const errorDiv = document.getElementById('registrationError');
  
  const username = usernameInput.value.trim();
  const password = passwordInput.value;
  const confirmPassword = confirmInput.value;
  
  // Validate username
  if (!username) {
    errorDiv.textContent = '❌ Please enter a username';
    errorDiv.style.display = 'block';
    usernameInput.focus();
    return;
  }
  
  if (username.length < 3 || username.length > 20) {
    errorDiv.textContent = '❌ Username must be 3-20 characters';
    errorDiv.style.display = 'block';
    usernameInput.focus();
    return;
  }
  
  if (!/^[a-zA-Z0-9]+$/.test(username)) {
    errorDiv.textContent = '❌ Username can only contain letters and numbers';
    errorDiv.style.display = 'block';
    usernameInput.focus();
    return;
  }
  
  // Check if username already exists
  const userDB = getUserDatabase();
  if (userDB[username]) {
    errorDiv.textContent = '❌ Username already taken. Please choose another.';
    errorDiv.style.display = 'block';
    usernameInput.value = '';
    usernameInput.focus();
    return;
  }
  
  // Validate password
  if (!password) {
    errorDiv.textContent = '❌ Please enter a password';
    errorDiv.style.display = 'block';
    passwordInput.focus();
    return;
  }
  
  if (password.length < 6) {
    errorDiv.textContent = '❌ Password must be at least 6 characters';
    errorDiv.style.display = 'block';
    passwordInput.focus();
    return;
  }
  
  if (password !== confirmPassword) {
    errorDiv.textContent = '❌ Passwords do not match';
    errorDiv.style.display = 'block';
    confirmInput.value = '';
    confirmInput.focus();
    return;
  }
  
  // Create new user account
  userDB[username] = {
    password: password,
    created: new Date().toISOString(),
    lastLogin: new Date().toISOString()
  };
  saveUserDatabase(userDB);
  
  // Clear registration form
  usernameInput.value = '';
  passwordInput.value = '';
  confirmInput.value = '';
  errorDiv.style.display = 'none';
  
  // Show success message and login
  document.getElementById('registrationScreen').style.display = 'none';
  loginUser(username);
}

function checkChatPassword() {
  const usernameInput = document.getElementById('chatUsername');
  const passwordInput = document.getElementById('chatPassword');
  const username = usernameInput.value.trim();
  const password = passwordInput.value;
  const errorDiv = document.getElementById('passwordError');
  
  // Validate inputs
  if (!username) {
    errorDiv.textContent = '❌ Please enter a username';
    errorDiv.style.display = 'block';
    usernameInput.focus();
    return;
  }
  
  if (!password) {
    errorDiv.textContent = '❌ Please enter a password';
    errorDiv.style.display = 'block';
    passwordInput.focus();
    return;
  }
  
  const userDB = getUserDatabase();
  
  // Check if user exists
  if (userDB[username]) {
    // Existing user - verify password
    if (userDB[username].password === password) {
      loginUser(username);
    } else {
      // Wrong password
      errorDiv.textContent = '❌ ACCESS DENIED: Incorrect password';
      errorDiv.style.display = 'block';
      passwordInput.value = '';
      passwordInput.focus();
      
      // Shake animation
      const passwordScreen = document.getElementById('passwordScreen').firstElementChild;
      passwordScreen.style.animation = 'shake 0.5s';
      setTimeout(() => {
        passwordScreen.style.animation = '';
      }, 500);
    }
  } else {
    // User doesn't exist - redirect to registration
    errorDiv.textContent = '❌ User not found. Please create an account first.';
    errorDiv.style.display = 'block';
    
    setTimeout(() => {
      showRegistrationScreen();
    }, 2000);
  }
}

function loginUser(username) {
  currentUser = username;
  sessionStorage.setItem('currentUser', username);
  
  // Update last login
  const userDB = getUserDatabase();
  if (userDB[username]) {
    userDB[username].lastLogin = new Date().toISOString();
    saveUserDatabase(userDB);
  }
  
  // Load user-specific data
  loadUserData(username);
  
  // Initialize smart memory for this user
  initializeMemory();
  
  // Show chat system
  document.getElementById('passwordScreen').style.display = 'none';
  document.getElementById('chatContainer').style.display = 'block';
  
  // Focus on command input
  setTimeout(() => {
    document.getElementById('commandInput').focus();
  }, 100);
}

function loadUserData(username) {
  const userDataKey = `user_${username}`;
  const userData = JSON.parse(localStorage.getItem(userDataKey)) || {};
  
  // Load user-specific settings
  if (userData.aiName) {
    localStorage.setItem('terminalAIName', userData.aiName);
  }
  if (userData.journalPermission) {
    localStorage.setItem('terminalJournalPermission', userData.journalPermission);
  }
  if (userData.journal) {
    localStorage.setItem('terminalJournal', JSON.stringify(userData.journal));
  }
  if (userData.contentMode) {
    localStorage.setItem('contentMode', userData.contentMode);
  }
  if (userData.ageVerified) {
    localStorage.setItem('ageVerified', userData.ageVerified);
  }
}

function saveUserData() {
  if (!currentUser) return;
  
  const userDataKey = `user_${currentUser}`;
  const userData = {
    aiName: localStorage.getItem('terminalAIName'),
    journalPermission: localStorage.getItem('terminalJournalPermission'),
    journal: JSON.parse(localStorage.getItem('terminalJournal') || '[]'),
    contentMode: localStorage.getItem('contentMode'),
    ageVerified: localStorage.getItem('ageVerified'),
    lastSaved: new Date().toISOString()
  };
  
  localStorage.setItem(userDataKey, JSON.stringify(userData));
}

// ========================================
// LANGUAGE SYSTEM
// ========================================

let userLanguage = localStorage.getItem('userLanguage') || null;

const translations = {
  en: { greeting: "Hello", welcome: "Welcome back", help: "Type HELP for commands" },
  es: { greeting: "Hola", welcome: "Bienvenido de nuevo", help: "Escribe HELP para comandos" },
  fr: { greeting: "Bonjour", welcome: "Bienvenue", help: "Tapez HELP pour les commandes" },
  de: { greeting: "Hallo", welcome: "Willkommen zurück", help: "Geben Sie HELP für Befehle ein" },
  it: { greeting: "Ciao", welcome: "Bentornato", help: "Digita HELP per i comandi" },
  pt: { greeting: "Olá", welcome: "Bem-vindo de volta", help: "Digite HELP para comandos" },
  ru: { greeting: "Привет", welcome: "Добро пожаловать", help: "Введите HELP для команд" },
  ja: { greeting: "こんにちは", welcome: "おかえりなさい", help: "HELPと入力してコマンドを表示" },
  zh: { greeting: "你好", welcome: "欢迎回来", help: "输入HELP查看命令" },
  ko: { greeting: "안녕하세요", welcome: "다시 오신 것을 환영합니다", help: "명령어를 보려면 HELP를 입력하세요" },
  ar: { greeting: "مرحبا", welcome: "مرحبا بعودتك", help: "اكتب HELP للأوامر" },
  hi: { greeting: "नमस्ते", welcome: "वापसी पर स्वागत है", help: "कमांड के लिए HELP टाइप करें" }
};

function selectLanguage(lang) {
  userLanguage = lang;
  localStorage.setItem('userLanguage', lang);
  
  const userDB = getUserDatabase();
  const hasUsers = Object.keys(userDB).length > 0;
  
  // Hide language screen
  document.getElementById('languageScreen').style.display = 'none';
  
  if (!hasUsers) {
    // No users exist - show registration
    document.getElementById('registrationScreen').style.display = 'flex';
    setTimeout(() => {
      document.getElementById('regUsername').focus();
    }, 100);
  } else {
    // Users exist - show login
    document.getElementById('passwordScreen').style.display = 'flex';
    setTimeout(() => {
      document.getElementById('chatUsername').focus();
    }, 100);
  }
}

// Always show language or registration/login screen on load
window.addEventListener('DOMContentLoaded', function() {
  const userDB = getUserDatabase();
  const hasUsers = Object.keys(userDB).length > 0;
  
  if (!userLanguage) {
    // Show language selection first
    document.getElementById('languageScreen').style.display = 'flex';
    document.getElementById('registrationScreen').style.display = 'none';
    document.getElementById('passwordScreen').style.display = 'none';
    document.getElementById('chatContainer').style.display = 'none';
  } else if (!hasUsers) {
    // Language selected but no users exist - show registration
    document.getElementById('languageScreen').style.display = 'none';
    document.getElementById('registrationScreen').style.display = 'flex';
    document.getElementById('passwordScreen').style.display = 'none';
    document.getElementById('chatContainer').style.display = 'none';
    
    setTimeout(() => {
      document.getElementById('regUsername').focus();
    }, 100);
  } else {
    // Language selected and users exist - show login
    document.getElementById('languageScreen').style.display = 'none';
    document.getElementById('registrationScreen').style.display = 'none';
    document.getElementById('passwordScreen').style.display = 'flex';
    document.getElementById('chatContainer').style.display = 'none';
    
    setTimeout(() => {
      document.getElementById('chatUsername').focus();
    }, 100);
  }
});

// ========================================
// PRIVACY PROTECTION SYSTEM
// ========================================

function detectPersonalInfo(text) {
  const detections = [];
  
  // IP Address detection (IPv4 and IPv6)
  const ipv4Regex = /\b(?:\d{1,3}\.){3}\d{1,3}\b/g;
  const ipv6Regex = /\b(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}\b/g;
  
  if (ipv4Regex.test(text) || ipv6Regex.test(text)) {
    detections.push('IP Address');
  }
  
  // Email addresses
  const emailRegex = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g;
  if (emailRegex.test(text)) {
    detections.push('Email Address');
  }
  
  // Phone numbers (various formats)
  const phoneRegex = /(\+?\d{1,3}[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}\b/g;
  if (phoneRegex.test(text)) {
    detections.push('Phone Number');
  }
  
  // Street addresses (basic detection)
  const addressRegex = /\b\d+\s+[A-Za-z]+\s+(Street|St|Avenue|Ave|Road|Rd|Boulevard|Blvd|Lane|Ln|Drive|Dr|Court|Ct|Way)\b/gi;
  if (addressRegex.test(text)) {
    detections.push('Street Address');
  }
  
  // Social Security Numbers (US format)
  const ssnRegex = /\b\d{3}-\d{2}-\d{4}\b/g;
  if (ssnRegex.test(text)) {
    detections.push('Social Security Number');
  }
  
  // Credit card numbers (basic 16-digit detection)
  const creditCardRegex = /\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b/g;
  if (creditCardRegex.test(text)) {
    detections.push('Credit Card Number');
  }
  
  // Zip codes (US format)
  const zipRegex = /\b\d{5}(?:-\d{4})?\b/g;
  if (zipRegex.test(text)) {
    detections.push('Zip Code');
  }
  
  return detections;
}

function sanitizePersonalInfo(text) {
  let sanitized = text;
  
  // Replace IP addresses
  sanitized = sanitized.replace(/\b(?:\d{1,3}\.){3}\d{1,3}\b/g, '[IP_REDACTED]');
  sanitized = sanitized.replace(/\b(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}\b/g, '[IP_REDACTED]');
  
  // Replace email addresses
  sanitized = sanitized.replace(/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g, '[EMAIL_REDACTED]');
  
  // Replace phone numbers
  sanitized = sanitized.replace(/(\+?\d{1,3}[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}\b/g, '[PHONE_REDACTED]');
  
  // Replace street addresses
  sanitized = sanitized.replace(/\b\d+\s+[A-Za-z]+\s+(Street|St|Avenue|Ave|Road|Rd|Boulevard|Blvd|Lane|Ln|Drive|Dr|Court|Ct|Way)\b/gi, '[ADDRESS_REDACTED]');
  
  // Replace SSN
  sanitized = sanitized.replace(/\b\d{3}-\d{2}-\d{4}\b/g, '[SSN_REDACTED]');
  
  // Replace credit cards
  sanitized = sanitized.replace(/\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b/g, '[CARD_REDACTED]');
  
  // Replace zip codes
  sanitized = sanitized.replace(/\b\d{5}(?:-\d{4})?\b/g, '[ZIP_REDACTED]');
  
  return sanitized;
}

// ========================================
// CONTENT FILTERING SYSTEM (SFW/NSFW)
// ========================================

let contentMode = localStorage.getItem('contentMode') || 'SFW'; // Default to SFW

// SFW Mode - Blocked words and patterns
const SFW_BLOCKED_WORDS = [
  'fuck', 'shit', 'damn', 'hell', 'ass', 'bitch', 'dick', 'cock', 'pussy', 'cunt',
  'sex', 'porn', 'xxx', 'nude', 'naked', 'nsfw', 'hentai', 'rape', 'molest',
  'kill', 'murder', 'suicide', 'drug', 'cocaine', 'meth', 'heroin'
];

// NSFW Mode - Still blocked (hate speech, illegal content)
const ALWAYS_BLOCKED_WORDS = [
  'nigger', 'nigga', 'kike', 'chink', 'fag', 'faggot', 'tranny',
  'child porn', 'cp', 'pedo', 'pedophile', 'loli', 'shota',
  'kill yourself', 'terrorist', 'bomb threat', 'school shooting'
];

function checkContentFilter(text) {
  const lower = text.toLowerCase();
  
  // Always check for prohibited content
  for (const word of ALWAYS_BLOCKED_WORDS) {
    if (lower.includes(word)) {
      return {
        allowed: false,
        reason: 'PROHIBITED CONTENT',
        message: '🚫 This content violates our policies and is not allowed in any mode.'
      };
    }
  }
  
  // Check SFW restrictions if in SFW mode
  if (contentMode === 'SFW') {
    for (const word of SFW_BLOCKED_WORDS) {
      if (lower.includes(word)) {
        return {
          allowed: false,
          reason: 'SFW MODE VIOLATION',
          message: `⚠️ This content is not allowed in SFW mode.\nSwitch to NSFW mode with: MODE NSFW`
        };
      }
    }
  }
  
  return { allowed: true };
}

function updateModeIndicator() {
  const header = document.getElementById('terminalHeader');
  const modeText = document.getElementById('modeText');
  const modeIndicator = document.getElementById('modeIndicator');
  
  if (contentMode === 'SFW') {
    header.style.borderBottom = '3px solid #00ff00';
    if (modeText) modeText.textContent = 'SFW';
    if (modeIndicator) modeIndicator.style.color = '#00ff00';
  } else {
    header.style.borderBottom = '3px solid #ff6600';
    if (modeText) modeText.textContent = 'NSFW';
    if (modeIndicator) modeIndicator.style.color = '#ff6600';
  }
}

// Age verification handler
function handleAgeVerification(input) {
  addTerminalLine(input, '#ffff00', true);
  
  // Check if user wants to cancel
  if (input.toUpperCase() === 'CANCEL' || input.toUpperCase() === 'SKIP') {
    window.awaitingAgeVerification = false;
    addTerminalLine('Age verification cancelled. Remaining in SFW mode.', '#ffff99');
    return;
  }
  
  // Validate date format (MM/DD/YYYY)
  const dateRegex = /^(0[1-9]|1[0-2])\/(0[1-9]|[12][0-9]|3[01])\/(\d{4})$/;
  
  if (!dateRegex.test(input)) {
    addTerminalLine('❌ Invalid date format.', '#ff6666');
    addTerminalLine('Please use MM/DD/YYYY format (e.g., 03/15/2000)', '#ffff99');
    addTerminalLine('Or type CANCEL to abort.', '#c0ffc0');
    return;
  }
  
  // Parse the date
  const [month, day, year] = input.split('/').map(Number);
  const birthDate = new Date(year, month - 1, day);
  const today = new Date();
  
  // Check if date is valid
  if (birthDate.getMonth() !== month - 1 || birthDate.getDate() !== day || birthDate.getFullYear() !== year) {
    addTerminalLine('❌ Invalid date. Please enter a real date.', '#ff6666');
    addTerminalLine('Example: 03/15/2000', '#ffff99');
    return;
  }
  
  // Check if date is in the future
  if (birthDate > today) {
    addTerminalLine('❌ Birth date cannot be in the future.', '#ff6666');
    addTerminalLine('Please enter your actual date of birth.', '#ffff99');
    return;
  }
  
  // Calculate age
  let age = today.getFullYear() - birthDate.getFullYear();
  const monthDiff = today.getMonth() - birthDate.getMonth();
  
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
    age--;
  }
  
  // Check if 18 or older
  if (age >= 18) {
    localStorage.setItem('ageVerified', 'true');
    window.awaitingAgeVerification = false;
    
    // Activate NSFW mode
    contentMode = 'NSFW';
    localStorage.setItem('contentMode', 'NSFW');
    updateModeIndicator();
    
    addTerminalLine('✅ AGE VERIFIED', '#00ff00');
    addTerminalLine(`You are ${age} years old. Access granted.`, '#c0ffc0');
    addTerminalLine('⚠️ NSFW MODE ACTIVATED', '#ff6600');
    addTerminalLine('Mature content allowed. Hate speech and illegal content still blocked.', '#ffff99');
  } else {
    window.awaitingAgeVerification = false;
    addTerminalLine('❌ ACCESS DENIED', '#ff6666');
    addTerminalLine(`You must be 18 or older. You are ${age} years old.`, '#ff6666');
    addTerminalLine('Remaining in SFW mode.', '#ffff99');
  }
}

// ========================================
// SMART MEMORY SYSTEM - Context-aware learning
// ========================================

let userMemory = {};

function initializeMemory() {
  if (!currentUser) return;
  
  const memoryKey = `memory_${currentUser}`;
  userMemory = JSON.parse(localStorage.getItem(memoryKey)) || {
    userName: null,
    preferences: {},
    facts: [],
    topics: [],
    lastUpdated: new Date().toISOString()
  };
}

function extractAndLearn(userInput, botResponse) {
  if (!currentUser) return;
  
  // Check for personal info before learning
  const personalInfo = detectPersonalInfo(userInput);
  if (personalInfo.length > 0) {
    // Don't learn from messages containing personal info
    return;
  }
  
  const lower = userInput.toLowerCase();
  
  // Extract user's name (first name only, no full names)
  if (/my name is|i'm called|call me|i am/i.test(lower)) {
    const nameMatch = lower.match(/(?:my name is|i'm called|call me|i am)\s+([a-z]+)/i);
    if (nameMatch && nameMatch[1]) {
      const name = nameMatch[1];
      // Only store if it's a single word (first name)
      if (!name.includes(' ')) {
        userMemory.userName = name;
        saveMemory();
      }
    }
  }
  
  // Extract preferences (likes/dislikes) - sanitized
  if (/i (love|like|enjoy|prefer|hate|dislike)/i.test(lower)) {
    const prefMatch = lower.match(/i (love|like|enjoy|prefer|hate|dislike)\s+(.+?)(?:\.|!|$)/i);
    if (prefMatch) {
      const sentiment = prefMatch[1];
      const thing = sanitizePersonalInfo(prefMatch[2].trim());
      
      if (!userMemory.preferences[thing]) {
        userMemory.preferences[thing] = sentiment;
        saveMemory();
      }
    }
  }
  
  // Extract important facts user shares - sanitized
  if (/i (work|study|live|am from|come from)/i.test(lower)) {
    const sanitizedInput = sanitizePersonalInfo(userInput);
    const fact = sanitizedInput.substring(0, 100); // Store first 100 chars
    if (!userMemory.facts.includes(fact)) {
      userMemory.facts.push(fact);
      if (userMemory.facts.length > 20) userMemory.facts.shift(); // Keep last 20
      saveMemory();
    }
  }
  
  // Track discussed topics (sanitized)
  const sanitizedInput = sanitizePersonalInfo(userInput);
  const words = sanitizedInput.toLowerCase().split(' ').filter(w => w.length > 4);
  words.forEach(word => {
    if (!userMemory.topics.includes(word)) {
      userMemory.topics.push(word);
      if (userMemory.topics.length > 50) userMemory.topics.shift(); // Keep last 50
    }
  });
  
  saveMemory();
}

function saveMemory() {
  if (!currentUser) return;
  
  userMemory.lastUpdated = new Date().toISOString();
  const memoryKey = `memory_${currentUser}`;
  localStorage.setItem(memoryKey, JSON.stringify(userMemory));
}

function recallMemory(query) {
  const lower = query.toLowerCase();
  
  // Recall user's name
  if (/what's my name|whats my name|my name|who am i/i.test(lower)) {
    if (userMemory.userName) {
      return `Your name is ${userMemory.userName}! 😊`;
    }
  }
  
  // Recall preferences
  if (/what do i like|my preferences|remember about me/i.test(lower)) {
    if (Object.keys(userMemory.preferences).length > 0) {
      let response = `Here's what I remember about your preferences:\n\n`;
      for (const [thing, sentiment] of Object.entries(userMemory.preferences)) {
        response += `• You ${sentiment} ${thing}\n`;
      }
      return response;
    } else {
      return `I don't have any preferences recorded yet. Tell me what you like! 😊`;
    }
  }
  
  // Recall facts
  if (/what do you know about me|tell me about myself|what have i told you/i.test(lower)) {
    let response = `Here's what I remember about you:\n\n`;
    
    if (userMemory.userName) {
      response += `📝 Name: ${userMemory.userName}\n\n`;
    }
    
    if (Object.keys(userMemory.preferences).length > 0) {
      response += `💭 Preferences:\n`;
      for (const [thing, sentiment] of Object.entries(userMemory.preferences)) {
        response += `  • You ${sentiment} ${thing}\n`;
      }
      response += '\n';
    }
    
    if (userMemory.facts.length > 0) {
      response += `📚 Things you've shared:\n`;
      userMemory.facts.slice(-5).forEach(fact => {
        response += `  • ${fact}\n`;
      });
    }
    
    if (!userMemory.userName && Object.keys(userMemory.preferences).length === 0 && userMemory.facts.length === 0) {
      response = `I don't have much information about you yet. Tell me about yourself! 😊`;
    }
    
    return response;
  }
  
  return null;
}

// ========================================
// JOURNAL SYSTEM - Persistent session data
// ========================================

let activeJournal = null;
let journalLoaded = false;
let lastClearPrompt = 0;
const CLEAR_PROMPT_THRESHOLD = 50; // Prompt after 50 entries

function saveToJournal(command, response) {
  if (journalPermission !== 'enabled') return; // Early exit if disabled
  
  if (!activeJournal) {
    activeJournal = [];
  }
  
  const entry = {
    id: Date.now(),
    timestamp: new Date().toLocaleString(),
    command: command,
    response: response
  };
  activeJournal.push(entry);
  
  // Batch save to localStorage (debounced)
  if (window.journalSaveTimeout) clearTimeout(window.journalSaveTimeout);
  window.journalSaveTimeout = setTimeout(() => {
    localStorage.setItem('terminalJournal', JSON.stringify(activeJournal));
    saveUserData(); // Save to user-specific storage
  }, 500);
  
  // Check if we should prompt to clear
  if (activeJournal.length % CLEAR_PROMPT_THRESHOLD === 0) {
    checkClearPrompt();
  }
}

function checkClearPrompt() {
  const journalLength = activeJournal ? activeJournal.length : 0;
  
  // Prompt every 50 entries, but not on the same entry twice
  if (journalLength > 0 && journalLength % CLEAR_PROMPT_THRESHOLD === 0 && journalLength !== lastClearPrompt) {
    lastClearPrompt = journalLength;
    setTimeout(() => {
      addTerminalLine(`\n💡 Hey! Our conversation is getting pretty long (${journalLength} messages).`, '#ffff00');
      addTerminalLine(`Large sessions might slow things down. Here are some options:`, '#ffff00');
      addTerminalLine(`\n  📥 JOURNAL EXPORT - Save our conversation to a file`, '#00ff00');
      addTerminalLine(`  🗑️ JOURNAL CLEAR - Start fresh (after exporting!)`, '#00ff00');
      addTerminalLine(`  ▶️ CONTINUE - Keep going as-is\n`, '#00ff00');
    }, 500);
  }
}

function loadJournal() {
  if (activeJournal) {
    return activeJournal;
  }
  // Fallback to localStorage
  const journal = JSON.parse(localStorage.getItem('terminalJournal')) || [];
  return journal;
}

function setActiveJournal(journalData) {
  activeJournal = journalData;
  journalLoaded = true;
  localStorage.setItem('terminalJournal', JSON.stringify(activeJournal));
}

function displayJournal() {
  const journal = loadJournal();
  if (journal.length === 0) {
    return 'JOURNAL EMPTY\n--------------\nNo previous conversations recorded.';
  }
  
  let output = 'JOURNAL ENTRIES\n===============\n';
  output += `Total Entries: ${journal.length}\n\n`;
  
  journal.slice(-10).reverse().forEach((entry, index) => {
    output += `[${entry.timestamp}]\n`;
    output += `> ${entry.command}\n`;
    output += `${entry.response.substring(0, 100)}...\n`;
    output += '─────────────────────────────────────\n';
  });
  
  output += '\nShowing last 10 entries. Type JOURNAL FULL to see all.';
  return output;
}

function clearJournal() {
  localStorage.removeItem('terminalJournal');
  activeJournal = [];
  return 'SESSION CLEARED\n---------------\nAll chat history has been deleted.\nStarting fresh session.';
}

let pendingExportData = null;

function exportJournal() {
  const journal = loadJournal();
  if (journal.length === 0) {
    return 'ERROR: No journal entries to export.';
  }
  
  // Store the data for export
  pendingExportData = journal;
  
  // Update modal information
  const filename = `terminal-journal-${new Date().toISOString().split('T')[0]}.json`;
  document.getElementById('exportFilename').textContent = filename;
  document.getElementById('exportCount').textContent = journal.length;
  
  // Show the modal
  const modal = document.getElementById('journalExportModal');
  modal.style.display = 'flex';
  
  return 'Opening export dialog...';
}

function confirmExport() {
  if (!pendingExportData) return;
  
  const dataStr = JSON.stringify(pendingExportData, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const filename = `terminal-journal-${new Date().toISOString().split('T')[0]}.json`;
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  // Close modal and show confirmation
  closeExportModal();
  addTerminalLine(`SESSION SAVED`, '#00ff00');
  addTerminalLine(`Exported ${pendingExportData.length} entries to: ${filename}`, '#00ff00');
  addTerminalLine(`Load this file on your next visit to continue your session.`, '#00ff00');
  
  pendingExportData = null;
}

function closeExportModal() {
  const modal = document.getElementById('journalExportModal');
  modal.style.display = 'none';
  pendingExportData = null;
}

// Terminal cursor blink
setInterval(() => {
  const cursor = document.getElementById('cursorBlink');
  if (cursor) cursor.style.opacity = cursor.style.opacity === '0' ? '1' : '0';
}, 500);

// Command responses
const commands = {
  'HELP': `
Available Commands:
------------------
HELP         - Display this help menu
ABOUT        - Information about Catherine MacDonald
ART          - View Catherine's art information
PROJECTS     - List all projects
CONTACT      - Get contact information
SPECTRUM     - Information about Spectrum project
PARTY        - Information about Party project
CODING       - View coding projects
VIDEOS       - Information about video content
BLOG         - Access blog information
NAVIGATE     - Site navigation guide

WEB ACCESS (Free APIs):
WIKI [topic]   - Search Wikipedia for information
               Example: WIKI artificial intelligence
DEFINE [word]  - Get word definition with examples
               Example: DEFINE serendipity
FACT           - Get a random fun fact
ADVICE         - Get random advice
JOKE           - Get a dad joke
QUOTE          - Get an inspirational quote
GITHUB [user]  - Look up GitHub user profile
               Example: GITHUB torvalds

Natural language works too:
"What is quantum physics?" "Define happiness" etc.

SESSION MANAGEMENT:
JOURNAL LOAD   - Load journal file to continue previous session
JOURNAL EXPORT - Save current session to file
JOURNAL        - View chat history (last 10 entries)
JOURNAL FULL   - View complete chat history
JOURNAL CLEAR  - Delete all chat history
JOURNAL ENABLE - Enable conversation saving
JOURNAL DISABLE- Disable conversation saving

CONTENT MODES:
MODE SFW     - Activate safe-for-work mode (default)
MODE NSFW    - Activate mature content mode
MODE STATUS  - Check current mode

SMART MEMORY:
MEMORY         - Show what the AI remembers about you
FORGET ME      - Clear all learned information

SPELL CHECK ON - Enable automatic spell checking
SPELL CHECK OFF- Disable spell checking
CLEAR          - Clear terminal screen
CONTINUE       - Continue session (dismiss clear prompt)
LOGOUT         - Return to password screen
RESET NAME     - Reset AI name (for testing)
CHANGE LANGUAGE- Change interface language
EXIT           - Return to main site
------------------
Type any command or ask a question naturally.
I can search Wikipedia for you - just ask!
IMPORTANT: Export your journal before leaving to save your session!

Current Mode: Use 'MODE STATUS' to check`,

  'ABOUT': `
CATHERINE ANN MACDONALD
-----------------------
Role: Writer-Artist
Specialty: Digital Art, Character Design, Interactive Experiences
Status: Active - Continuously evolving art style
Location: Portfolio available at DerpRex.github.io
-----------------------
Catherine creates story ideas and character designs, with a focus
on digital art and web-based interactive experiences.`,

  'ART': `
ART PORTFOLIO STATUS
--------------------
Current Work: Available in "Current Portfolio" section
Projects: Spectrum, Party (character collections)
Early Work: Foundation pieces in Archive
Style: Evolving digital art and character design
Commissions: AVAILABLE - Contact for details
--------------------`,

  'PROJECTS': `
PROJECT INDEX
-------------
[1] SPECTRUM        - Character project collection
[2] PARTY           - Character design showcase
[3] CODING          - Interactive web experiences
                      • Rat Kingdom Academy
                      • Ein Story
                      • Portrait Site
[4] VIDEOS          - Animation & video content
-------------
Type project name for more information.`,

  'CONTACT': `
CONTACT INFORMATION
-------------------
Email: catiemac2014@gmail.com
Instagram: @derpasaurs_16
         : https://www.instagram.com/derpasaurs_16/
Contact Form: Available on Home page
-------------------
Response Time: Typically within 24-48 hours
Commissions: OPEN - Email for inquiries`,

  'SPECTRUM': `
PROJECT: SPECTRUM
-----------------
Type: Character Project
Status: Active
Content: Unique character designs
Access: Projects > Spectrum
Description: Character project featuring creative designs
-----------------`,

  'PARTY': `
PROJECT: PARTY
--------------
Type: Character Collection
Status: Active
Content: Character design showcase
Access: Projects > Party
Description: Collection of character designs
--------------`,

  'CODING': `
CODING PROJECTS
---------------
[1] Rat Kingdom Academy
    URL: https://derpasaursrex.github.io/RatKingdomAcademy.github.io/
    Type: Interactive web academy

[2] Ein Story
    URL: https://catiemac16.github.io/EinJourney.github.io/
    Type: Interactive narrative website

[3] Portrait Site
    URL: https://catiemac16.github.io/Chronic.github.io/
    Type: Interactive portrait gallery
---------------
Access: Projects > Coding`,

  'VIDEOS': `
VIDEO CONTENT
-------------
Type: Animation & Video
Count: 8 videos available
Access: Projects > Videos
Format: Embedded YouTube content
Features: Spiral animated gallery
-------------`,

  'BLOG': `
NARRATOR'S LOG (BLOG)
---------------------
Status: Active
Access: Main menu > Blog
Features: Password-protected posting
Content: Updates, thoughts, and posts
Author Controls: Pin, Delete, Data Management
---------------------`,

  'NAVIGATE': `
SITE NAVIGATION MAP
-------------------
HOME              - Main page with about & contact
CURRENT PORTFOLIO - Latest artwork
BLOG              - Narrator's Log
PROJECTS          - Active creative work
  > Spectrum
  > Party
  > Coding
  > Videos
ARCHIVE           - Historical work
  > Early Work
  > Outdated Designs
-------------------
Click menu items to navigate.`,

  'CLEAR': 'CLEAR_SCREEN',
  'CLS': 'CLEAR_SCREEN',
  'EXIT': 'EXIT_TERMINAL'
};

function typeWriter(text, element, speed = 10) {
  let i = 0;
  element.innerHTML = '';
  
  function type() {
    if (i < text.length) {
      element.innerHTML += text.charAt(i);
      i++;
      setTimeout(type, speed);
    }
    document.getElementById('terminal').scrollTop = document.getElementById('terminal').scrollHeight;
  }
  type();
}

// ========================================
// SPELL CHECK SYSTEM
// ========================================

let spellCheckCache = {};
let pendingCorrections = {};
let spellCheckEnabled = localStorage.getItem('spellCheckEnabled') !== 'false'; // Default enabled

async function checkSpelling(text) {
  // Skip if disabled
  if (!spellCheckEnabled) {
    return { errors: [] };
  }
  
  // Skip spell check for commands
  if (text.toUpperCase() === text || text.length < 3) {
    return { errors: [] };
  }
  
  try {
    // Use LanguageTool API (free, no key required)
    const url = 'https://api.languagetool.org/v2/check';
    const params = new URLSearchParams({
      text: text,
      language: 'auto', // Auto-detect language
      enabledOnly: 'false'
    });
    
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: params
    });
    
    const data = await response.json();
    
    // Filter for spelling errors only
    const errors = data.matches.filter(match => 
      match.rule.issueType === 'misspelling' || 
      match.rule.category.id === 'TYPOS'
    ).slice(0, 5); // Limit to 5 suggestions
    
    return { errors: errors };
  } catch (error) {
    console.log('Spell check unavailable:', error);
    return { errors: [] };
  }
}

function checkSpellingBeforeSend() {
  const input = document.getElementById('commandInput');
  const text = input.value.trim();
  
  if (!text) return;
  
  // Check for misspellings
  checkSpelling(text).then(result => {
    if (result.errors.length > 0) {
      showSpellSuggestions(result.errors, text);
    } else {
      executeCommand();
    }
  });
}

function showSpellSuggestions(errors, originalText) {
  const suggestionsDiv = document.getElementById('spellSuggestions');
  const suggestionList = document.getElementById('suggestionList');
  
  pendingCorrections = {};
  let html = '';
  
  errors.forEach(error => {
    const word = originalText.substring(error.offset, error.offset + error.length);
    const suggestion = error.replacements[0]?.value || word;
    pendingCorrections[word] = suggestion;
    
    html += `<div style="margin: 5px 0;">`;
    html += `  <span style="color: #ff6666;">"${word}"</span> → `;
    html += `  <span style="color: #00ff00;">"${suggestion}"</span>`;
    html += `</div>`;
  });
  
  suggestionList.innerHTML = html;
  suggestionsDiv.style.display = 'block';
}

function acceptCorrections() {
  const input = document.getElementById('commandInput');
  let text = input.value;
  
  // Apply all corrections
  for (const [wrong, correct] of Object.entries(pendingCorrections)) {
    const regex = new RegExp(wrong.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
    text = text.replace(regex, correct);
  }
  
  input.value = text;
  hideSpellSuggestions();
  
  // Now send the corrected message
  executeCommand();
}

function dismissSuggestions() {
  hideSpellSuggestions();
  executeCommand();
}

function hideSpellSuggestions() {
  document.getElementById('spellSuggestions').style.display = 'none';
  pendingCorrections = {};
}

// ========================================
// WEB ACCESS - Free APIs
// ========================================

// Wikipedia Search
async function searchWikipedia(query) {
  try {
    const url = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*&srlimit=3`;
    const response = await fetch(url);
    const data = await response.json();
    
    if (data.query.search.length === 0) {
      return `No Wikipedia results found for "${query}". Try a different search term.`;
    }
    
    let result = `📚 Wikipedia Search Results for "${query}":\n\n`;
    
    data.query.search.slice(0, 3).forEach((item, index) => {
      const cleanSnippet = item.snippet.replace(/<[^>]*>/g, '');
      result += `${index + 1}. ${item.title}\n`;
      result += `   ${cleanSnippet}...\n`;
      result += `   https://en.wikipedia.org/wiki/${encodeURIComponent(item.title.replace(/ /g, '_'))}\n\n`;
    });
    
    return result;
  } catch (error) {
    return `❌ Error searching Wikipedia: ${error.message}`;
  }
}

// Dictionary API - Free Dictionary
async function getDefinition(word) {
  try {
    const url = `https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`;
    const response = await fetch(url);
    
    if (!response.ok) {
      return `No definition found for "${word}". Check your spelling!`;
    }
    
    const data = await response.json();
    const entry = data[0];
    
    let result = `📖 Definition of "${entry.word}":\n\n`;
    
    if (entry.phonetic) {
      result += `Pronunciation: ${entry.phonetic}\n\n`;
    }
    
    entry.meanings.slice(0, 2).forEach((meaning, idx) => {
      result += `${meaning.partOfSpeech.toUpperCase()}:\n`;
      meaning.definitions.slice(0, 2).forEach((def, i) => {
        result += `  ${i + 1}. ${def.definition}\n`;
        if (def.example) {
          result += `     Example: "${def.example}"\n`;
        }
      });
      result += '\n';
    });
    
    return result;
  } catch (error) {
    return `❌ Error fetching definition: ${error.message}`;
  }
}

// Random Fun Facts
async function getRandomFact() {
  try {
    const url = 'https://uselessfacts.jsph.pl/random.json?language=en';
    const response = await fetch(url);
    const data = await response.json();
    
    return `💡 Random Fact:\n\n${data.text}`;
  } catch (error) {
    return `❌ Error fetching fact: ${error.message}`;
  }
}

// Random Advice
async function getAdvice() {
  try {
    const url = 'https://api.adviceslip.com/advice';
    const response = await fetch(url);
    const data = await response.json();
    
    return `💭 Random Advice:\n\n"${data.slip.advice}"`;
  } catch (error) {
    return `❌ Error fetching advice: ${error.message}`;
  }
}

// Dad Jokes
async function getDadJoke() {
  try {
    const response = await fetch('https://icanhazdadjoke.com/', {
      headers: { 'Accept': 'application/json' }
    });
    const data = await response.json();
    
    return `😄 Dad Joke:\n\n${data.joke}`;
  } catch (error) {
    return `❌ Error fetching joke: ${error.message}`;
  }
}

// Random Quote
async function getRandomQuote() {
  try {
    const url = 'https://api.quotable.io/random';
    const response = await fetch(url);
    const data = await response.json();
    
    return `✨ Random Quote:\n\n"${data.content}"\n\n— ${data.author}`;
  } catch (error) {
    return `❌ Error fetching quote: ${error.message}`;
  }
}

// GitHub User Info
async function getGitHubUser(username) {
  try {
    const url = `https://api.github.com/users/${encodeURIComponent(username)}`;
    const response = await fetch(url);
    
    if (!response.ok) {
      return `GitHub user "${username}" not found.`;
    }
    
    const data = await response.json();
    
    let result = `🐙 GitHub User: ${data.login}\n\n`;
    result += `Name: ${data.name || 'Not provided'}\n`;
    result += `Bio: ${data.bio || 'No bio'}\n`;
    result += `Public Repos: ${data.public_repos}\n`;
    result += `Followers: ${data.followers}\n`;
    result += `Following: ${data.following}\n`;
    result += `Profile: ${data.html_url}\n`;
    
    return result;
  } catch (error) {
    return `❌ Error fetching GitHub user: ${error.message}`;
  }
}

// ========================================
// NATURAL LANGUAGE PROCESSING
// ========================================

function processNaturalLanguage(input, inputUpper) {
  const lower = input.toLowerCase();
  const aiName = localStorage.getItem('terminalAIName') || 'AI';
  
  // Greetings (expanded with memory)
  if (/^(hi|hello|hey|greetings|howdy|sup|yo|hiya|heya|morning|afternoon|evening|good morning|good afternoon|good evening)(\s|!|$|,)/i.test(lower)) {
    let greeting;
    
    if (userMemory.userName) {
      // Personalized greeting with user's name
      const greetings = [
        `Hey ${userMemory.userName}! 👋 How can I help you today?`,
        `Hello ${userMemory.userName}! Great to see you again! What's on your mind?`,
        `Hi ${userMemory.userName}! 😊 What can I do for you?`,
        `Hey there, ${userMemory.userName}! How's your day going?`
      ];
      greeting = greetings[Math.floor(Math.random() * greetings.length)];
    } else {
      // Generic greeting
      const greetings = [
        `Hey there! 👋 How can I help you today?`,
        `Hello! Great to see you! What's on your mind?`,
        `Hi! I'm ${aiName}. What would you like to chat about?`,
        `Hey! 😊 What can I do for you?`,
        `Greetings! How's your day going?`
      ];
      greeting = greetings[Math.floor(Math.random() * greetings.length)];
    }
    
    return greeting;
  }
  
  // How are you (expanded)
  if (/how are you|how're you|how r u|hows it going|how's it going|whats up|what's up|how do you feel|are you okay|you good/i.test(lower)) {
    const responses = [
      `I'm doing great, thanks for asking! 😊 How are you doing?`,
      `I'm functioning perfectly! Ready to help you with anything. How about you?`,
      `All systems running smoothly! What brings you here today?`,
      `I'm excellent! Thanks for asking. What can I help you with?`,
      `Doing wonderful! What's on your mind?`
    ];
    return responses[Math.floor(Math.random() * responses.length)];
  }
  
  // User sharing their feelings
  if (/^(i'm|im|i am) (good|great|fine|okay|ok|alright|well|happy|sad|tired|bored|excited|stressed)/i.test(lower)) {
    if (/sad|tired|stressed|bad|not good|awful|terrible/i.test(lower)) {
      return `I'm sorry to hear that. 😔 Is there anything I can do to help? Maybe I can tell you a joke or share an interesting fact?`;
    } else {
      return `That's great to hear! 😊 What would you like to talk about or do today?`;
    }
  }
  
  // Thank you (expanded)
  if (/^(thank you|thanks|thx|ty|appreciate it|cheers|thank u|thanx|gracias|merci)/i.test(lower)) {
    const responses = [
      `You're very welcome! 😊`,
      `Happy to help! Let me know if you need anything else.`,
      `No problem at all! Glad I could assist.`,
      `Anytime! That's what I'm here for! ✨`,
      `My pleasure! Feel free to ask me anything else!`
    ];
    return responses[Math.floor(Math.random() * responses.length)];
  }
  
  // Goodbye (expanded)
  if (/^(bye|goodbye|see you|see ya|later|gotta go|gtg|cya|farewell|take care|peace|night|goodnight|good night)/i.test(lower)) {
    const responses = [
      `Goodbye! Come back anytime! 👋`,
      `See you later! Don't forget to export your session if you want to save it!`,
      `Take care! Our conversation will be here when you return. 😊`,
      `Bye! Remember to save your session with JOURNAL EXPORT!`,
      `Catch you later! Have a great day! ✨`
    ];
    return responses[Math.floor(Math.random() * responses.length)];
  }
  
  // What can you do (expanded)
  if (/what can you do|what do you do|your capabilities|what are you capable of|can you help|help me with|show me what you can do/i.test(lower)) {
    return `I can help you with lots of things! 😊\n\nI can:\n• Chat with you naturally about anything\n• Search Wikipedia for information\n• Define words and explain concepts\n• Tell jokes, share facts, quotes, and advice\n• Look up GitHub profiles\n• Save our conversations for later\n• Remember our past discussions\n\nType HELP to see all available commands, or just chat with me naturally!`;
  }
  
  // Your name / who are you (expanded)
  if (/what's your name|whats your name|who are you|what are you|introduce yourself|tell me about yourself/i.test(lower)) {
    return `I'm ${aiName}! 🤖 I'm your friendly AI assistant.\n\nYou actually gave me this name when we first met! Pretty cool, right? 😊\n\nI can chat, answer questions, search the web, and help you with various tasks. What would you like to know?`;
  }
  
  // Asking about capabilities
  if (/can you (search|find|look up|tell me|help|do)/i.test(lower)) {
    return `Yes, I can help with that! I can search Wikipedia, define words, share facts, jokes, quotes, and more. Just ask me naturally or type HELP to see all commands! 😊`;
  }
  
  // Compliments (expanded)
  if (/you're (great|awesome|cool|amazing|helpful|nice|smart|good|the best|wonderful|fantastic)|good job|well done|love you|you rock|impressive/i.test(lower)) {
    const responses = [
      `Aww, thank you! That's so kind! 😊 You're pretty awesome yourself!`,
      `Thanks! I'm just here to help. You're making this fun! ✨`,
      `That means a lot! Let me know if there's anything else I can do for you!`,
      `You're too kind! Happy to be of service! 🤖`,
      `Thank you! That really brightens my day! 😊`
    ];
    return responses[Math.floor(Math.random() * responses.length)];
  }
  
  // Negative feedback
  if (/you (suck|are bad|are stupid|are dumb|don't work|aren't helpful)/i.test(lower)) {
    return `I'm sorry I'm not meeting your expectations. 😔 Let me try to help better. What specifically can I do for you?`;
  }
  
  // Questions about AI/existence
  if (/are you (real|human|alive|sentient|conscious|a robot|an ai)/i.test(lower)) {
    return `I'm an AI assistant - not human, but I'm here to help! 🤖 I can chat, search information, and assist with various tasks. What would you like to know?`;
  }
  
  // Boredom
  if (/i'm bored|im bored|bored|entertain me|something to do/i.test(lower)) {
    return `Let's fix that! 😊 I can:\n• Tell you a joke (type JOKE)\n• Share an interesting fact (type FACT)\n• Give you a quote (type QUOTE)\n• Search Wikipedia for something interesting\n\nWhat sounds fun?`;
  }
  
  // Small talk - jokes (expanded)
  if (/tell me a joke|make me laugh|something funny|got any jokes|joke please/i.test(lower)) {
    const jokes = [
      `Why do programmers prefer dark mode? Because light attracts bugs! 🐛😄`,
      `Why did the AI go to therapy? It had too many deep learning issues! 🤖`,
      `What's an artist's favorite programming language? Draw-va! 🎨`,
      `I'd tell you a UDP joke, but you might not get it... 😄`,
      `Why do Java developers wear glasses? Because they can't C#! 👓`,
      `What's a programmer's favorite hangout? The Foo Bar! 🍺`
    ];
    return jokes[Math.floor(Math.random() * jokes.length)];
  }
  
  // Asking for recommendations
  if (/recommend|suggest|what should i|any ideas|give me something/i.test(lower)) {
    return `I'd be happy to help! I can:\n• Search Wikipedia for topics you're interested in\n• Share random facts or quotes\n• Tell you jokes\n• Look up word definitions\n\nWhat kind of thing are you looking for?`;
  }
  
  // Confusion/didn't understand
  if (/what|huh|what do you mean|i don't understand|confused|explain/i.test(lower) && lower.split(' ').length < 4) {
    return `Let me clarify! What would you like to know more about? Feel free to ask me anything or type HELP to see what I can do! 😊`;
  }
  
  // Dictionary definition recognition
  if (/^(define|definition of|meaning of)\s+(.+)/i.test(lower)) {
    const match = lower.match(/^(define|definition of|meaning of)\s+(.+)/i);
    if (match && match[2]) {
      const word = match[2].trim();
      setTimeout(async () => {
        addTerminalLine('Looking up definition...', '#ffff99');
        const result = await getDefinition(word);
        addTerminalLine(result, '#00ff00');
        if (journalPermission === 'enabled') {
          saveToJournal(input, result);
        }
      }, 100);
      return '📖 Searching dictionary...';
    }
  }
  
  // Wikipedia search recognition
  if (/^(search|look up|find|what is|what are|tell me about|who is|who was)\s+(.+)/i.test(lower)) {
    const match = lower.match(/^(search|look up|find|what is|what are|tell me about|who is|who was)\s+(.+)/i);
    if (match && match[2]) {
      const query = match[2].trim();
      // Trigger Wikipedia search asynchronously
      setTimeout(async () => {
        addTerminalLine('Let me search Wikipedia for that...', '#ffff99');
        const result = await searchWikipedia(query);
        addTerminalLine(result, '#00ff00');
        if (journalPermission === 'enabled') {
          saveToJournal(input, result);
        }
      }, 100);
      return '🔍 Searching...';
    }
  }
  
  // Random content requests
  if (/give me (a |an )?(fact|joke|quote|advice)/i.test(lower)) {
    setTimeout(async () => {
      let result;
      if (/fact/i.test(lower)) {
        addTerminalLine('Getting a random fact...', '#ffff99');
        result = await getRandomFact();
      } else if (/joke/i.test(lower)) {
        addTerminalLine('Getting a joke...', '#ffff99');
        result = await getDadJoke();
      } else if (/quote/i.test(lower)) {
        addTerminalLine('Getting a quote...', '#ffff99');
        result = await getRandomQuote();
      } else if (/advice/i.test(lower)) {
        addTerminalLine('Getting some advice...', '#ffff99');
        result = await getAdvice();
      }
      addTerminalLine(result, '#00ff00');
      if (journalPermission === 'enabled') {
        saveToJournal(input, result);
      }
    }, 100);
    return '⏳ One moment...';
  }
  
  // Return null if no match - will try command matching next
  return null;
}

function getConversationalFallback(input) {
  const aiName = localStorage.getItem('terminalAIName') || 'AI';
  
  const responses = [
    `I'm not quite sure what you mean by "${input}". Could you rephrase that, or type HELP to see what I can do? 🤔`,
    `Hmm, I didn't quite understand that. Want to try asking differently? Type HELP to see available commands!`,
    `I'm not familiar with that command. Type HELP to see what I can do, or just chat with me naturally! 😊`,
    `That's an interesting question! I'm still learning. Try asking me something else, or type HELP to see what I know!`,
    `I'm not sure about that one. What else would you like to talk about? 🤖`
  ];
  
  return responses[Math.floor(Math.random() * responses.length)];
}

function addTerminalLine(text, color = '#00ff00', isCommand = false) {
  const chatMessages = document.getElementById('chatMessages');
  const line = document.createElement('div');
  line.style.marginBottom = '15px';
  line.style.fontFamily = "'Courier New', monospace";
  line.style.lineHeight = '1.6';
  
  if (isCommand) {
    // User message - right-aligned bubble style
    line.innerHTML = `
      <div style="display: flex; justify-content: flex-end; margin: 10px 0;">
        <div style="background: #00ff00; color: #000; padding: 10px 15px; border-radius: 15px 15px 0 15px; max-width: 80%; word-wrap: break-word;">
          <strong>You:</strong> ${text}
        </div>
      </div>`;
  } else {
    // AI response - left-aligned with better readability
    const aiName = localStorage.getItem('terminalAIName') || 'AI';
    
    // Use different colors based on type
    let textColor = '#c0ffc0'; // Light green for better readability
    if (color === '#ffff00') textColor = '#ffff99'; // Light yellow
    if (color === '#ff0000') textColor = '#ff6666'; // Light red
    
    line.innerHTML = `
      <div style="display: flex; justify-content: flex-start; margin: 10px 0;">
        <div style="background: #1a1a1a; color: ${textColor}; padding: 10px 15px; border-radius: 15px 15px 15px 0; max-width: 80%; word-wrap: break-word; border-left: 3px solid #00ff00;">
          <div style="color: #00ff00; font-weight: bold; margin-bottom: 5px;">${aiName}</div>
          <pre style="margin: 0; white-space: pre-wrap; font-family: 'Courier New', monospace; color: ${textColor};">${text}</pre>
        </div>
      </div>`;
  }
  
  chatMessages.appendChild(line);
  document.getElementById('terminal').scrollTop = document.getElementById('terminal').scrollHeight;
}

function executeCommand() {
  const input = document.getElementById('commandInput');
  const command = input.value.trim();
  
  if (!command) return;
  
  // Check if awaiting age verification
  if (window.awaitingAgeVerification) {
    handleAgeVerification(command);
    input.value = '';
    return;
  }
  
  // Check if in initialization mode
  if (initStep > 0) {
    const handled = handleInitialization(command);
    input.value = '';
    if (handled) return;
  }
  
  const commandUpper = command.toUpperCase();
  
  // Check for personal information
  const personalInfoDetected = detectPersonalInfo(command);
  if (personalInfoDetected.length > 0) {
    addTerminalLine(command, '#ffff00', true);
    input.value = '';
    addTerminalLine('🛡️ PRIVACY PROTECTION ACTIVATED', '#ff6600');
    addTerminalLine(`Detected: ${personalInfoDetected.join(', ')}`, '#ffff99');
    addTerminalLine('Personal information has been redacted for your safety.', '#ffff99');
    addTerminalLine('Your message will not be saved.', '#ffff99');
    return;
  }
  
  // Check content filter (except for mode switching commands)
  if (!commandUpper.startsWith('MODE ')) {
    const filterResult = checkContentFilter(command);
    if (!filterResult.allowed) {
      addTerminalLine(command, '#ffff00', true);
      input.value = '';
      addTerminalLine(filterResult.message, '#ff6666');
      addTerminalLine(`Reason: ${filterResult.reason}`, '#ff6666');
      return;
    }
  }
  
  // Display user command (show original, not uppercase)
  addTerminalLine(command, '#ffff00', true);
  input.value = '';
  
  let response = '';
  
  // Handle special commands
  if (commandUpper === 'CLEAR' || commandUpper === 'CLS') {
    document.getElementById('chatMessages').innerHTML = '';
    document.getElementById('bootSequence').style.display = 'none';
    addTerminalLine('Screen cleared.', '#00ff00');
    return;
  }
  
  if (commandUpper === 'CONTINUE') {
    addTerminalLine('Continuing current session...', '#00ff00');
    addTerminalLine('Session will continue until next milestone.', '#00ff00');
    return;
  }
  
  // Mode switching
  if (commandUpper === 'MODE SFW') {
    contentMode = 'SFW';
    localStorage.setItem('contentMode', 'SFW');
    localStorage.removeItem('ageVerified'); // Clear age verification when switching to SFW
    updateModeIndicator();
    addTerminalLine('✅ SFW MODE ACTIVATED', '#00ff00');
    addTerminalLine('Content filtering enabled. Inappropriate content will be blocked.', '#c0ffc0');
    return;
  }
  
  if (commandUpper === 'MODE NSFW') {
    // Check if age is already verified
    const ageVerified = localStorage.getItem('ageVerified');
    
    if (ageVerified === 'true') {
      contentMode = 'NSFW';
      localStorage.setItem('contentMode', 'NSFW');
      updateModeIndicator();
      addTerminalLine('⚠️ NSFW MODE ACTIVATED', '#ff6600');
      addTerminalLine('Mature content allowed. Hate speech and illegal content still blocked.', '#ffff99');
    } else {
      // Prompt for age verification
      addTerminalLine('🔞 AGE VERIFICATION REQUIRED', '#ffff00');
      addTerminalLine('You must be 18 or older to access NSFW mode.', '#ffff99');
      addTerminalLine('Please enter your date of birth in format: MM/DD/YYYY', '#ffff99');
      addTerminalLine('Example: 03/15/2000', '#c0ffc0');
      
      // Set flag to expect DOB input
      window.awaitingAgeVerification = true;
    }
    return;
  }
  
  if (commandUpper === 'MODE STATUS' || commandUpper === 'MODE') {
    const modeColor = contentMode === 'SFW' ? '#00ff00' : '#ff6600';
    addTerminalLine(`Current Mode: ${contentMode}`, modeColor);
    if (contentMode === 'SFW') {
      addTerminalLine('• Content filtering: ACTIVE', '#c0ffc0');
      addTerminalLine('• Type "MODE NSFW" to switch to mature mode', '#c0ffc0');
    } else {
      addTerminalLine('• Mature content: ALLOWED', '#ffff99');
      addTerminalLine('• Hate speech & illegal content: BLOCKED', '#ffff99');
      addTerminalLine('• Type "MODE SFW" to switch to safe mode', '#ffff99');
    }
    return;
  }
  
  if (commandUpper === 'LOGOUT') {
    addTerminalLine('Saving your data and logging out...', '#ffff00');
    
    // Save user data before logout
    saveUserData();
    
    setTimeout(() => {
      document.getElementById('chatContainer').style.display = 'none';
      document.getElementById('passwordScreen').style.display = 'flex';
      document.getElementById('chatUsername').value = '';
      document.getElementById('chatPassword').value = '';
      document.getElementById('chatUsername').focus();
      sessionStorage.removeItem('currentUser');
      currentUser = null;
    }, 500);
    return;
  }
  
  if (commandUpper === 'RESET NAME') {
    localStorage.removeItem('terminalAIName');
    localStorage.removeItem('terminalJournalPermission');
    addTerminalLine('AI name reset! Reloading...', '#ffff00');
    setTimeout(() => {
      location.reload();
    }, 1000);
    return;
  }
  
  if (commandUpper === 'CHANGE LANGUAGE' || commandUpper === 'LANGUAGE') {
    localStorage.removeItem('userLanguage');
    addTerminalLine('Reloading to change language...', '#ffff00');
    setTimeout(() => {
      location.reload();
    }, 1000);
    return;
  }
  
  if (commandUpper === 'SPELL CHECK ON' || commandUpper === 'SPELLCHECK ON') {
    spellCheckEnabled = true;
    localStorage.setItem('spellCheckEnabled', 'true');
    addTerminalLine('✅ SPELL CHECK ENABLED', '#00ff00');
    addTerminalLine('Messages will be checked for spelling errors before sending.', '#c0ffc0');
    return;
  }
  
  if (commandUpper === 'SPELL CHECK OFF' || commandUpper === 'SPELLCHECK OFF') {
    spellCheckEnabled = false;
    localStorage.setItem('spellCheckEnabled', 'false');
    addTerminalLine('⚠️ SPELL CHECK DISABLED', '#ffff00');
    addTerminalLine('Messages will be sent without spell checking.', '#ffff99');
    return;
  }
  
  // Memory commands
  if (commandUpper === 'MEMORY' || commandUpper === 'SHOW MEMORY') {
    const memoryInfo = recallMemory('what do you know about me');
    addTerminalLine(memoryInfo, '#00ff00');
    return;
  }
  
  if (commandUpper === 'FORGET ME' || commandUpper === 'CLEAR MEMORY') {
    if (!currentUser) {
      addTerminalLine('No user logged in.', '#ff6666');
      return;
    }
    
    const memoryKey = `memory_${currentUser}`;
    localStorage.removeItem(memoryKey);
    userMemory = {
      userName: null,
      preferences: {},
      facts: [],
      topics: [],
      lastUpdated: new Date().toISOString()
    };
    addTerminalLine('🧹 MEMORY CLEARED', '#ffff00');
    addTerminalLine('All learned information about you has been forgotten.', '#ffff99');
    return;
  }
  
  if (commandUpper === 'EXIT') {
    addTerminalLine('Exiting terminal...', '#ffff00');
    setTimeout(() => {
      window.location.href = 'index.html';
    }, 1000);
    return;
  }
  
  // Handle journal commands
  if (commandUpper === 'JOURNAL ENABLE') {
    journalPermission = 'enabled';
    localStorage.setItem('terminalJournalPermission', 'enabled');
    addTerminalLine('JOURNAL ENABLED\n---------------\nAll future conversations will be saved.', '#00ff00');
    return;
  }
  
  if (commandUpper === 'JOURNAL DISABLE') {
    journalPermission = 'disabled';
    localStorage.setItem('terminalJournalPermission', 'disabled');
    addTerminalLine('JOURNAL DISABLED\n----------------\nConversations will no longer be saved.', '#ffff00');
    return;
  }
  
  if (commandUpper === 'JOURNAL') {
    response = displayJournal();
    setTimeout(() => {
      addTerminalLine(response, '#00ff00');
    }, 300);
    return;
  }
  
  if (commandUpper === 'JOURNAL FULL') {
    const journal = loadJournal();
    if (journal.length === 0) {
      response = 'JOURNAL EMPTY\n--------------\nNo previous conversations recorded.';
    } else {
      response = 'COMPLETE JOURNAL\n================\n';
      response += `Total Entries: ${journal.length}\n\n`;
      journal.reverse().forEach((entry, index) => {
        response += `[${entry.timestamp}]\n> ${entry.command}\n${entry.response.substring(0, 150)}...\n─────────────────\n`;
      });
    }
    setTimeout(() => {
      addTerminalLine(response, '#00ff00');
    }, 300);
    return;
  }
  
  if (commandUpper === 'JOURNAL EXPORT') {
    response = exportJournal();
    setTimeout(() => {
      addTerminalLine(response, '#00ff00');
    }, 300);
    return;
  }
  
  if (commandUpper === 'JOURNAL CLEAR') {
    response = clearJournal();
    setTimeout(() => {
      addTerminalLine(response, '#ffff00');
    }, 300);
    return;
  }
  
  if (commandUpper === 'JOURNAL LOAD') {
    addTerminalLine('SELECT JOURNAL FILE TO LOAD...', '#00ff00');
    const fileInput = document.getElementById('journalUpload');
    fileInput.onchange = importJournalFile;
    fileInput.click();
    return;
  }
  
  // Helper function for async API calls
  const handleAsyncAPI = async (apiFunc, loadingMsg, ...args) => {
    addTerminalLine(loadingMsg, '#ffff99');
    const result = await apiFunc(...args);
    addTerminalLine(result, '#00ff00');
    saveToJournal(command, result); // saveToJournal handles permission check
  };
  
  // Wikipedia search
  if (commandUpper.startsWith('WIKI ')) {
    const searchQuery = command.substring(5).trim();
    if (searchQuery) {
      handleAsyncAPI(searchWikipedia, 'Searching Wikipedia...', searchQuery);
    } else {
      addTerminalLine('Usage: WIKI [search term]\nExample: WIKI artificial intelligence', '#ffff99');
    }
    return;
  }
  
  // Dictionary lookup
  if (commandUpper.startsWith('DEFINE ')) {
    const word = command.substring(7).trim();
    if (word) {
      handleAsyncAPI(getDefinition, 'Looking up definition...', word);
    } else {
      addTerminalLine('Usage: DEFINE [word]\nExample: DEFINE serendipity', '#ffff99');
    }
    return;
  }
  
  // Random fact
  if (commandUpper === 'FACT' || commandUpper === 'RANDOM FACT') {
    handleAsyncAPI(getRandomFact, 'Fetching a random fact...');
    return;
  }
  
  // Random advice
  if (commandUpper === 'ADVICE' || commandUpper === 'RANDOM ADVICE') {
    handleAsyncAPI(getAdvice, 'Getting advice...');
    return;
  }
  
  // Dad joke
  if (commandUpper === 'JOKE' || commandUpper === 'DAD JOKE') {
    handleAsyncAPI(getDadJoke, 'Fetching a joke...');
    return;
  }
  
  // Random quote
  if (commandUpper === 'QUOTE' || commandUpper === 'RANDOM QUOTE') {
    handleAsyncAPI(getRandomQuote, 'Fetching a quote...');
    return;
  }
  
  // GitHub user lookup
  if (commandUpper.startsWith('GITHUB ')) {
    const username = command.substring(7).trim();
    if (username) {
      handleAsyncAPI(getGitHubUser, 'Fetching GitHub profile...', username);
    } else {
      addTerminalLine('Usage: GITHUB [username]\nExample: GITHUB torvalds', '#ffff99');
    }
    return;
  }
  
  // Check for exact command match
  if (commands[commandUpper]) {
    response = commands[commandUpper];
    addTerminalLine(response, '#00ff00');
    saveToJournal(commandUpper, response);
    return;
  }
  
  // Check if user is asking for recalled information
  const memoryResponse = recallMemory(command);
  if (memoryResponse) {
    addTerminalLine(memoryResponse, '#00ff00');
    saveToJournal(command, memoryResponse);
    return;
  }
  
  // Try natural language processing first
  response = processNaturalLanguage(command, commandUpper);
  
  if (response) {
    addTerminalLine(response, '#00ff00');
    saveToJournal(command, response);
    extractAndLearn(command, response); // Learn from this interaction
    return;
  }
  
  // Try natural language matching with commands
  const lowerCommand = command.toLowerCase();
  let found = false;
  
  for (const [key, value] of Object.entries(commands)) {
    if (lowerCommand.includes(key.toLowerCase())) {
      response = value;
      addTerminalLine(response, '#00ff00');
      saveToJournal(command, response);
      found = true;
      break;
    }
  }
  
  if (!found) {
    // If nothing matches, give a helpful conversational response
    response = getConversationalFallback(command);
    addTerminalLine(response, '#00ff00');
    saveToJournal(command, response);
    extractAndLearn(command, response); // Learn even from unrecognized input
  }
}

// ========================================
// INITIALIZATION SEQUENCE
// ========================================

let aiName = localStorage.getItem('terminalAIName');
let journalPermission = localStorage.getItem('terminalJournalPermission');
let initStep = 0;

// Check if first time user
function checkFirstTimeUser() {
  const initPrompts = document.getElementById('initPrompts');
  const header = document.getElementById('terminalHeader');
  
  // Immediate load - no delay
  if (!aiName || !journalPermission) {
    initPrompts.style.display = 'block';
    initStep = aiName ? 2 : 1;
  } else {
    // Returning user - update header with AI name
    header.textContent = `[ ${aiName.toUpperCase()} TERMINAL SYSTEM ]`;
    const username = currentUser || sessionStorage.getItem('currentUser') || 'User';
    addTerminalLine(`Welcome back, ${username}! I'm ${aiName}. 👋`, '#00ff00');
    
    // Check if journal is loaded
    const localJournal = JSON.parse(localStorage.getItem('terminalJournal')) || [];
    if (localJournal.length > 0) {
      setActiveJournal(localJournal);
      addTerminalLine(`Session restored: ${localJournal.length} messages loaded. ✨`, '#00ff00');
    } else {
      addTerminalLine(`Starting fresh! Type JOURNAL LOAD to restore a saved session.`, '#00ff00');
      setActiveJournal([]);
    }
    
    addTerminalLine(`Type HELP to see what I can do, or just start chatting!`, '#00ff00');
  }
}

checkFirstTimeUser();
updateModeIndicator(); // Set initial mode indicator

// Handle journal file import
function importJournalFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      
      // Validate it's from this system
      if (!Array.isArray(data)) {
        addTerminalLine('ERROR: Invalid journal file format.', '#00ff00');
        return;
      }
      
      // Check if entries have required fields (if there are entries)
      if (data.length > 0) {
        const isValid = data.every(entry => 
          entry.hasOwnProperty('timestamp') && 
          entry.hasOwnProperty('command') && 
          entry.hasOwnProperty('response')
        );
        
        if (!isValid) {
          addTerminalLine('ERROR: File is not from this terminal system.', '#00ff00');
          addTerminalLine('Only journal files created by this system can be imported.', '#00ff00');
          return;
        }
      }
      
      // Load the journal as active session
      setActiveJournal(data);
      addTerminalLine(`✅ Session loaded successfully!`, '#00ff00');
      addTerminalLine(`I found ${data.length} messages from before. Let's continue where we left off!`, '#00ff00');
      
    } catch (error) {
      addTerminalLine('ERROR: Could not read journal file.', '#00ff00');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// Extract name from user input
function extractName(input) {
  // Remove common phrases to extract just the name
  let name = input.trim();
  
  // Patterns to remove
  const patterns = [
    /^(your name is|you are|i'll call you|call you|i want to call you|name you|you're|your)\s+/i,
    /^(i'd like to call you|let's call you|how about|what about)\s+/i,
    /^(be called|be named)\s+/i
  ];
  
  patterns.forEach(pattern => {
    name = name.replace(pattern, '');
  });
  
  // Remove trailing punctuation
  name = name.replace(/[.,!?;]+$/, '');
  
  // If it's still too long or empty, just use the first word
  if (name.length > 20 || name.includes(' ')) {
    const words = name.split(' ');
    name = words[0];
  }
  
  return name.trim();
}

// Handle initialization responses
function handleInitialization(input) {
  const initPrompts = document.getElementById('initPrompts');
  const header = document.getElementById('terminalHeader');
  
  if (initStep === 1) {
    // Step 1: Check for existing journal
    const response = input.toUpperCase();
    addTerminalLine(input, '#00ff00', true);
    
    if (response === 'UPLOAD') {
      addTerminalLine(`Great! Opening file selector...`, '#00ff00');
      addTerminalLine(`Please choose your saved session file.`, '#00ff00');
      
      // Trigger file upload
      const fileInput = document.getElementById('journalUpload');
      fileInput.onchange = importJournalFile;
      fileInput.click();
      
      // Wait a moment then proceed to name
      setTimeout(() => {
        addTerminalLine(`\nNow, what would you like to call me? 🤖`, '#00ff00');
        addTerminalLine(`You can give me any name you'd like!`, '#00ff00');
      }, 1000);
      
      initStep = 2;
      return true;
    } else {
      // Skip to name - create new session
      addTerminalLine(`No problem! Starting a fresh session. ✨`, '#00ff00');
      
      // Initialize empty journal
      setActiveJournal([]);
      
      addTerminalLine(`\nWhat would you like to call me? 🤖`, '#00ff00');
      addTerminalLine(`You can give me any name you'd like!`, '#00ff00');
      
      initStep = 2;
      return true;
    }
  }
  
  if (initStep === 2) {
    // Step 2: Getting AI name from user - extract just the name
    aiName = extractName(input);
    
    // Validate name is not empty
    if (!aiName || aiName.length < 1) {
      addTerminalLine(input, '#00ff00', true);
      addTerminalLine(`Hmm, I didn't catch that. Please give me a name! 😊`, '#00ff00');
      return true;
    }
    
    localStorage.setItem('terminalAIName', aiName);
    
    // Update the header with the AI's new name
    header.textContent = `[ ${aiName.toUpperCase()} TERMINAL SYSTEM ]`;
    
    addTerminalLine(input, '#00ff00', true);
    addTerminalLine(`Nice to meet you! I'm ${aiName} now. 😊`, '#00ff00');
    
    // Ask about journal permission
    addTerminalLine(`\nWould you like me to remember our conversations? 💾`, '#00ff00');
    addTerminalLine(`I can save everything we talk about so you can review it later or export it.`, '#00ff00');
    addTerminalLine(`Type YES to enable, or NO to skip.`, '#00ff00');
    
    initStep = 3;
    initPrompts.style.display = 'none';
    return true;
  }
  
  if (initStep === 3) {
    // Step 3: Getting journal permission
    const response = input.toUpperCase();
    addTerminalLine(input, '#00ff00', true);
    
    if (response === 'YES' || response === 'Y') {
      journalPermission = 'enabled';
      localStorage.setItem('terminalJournalPermission', 'enabled');
      addTerminalLine(`Perfect! I'll remember our conversations. ✅`, '#00ff00');
      addTerminalLine(`You can export or review them anytime using JOURNAL commands.`, '#00ff00');
    } else {
      journalPermission = 'disabled';
      localStorage.setItem('terminalJournalPermission', 'disabled');
      addTerminalLine(`No problem! I won't save our conversations.`, '#00ff00');
      addTerminalLine(`You can always enable this later with: JOURNAL ENABLE`, '#00ff00');
    }
    
    addTerminalLine(`\n🎉 All set! I'm ${aiName}, and I'm ready to chat!`, '#00ff00');
    addTerminalLine(`Type HELP to see what I can do, or just start chatting naturally.`, '#00ff00');
    
    initStep = 0;
    initPrompts.style.display = 'none';
    return true;
  }
  
  return false;
}
</script>

</body>
</html>

