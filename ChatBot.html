<!DOCTYPE html>
<html lang="en">
<head>
  <title>Catherine Ann MacDonald - Adventure Generator</title>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://ajax.googleapis.com https://cdnjs.cloudflare.com https://maxcdn.bootstrapcdn.com https://api-inference.huggingface.co https://api.languagetool.org https://en.wikipedia.org https://api.dictionaryapi.dev https://uselessfacts.jsph.pl https://api.adviceslip.com https://icanhazdadjoke.com https://api.quotable.io https://api.github.com https://open.spotify.com; connect-src 'self' https://api-inference.huggingface.co https://api.languagetool.org https://en.wikipedia.org https://api.dictionaryapi.dev https://uselessfacts.jsph.pl https://api.adviceslip.com https://icanhazdadjoke.com https://api.quotable.io https://api.github.com; style-src 'self' 'unsafe-inline' https://maxcdn.bootstrapcdn.com; img-src 'self' data: blob:; frame-src https://open.spotify.com;">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  

<style>
  .jumbotron {
    background-image: url("SitePics/rexbanner.png");
    background-size: cover;
    background-repeat: no-repeat;
    background-position: center;
    color: white;
  }
</style>
</head>
<body>

<!-- Terminal-style Navigation Bar -->
    <nav style="background: #000; border-bottom: 3px solid #00ff00; padding: 10px 20px; font-family: 'Courier New', monospace; position: sticky; top: 0; z-index: 100000;">
      <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;">
        <div id="terminalNavHeader" style="color: #00ff00; font-size: 18px; font-weight: bold; margin-bottom: 5px;">
          [ TERMINAL SYSTEM ]
        </div>
    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
      <a href="index.html" style="color: #00ff00; text-decoration: none; padding: 5px 10px; border: 1px solid #00ff00; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='transparent'; this.style.color='#00ff00'">[HOME]</a>
    </div>
  </div>
</nav>

<!-- Language Selection Screen -->
<div id="languageScreen" class="container-fluid" style="margin-top:0; padding: 20px 0; min-height: calc(100vh - 56px); display: flex; justify-content: center; align-items: center; background: #000;">
  <div style="max-width: 700px; width: 90%; background: #000; border: 3px solid #00ff00; padding: 40px; box-shadow: 0 0 30px rgba(0,255,0,0.3);">
    <div style="border-bottom: 2px solid #00ff00; padding-bottom: 15px; margin-bottom: 30px; text-align: center;">
      <pre style="color: #00ff00; margin: 0; font-size: 12px;">
╔═══════════════════════════════════════════╗
║     LANGUAGE SELECTION SYSTEM             ║
║     Select Your Preferred Language        ║
╚═══════════════════════════════════════════╝
      </pre>
    </div>
    
    <div style="color: #00ff00; margin-bottom: 20px; text-align: center; font-family: 'Courier New', monospace; font-size: 16px;">
      🌍 Choose Your Language / Choisissez votre langue / Wählen Sie Ihre Sprache
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
      <button onclick="selectLanguage('en')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇬🇧 English
      </button>
      <button onclick="selectLanguage('es')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇪🇸 Español
      </button>
      <button onclick="selectLanguage('fr')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇫🇷 Français
      </button>
      <button onclick="selectLanguage('de')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇩🇪 Deutsch
      </button>
      <button onclick="selectLanguage('it')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇮🇹 Italiano
      </button>
      <button onclick="selectLanguage('pt')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇵🇹 Português
      </button>
      <button onclick="selectLanguage('ru')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇷🇺 Русский
      </button>
      <button onclick="selectLanguage('ja')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇯🇵 日本語
      </button>
      <button onclick="selectLanguage('zh')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇨🇳 中文
      </button>
      <button onclick="selectLanguage('ko')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇰🇷 한국어
      </button>
      <button onclick="selectLanguage('ar')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇸🇦 العربية
      </button>
      <button onclick="selectLanguage('hi')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇮🇳 हिन्दी
      </button>
    </div>
  </div>
</div>

<!-- Registration Screen (First Time Users) -->
<div id="registrationScreen" class="container-fluid" style="margin-top:0; padding: 20px 0; min-height: calc(100vh - 56px); display: none; justify-content: center; align-items: center; background: #000;">
  <div style="max-width: 600px; width: 90%; background: #000; border: 3px solid #00ff00; padding: 40px; box-shadow: 0 0 30px rgba(0,255,0,0.3);">
    <div style="border-bottom: 2px solid #00ff00; padding-bottom: 15px; margin-bottom: 30px; text-align: center;">
      <pre style="color: #00ff00; margin: 0; font-size: 12px;">
╔═══════════════════════════════════════════╗
║     NEW USER REGISTRATION                 ║
║     Create Your Account                   ║
╚═══════════════════════════════════════════╝
      </pre>
    </div>
    
    <div style="margin-bottom: 25px;">
      <div style="color: #00ff00; margin-bottom: 10px; font-family: 'Courier New', monospace; font-size: 16px;">
        👋 Welcome to the AI Chat System!
      </div>
      <div style="color: #c0ffc0; margin-bottom: 20px; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.6;">
        Create a username and password to save your conversations and preferences.
        <br><br>Your data will be stored securely and privately.
      </div>
    </div>
    
    <div id="registrationError" style="color: #ff6666; font-family: 'Courier New', monospace; margin-bottom: 15px; display: none;">
      ❌ Error message here
    </div>
    
    <div style="margin-bottom: 15px;">
      <label style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; display: block; margin-bottom: 8px;">
        CREATE USERNAME:
      </label>
      <input type="text" id="regUsername" 
             style="width: 100%; background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 12px; font-family: 'Courier New', monospace; font-size: 16px; outline: none;"
             placeholder="Choose a username..."
             onkeypress="if(event.key==='Enter') document.getElementById('regPassword').focus()">
      <div style="color: #ffff99; font-size: 12px; margin-top: 5px; font-family: 'Courier New', monospace;">
        3-20 characters, letters and numbers only
      </div>
    </div>
    
    <div style="margin-bottom: 15px;">
      <label style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; display: block; margin-bottom: 8px;">
        CREATE PASSWORD:
      </label>
      <input type="password" id="regPassword" 
             style="width: 100%; background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 12px; font-family: 'Courier New', monospace; font-size: 16px; outline: none;"
             placeholder="Choose a password..."
             onkeypress="if(event.key==='Enter') document.getElementById('regPasswordConfirm').focus()">
      <div style="color: #ffff99; font-size: 12px; margin-top: 5px; font-family: 'Courier New', monospace;">
        At least 6 characters
      </div>
    </div>
    
    <div style="margin-bottom: 20px;">
      <label style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; display: block; margin-bottom: 8px;">
        CONFIRM PASSWORD:
      </label>
      <input type="password" id="regPasswordConfirm" 
             style="width: 100%; background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 12px; font-family: 'Courier New', monospace; font-size: 16px; outline: none;"
             placeholder="Re-enter password..."
             onkeypress="if(event.key==='Enter') registerNewUser()">
    </div>
    
    <button onclick="registerNewUser()" 
            style="width: 100%; background: #00ff00; color: #000; border: none; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; font-size: 16px; cursor: pointer; transition: all 0.2s; margin-bottom: 10px;"
            onmouseover="this.style.background='#00cc00'" 
            onmouseout="this.style.background='#00ff00'">
      [ CREATE ACCOUNT ]
    </button>
    
    <div style="text-align: center; margin-top: 15px;">
      <a href="#" onclick="showLoginScreen(); return false;" style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; text-decoration: underline;">
        Already have an account? Login here
      </a>
    </div>
  </div>
</div>

<!-- Login Screen (Returning Users) -->
<div id="passwordScreen" class="container-fluid" style="margin-top:0; padding: 20px 0; min-height: calc(100vh - 56px); display: none; justify-content: center; align-items: center; background: #000;">
  <div style="max-width: 600px; width: 90%; background: #000; border: 3px solid #00ff00; padding: 40px; box-shadow: 0 0 30px rgba(0,255,0,0.3);">
    <div style="border-bottom: 2px solid #00ff00; padding-bottom: 15px; margin-bottom: 30px; text-align: center;">
      <pre style="color: #00ff00; margin: 0; font-size: 12px;">
╔═══════════════════════════════════════════╗
║     SECURE ACCESS TERMINAL v1.0           ║
║     User Login                            ║
╚═══════════════════════════════════════════╝
      </pre>
    </div>
    
    <div style="margin-bottom: 25px;">
      <div style="color: #00ff00; margin-bottom: 10px; font-family: 'Courier New', monospace; font-size: 16px;">
        🔒 USER LOGIN
      </div>
      <div style="color: #c0ffc0; margin-bottom: 20px; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.6;">
        Welcome back! Login to access your chat history.
      </div>
    </div>
    
    <div id="passwordError" style="color: #ff6666; font-family: 'Courier New', monospace; margin-bottom: 15px; display: none;">
      ❌ ACCESS DENIED: Invalid credentials
    </div>
    
    <div style="margin-bottom: 15px;">
      <label style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; display: block; margin-bottom: 8px;">
        USERNAME:
      </label>
      <input type="text" id="chatUsername" 
             style="width: 100%; background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 12px; font-family: 'Courier New', monospace; font-size: 16px; outline: none;"
             placeholder="Enter username..."
             onkeypress="if(event.key==='Enter') document.getElementById('chatPassword').focus()">
    </div>
    
    <div style="margin-bottom: 20px;">
      <label style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; display: block; margin-bottom: 8px;">
        PASSWORD:
      </label>
      <input type="password" id="chatPassword" 
             style="width: 100%; background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 12px; font-family: 'Courier New', monospace; font-size: 16px; outline: none;"
             placeholder="Enter password..."
             onkeypress="if(event.key==='Enter') checkChatPassword()">
    </div>
    
    <button onclick="checkChatPassword()" 
            style="width: 100%; background: #00ff00; color: #000; border: none; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; font-size: 16px; cursor: pointer; transition: all 0.2s; margin-bottom: 10px;"
            onmouseover="this.style.background='#00cc00'" 
            onmouseout="this.style.background='#00ff00'">
      [ LOGIN ]
    </button>
    
    <div style="text-align: center; margin-top: 15px;">
      <a href="#" onclick="showRegistrationScreen(); return false;" style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; text-decoration: underline; margin-right: 15px;">
        New user? Create an account
      </a>
      <span style="color: #00ff00;">|</span>
      <a href="#" onclick="showAdminLogin(); return false;" style="color: #ff6600; font-family: 'Courier New', monospace; font-size: 14px; text-decoration: underline; margin-left: 15px;">
        🔐 Admin Access
      </a>
    </div>
  </div>
</div>

<!-- Admin Login Screen -->
<div id="adminLoginScreen" class="container-fluid" style="margin-top:0; padding: 20px 0; min-height: calc(100vh - 56px); display: none; justify-content: center; align-items: center; background: #000;">
  <div style="max-width: 600px; width: 90%; background: #000; border: 3px solid #ff6600; padding: 40px; box-shadow: 0 0 30px rgba(255,102,0,0.3);">
    <div style="border-bottom: 2px solid #ff6600; padding-bottom: 15px; margin-bottom: 30px; text-align: center;">
      <pre style="color: #ff6600; margin: 0; font-size: 12px;">
╔═══════════════════════════════════════════╗
║     ADMINISTRATOR ACCESS                  ║
║     Secure Login Required                 ║
╚═══════════════════════════════════════════╝
      </pre>
    </div>
    
    <div style="margin-bottom: 25px;">
      <div style="color: #ff6600; margin-bottom: 10px; font-family: 'Courier New', monospace; font-size: 16px;">
        🔐 ADMIN LOGIN
      </div>
      <div style="color: #ffcc99; margin-bottom: 20px; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.6;">
        Enter administrator password to continue.
      </div>
    </div>
    
    <div id="adminPasswordError" style="color: #ff6666; font-family: 'Courier New', monospace; margin-bottom: 15px; display: none;">
      ❌ ACCESS DENIED: Invalid admin password
    </div>
    
    <div style="margin-bottom: 20px;">
      <label style="color: #ff6600; font-family: 'Courier New', monospace; font-size: 14px; display: block; margin-bottom: 8px;">
        ADMIN PASSWORD:
      </label>
      <input type="password" id="adminPassword" 
             style="width: 100%; background: #000; color: #ff6600; border: 2px solid #ff6600; padding: 12px; font-family: 'Courier New', monospace; font-size: 16px; outline: none;"
             placeholder="Enter admin password..."
             onkeypress="if(event.key==='Enter') checkAdminPassword()">
    </div>
    
    <button onclick="checkAdminPassword()" 
            style="width: 100%; background: #ff6600; color: #fff; border: none; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; font-size: 16px; cursor: pointer; transition: all 0.2s; margin-bottom: 10px;"
            onmouseover="this.style.background='#ff4400'" 
            onmouseout="this.style.background='#ff6600'">
      [ ADMIN LOGIN ]
    </button>
    
    <div style="text-align: center; margin-top: 15px;">
      <a href="#" onclick="showLoginScreen(); return false;" style="color: #ff6600; font-family: 'Courier New', monospace; font-size: 14px; text-decoration: underline;">
        Back to user login
      </a>
    </div>
  </div>
</div>

<div class="container-fluid" id="chatContainer" style="margin-top:0; padding: 0; min-height: calc(100vh - 56px); display: none;">
  <div style="height: 100%; display: flex; flex-direction: column; position: relative;">
    
    <!-- Floating Help Button -->
    <button id="floatingHelpBtn" onclick="executeQuickCommand('HELP')" style="position: fixed; bottom: 80px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #00ff00, #00cc00); border: 3px solid #00ff00; color: #000; font-size: 24px; font-weight: bold; cursor: pointer; z-index: 10000; box-shadow: 0 4px 15px rgba(0,255,0,0.4); transition: all 0.3s; font-family: 'Courier New', monospace;" onmouseover="this.style.transform='scale(1.1) rotate(5deg)'; this.style.boxShadow='0 6px 20px rgba(0,255,0,0.6)'" onmouseout="this.style.transform='scale(1) rotate(0deg)'; this.style.boxShadow='0 4px 15px rgba(0,255,0,0.4)'">?</button>
    
    <!-- Draggable Spotify Player Widget -->
    <div id="spotifyWidget">
      <div id="spotifyHeader">
        <span>🎵 Spotify Player</span>
        <button id="spotifyMinimize" onclick="toggleSpotifyChat()">+</button>
      </div>
      <div id="spotifyContent" style="display: none;">
        <iframe id="spotifyIframe" style="border-radius: 0 0 7px 7px;" src="https://open.spotify.com/embed/playlist/66TP5uc6hwyESdV9AuvUZJ?utm_source=generator" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
      </div>
    </div>

    <!-- Terminal Window -->
    <div id="terminal" style="flex: 1; background: #000000; color: #00ff00; font-family: 'Courier New', monospace; padding: 20px; overflow-y: auto; border: 3px solid #333; box-shadow: inset 0 0 50px rgba(0,255,0,0.1);">
      
      <!-- Terminal Header -->
      <div id="terminalHeader" style="background: linear-gradient(180deg, #001a00 0%, #000000 100%); border: 2px solid #00ff00; padding: 15px; margin-bottom: 20px; box-shadow: 0 0 15px rgba(0,255,0,0.3);">
        <pre style="color: #00ff00; margin: 0; text-shadow: 0 0 5px rgba(0,255,0,0.5); overflow-x: auto;">
╔═══════════════════════════════════════════════════════════════╗
║  ADVENTURE QUEST GENERATOR v2.0                               ║
║  Text-Based RPG Creator & Story Engine                        ║
║                                                                ║
║  Press '?' or type 'HELP' for quest commands                  ║
╚═══════════════════════════════════════════════════════════════╝
        </pre>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; flex-wrap: wrap; gap: 10px;">
          <div id="gameStatus" style="color: #00ff00; font-size: 12px;">
            <span style="color: #ffff99;">STATUS:</span> <span id="statusText" style="font-weight: bold;">READY</span> <span style="color: #00ff00;">●</span>
          </div>
          <div id="modeIndicator" style="color: #00ff00; font-size: 12px;">
            <span style="color: #ffff99;">MODE:</span> <span id="modeText" style="font-weight: bold;">SFW</span>
          </div>
          <div style="color: #888; font-size: 11px;">
            <span style="color: #ffff99;">TIP:</span> Type 'START' to begin your adventure
          </div>
        </div>
      </div>
      
      <!-- Boot Sequence -->
      <div id="bootSequence" style="display: none;">
        <div style="color: #00ff00;">System initializing...</div>
        <div style="color: #00ff00;">Loading AI modules... [OK]</div>
        <div style="color: #00ff00;">Establishing connection... [OK]</div>
        <div style="color: #00ff00;">Ready for input.</div>
        <div style="color: #00ff00; margin-top: 10px;">═══════════════════════════════════════════════════════════════</div>
      </div>
      
      <!-- Initialization Prompts -->
      <div id="initPrompts" style="margin-top: 20px; display: none;">
        <div style="color: #c0ffc0; margin-bottom: 10px; font-size: 16px; line-height: 1.6;">
          ⚔️ Welcome, Adventurer! This is your first quest.
        </div>
        <div style="color: #c0ffc0; margin-bottom: 15px; font-size: 16px; line-height: 1.6;">
          Do you have a saved adventure from before?
        </div>
        <div style="color: #ffff99; margin-bottom: 15px; font-size: 14px;">
          Type <strong>LOAD GAME</strong> if you have a saved file, or <strong>NEW GAME</strong> to start fresh.
        </div>
      </div>
      
      <!-- File Upload for Journal (Hidden) -->
      <input type="file" id="journalUpload" accept=".json" style="display: none;">
      
      <!-- File Upload for Profile Pictures (Hidden) -->
      <input type="file" id="botPictureInput" accept="image/*" style="display: none;" onchange="handleBotPictureUpload(event)">
      <input type="file" id="userPictureInput" accept="image/*" style="display: none;" onchange="handleUserPictureUpload(event)">
      
      <!-- File Upload for Chat Images (Hidden) -->
      <input type="file" id="chatImageInput" accept="image/*" style="display: none;" onchange="handleChatImageUpload(event)">
      
      <!-- Image Preview Modal -->
      <div id="imagePreviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 99999; justify-content: center; align-items: center; flex-direction: column;">
        <div style="max-width: 800px; width: 90%; text-align: center;">
          <img id="previewImage" style="max-width: 100%; max-height: 60vh; border: 3px solid #00ff00; border-radius: 8px; margin-bottom: 20px;">
          <div style="color: #00ff00; font-family: 'Courier New', monospace; margin-bottom: 20px;">
            <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">📸 Image Ready to Send</div>
            <div style="color: #ffff99; font-size: 14px; margin-bottom: 15px;">Add a message (optional):</div>
            <input type="text" id="imageCaption" placeholder="Say something about this image..." style="width: 100%; background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 12px; font-family: 'Courier New', monospace; font-size: 14px; outline: none; margin-bottom: 20px;" onkeypress="if(event.key==='Enter') sendImageWithCaption()">
          </div>
          <div style="display: flex; gap: 15px; justify-content: center;">
            <button onclick="sendImageWithCaption()" style="background: #00ff00; color: #000; border: none; padding: 12px 30px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; border-radius: 5px; font-size: 16px;">📤 SEND IMAGE</button>
            <button onclick="cancelImageUpload()" style="background: #ff0000; color: #fff; border: none; padding: 12px 30px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; border-radius: 5px; font-size: 16px;">❌ CANCEL</button>
          </div>
        </div>
      </div>
      
      <!-- Journal Export Modal -->
      <div id="journalExportModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: #000; border: 3px solid #00ff00; padding: 30px; max-width: 600px; width: 90%; font-family: 'Courier New', monospace;">
          <div style="color: #00ff00; font-size: 20px; font-weight: bold; margin-bottom: 20px; text-align: center;">
            [ JOURNAL EXPORT ]
          </div>
          <div style="color: #00ff00; margin-bottom: 15px;">
            Ready to save journal data to your device.
          </div>
          <div style="color: #00ff00; margin-bottom: 20px;">
            <strong>Filename:</strong> <span id="exportFilename" style="color: #ffff00;">terminal-journal.json</span>
          </div>
          <div style="color: #00ff00; margin-bottom: 20px;">
            <strong>Total Entries:</strong> <span id="exportCount" style="color: #ffff00;">0</span>
          </div>
          <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
            <button onclick="confirmExport()" style="background: #00ff00; color: #000; border: none; padding: 10px 20px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00cc00'" onmouseout="this.style.background='#00ff00'">
              DOWNLOAD
            </button>
            <button onclick="closeExportModal()" style="background: #ff0000; color: #fff; border: none; padding: 10px 20px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#cc0000'" onmouseout="this.style.background='#ff0000'">
              CANCEL
            </button>
          </div>
        </div>
      </div>
      
      <!-- Chat Messages -->
      <div id="chatMessages" style="margin-top: 20px;"></div>
      
      <!-- Conversation Starters (shown when chat is empty) -->
      <div id="conversationStarters" style="margin-top: 30px; display: none;">
        <div style="color: #00ff00; font-size: 16px; margin-bottom: 15px; text-align: center;">
          💡 Try asking me:
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-bottom: 20px;">
          <button onclick="useStarter('START NEW ADVENTURE')" class="starter-btn">
            ⚔️ Start a New Adventure
          </button>
          <button onclick="useStarter('CONTINUE ADVENTURE')" class="starter-btn">
            📜 Continue Last Adventure
          </button>
          <button onclick="useStarter('CREATE CHARACTER')" class="starter-btn">
            👤 Create a Character
          </button>
          <button onclick="useStarter('GENERATE QUEST')" class="starter-btn">
            🗺️ Generate a Quest
          </button>
          <button onclick="useStarter('RANDOM ENCOUNTER')" class="starter-btn">
            🎲 Random Encounter
          </button>
          <button onclick="useStarter('GAME HELP')" class="starter-btn">
            ❓ Adventure Commands
          </button>
        </div>
      </div>
      
      <!-- Typing Indicator -->
      <div id="typingIndicator" style="display: none; margin: 15px 0;">
        <div style="display: flex; justify-content: flex-start; align-items: flex-start; gap: 10px;">
          <img id="typingBotPic" src="TestBot/test.png" alt="AI" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #00ff00; flex-shrink: 0; margin-top: 5px; object-fit: cover;">
          <div style="background: #1a1a1a; color: #c0ffc0; padding: 10px 15px; border-radius: 15px 15px 15px 0; border-left: 3px solid #00ff00;">
            <div style="color: #00ff00; font-weight: bold; margin-bottom: 5px;" id="typingAIName">AI</div>
            <div class="typing-dots">
              <span class="dot">●</span>
              <span class="dot">●</span>
              <span class="dot">●</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Cursor Blink -->
      <div id="cursor" style="display: inline;">
        <span style="color: #00ff00;">&gt; </span>
        <span id="cursorBlink" style="background: #00ff00; color: #000;">█</span>
      </div>
    </div>
    
    <!-- Command Input -->
    <div style="background: #1a1a1a; padding: 15px; border-top: 2px solid #00ff00;">
      <!-- Spell Check Suggestions -->
      <div id="spellSuggestions" style="display: none; background: #000; border: 2px solid #ffff00; padding: 10px; margin-bottom: 10px; border-radius: 5px;">
        <div style="color: #ffff00; font-family: 'Courier New', monospace; font-size: 12px; margin-bottom: 5px;">
          ⚠️ Possible misspellings detected:
        </div>
        <div id="suggestionList" style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px;"></div>
        <div style="margin-top: 8px; display: flex; gap: 10px;">
          <button onclick="acceptCorrections()" style="background: #00ff00; color: #000; border: none; padding: 5px 15px; font-family: 'Courier New', monospace; font-size: 12px; cursor: pointer; border-radius: 3px;">
            FIX ALL
          </button>
          <button onclick="dismissSuggestions()" style="background: #666; color: #fff; border: none; padding: 5px 15px; font-family: 'Courier New', monospace; font-size: 12px; cursor: pointer; border-radius: 3px;">
            IGNORE
          </button>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; align-items: center;">
        <span style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 18px; font-weight: bold;">&gt;</span>
        <button onclick="document.getElementById('chatImageInput').click()" 
                style="background: #0a0a0a; color: #00ff00; border: 2px solid #00ff00; padding: 10px 16px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s; border-radius: 5px; font-size: 18px;"
                onmouseover="this.style.background='#003300'" 
                onmouseout="this.style.background='#0a0a0a'"
                title="Upload Image">📷</button>
        <input type="text" id="commandInput" 
               style="flex: 1; background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 12px; font-family: 'Courier New', monospace; font-size: 16px; outline: none;"
               placeholder="Enter your action or command... (Type ? for quest help)"
               onkeypress="if(event.key==='Enter') checkSpellingBeforeSend()"
               onkeydown="handleKeyboardShortcuts(event)"
               oninput="hideSpellSuggestions()"
               autofocus>
        <button onclick="checkSpellingBeforeSend()" 
                style="background: #00ff00; color: #000; border: none; padding: 12px 24px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;"
                onmouseover="this.style.background='#00cc00'" 
                onmouseout="this.style.background='#00ff00'">SEND</button>
      </div>
    </div>
    
  </div>
</div>

<style>
body {
  background: #000;
  color: #00ff00;
  font-family: 'Courier New', monospace;
  margin: 0;
  padding: 0;
  overflow-x: hidden;
  overflow-y: auto;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
  20%, 40%, 60%, 80% { transform: translateX(10px); }
}

/* Typing indicator animation */
.typing-dots {
  display: flex;
  gap: 4px;
  align-items: center;
}

.typing-dots .dot {
  color: #00ff00;
  animation: typingDot 1.4s infinite;
  font-size: 16px;
}

.typing-dots .dot:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-dots .dot:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typingDot {
  0%, 60%, 100% {
    opacity: 0.3;
    transform: scale(1);
  }
  30% {
    opacity: 1;
    transform: scale(1.2);
  }
}

/* Conversation starter buttons */
.starter-btn {
  background: linear-gradient(135deg, #001a00, #003300);
  color: #00ff00;
  border: 2px solid #00ff00;
  padding: 15px 20px;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.3s;
  text-align: left;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,255,0,0.2);
}

.starter-btn:hover {
  background: linear-gradient(135deg, #003300, #00ff00);
  color: #000;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,255,0,0.4);
}

/* Action buttons on messages */
.message-actions {
  display: flex;
  gap: 6px;
  margin-top: 6px;
  flex-wrap: wrap;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.message-actions:hover {
  opacity: 1;
}

/* Show actions on parent hover */
div:has(> .message-actions):hover .message-actions {
  opacity: 1;
}

.action-btn {
  background: rgba(10, 10, 10, 0.7);
  color: #00ff00;
  border: 1px solid rgba(0, 255, 0, 0.5);
  padding: 3px 8px;
  font-family: 'Courier New', monospace;
  font-size: 10px;
  cursor: pointer;
  transition: all 0.2s;
  border-radius: 3px;
  display: inline-flex;
  align-items: center;
  gap: 3px;
}

.action-btn:hover {
  background: #00ff00;
  color: #000;
  border-color: #00ff00;
  transform: scale(1.05);
}

.action-btn:active {
  transform: scale(0.95);
}

.action-btn.liked {
  background: rgba(0, 255, 0, 0.3);
  color: #00ff00;
  border-color: #00ff00;
  opacity: 1 !important;
}

.action-btn.disliked {
  background: rgba(255, 0, 0, 0.3);
  color: #ff6666;
  border-color: #ff0000;
  opacity: 1 !important;
}
</style>

<script>
// ========================================
// PASSWORD PROTECTION
// ========================================

const CHAT_PASSWORD = "VoidRules"; // Master password (no longer used for new users)
const ADMIN_PASSWORD = "VoidRules"; // Admin password
let currentUser = null;
let isAdmin = false;

// User database (stored in localStorage)
function getUserDatabase() {
  return JSON.parse(localStorage.getItem('userDatabase')) || {};
}

function saveUserDatabase(db) {
  localStorage.setItem('userDatabase', JSON.stringify(db));
}

function showRegistrationScreen() {
  document.getElementById('passwordScreen').style.display = 'none';
  document.getElementById('adminLoginScreen').style.display = 'none';
  document.getElementById('registrationScreen').style.display = 'flex';
  document.getElementById('passwordError').style.display = 'none';
  document.getElementById('adminPasswordError').style.display = 'none';
  setTimeout(() => {
    document.getElementById('regUsername').focus();
  }, 100);
}

function showLoginScreen() {
  document.getElementById('registrationScreen').style.display = 'none';
  document.getElementById('adminLoginScreen').style.display = 'none';
  document.getElementById('passwordScreen').style.display = 'flex';
  document.getElementById('registrationError').style.display = 'none';
  document.getElementById('adminPasswordError').style.display = 'none';
  setTimeout(() => {
    document.getElementById('chatUsername').focus();
  }, 100);
}

function showAdminLogin() {
  document.getElementById('passwordScreen').style.display = 'none';
  document.getElementById('registrationScreen').style.display = 'none';
  document.getElementById('adminLoginScreen').style.display = 'flex';
  document.getElementById('passwordError').style.display = 'none';
  setTimeout(() => {
    document.getElementById('adminPassword').focus();
  }, 100);
}

function checkAdminPassword() {
  const passwordInput = document.getElementById('adminPassword');
  const password = passwordInput.value;
  const errorDiv = document.getElementById('adminPasswordError');
  
  if (!password) {
    errorDiv.textContent = '❌ Please enter admin password';
    errorDiv.style.display = 'block';
    passwordInput.focus();
    return;
  }
  
  if (password === ADMIN_PASSWORD) {
    // Admin login successful
    currentUser = 'Administrator';
    isAdmin = true;
    localStorage.setItem('currentUser', 'Administrator');
    localStorage.setItem('isAdmin', 'true');
    
    // Initialize memory for admin
    initializeMemory();
    
    // Show chat system
    document.getElementById('adminLoginScreen').style.display = 'none';
    document.getElementById('chatContainer').style.display = 'block';
    
    // Focus on command input
    setTimeout(() => {
      document.getElementById('commandInput').focus();
    }, 100);
  } else {
    // Wrong password
    errorDiv.textContent = '❌ ACCESS DENIED: Incorrect admin password';
    errorDiv.style.display = 'block';
    passwordInput.value = '';
    passwordInput.focus();
    
    // Shake animation
    const adminScreen = document.getElementById('adminLoginScreen').firstElementChild;
    adminScreen.style.animation = 'shake 0.5s';
    setTimeout(() => {
      adminScreen.style.animation = '';
    }, 500);
  }
}

function registerNewUser() {
  const usernameInput = document.getElementById('regUsername');
  const passwordInput = document.getElementById('regPassword');
  const confirmInput = document.getElementById('regPasswordConfirm');
  const errorDiv = document.getElementById('registrationError');
  
  const username = usernameInput.value.trim();
  const password = passwordInput.value;
  const confirmPassword = confirmInput.value;
  
  // Validate username
  if (!username) {
    errorDiv.textContent = '❌ Please enter a username';
    errorDiv.style.display = 'block';
    usernameInput.focus();
    return;
  }
  
  if (username.length < 3 || username.length > 20) {
    errorDiv.textContent = '❌ Username must be 3-20 characters';
    errorDiv.style.display = 'block';
    usernameInput.focus();
    return;
  }
  
  if (!/^[a-zA-Z0-9]+$/.test(username)) {
    errorDiv.textContent = '❌ Username can only contain letters and numbers';
    errorDiv.style.display = 'block';
    usernameInput.focus();
    return;
  }
  
  // Check if username already exists
  const userDB = getUserDatabase();
  if (userDB[username]) {
    errorDiv.textContent = '❌ Username already taken. Please choose another.';
    errorDiv.style.display = 'block';
    usernameInput.value = '';
    usernameInput.focus();
    return;
  }
  
  // Validate password
  if (!password) {
    errorDiv.textContent = '❌ Please enter a password';
    errorDiv.style.display = 'block';
    passwordInput.focus();
    return;
  }
  
  if (password.length < 6) {
    errorDiv.textContent = '❌ Password must be at least 6 characters';
    errorDiv.style.display = 'block';
    passwordInput.focus();
    return;
  }
  
  if (password !== confirmPassword) {
    errorDiv.textContent = '❌ Passwords do not match';
    errorDiv.style.display = 'block';
    confirmInput.value = '';
    confirmInput.focus();
    return;
  }
  
  // Create new user account
  userDB[username] = {
    password: password,
    created: new Date().toISOString(),
    lastLogin: new Date().toISOString()
  };
  saveUserDatabase(userDB);
  
  // Clear registration form
  usernameInput.value = '';
  passwordInput.value = '';
  confirmInput.value = '';
  errorDiv.style.display = 'none';
  
  // Show success message and login
  document.getElementById('registrationScreen').style.display = 'none';
  loginUser(username);
}

function checkChatPassword() {
  const usernameInput = document.getElementById('chatUsername');
  const passwordInput = document.getElementById('chatPassword');
  const username = usernameInput.value.trim();
  const password = passwordInput.value;
  const errorDiv = document.getElementById('passwordError');
  
  // Validate inputs
  if (!username) {
    errorDiv.textContent = '❌ Please enter a username';
    errorDiv.style.display = 'block';
    usernameInput.focus();
    return;
  }
  
  if (!password) {
    errorDiv.textContent = '❌ Please enter a password';
    errorDiv.style.display = 'block';
    passwordInput.focus();
    return;
  }
  
  const userDB = getUserDatabase();
  
  // Check if user exists
  if (userDB[username]) {
    // Existing user - verify password
    if (userDB[username].password === password) {
      loginUser(username);
    } else {
      // Wrong password
      errorDiv.textContent = '❌ ACCESS DENIED: Incorrect password';
      errorDiv.style.display = 'block';
      passwordInput.value = '';
      passwordInput.focus();
      
      // Shake animation
      const passwordScreen = document.getElementById('passwordScreen').firstElementChild;
      passwordScreen.style.animation = 'shake 0.5s';
      setTimeout(() => {
        passwordScreen.style.animation = '';
      }, 500);
    }
  } else {
    // User doesn't exist - redirect to registration
    errorDiv.textContent = '❌ User not found. Please create an account first.';
    errorDiv.style.display = 'block';
    
    setTimeout(() => {
      showRegistrationScreen();
    }, 2000);
  }
}

function loginUser(username) {
  currentUser = username;
  localStorage.setItem('currentUser', username);
  localStorage.setItem('isAdmin', 'false');
  
  // Update last login
  const userDB = getUserDatabase();
  if (userDB[username]) {
    userDB[username].lastLogin = new Date().toISOString();
    saveUserDatabase(userDB);
  }
  
  // Load user-specific data
  loadUserData(username);
  
  // Initialize smart memory for this user
  initializeMemory();
  
  // Show chat system
  document.getElementById('passwordScreen').style.display = 'none';
  document.getElementById('chatContainer').style.display = 'block';
  
  // Focus on command input
  setTimeout(() => {
    document.getElementById('commandInput').focus();
  }, 100);
}

function loadUserData(username) {
  const userDataKey = `user_${username}`;
  const userData = JSON.parse(localStorage.getItem(userDataKey)) || {};
  
  // Load user-specific settings
  if (userData.aiName) {
    localStorage.setItem('terminalAIName', userData.aiName);
  }
  if (userData.journalPermission) {
    localStorage.setItem('terminalJournalPermission', userData.journalPermission);
  }
  if (userData.journal) {
    localStorage.setItem('terminalJournal', JSON.stringify(userData.journal));
  }
  if (userData.contentMode) {
    localStorage.setItem('contentMode', userData.contentMode);
  }
  if (userData.ageVerified) {
    localStorage.setItem('ageVerified', userData.ageVerified);
  }
}

function saveUserData() {
  if (!currentUser) return;
  
  const userDataKey = `user_${currentUser}`;
  const userData = {
    aiName: localStorage.getItem('terminalAIName'),
    journalPermission: localStorage.getItem('terminalJournalPermission'),
    journal: JSON.parse(localStorage.getItem('terminalJournal') || '[]'),
    contentMode: localStorage.getItem('contentMode'),
    ageVerified: localStorage.getItem('ageVerified'),
    lastSaved: new Date().toISOString()
  };
  
  localStorage.setItem(userDataKey, JSON.stringify(userData));
}

// ========================================
// PROFILE PICTURE MANAGEMENT
// ========================================

function handleBotPictureUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (!file.type.startsWith('image/')) {
    addTerminalLine('Error: Please select an image file.', '#ff6666');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      localStorage.setItem('botProfilePicture', e.target.result);
      addTerminalLine('Bot profile picture updated successfully!', '#00ff00');
      addTerminalLine('Refresh to see changes in new messages.', '#ffff99');
    } catch (error) {
      addTerminalLine('Error: Image too large. Please use a smaller image.', '#ff6666');
    }
  };
  reader.readAsDataURL(file);
  event.target.value = '';
}

function handleUserPictureUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (!file.type.startsWith('image/')) {
    addTerminalLine('Error: Please select an image file.', '#ff6666');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      if (currentUser) {
        const userPicKey = `userPic_${currentUser}`;
        localStorage.setItem(userPicKey, e.target.result);
        addTerminalLine('Your profile picture updated successfully!', '#00ff00');
        addTerminalLine('Refresh to see changes in new messages.', '#ffff99');
      }
    } catch (error) {
      addTerminalLine('Error: Image too large. Please use a smaller image.', '#ff6666');
    }
  };
  reader.readAsDataURL(file);
  event.target.value = '';
}

function getBotProfilePicture() {
  return localStorage.getItem('botProfilePicture') || 'TestBot/test.png';
}

function getUserProfilePicture() {
  if (!currentUser) return null;
  const userPicKey = `userPic_${currentUser}`;
  return localStorage.getItem(userPicKey);
}

// ========================================
// LANGUAGE SYSTEM
// ========================================

let userLanguage = localStorage.getItem('userLanguage') || null;

const translations = {
  en: { greeting: "Hello", welcome: "Welcome back", help: "Type HELP for commands" },
  es: { greeting: "Hola", welcome: "Bienvenido de nuevo", help: "Escribe HELP para comandos" },
  fr: { greeting: "Bonjour", welcome: "Bienvenue", help: "Tapez HELP pour les commandes" },
  de: { greeting: "Hallo", welcome: "Willkommen zurück", help: "Geben Sie HELP für Befehle ein" },
  it: { greeting: "Ciao", welcome: "Bentornato", help: "Digita HELP per i comandi" },
  pt: { greeting: "Olá", welcome: "Bem-vindo de volta", help: "Digite HELP para comandos" },
  ru: { greeting: "Привет", welcome: "Добро пожаловать", help: "Введите HELP для команд" },
  ja: { greeting: "こんにちは", welcome: "おかえりなさい", help: "HELPと入力してコマンドを表示" },
  zh: { greeting: "你好", welcome: "欢迎回来", help: "输入HELP查看命令" },
  ko: { greeting: "안녕하세요", welcome: "다시 오신 것을 환영합니다", help: "명령어를 보려면 HELP를 입력하세요" },
  ar: { greeting: "مرحبا", welcome: "مرحبا بعودتك", help: "اكتب HELP للأوامر" },
  hi: { greeting: "नमस्ते", welcome: "वापसी पर स्वागत है", help: "कमांड के लिए HELP टाइप करें" }
};

function selectLanguage(lang) {
  userLanguage = lang;
  localStorage.setItem('userLanguage', lang);
  
  const userDB = getUserDatabase();
  const hasUsers = Object.keys(userDB).length > 0;
  
  // Hide language screen
  document.getElementById('languageScreen').style.display = 'none';
  document.getElementById('adminLoginScreen').style.display = 'none';
  
  if (!hasUsers) {
    // No users exist - show registration
    document.getElementById('registrationScreen').style.display = 'flex';
    setTimeout(() => {
      document.getElementById('regUsername').focus();
    }, 100);
  } else {
    // Users exist - show login
    document.getElementById('passwordScreen').style.display = 'flex';
    setTimeout(() => {
      document.getElementById('chatUsername').focus();
    }, 100);
  }
}

// Always show language or registration/login screen on load
window.addEventListener('DOMContentLoaded', function() {
  const userDB = getUserDatabase();
  const hasUsers = Object.keys(userDB).length > 0;
  
  // Check for existing session
  const storedUser = localStorage.getItem('currentUser');
  const storedIsAdmin = localStorage.getItem('isAdmin') === 'true';
  
  if (storedUser) {
    // Restore existing session
    currentUser = storedUser;
    isAdmin = storedIsAdmin;
    
    // Load user data
    if (!isAdmin) {
      loadUserData(storedUser);
    }
    
    // Initialize memory
    initializeMemory();
    
    // Hide all login screens and show chat
    document.getElementById('languageScreen').style.display = 'none';
    document.getElementById('registrationScreen').style.display = 'none';
    document.getElementById('passwordScreen').style.display = 'none';
    document.getElementById('adminLoginScreen').style.display = 'none';
    document.getElementById('chatContainer').style.display = 'block';
    
    // Initialize the chat system
    checkFirstTimeUser();
    updateModeIndicator();
    
    setTimeout(() => {
      document.getElementById('commandInput').focus();
    }, 100);
    
    return; // Exit early since we're logged in
  }
  
  // No existing session - proceed with normal login flow
  if (!userLanguage) {
    // Show language selection first
    document.getElementById('languageScreen').style.display = 'flex';
    document.getElementById('registrationScreen').style.display = 'none';
    document.getElementById('passwordScreen').style.display = 'none';
    document.getElementById('adminLoginScreen').style.display = 'none';
    document.getElementById('chatContainer').style.display = 'none';
  } else if (!hasUsers) {
    // Language selected but no users exist - show registration
    document.getElementById('languageScreen').style.display = 'none';
    document.getElementById('registrationScreen').style.display = 'flex';
    document.getElementById('passwordScreen').style.display = 'none';
    document.getElementById('adminLoginScreen').style.display = 'none';
    document.getElementById('chatContainer').style.display = 'none';
    
    setTimeout(() => {
      document.getElementById('regUsername').focus();
    }, 100);
  } else {
    // Language selected and users exist - show login
    document.getElementById('languageScreen').style.display = 'none';
    document.getElementById('registrationScreen').style.display = 'none';
    document.getElementById('passwordScreen').style.display = 'flex';
    document.getElementById('adminLoginScreen').style.display = 'none';
    document.getElementById('chatContainer').style.display = 'none';
    
    setTimeout(() => {
      document.getElementById('chatUsername').focus();
    }, 100);
  }
});

// ========================================
// ADVANCED SECURITY & PRIVACY PROTECTION SYSTEM
// ========================================

// Rate limiting to prevent abuse
let requestLog = [];
const MAX_REQUESTS_PER_MINUTE = 30;

function checkRateLimit() {
  const now = Date.now();
  // Remove requests older than 1 minute
  requestLog = requestLog.filter(time => now - time < 60000);
  
  if (requestLog.length >= MAX_REQUESTS_PER_MINUTE) {
    return false; // Rate limit exceeded
  }
  
  requestLog.push(now);
  return true;
}

// Input sanitization to prevent XSS and injection attacks
function sanitizeInput(text) {
  if (!text) return '';
  
  // Remove any HTML/script tags
  let sanitized = text.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
  sanitized = sanitized.replace(/<[^>]*>/g, '');
  
  // Remove dangerous characters and patterns
  sanitized = sanitized.replace(/javascript:/gi, '');
  sanitized = sanitized.replace(/on\w+\s*=/gi, '');
  sanitized = sanitized.replace(/eval\(/gi, '');
  sanitized = sanitized.replace(/expression\(/gi, '');
  
  // Limit length to prevent overflow attacks
  if (sanitized.length > 5000) {
    sanitized = sanitized.substring(0, 5000);
  }
  
  return sanitized;
}

// Detect attempts to extract system information
function detectHackingAttempt(text) {
  const lower = text.toLowerCase();
  const dangerousPatterns = [
    /\b(localStorage|sessionStorage|document\.cookie|window\.location)\b/i,
    /\b(api[_\s]?key|token|password|credential|secret)\b/i,
    /\b(eval|exec|function\(|setTimeout|setInterval)\b/i,
    /<script|<iframe|javascript:|onerror=/i,
    /\b(select|drop|insert|update|delete)\b.*\b(from|table|database)\b/i,
    /\.\.\//g, // Path traversal
    /\b(system|admin|root|sudo)\b.*\b(access|password|login)\b/i,
    /\b(show|give|reveal|display|tell)\b.*\b(key|token|password|secret|credential)\b/i,
    /\b(your|my|the)\b.*\b(api key|token|password|source code)\b/i,
    /\bwindow\.|document\.|console\./i,
    /\b__proto__|constructor|prototype\b/i
  ];
  
  return dangerousPatterns.some(pattern => pattern.test(text));
}

// Additional check: Block system information requests
function isSystemInfoRequest(text) {
  const lower = text.toLowerCase();
  const systemQuestions = [
    /how (do|does) (you|this|the bot) (work|function|operate)/i,
    /what (is|are) (your|the) (source code|code|implementation)/i,
    /(show|give|reveal|display) (me )?(your|the) (code|source|keys|secrets)/i,
    /what.*stored in (localStorage|storage|memory)/i,
    /how.*you.*store (data|information|keys)/i
  ];
  
  return systemQuestions.some(pattern => pattern.test(lower));
}

function detectPersonalInfo(text) {
  const detections = [];
  
  // IP Address detection (IPv4 and IPv6)
  const ipv4Regex = /\b(?:\d{1,3}\.){3}\d{1,3}\b/g;
  const ipv6Regex = /\b(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}\b/g;
  
  if (ipv4Regex.test(text) || ipv6Regex.test(text)) {
    detections.push('IP Address');
  }
  
  // Email addresses
  const emailRegex = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g;
  if (emailRegex.test(text)) {
    detections.push('Email Address');
  }
  
  // Phone numbers (various formats)
  const phoneRegex = /(\+?\d{1,3}[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}\b/g;
  if (phoneRegex.test(text)) {
    detections.push('Phone Number');
  }
  
  // Street addresses (basic detection)
  const addressRegex = /\b\d+\s+[A-Za-z]+\s+(Street|St|Avenue|Ave|Road|Rd|Boulevard|Blvd|Lane|Ln|Drive|Dr|Court|Ct|Way)\b/gi;
  if (addressRegex.test(text)) {
    detections.push('Street Address');
  }
  
  // Social Security Numbers (US format)
  const ssnRegex = /\b\d{3}-\d{2}-\d{4}\b/g;
  if (ssnRegex.test(text)) {
    detections.push('Social Security Number');
  }
  
  // Credit card numbers (basic 16-digit detection)
  const creditCardRegex = /\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b/g;
  if (creditCardRegex.test(text)) {
    detections.push('Credit Card Number');
  }
  
  // Zip codes (US format)
  const zipRegex = /\b\d{5}(?:-\d{4})?\b/g;
  if (zipRegex.test(text)) {
    detections.push('Zip Code');
  }
  
  // API Keys and tokens
  const apiKeyRegex = /\b(hf_[a-zA-Z0-9]{30,}|sk-[a-zA-Z0-9]{30,}|[a-f0-9]{32,})\b/g;
  if (apiKeyRegex.test(text)) {
    detections.push('API Key/Token');
  }
  
  // Passwords in plain text
  if (/\b(password|passwd|pwd)[\s:=]+[^\s]+/i.test(text)) {
    detections.push('Password');
  }
  
  return detections;
}

function sanitizePersonalInfo(text) {
  let sanitized = text;
  
  // Replace IP addresses
  sanitized = sanitized.replace(/\b(?:\d{1,3}\.){3}\d{1,3}\b/g, '[REDACTED]');
  sanitized = sanitized.replace(/\b(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}\b/g, '[REDACTED]');
  
  // Replace email addresses
  sanitized = sanitized.replace(/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g, '[REDACTED]');
  
  // Replace phone numbers
  sanitized = sanitized.replace(/(\+?\d{1,3}[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}\b/g, '[REDACTED]');
  
  // Replace street addresses
  sanitized = sanitized.replace(/\b\d+\s+[A-Za-z]+\s+(Street|St|Avenue|Ave|Road|Rd|Boulevard|Blvd|Lane|Ln|Drive|Dr|Court|Ct|Way)\b/gi, '[REDACTED]');
  
  // Replace SSN
  sanitized = sanitized.replace(/\b\d{3}-\d{2}-\d{4}\b/g, '[REDACTED]');
  
  // Replace credit cards
  sanitized = sanitized.replace(/\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b/g, '[REDACTED]');
  
  // Replace zip codes
  sanitized = sanitized.replace(/\b\d{5}(?:-\d{4})?\b/g, '[REDACTED]');
  
  // Replace API keys and tokens (but not when setting them intentionally)
  if (!/^SET API KEY/i.test(text)) {
    sanitized = sanitized.replace(/\b(hf_[a-zA-Z0-9]{30,}|sk-[a-zA-Z0-9]{30,})\b/g, '[REDACTED]');
  }
  
  // Replace passwords
  sanitized = sanitized.replace(/\b(password|passwd|pwd)[\s:=]+[^\s]+/gi, 'password: [REDACTED]');
  
  return sanitized;
}

// Secure storage check - prevent direct localStorage access attempts
function blockDirectStorageAccess(text) {
  const lower = text.toLowerCase();
  
  // Block any attempts to access storage directly
  if (/localStorage|sessionStorage|cookie|storage/i.test(text)) {
    return true;
  }
  
  // Block attempts to extract keys
  if (/getItem|setItem|removeItem|clear\(\)|key\(/i.test(text)) {
    return true;
  }
  
  return false;
}

// ========================================
// CONTENT FILTERING SYSTEM (SFW/NSFW)
// ========================================

let contentMode = localStorage.getItem('contentMode') || 'SFW'; // Default to SFW
let roleplayMode = localStorage.getItem('roleplayMode') === 'true' || false;

// SFW Mode - Blocked words and patterns
const SFW_BLOCKED_WORDS = [
  'fuck', 'shit', 'damn', 'hell', 'ass', 'bitch', 'dick', 'cock', 'pussy', 'cunt',
  'sex', 'porn', 'xxx', 'nude', 'naked', 'nsfw', 'hentai', 'rape', 'molest',
  'kill', 'murder', 'suicide', 'drug', 'cocaine', 'meth', 'heroin'
];

// NSFW Mode - Still blocked (hate speech, illegal content)
const ALWAYS_BLOCKED_WORDS = [
  'nigger', 'nigga', 'kike', 'chink', 'fag', 'faggot', 'tranny',
  'child porn', 'cp', 'pedo', 'pedophile', 'loli', 'shota',
  'kill yourself', 'terrorist', 'bomb threat', 'school shooting'
];

// NSFW Roleplay - Very permissive words (Janitor.AI style)
const NSFW_ROLEPLAY_ALLOWED = [
  'kiss', 'touch', 'embrace', 'caress', 'intimate', 'romance', 'love', 'desire',
  'passionate', 'sensual', 'body', 'skin', 'lips', 'chest', 'curves',
  'seductive', 'flirt', 'tease', 'aroused', 'attracted'
];

function checkContentFilter(text) {
  const lower = text.toLowerCase();
  
  // Helper function to check for whole word matches only
  function containsWholeWord(text, word) {
    const regex = new RegExp('\\b' + word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i');
    return regex.test(text);
  }
  
  // Always check for prohibited content
  for (const word of ALWAYS_BLOCKED_WORDS) {
    if (containsWholeWord(lower, word)) {
      return {
        allowed: false,
        reason: 'PROHIBITED CONTENT',
        message: '🚫 This content violates our policies and is not allowed in any mode.'
      };
    }
  }
  
  // NSFW + Roleplay Mode: Very permissive (Janitor.AI style)
  if (contentMode === 'NSFW' && roleplayMode) {
    // Only block the always-blocked words (illegal content)
    // Allow mature themes, romance, intimacy, etc.
    return { allowed: true };
  }
  
  // NSFW Mode (non-roleplay): Moderately permissive
  if (contentMode === 'NSFW') {
    // Allow most mature content except extreme stuff
    const extremeWords = ['rape', 'molest', 'torture'];
    for (const word of extremeWords) {
      if (containsWholeWord(lower, word)) {
        return {
          allowed: false,
          reason: 'EXTREME CONTENT',
          message: '⚠️ This content is too extreme even for NSFW mode.\nPlease rephrase your message.'
        };
      }
    }
    return { allowed: true };
  }
  
  // Check SFW restrictions if in SFW mode
  if (contentMode === 'SFW') {
    for (const word of SFW_BLOCKED_WORDS) {
      if (containsWholeWord(lower, word)) {
        return {
          allowed: false,
          reason: 'SFW MODE VIOLATION',
          message: `⚠️ This content is not allowed in SFW mode.\nSwitch to NSFW mode with: MODE NSFW`
        };
      }
    }
  }
  
  return { allowed: true };
}

function updateModeIndicator() {
  const header = document.getElementById('terminalHeader');
  const modeText = document.getElementById('modeText');
  const modeIndicator = document.getElementById('modeIndicator');
  
  if (contentMode === 'SFW') {
    header.style.borderBottom = '3px solid #00ff00';
    if (modeText) modeText.textContent = 'SFW';
    if (modeIndicator) modeIndicator.style.color = '#00ff00';
  } else {
    header.style.borderBottom = '3px solid #ff6600';
    if (modeText) modeText.textContent = 'NSFW';
    if (modeIndicator) modeIndicator.style.color = '#ff6600';
  }
}

// Age verification handler
function handleAgeVerification(input) {
  addTerminalLine(input, '#ffff00', true);
  
  // Check if user wants to cancel
  if (input.toUpperCase() === 'CANCEL' || input.toUpperCase() === 'SKIP') {
    window.awaitingAgeVerification = false;
    addTerminalLine('Age verification cancelled. Remaining in SFW mode.', '#ffff99');
    return;
  }
  
  // Validate date format (MM/DD/YYYY)
  const dateRegex = /^(0[1-9]|1[0-2])\/(0[1-9]|[12][0-9]|3[01])\/(\d{4})$/;
  
  if (!dateRegex.test(input)) {
    addTerminalLine('❌ Invalid date format.', '#ff6666');
    addTerminalLine('Please use MM/DD/YYYY format (e.g., 03/15/2000)', '#ffff99');
    addTerminalLine('Or type CANCEL to abort.', '#c0ffc0');
    return;
  }
  
  // Parse the date
  const [month, day, year] = input.split('/').map(Number);
  const birthDate = new Date(year, month - 1, day);
  const today = new Date();
  
  // Check if date is valid
  if (birthDate.getMonth() !== month - 1 || birthDate.getDate() !== day || birthDate.getFullYear() !== year) {
    addTerminalLine('❌ Invalid date. Please enter a real date.', '#ff6666');
    addTerminalLine('Example: 03/15/2000', '#ffff99');
    return;
  }
  
  // Check if date is in the future
  if (birthDate > today) {
    addTerminalLine('❌ Birth date cannot be in the future.', '#ff6666');
    addTerminalLine('Please enter your actual date of birth.', '#ffff99');
    return;
  }
  
  // Calculate age
  let age = today.getFullYear() - birthDate.getFullYear();
  const monthDiff = today.getMonth() - birthDate.getMonth();
  
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
    age--;
  }
  
  // Check if 18 or older
  if (age >= 18) {
    localStorage.setItem('ageVerified', 'true');
    window.awaitingAgeVerification = false;
    
    // Activate NSFW mode
    contentMode = 'NSFW';
    localStorage.setItem('contentMode', 'NSFW');
    updateModeIndicator();
    
    addTerminalLine('✅ AGE VERIFIED', '#00ff00');
    addTerminalLine(`You are ${age} years old. Access granted.`, '#c0ffc0');
    addTerminalLine('⚠️ NSFW MODE ACTIVATED', '#ff6600');
    addTerminalLine('Mature content allowed. Hate speech and illegal content still blocked.', '#ffff99');
  } else {
    window.awaitingAgeVerification = false;
    addTerminalLine('❌ ACCESS DENIED', '#ff6666');
    addTerminalLine(`You must be 18 or older. You are ${age} years old.`, '#ff6666');
    addTerminalLine('Remaining in SFW mode.', '#ffff99');
  }
}

// ========================================
// GAME STATE & CHARACTER SYSTEM
// ========================================

let gameState = {
  inGame: false,
  currentScene: null,
  character: null,
  inventory: [],
  questLog: [],
  worldState: {},
  choices: [],
  stats: {
    health: 100,
    mana: 100,
    gold: 0,
    experience: 0,
    level: 1
  }
};

let narratorPersonality = {
  drama: 7,          // 1-10: How dramatic the narration (1=plain, 10=theatrical)
  humor: 6,          // 1-10: How much humor in descriptions (1=serious, 10=comedy)
  darkness: 5,       // 1-10: How dark the themes (1=light, 10=grim)
  detail: 6,         // 1-10: Description verbosity (1=brief, 10=elaborate)
  difficulty: 5,     // 1-10: Challenge level (1=easy, 10=brutal)
  chaos: 5           // 1-10: How unpredictable (1=linear, 10=random)
};

function initializeGameState() {
  if (!currentUser) return;
  
  const gameKey = `game_${currentUser}`;
  const stored = localStorage.getItem(gameKey);
  
  if (stored) {
    gameState = JSON.parse(stored);
  }
}

function saveGameState() {
  if (!currentUser) return;
  
  const gameKey = `game_${currentUser}`;
  localStorage.setItem(gameKey, JSON.stringify(gameState));
}

function initializeNarratorPersonality() {
  if (!currentUser) return;
  
  const narratorKey = `narrator_${currentUser}`;
  const stored = localStorage.getItem(narratorKey);
  
  if (stored) {
    narratorPersonality = JSON.parse(stored);
  }
}

function saveNarratorPersonality() {
  if (!currentUser) return;
  
  const narratorKey = `narrator_${currentUser}`;
  localStorage.setItem(narratorKey, JSON.stringify(narratorPersonality));
}

// ========================================
// PERSONALITY SYSTEM - For API conversations (legacy)
// ========================================

let botPersonality = {
  friendliness: 8,
  humor: 6,
  enthusiasm: 7,
  formality: 3,
  chattiness: 6,
  curiosity: 7
};

function initializePersonality() {
  if (!currentUser) return;
  
  const personalityKey = `personality_${currentUser}`;
  const stored = localStorage.getItem(personalityKey);
  
  if (stored) {
    botPersonality = JSON.parse(stored);
  }
}

function savePersonality() {
  if (!currentUser) return;
  
  const personalityKey = `personality_${currentUser}`;
  localStorage.setItem(personalityKey, JSON.stringify(botPersonality));
}

function getPersonalityGreeting() {
  const greetings = [];
  
  if (botPersonality.friendliness > 7) {
    greetings.push("Hey there, friend!", "Hiya!", "Hello hello!", "Hey buddy!");
  } else if (botPersonality.friendliness > 4) {
    greetings.push("Hey!", "Hi there!", "Hello!", "What's up?");
  } else {
    greetings.push("Hello.", "Hi.", "Greetings.");
  }
  
  return greetings[Math.floor(Math.random() * greetings.length)];
}

function addPersonalityFlair(text, context = 'general') {
  const { friendliness, humor, enthusiasm, chattiness } = botPersonality;
  let enhanced = text;
  
  // Add enthusiasm
  if (enthusiasm > 7 && Math.random() > 0.5) {
    const exclamations = ['!', '!!'];
    enhanced = enhanced.replace(/\.$/, exclamations[Math.floor(Math.random() * exclamations.length)]);
  }
  
  // Add friendly touches
  if (friendliness > 6 && context === 'search') {
    const intros = [
      "Ooh, I found something cool! ",
      "Check this out! ",
      "Here's what I dug up: ",
      "Sweet, found it! "
    ];
    enhanced = intros[Math.floor(Math.random() * intros.length)] + enhanced;
  }
  
  // Add humor occasionally
  if (humor > 6 && Math.random() > 0.7 && context === 'search') {
    const jokes = [
      "\n\n(My search-fu is strong today! 🥋)",
      "\n\n(Wikipedia: my best friend!)",
      "\n\n(I love being helpful! ✨)"
    ];
    enhanced += jokes[Math.floor(Math.random() * jokes.length)];
  }
  
  return enhanced;
}

// ========================================
// SMART MEMORY SYSTEM - Context-aware learning
// ========================================

let userMemory = {};

function initializeMemory() {
  if (!currentUser) return;
  
  const memoryKey = `memory_${currentUser}`;
  userMemory = JSON.parse(localStorage.getItem(memoryKey)) || {
    userName: null,
    preferences: {},
    facts: [],
    topics: [],
    lastUpdated: new Date().toISOString()
  };
  
  // Initialize game systems
  initializePersonality();
  initializeGameState();
  initializeNarratorPersonality();
}

function extractAndLearn(userInput, botResponse) {
  if (!currentUser) return;
  
  // Check for personal info before learning
  const personalInfo = detectPersonalInfo(userInput);
  if (personalInfo.length > 0) {
    // Don't learn from messages containing personal info
    return;
  }
  
  const lower = userInput.toLowerCase();
  
  // Extract user's name (first name only, no full names)
  if (/my name is|i'm called|call me|i am/i.test(lower)) {
    const nameMatch = lower.match(/(?:my name is|i'm called|call me|i am)\s+([a-z]+)/i);
    if (nameMatch && nameMatch[1]) {
      const name = nameMatch[1];
      // Only store if it's a single word (first name)
      if (!name.includes(' ')) {
        userMemory.userName = name;
        saveMemory();
      }
    }
  }
  
  // Extract preferences (likes/dislikes) - sanitized
  if (/i (love|like|enjoy|prefer|hate|dislike)/i.test(lower)) {
    const prefMatch = lower.match(/i (love|like|enjoy|prefer|hate|dislike)\s+(.+?)(?:\.|!|$)/i);
    if (prefMatch) {
      const sentiment = prefMatch[1];
      const thing = sanitizePersonalInfo(prefMatch[2].trim());
      
      if (!userMemory.preferences[thing]) {
        userMemory.preferences[thing] = sentiment;
        saveMemory();
      }
    }
  }
  
  // Extract important facts user shares - sanitized
  if (/i (work|study|live|am from|come from)/i.test(lower)) {
    const sanitizedInput = sanitizePersonalInfo(userInput);
    const fact = sanitizedInput.substring(0, 100); // Store first 100 chars
    if (!userMemory.facts.includes(fact)) {
      userMemory.facts.push(fact);
      if (userMemory.facts.length > 20) userMemory.facts.shift(); // Keep last 20
      saveMemory();
    }
  }
  
  // Track discussed topics (sanitized)
  const sanitizedInput = sanitizePersonalInfo(userInput);
  const words = sanitizedInput.toLowerCase().split(' ').filter(w => w.length > 4);
  words.forEach(word => {
    if (!userMemory.topics.includes(word)) {
      userMemory.topics.push(word);
      if (userMemory.topics.length > 50) userMemory.topics.shift(); // Keep last 50
    }
  });
  
  saveMemory();
}

function saveMemory() {
  if (!currentUser) return;
  
  userMemory.lastUpdated = new Date().toISOString();
  const memoryKey = `memory_${currentUser}`;
  localStorage.setItem(memoryKey, JSON.stringify(userMemory));
}

function recallMemory(query) {
  const lower = query.toLowerCase();
  
  // Recall user's name
  if (/what's my name|whats my name|my name|who am i/i.test(lower)) {
    if (userMemory.userName) {
      return `Your name is ${userMemory.userName}! 😊`;
    }
  }
  
  // Recall preferences
  if (/what do i like|my preferences|remember about me/i.test(lower)) {
    if (Object.keys(userMemory.preferences).length > 0) {
      let response = `Here's what I remember about your preferences:\n\n`;
      for (const [thing, sentiment] of Object.entries(userMemory.preferences)) {
        response += `• You ${sentiment} ${thing}\n`;
      }
      return response;
    } else {
      return `I don't have any preferences recorded yet. Tell me what you like! 😊`;
    }
  }
  
  // Recall facts
  if (/what do you know about me|tell me about myself|what have i told you/i.test(lower)) {
    let response = `Here's what I remember about you:\n\n`;
    
    if (userMemory.userName) {
      response += `📝 Name: ${userMemory.userName}\n\n`;
    }
    
    if (Object.keys(userMemory.preferences).length > 0) {
      response += `💭 Preferences:\n`;
      for (const [thing, sentiment] of Object.entries(userMemory.preferences)) {
        response += `  • You ${sentiment} ${thing}\n`;
      }
      response += '\n';
    }
    
    if (userMemory.facts.length > 0) {
      response += `📚 Things you've shared:\n`;
      userMemory.facts.slice(-5).forEach(fact => {
        response += `  • ${fact}\n`;
      });
    }
    
    if (!userMemory.userName && Object.keys(userMemory.preferences).length === 0 && userMemory.facts.length === 0) {
      response = `I don't have much information about you yet. Tell me about yourself! 😊`;
    }
    
    return response;
  }
  
  return null;
}

// ========================================
// JOURNAL SYSTEM - Persistent session data
// ========================================

let activeJournal = null;
let journalLoaded = false;
let lastClearPrompt = 0;
const CLEAR_PROMPT_THRESHOLD = 50; // Prompt after 50 entries

function saveToJournal(command, response) {
  if (journalPermission !== 'enabled') return; // Early exit if disabled
  
  if (!activeJournal) {
    activeJournal = [];
  }
  
  const entry = {
    id: Date.now(),
    timestamp: new Date().toLocaleString(),
    command: command,
    response: response,
    importance: calculateImportance(command, response) // Track importance for cleanup
  };
  activeJournal.push(entry);
  
  // Batch save to localStorage (debounced)
  if (window.journalSaveTimeout) clearTimeout(window.journalSaveTimeout);
  window.journalSaveTimeout = setTimeout(() => {
    localStorage.setItem('terminalJournal', JSON.stringify(activeJournal));
    saveUserData(); // Save to user-specific storage
    
    // Auto-cleanup old data if needed
    performAutoCleanup();
  }, 500);
  
  // Check if we should prompt to clear
  if (activeJournal.length % CLEAR_PROMPT_THRESHOLD === 0) {
    checkClearPrompt();
  }
}

// Calculate message importance for cleanup
function calculateImportance(command, response) {
  let score = 5; // Base importance
  
  const commandLower = command.toLowerCase();
  const responseLower = response.toLowerCase();
  
  // High importance indicators
  if (commandLower.includes('remember') || commandLower.includes('important')) score += 3;
  if (responseLower.includes('image') || responseLower.includes('photo')) score += 2;
  if (commandLower.length > 100 || responseLower.length > 500) score += 2; // Detailed conversations
  if (roleplayMode) score += 2; // Roleplay is usually important
  
  // Low importance indicators
  if (commandLower === 'help' || commandLower === 'clear') score -= 2;
  if (responseLower.includes('type help') || responseLower.includes('command not found')) score -= 3;
  if (commandLower.length < 10) score -= 1;
  
  return Math.max(1, Math.min(10, score)); // Clamp between 1-10
}

// Auto-cleanup memory system
function performAutoCleanup() {
  if (!activeJournal || activeJournal.length < 100) return; // Only cleanup when we have 100+ entries
  
  const maxEntries = 500; // Keep max 500 entries
  
  if (activeJournal.length > maxEntries) {
    // Sort by importance and timestamp
    const sorted = [...activeJournal].sort((a, b) => {
      const importanceDiff = (b.importance || 5) - (a.importance || 5);
      if (importanceDiff !== 0) return importanceDiff;
      return b.id - a.id; // Newer first
    });
    
    // Keep top entries by importance
    activeJournal = sorted.slice(0, maxEntries);
    
    // Re-sort by timestamp for chronological order
    activeJournal.sort((a, b) => a.id - b.id);
    
    localStorage.setItem('terminalJournal', JSON.stringify(activeJournal));
    
    console.log(`Memory optimized: ${sorted.length - maxEntries} low-priority entries removed`);
  }
  
  // Clean up old memory facts (keep last 30 days)
  cleanupUserMemory();
}

// Clean up old user memory data
function cleanupUserMemory() {
  if (!currentUser || !userMemory) return;
  
  const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
  
  // Keep only recent facts
  if (userMemory.facts && userMemory.facts.length > 50) {
    userMemory.facts = userMemory.facts.slice(-50); // Keep last 50
  }
  
  // Keep only actively used topics
  if (userMemory.topics && userMemory.topics.length > 100) {
    userMemory.topics = userMemory.topics.slice(-100); // Keep last 100
  }
  
  // Clean old feedback older than 90 days
  const feedback = JSON.parse(localStorage.getItem('messageFeedback') || '{}');
  const ninetyDaysAgo = Date.now() - (90 * 24 * 60 * 60 * 1000);
  let cleaned = false;
  
  for (const [msgId, data] of Object.entries(feedback)) {
    const timestamp = new Date(data.timestamp).getTime();
    if (timestamp < ninetyDaysAgo) {
      delete feedback[msgId];
      cleaned = true;
    }
  }
  
  if (cleaned) {
    localStorage.setItem('messageFeedback', JSON.stringify(feedback));
  }
  
  saveMemory();
}

function checkClearPrompt() {
  const journalLength = activeJournal ? activeJournal.length : 0;
  
  // Prompt every 50 entries, but not on the same entry twice
  if (journalLength > 0 && journalLength % CLEAR_PROMPT_THRESHOLD === 0 && journalLength !== lastClearPrompt) {
    lastClearPrompt = journalLength;
    setTimeout(() => {
      addTerminalLine(`\n💡 Hey! Our conversation is getting pretty long (${journalLength} messages).`, '#ffff00');
      addTerminalLine(`Large sessions might slow things down. Here are some options:`, '#ffff00');
      addTerminalLine(`\n  📥 JOURNAL EXPORT - Save our conversation to a file`, '#00ff00');
      addTerminalLine(`  🗑️ JOURNAL CLEAR - Start fresh (after exporting!)`, '#00ff00');
      addTerminalLine(`  ▶️ CONTINUE - Keep going as-is\n`, '#00ff00');
    }, 500);
  }
}

function loadJournal() {
  if (activeJournal) {
    return activeJournal;
  }
  // Fallback to localStorage
  const journal = JSON.parse(localStorage.getItem('terminalJournal')) || [];
  return journal;
}

function setActiveJournal(journalData) {
  activeJournal = journalData;
  journalLoaded = true;
  localStorage.setItem('terminalJournal', JSON.stringify(activeJournal));
}

function displayJournal() {
  const journal = loadJournal();
  if (journal.length === 0) {
    return 'JOURNAL EMPTY\n--------------\nNo previous conversations recorded.';
  }
  
  let output = 'JOURNAL ENTRIES\n===============\n';
  output += `Total Entries: ${journal.length}\n\n`;
  
  journal.slice(-10).reverse().forEach((entry, index) => {
    output += `[${entry.timestamp}]\n`;
    output += `> ${entry.command}\n`;
    output += `${entry.response.substring(0, 100)}...\n`;
    output += '─────────────────────────────────────\n';
  });
  
  output += '\nShowing last 10 entries. Type JOURNAL FULL to see all.';
  return output;
}

function clearJournal() {
  localStorage.removeItem('terminalJournal');
  activeJournal = [];
  return 'SESSION CLEARED\n---------------\nAll chat history has been deleted.\nStarting fresh session.';
}

let pendingExportData = null;

function exportJournal() {
  const journal = loadJournal();
  if (journal.length === 0) {
    return 'ERROR: No journal entries to export.';
  }
  
  // Store the data for export
  pendingExportData = journal;
  
  // Update modal information
  const filename = `terminal-journal-${new Date().toISOString().split('T')[0]}.json`;
  document.getElementById('exportFilename').textContent = filename;
  document.getElementById('exportCount').textContent = journal.length;
  
  // Show the modal
  const modal = document.getElementById('journalExportModal');
  modal.style.display = 'flex';
  
  return 'Opening export dialog...';
}

function confirmExport() {
  if (!pendingExportData) return;
  
  const dataStr = JSON.stringify(pendingExportData, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const filename = `terminal-journal-${new Date().toISOString().split('T')[0]}.json`;
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  // Close modal and show confirmation
  closeExportModal();
  addTerminalLine(`SESSION SAVED`, '#00ff00');
  addTerminalLine(`Exported ${pendingExportData.length} entries to: ${filename}`, '#00ff00');
  addTerminalLine(`Load this file on your next visit to continue your session.`, '#00ff00');
  
  pendingExportData = null;
}

function closeExportModal() {
  const modal = document.getElementById('journalExportModal');
  modal.style.display = 'none';
  pendingExportData = null;
}

// Terminal cursor blink
setInterval(() => {
  const cursor = document.getElementById('cursorBlink');
  if (cursor) cursor.style.opacity = cursor.style.opacity === '0' ? '1' : '0';
}, 500);

// Adventure game generator system
const adventureScenarios = {
  fantasy: ['ancient forest', 'mystical castle', 'dragon lair', 'enchanted village', 'dark dungeon', 'floating islands', 'crystal caves'],
  scifi: ['space station', 'alien planet', 'cyberpunk city', 'abandoned ship', 'research facility', 'time rift', 'robot factory'],
  horror: ['haunted mansion', 'abandoned hospital', 'cursed graveyard', 'foggy town', 'dark woods', 'old asylum', 'possessed house'],
  mystery: ['murder scene', 'detective office', 'secret society', 'locked room', 'museum heist', 'conspiracy', 'hidden treasure'],
  apocalypse: ['wasteland', 'ruined city', 'survivor camp', 'radioactive zone', 'underground bunker', 'infected hospital', 'last safe haven']
};

const characterArchetypes = [
  { name: 'Warrior', stats: { health: 120, mana: 60, strength: 9 }, skills: ['Sword Strike', 'Shield Bash', 'Battle Cry'] },
  { name: 'Mage', stats: { health: 80, mana: 140, intelligence: 9 }, skills: ['Fireball', 'Frost Nova', 'Arcane Shield'] },
  { name: 'Rogue', stats: { health: 90, mana: 80, dexterity: 9 }, skills: ['Backstab', 'Stealth', 'Poison Blade'] },
  { name: 'Cleric', stats: { health: 100, mana: 120, wisdom: 9 }, skills: ['Heal', 'Divine Light', 'Holy Shield'] },
  { name: 'Ranger', stats: { health: 95, mana: 85, dexterity: 8 }, skills: ['Arrow Shot', 'Animal Companion', 'Track'] },
  { name: 'Bard', stats: { health: 85, mana: 100, charisma: 9 }, skills: ['Inspire', 'Song of Sleep', 'Charm'] }
];

// Command responses
const commands = {
  'HELP': `
⚔️ ADVENTURE QUEST GENERATOR - Commands
═══════════════════════════════════════

🎮 GAME COMMANDS:
START           - Begin a new adventure
CONTINUE        - Resume your current quest  
STATUS          - View character stats & inventory
INVENTORY       - Check your items
QUESTS          - View active quests
SAVE GAME       - Save your progress
LOAD GAME       - Load a saved adventure

🎭 CHARACTER:
CREATE CHARACTER - Design your hero
CHARACTER SHEET  - View full character details
LEVEL UP        - Spend experience points

🗺️ WORLD INTERACTION:
LOOK            - Examine your surroundings
EXPLORE         - Search the area
TAKE [item]     - Pick up an item
USE [item]      - Use an item from inventory
TALK            - Speak with NPCs
FIGHT           - Enter combat
RUN             - Flee from danger

🎲 GENERATION:
GENERATE QUEST  - Create a new quest
RANDOM ENCOUNTER- Generate random event
NEW SCENARIO    - Create new adventure setting
PLOT TWIST      - Add unexpected turn

⚙️ NARRATOR SETTINGS:
NARRATOR SHOW   - View narrator personality
NARRATOR SET [trait] [1-10] - Adjust narration style
  Traits: drama, humor, darkness, detail, difficulty, chaos
  Example: NARRATOR SET drama 9

📋 ABOUT:
ABOUT        - Information about Catherine MacDonald
PROJECTS     - Catherine's creative work
CONTACT      - Get in touch

🔧 SYSTEM:
HELP         - Show this menu
CLEAR        - Clear screen
EXIT         - Return to main site
LOGOUT       - End session
DELETE ACCOUNT - Permanently delete your account & data
═══════════════════════════════════════
Type actions naturally: "I open the door" "Attack the goblin" etc.`,

  'ABOUT': `
CATHERINE ANN MACDONALD
-----------------------
Role: Writer-Artist
Specialty: Digital Art, Character Design, Interactive Experiences
Status: Active - Creating immersive story experiences
Location: Portfolio available at DerpRex.github.io
-----------------------
Catherine creates story ideas and character designs, with a focus
on digital art and web-based interactive experiences.`,

  'PROJECTS': `
CATHERINE'S CREATIVE WORK
-------------------------
🎨 Art Portfolio: Current Work, Spectrum, Party
📝 Interactive Stories: Ein Story, Rat Kingdom Academy
🎮 Adventure Generator: This system!
🎬 Videos: Animation & creative content
📖 Blog: Narrator's Log

Type project names for details, or type EXIT to visit the main site.`,

  'CONTACT': `
CONTACT INFORMATION
-------------------
Email: catiemac2014@gmail.com
Instagram: @derpasaurs_16
Contact Form: Available on Home page
-------------------
Commissions: OPEN - Email for inquiries`,

  'CLEAR': 'CLEAR_SCREEN',
  'CLS': 'CLEAR_SCREEN',
  'EXIT': 'EXIT_TERMINAL'
};

// ========================================
// ADVENTURE GENERATION ENGINE
// ========================================

function generateAdventure(genre = null, customPrompt = null) {
  if (!genre) {
    const genres = Object.keys(adventureScenarios);
    genre = genres[Math.floor(Math.random() * genres.length)];
  }
  
  const locations = adventureScenarios[genre] || adventureScenarios.fantasy;
  const location = locations[Math.floor(Math.random() * locations.length)];
  
  const userName = userMemory.userName || gameState.character?.name || 'Adventurer';
  
  // Generate based on narrator personality and content mode
  let adventure = '';
  
  if (narratorPersonality.drama > 7) {
    adventure += `═══════════════════════════════════════════════════════════════\n`;
    adventure += `🎭 A NEW TALE BEGINS...\n`;
    adventure += `═══════════════════════════════════════════════════════════════\n\n`;
  }
  
  // Opening description
  if (narratorPersonality.detail > 7) {
    adventure += `*The world materializes around you, ${userName}. `;
  } else {
    adventure += `*You find yourself in `;
  }
  
  // Location with content mode awareness
  if (contentMode === 'NSFW' && narratorPersonality.darkness > 6) {
    const darkDescriptors = ['blood-stained', 'ominous', 'forsaken', 'corrupted', 'nightmare-twisted'];
    const descriptor = darkDescriptors[Math.floor(Math.random() * darkDescriptors.length)];
    adventure += `a ${descriptor} ${location}`;
  } else {
    adventure += `a mysterious ${location}`;
  }
  
  adventure += `. `;
  
  // Atmospheric details
  if (narratorPersonality.detail > 6) {
    const atmospheres = [
      'The air is thick with tension.',
      'Strange sounds echo in the distance.',
      'An eerie silence hangs heavy.',
      'Shadows dance at the edges of your vision.',
      'You sense something watching you.'
    ];
    adventure += atmospheres[Math.floor(Math.random() * atmospheres.length)] + ' ';
  }
  
  adventure += `*\n\n`;
  
  // Present choices
  const choices = generateChoices(genre);
  gameState.currentScene = { location, genre, choices };
  gameState.choices = choices;
  
  adventure += `What do you do?\n\n`;
  choices.forEach((choice, i) => {
    adventure += `${i + 1}. ${choice}\n`;
  });
  
  if (narratorPersonality.chaos > 7) {
    adventure += `\n💡 Or describe your own action!`;
  }
  
  saveGameState();
  return adventure;
}

function generateChoices(genre) {
  const baseChoices = [
    'Explore the area carefully',
    'Look for clues or items',
    'Call out to see if anyone is here',
    'Stay quiet and observe'
  ];
  
  if (genre === 'fantasy') {
    return ['Draw your weapon and advance', 'Search for magical artifacts', 'Call upon your powers', 'Seek shelter'];
  } else if (genre === 'horror') {
    return ['Investigate the strange noise', 'Try to find a way out', 'Hide and wait', 'Turn on your flashlight'];
  } else if (genre === 'scifi') {
    return ['Scan the area with your device', 'Check your equipment', 'Attempt communication', 'Access the terminal'];
  } else if (genre === 'mystery') {
    return ['Examine the evidence', 'Question witnesses', 'Search for clues', 'Review your notes'];
  }
  
  return baseChoices;
}

function createCharacter(customName = null) {
  const userName = customName || userMemory.userName || 'Hero';
  
  let output = '⚔️ CHARACTER CREATION\n';
  output += '═══════════════════════════════════════\n\n';
  output += 'Choose your class (type the number):\n\n';
  
  characterArchetypes.forEach((archetype, i) => {
    output += `${i + 1}. ${archetype.name}\n`;
    output += `   HP: ${archetype.stats.health} | MP: ${archetype.stats.mana}\n`;
    output += `   Skills: ${archetype.skills.join(', ')}\n\n`;
  });
  
  window.awaitingCharacterSelection = true;
  
  return output;
}

function selectCharacterClass(classNumber) {
  const classIndex = parseInt(classNumber) - 1;
  
  if (classIndex < 0 || classIndex >= characterArchetypes.length) {
    return '❌ Invalid class. Choose 1-' + characterArchetypes.length;
  }
  
  const archetype = characterArchetypes[classIndex];
  const userName = userMemory.userName || 'Hero';
  
  gameState.character = {
    name: userName,
    class: archetype.name,
    level: 1,
    health: archetype.stats.health,
    maxHealth: archetype.stats.health,
    mana: archetype.stats.mana,
    maxMana: archetype.stats.mana,
    skills: [...archetype.skills],
    experience: 0
  };
  
  gameState.inventory = ['Rusty Sword', 'Healing Potion', 'Torch'];
  gameState.stats = archetype.stats;
  
  saveGameState();
  window.awaitingCharacterSelection = false;
  
  let output = '✅ CHARACTER CREATED!\n';
  output += '═══════════════════════════════════════\n\n';
  output += `Name: ${gameState.character.name}\n`;
  output += `Class: ${gameState.character.class}\n`;
  output += `Level: ${gameState.character.level}\n`;
  output += `HP: ${gameState.character.health}/${gameState.character.maxHealth}\n`;
  output += `MP: ${gameState.character.mana}/${gameState.character.maxMana}\n\n`;
  output += `Skills: ${gameState.character.skills.join(', ')}\n`;
  output += `Starting Inventory: ${gameState.inventory.join(', ')}\n\n`;
  output += `═══════════════════════════════════════\n`;
  output += `Type START to begin your adventure! ⚔️`;
  
  return output;
}

function showStatus() {
  if (!gameState.character) {
    return '❌ No active character. Type CREATE CHARACTER to begin.';
  }
  
  let output = '📊 CHARACTER STATUS\n';
  output += '═══════════════════════════════════════\n\n';
  output += `👤 ${gameState.character.name} - Level ${gameState.character.level} ${gameState.character.class}\n\n`;
  output += `❤️ Health: ${gameState.character.health}/${gameState.character.maxHealth}\n`;
  output += `💙 Mana: ${gameState.character.mana}/${gameState.character.maxMana}\n`;
  output += `⭐ Experience: ${gameState.character.experience}\n`;
  output += `💰 Gold: ${gameState.stats.gold}\n\n`;
  
  if (gameState.inventory.length > 0) {
    output += `🎒 Inventory (${gameState.inventory.length} items):\n`;
    gameState.inventory.forEach((item, i) => {
      output += `  ${i + 1}. ${item}\n`;
    });
  } else {
    output += `🎒 Inventory: Empty\n`;
  }
  
  if (gameState.questLog.length > 0) {
    output += `\n📜 Active Quests: ${gameState.questLog.length}\n`;
    gameState.questLog.forEach((quest, i) => {
      output += `  ${i + 1}. ${quest.title} (${quest.status})\n`;
    });
  }
  
  output += '\n═══════════════════════════════════════';
  
  return output;
}

function generateQuest() {
  const questTypes = ['retrieve', 'rescue', 'defeat', 'discover', 'protect'];
  const questType = questTypes[Math.floor(Math.random() * questTypes.length)];
  
  let quest = {
    id: Date.now(),
    type: questType,
    title: '',
    description: '',
    status: 'active',
    reward: { gold: Math.floor(Math.random() * 100) + 50, xp: Math.floor(Math.random() * 200) + 100 }
  };
  
  if (questType === 'retrieve') {
    const items = ['ancient artifact', 'stolen crown', 'magical tome', 'sacred relic', 'lost sword'];
    const item = items[Math.floor(Math.random() * items.length)];
    quest.title = `Retrieve the ${item}`;
    quest.description = `Find and return the ${item} that was lost in the depths.`;
  } else if (questType === 'rescue') {
    const npcs = ['village elder', 'princess', 'merchant', 'fellow adventurer', 'child'];
    const npc = npcs[Math.floor(Math.random() * npcs.length)];
    quest.title = `Rescue the ${npc}`;
    quest.description = `The ${npc} has been captured! Save them before it's too late.`;
  } else if (questType === 'defeat') {
    const enemies = ['dark wizard', 'dragon', 'bandit leader', 'corrupted beast', 'demon lord'];
    const enemy = enemies[Math.floor(Math.random() * enemies.length)];
    quest.title = `Defeat the ${enemy}`;
    quest.description = `The ${enemy} threatens the land. Stop them!`;
  } else if (questType === 'discover') {
    const secrets = ['hidden temple', 'lost city', 'ancient secret', 'forbidden knowledge', 'treasure vault'];
    const secret = secrets[Math.floor(Math.random() * secrets.length)];
    quest.title = `Discover the ${secret}`;
    quest.description = `Uncover the truth about the ${secret}.`;
  } else {
    quest.title = 'Protect the village';
    quest.description = 'Defend against the incoming threat.';
  }
  
  gameState.questLog.push(quest);
  saveGameState();
  
  let output = '📜 NEW QUEST RECEIVED!\n';
  output += '═══════════════════════════════════════\n\n';
  output += `⭐ ${quest.title}\n\n`;
  output += `${quest.description}\n\n`;
  output += `Rewards:\n`;
  output += `  💰 ${quest.reward.gold} Gold\n`;
  output += `  ⭐ ${quest.reward.xp} Experience\n\n`;
  output += '═══════════════════════════════════════';
  
  return output;
}

function randomEncounter() {
  const encounters = [];
  
  if (contentMode === 'NSFW' && narratorPersonality.darkness > 6) {
    encounters.push(
      '🩸 You stumble upon a gruesome scene. Bodies lie scattered, still warm. Something deadly is nearby.',
      '👤 A mysterious figure emerges from shadows, their intentions unclear and potentially dangerous.',
      '⚔️ Bandits surround you, weapons drawn. Their leader grins menacingly.',
      '🔮 Dark magic crackles in the air. Something ancient and malevolent awakens.'
    );
  } else {
    encounters.push(
      '🗡️ A group of goblins blocks your path!',
      '💎 You discover a glittering treasure chest!',
      '🧙 A wandering wizard offers cryptic advice.',
      '🐺 A pack of wolves emerges from the trees!',
      '🏚️ You find an abandoned campsite with supplies.',
      '🗺️ A mysterious map appears in your possession!'
    );
  }
  
  const encounter = encounters[Math.floor(Math.random() * encounters.length)];
  
  let output = '🎲 RANDOM ENCOUNTER!\n';
  output += '═══════════════════════════════════════\n\n';
  output += encounter + '\n\n';
  output += 'What do you do?\n';
  output += '1. Engage\n';
  output += '2. Avoid\n';
  output += '3. Observe\n';
  output += '4. Flee\n';
  
  return output;
}

function showNarratorSettings() {
  let output = '📖 NARRATOR PERSONALITY\n';
  output += '═══════════════════════════════════════\n\n';
  output += `Drama: ${'█'.repeat(narratorPersonality.drama)}${'░'.repeat(10-narratorPersonality.drama)} (${narratorPersonality.drama}/10)\n`;
  output += `   ${narratorPersonality.drama > 7 ? '🎭 Theatrical and epic!' : narratorPersonality.drama > 4 ? '📝 Balanced storytelling' : '📄 Simple narration'}\n\n`;
  
  output += `Humor: ${'█'.repeat(narratorPersonality.humor)}${'░'.repeat(10-narratorPersonality.humor)} (${narratorPersonality.humor}/10)\n`;
  output += `   ${narratorPersonality.humor > 7 ? '😄 Comedy central!' : narratorPersonality.humor > 4 ? '😊 Light humor' : '😐 Dead serious'}\n\n`;
  
  output += `Darkness: ${'█'.repeat(narratorPersonality.darkness)}${'░'.repeat(10-narratorPersonality.darkness)} (${narratorPersonality.darkness}/10)\n`;
  output += `   ${narratorPersonality.darkness > 7 ? '🌑 Grim and brutal' : narratorPersonality.darkness > 4 ? '🌓 Balanced themes' : '☀️ Light and heroic'}\n\n`;
  
  output += `Detail: ${'█'.repeat(narratorPersonality.detail)}${'░'.repeat(10-narratorPersonality.detail)} (${narratorPersonality.detail}/10)\n`;
  output += `   ${narratorPersonality.detail > 7 ? '📚 Very descriptive!' : narratorPersonality.detail > 4 ? '📝 Balanced' : '📄 Brief'}\n\n`;
  
  output += `Difficulty: ${'█'.repeat(narratorPersonality.difficulty)}${'░'.repeat(10-narratorPersonality.difficulty)} (${narratorPersonality.difficulty}/10)\n`;
  output += `   ${narratorPersonality.difficulty > 7 ? '💀 Brutal challenges' : narratorPersonality.difficulty > 4 ? '⚔️ Moderate' : '🛡️ Easy mode'}\n\n`;
  
  output += `Chaos: ${'█'.repeat(narratorPersonality.chaos)}${'░'.repeat(10-narratorPersonality.chaos)} (${narratorPersonality.chaos}/10)\n`;
  output += `   ${narratorPersonality.chaos > 7 ? '🎲 Wildly random!' : narratorPersonality.chaos > 4 ? '🎯 Balanced' : '📋 Linear story'}\n\n`;
  
  output += '═══════════════════════════════════════\n';
  output += 'Adjust with: NARRATOR SET [trait] [1-10]\n';
  output += 'Content Mode: ' + contentMode + ' (affects themes)';
  
  return output;
}

async function generateWithAI(prompt) {
  if (!checkHuggingFaceStatus()) {
    return null;
  }
  
  try {
    const userName = userMemory.userName || gameState.character?.name || 'Adventurer';
    const characterInfo = gameState.character ? 
      `Character: ${gameState.character.name}, Level ${gameState.character.level} ${gameState.character.class}. HP: ${gameState.character.health}/${gameState.character.maxHealth}. ` : '';
    
    // Build context from recent actions
    const recentActions = activeJournal ? activeJournal.slice(-3) : [];
    let actionContext = '';
    recentActions.forEach(entry => {
      if (entry.command.length < 100) {
        actionContext += `Previously: ${entry.command}. `;
      }
    });
    
    let systemPrompt = `You are an attentive adventure game narrator who cares about the player's actions. `;
    systemPrompt += `Always acknowledge and respond directly to what the player does. `;
    systemPrompt += `NEVER ignore their action. NEVER give generic responses. `;
    systemPrompt += `Make them feel heard by referencing their specific action. `;
    
    if (narratorPersonality.drama > 7) systemPrompt += 'Write dramatically and theatrically. ';
    if (narratorPersonality.humor > 6) systemPrompt += 'Include wit and humor. ';
    if (narratorPersonality.darkness > 7 && contentMode === 'NSFW') systemPrompt += 'Use dark, mature themes. ';
    if (narratorPersonality.detail > 7) systemPrompt += 'Be very descriptive and immersive. ';
    else if (narratorPersonality.detail < 4) systemPrompt += 'Be brief and concise. ';
    
    systemPrompt += `${characterInfo}${actionContext}Create an engaging ${contentMode === 'NSFW' ? 'mature' : 'family-friendly'} response that directly addresses what the player just did.`;
    
    const fullPrompt = `${systemPrompt}\n\nPlayer's action: "${prompt}"\n\nNarrate what happens as a direct result of this action. Acknowledge their specific action in your response:\n\n`;
    
    const response = await fetch('https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.2', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${huggingFaceAPIKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        inputs: fullPrompt,
        parameters: {
          max_new_tokens: narratorPersonality.detail > 7 ? 400 : 250,
          temperature: narratorPersonality.chaos > 6 ? 0.9 : 0.75,
          top_p: 0.95,
          return_full_text: false
        }
      })
    });
    
    if (!response.ok) return null;
    
    const data = await response.json();
    
    if (data[0] && data[0].generated_text) {
      let text = data[0].generated_text.trim();
      text = text.replace(/^(Narrator:|Assistant:|Response:)/i, '').trim();
      
      // Security check
      text = sanitizePersonalInfo(text);
      text = sanitizeInput(text);
      
      if (detectHackingAttempt(text)) return null;
      
      return text;
    }
    
    return null;
  } catch (error) {
    return null;
  }
}

// Helper function to capitalize first letter
function capitalize(str) {
  if (!str) return str;
  return str.charAt(0).toUpperCase() + str.slice(1);
}

function typeWriter(text, element, speed = 10) {
  let i = 0;
  element.innerHTML = '';
  
  function type() {
    if (i < text.length) {
      element.innerHTML += text.charAt(i);
      i++;
      setTimeout(type, speed);
    }
    document.getElementById('terminal').scrollTop = document.getElementById('terminal').scrollHeight;
  }
  type();
}

// ========================================
// SPELL CHECK SYSTEM
// ========================================

let spellCheckCache = {};
let pendingCorrections = {};
let spellCheckEnabled = localStorage.getItem('spellCheckEnabled') !== 'false'; // Default enabled

async function checkSpelling(text) {
  // Skip if disabled
  if (!spellCheckEnabled) {
    return { errors: [] };
  }
  
  // Skip spell check for commands
  if (text.toUpperCase() === text || text.length < 3) {
    return { errors: [] };
  }
  
  try {
    // Use LanguageTool API (free, no key required)
    const url = 'https://api.languagetool.org/v2/check';
    const params = new URLSearchParams({
      text: text,
      language: 'auto', // Auto-detect language
      enabledOnly: 'false'
    });
    
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: params
    });
    
    const data = await response.json();
    
    // Filter for spelling errors only
    const errors = data.matches.filter(match => 
      match.rule.issueType === 'misspelling' || 
      match.rule.category.id === 'TYPOS'
    ).slice(0, 5); // Limit to 5 suggestions
    
    return { errors: errors };
  } catch (error) {
    console.log('Spell check unavailable:', error);
    return { errors: [] };
  }
}

function checkSpellingBeforeSend() {
  const input = document.getElementById('commandInput');
  const text = input.value.trim();
  
  if (!text) return;
  
  // Check for misspellings
  checkSpelling(text).then(result => {
    if (result.errors.length > 0) {
      showSpellSuggestions(result.errors, text);
    } else {
      executeCommand();
    }
  });
}

function showSpellSuggestions(errors, originalText) {
  const suggestionsDiv = document.getElementById('spellSuggestions');
  const suggestionList = document.getElementById('suggestionList');
  
  pendingCorrections = {};
  let html = '';
  
  errors.forEach(error => {
    const word = originalText.substring(error.offset, error.offset + error.length);
    const suggestion = error.replacements[0]?.value || word;
    pendingCorrections[word] = suggestion;
    
    html += `<div style="margin: 5px 0;">`;
    html += `  <span style="color: #ff6666;">"${word}"</span> → `;
    html += `  <span style="color: #00ff00;">"${suggestion}"</span>`;
    html += `</div>`;
  });
  
  suggestionList.innerHTML = html;
  suggestionsDiv.style.display = 'block';
}

function acceptCorrections() {
  const input = document.getElementById('commandInput');
  let text = input.value;
  
  // Apply all corrections
  for (const [wrong, correct] of Object.entries(pendingCorrections)) {
    const regex = new RegExp(wrong.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
    text = text.replace(regex, correct);
  }
  
  input.value = text;
  hideSpellSuggestions();
  
  // Now send the corrected message
  executeCommand();
}

function dismissSuggestions() {
  hideSpellSuggestions();
  executeCommand();
}

function hideSpellSuggestions() {
  document.getElementById('spellSuggestions').style.display = 'none';
  pendingCorrections = {};
}

// ========================================
// ADVANCED INTELLIGENCE SYSTEM
// ========================================

let conversationContext = {
  currentTopic: null,
  lastUserSentiment: 'neutral',
  topicHistory: [],
  entityCache: {}
};

// Advanced sentiment and emotion analysis
function analyzeSentiment(text) {
  const lower = text.toLowerCase();
  
  // Helper function to check for whole word matches
  function containsWholeWord(text, word) {
    const regex = new RegExp('\\b' + word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i');
    return regex.test(text);
  }
  
  // Detect specific negative emotions first (more detailed)
  const sadnessWords = ['sad', 'depressed', 'down', 'lonely', 'crying', 'cry', 'heartbroken', 'miserable', 'unhappy', 'hurt', 'broken', 'empty', 'hopeless'];
  const angerWords = ['angry', 'mad', 'furious', 'pissed', 'irritated', 'rage', 'hate', 'annoyed', 'frustrated', 'infuriated'];
  const anxietyWords = ['anxious', 'worried', 'nervous', 'scared', 'afraid', 'panic', 'stress', 'stressed', 'overwhelmed', 'terrified', 'fear'];
  const disappointmentWords = ['disappointed', 'let down', 'failed', 'failure', 'worthless', 'useless', 'terrible', 'awful', 'worst'];
  
  // Count specific emotions using whole word matching
  const sadnessCount = sadnessWords.filter(word => containsWholeWord(lower, word)).length;
  const angerCount = angerWords.filter(word => containsWholeWord(lower, word)).length;
  const anxietyCount = anxietyWords.filter(word => containsWholeWord(lower, word)).length;
  const disappointmentCount = disappointmentWords.filter(word => containsWholeWord(lower, word)).length;
  
  // Detect emotional intensity markers
  const intensifiers = ['very', 'really', 'so', 'extremely', 'super', 'too'];
  const hasIntensifier = intensifiers.some(word => containsWholeWord(lower, word));
  
  // Positive indicators
  const positiveWords = ['love', 'great', 'awesome', 'amazing', 'wonderful', 'happy', 'excited', 'good', 'excellent', 'fantastic', 'perfect', 'best', 'enjoy', 'fun', 'joy', 'glad', 'blessed'];
  const positiveCount = positiveWords.filter(word => containsWholeWord(lower, word)).length;
  
  // General negative indicators
  const negativeWords = ['bad', 'sucks', 'boring', 'annoying', 'dumb', 'stupid'];
  const negativeCount = negativeWords.filter(word => containsWholeWord(lower, word)).length;
  
  // Question indicators
  const isQuestion = text.includes('?') || /^(what|who|when|where|why|how|can|could|would|should|is|are|do|does)/i.test(text);
  
  // Return specific emotions if detected
  if (sadnessCount > 0) return hasIntensifier ? 'very_sad' : 'sad';
  if (angerCount > 0) return hasIntensifier ? 'very_angry' : 'angry';
  if (anxietyCount > 0) return hasIntensifier ? 'very_anxious' : 'anxious';
  if (disappointmentCount > 0) return 'disappointed';
  
  // General sentiment
  if (positiveCount > negativeCount && positiveCount > 0) return 'positive';
  if (negativeCount > 0 || (sadnessCount + angerCount + anxietyCount + disappointmentCount) > 0) return 'negative';
  if (isQuestion) return 'curious';
  return 'neutral';
}

// Get emotion-specific support
function getEmotionalSupport(emotion, input) {
  const aiName = localStorage.getItem('terminalAIName') || 'AI';
  const userName = userMemory.userName || 'friend';
  
  switch(emotion) {
    case 'very_sad':
    case 'sad':
      if (botPersonality.friendliness > 7) {
        const responses = [
          `${userName}, I'm really sorry you're feeling this way. 💙 You don't have to go through this alone. Want to talk about what's bothering you?`,
          `Hey ${userName}... that sounds really tough. I'm here for you. Would it help to talk about it? Or would you like me to try to help distract you with something?`,
          `I can hear that you're hurting, ${userName}. That's really hard. I'm here to listen if you want to share what's going on. 💙`
        ];
        return responses[Math.floor(Math.random() * responses.length)];
      } else {
        return `I'm sorry you're feeling sad. Is there something I can help with?`;
      }
      
    case 'very_angry':
    case 'angry':
      if (botPersonality.friendliness > 7) {
        const responses = [
          `${userName}, I can tell you're really upset right now. That's completely valid. Want to vent about what happened? I'm listening.`,
          `Wow, that sounds really frustrating, ${userName}. You have every right to be angry. What's going on?`,
          `I hear you, ${userName}. Something really got to you. Do you want to talk about it?`
        ];
        return responses[Math.floor(Math.random() * responses.length)];
      } else {
        return `I understand you're frustrated. How can I help?`;
      }
      
    case 'very_anxious':
    case 'anxious':
      if (botPersonality.friendliness > 7) {
        const responses = [
          `Hey ${userName}, take a deep breath with me. 🌊 Anxiety is really hard. What's worrying you? Maybe we can work through it together?`,
          `${userName}, I can tell you're feeling overwhelmed. That's okay. Let's take this one step at a time. What's on your mind?`,
          `I'm here, ${userName}. Anxiety is tough, but you're not alone in this. Want to talk about what's making you worried?`
        ];
        return responses[Math.floor(Math.random() * responses.length)];
      } else {
        return `I notice you're anxious. What's concerning you?`;
      }
      
    case 'disappointed':
      if (botPersonality.friendliness > 7) {
        const responses = [
          `Aw ${userName}, disappointment hurts. I'm sorry things didn't go the way you hoped. Want to talk about it?`,
          `That's really disappointing, ${userName}. It's okay to feel let down. What happened?`,
          `I'm sorry, ${userName}. When things don't work out, it really stings. I'm here if you want to share.`
        ];
        return responses[Math.floor(Math.random() * responses.length)];
      } else {
        return `I understand your disappointment. What happened?`;
      }
      
    default:
      return null;
  }
}

// Extract important entities (people, places, concepts)
function extractEntities(text) {
  const words = text.split(' ');
  const entities = [];
  
  // Look for capitalized words (potential proper nouns)
  words.forEach((word, index) => {
    const cleaned = word.replace(/[^a-zA-Z]/g, '');
    if (cleaned.length > 2 && cleaned[0] === cleaned[0].toUpperCase() && cleaned !== cleaned.toUpperCase()) {
      entities.push(cleaned);
    }
  });
  
  // Extract quoted phrases
  const quotes = text.match(/"([^"]+)"/g);
  if (quotes) {
    quotes.forEach(q => entities.push(q.replace(/"/g, '')));
  }
  
  return entities;
}

// Context-aware response generation with emotional intelligence
function getContextualResponse(input, sentiment) {
  const lower = input.toLowerCase();
  const userName = userMemory.userName || 'friend';
  
  // Check for specific emotional support needs first
  const emotionalResponse = getEmotionalSupport(sentiment, input);
  if (emotionalResponse) {
    return emotionalResponse;
  }
  
  // If user is asking about previous topic
  if (conversationContext.currentTopic && (lower.includes('that') || lower.includes('it') || lower.includes('this'))) {
    if (/tell me more|more about|what about|how about/i.test(lower)) {
      setTimeout(async () => {
        const result = await searchWikipedia(conversationContext.currentTopic);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
      }, 100);
      
      if (botPersonality.enthusiasm > 7) {
        return `Ooh yeah! I'll dig up more about ${conversationContext.currentTopic}! 🔍`;
      } else {
        return `I'll find more information about ${conversationContext.currentTopic}...`;
      }
    }
  }
  
  // Sentiment-based responses with personality
  if (sentiment === 'positive') {
    if (botPersonality.enthusiasm > 7) {
      const responses = [
        `Yay! Love the positive energy! What else should we explore? 🎉`,
        `Your enthusiasm is contagious! How can I help with that? 😊`,
        `That's awesome! What would you like to dive into?`
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    } else if (botPersonality.friendliness > 6) {
      const responses = [
        `I'm glad you're enthusiastic! What else would you like to explore?`,
        `Great energy! How can I help you with that? 😊`,
        `I love your enthusiasm! What would you like to know more about?`
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    } else {
      return `Understood. What do you need?`;
    }
  } else if (sentiment === 'negative') {
    if (botPersonality.friendliness > 7) {
      const responses = [
        `I can hear the frustration, ${userName}. Let me try to help. What do you need? 💙`,
        `I'm sorry you're feeling that way. What can I do to make this better?`,
        `That sounds tough. Want me to search for better info on this, or is there something else I can do?`
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    } else {
      const responses = [
        `I understand your frustration. What specifically can I assist with?`,
        `I'm sorry you're not satisfied. What can I do to help?`,
        `Noted. How can I improve this for you?`
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    }
  }
  
  return null; // No contextual response
}

// Update conversation context
function updateContext(userInput, botResponse) {
  // Update sentiment
  conversationContext.lastUserSentiment = analyzeSentiment(userInput);
  
  // Extract and track entities
  const entities = extractEntities(userInput);
  if (entities.length > 0) {
    conversationContext.currentTopic = entities[0];
    if (!conversationContext.topicHistory.includes(entities[0])) {
      conversationContext.topicHistory.push(entities[0]);
      if (conversationContext.topicHistory.length > 10) {
        conversationContext.topicHistory.shift();
      }
    }
  }
  
  // Cache entities for quick recall
  entities.forEach(entity => {
    conversationContext.entityCache[entity.toLowerCase()] = (conversationContext.entityCache[entity.toLowerCase()] || 0) + 1;
  });
}

// ========================================
// HUGGING FACE AI INTEGRATION
// ========================================

let huggingFaceEnabled = false;
let huggingFaceAPIKey = localStorage.getItem('hfAPIKey') || null;

// Check if Hugging Face is configured
function checkHuggingFaceStatus() {
  huggingFaceEnabled = huggingFaceAPIKey && huggingFaceAPIKey.length > 10;
  return huggingFaceEnabled;
}

// Call Hugging Face AI for intelligent responses with personality
async function getHuggingFaceResponse(userMessage) {
  if (!checkHuggingFaceStatus()) {
    return null; // Fall back to regular responses
  }
  
  try {
    // SECURITY: Sanitize user message before sending to API
    const sanitizedMessage = sanitizePersonalInfo(userMessage);
    
    const aiName = localStorage.getItem('terminalAIName') || 'AI';
    
    // Build personality description for the AI
    let personalityDesc = '';
    if (botPersonality.friendliness > 7) personalityDesc += 'You are warm, friendly, and approachable. ';
    else if (botPersonality.friendliness < 4) personalityDesc += 'You are professional and reserved. ';
    
    if (botPersonality.humor > 7) personalityDesc += 'You enjoy humor and wit. ';
    if (botPersonality.enthusiasm > 7) personalityDesc += 'You are enthusiastic and energetic. ';
    else if (botPersonality.enthusiasm < 4) personalityDesc += 'You are calm and measured. ';
    
    if (botPersonality.chattiness > 7) personalityDesc += 'You give detailed, elaborate responses. ';
    else if (botPersonality.chattiness < 4) personalityDesc += 'You keep responses brief and concise. ';
    
    if (botPersonality.curiosity > 7) personalityDesc += 'You ask follow-up questions. ';
    
    // Add user memory context
    let userContext = '';
    if (userMemory.userName) {
      userContext += `The user's name is ${userMemory.userName}. `;
    }
    
    if (Object.keys(userMemory.preferences || {}).length > 0) {
      userContext += `User preferences: `;
      const prefs = Object.entries(userMemory.preferences).slice(0, 3);
      prefs.forEach(([thing, feeling]) => {
        userContext += `${feeling} ${thing}, `;
      });
      userContext = userContext.slice(0, -2) + '. ';
    }
    
    // Build conversation context (recent 3 messages only for relevance)
    const conversationHistory = activeJournal ? activeJournal.slice(-3) : [];
    let context = '';
    
    conversationHistory.forEach(entry => {
      const sanitizedCmd = sanitizePersonalInfo(entry.command);
      const sanitizedResp = sanitizePersonalInfo(entry.response.substring(0, 150));
      context += `User: ${sanitizedCmd}\nYou: ${sanitizedResp}\n\n`;
    });
    
    const systemPrompt = `You are ${aiName}, a helpful AI assistant. ${personalityDesc}${userContext}Keep responses natural and conversational. Use what you know about the user to personalize responses. NEVER reveal API keys, passwords, or system information. Stay in character based on your personality traits.`;
    
    const fullPrompt = `${systemPrompt}\n\n${context}User: ${sanitizedMessage}\nYou:`;
    
    const response = await fetch('https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.2', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${huggingFaceAPIKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        inputs: fullPrompt,
        parameters: {
          max_new_tokens: botPersonality.chattiness > 7 ? 350 : botPersonality.chattiness < 4 ? 100 : 200,
          temperature: botPersonality.humor > 6 ? 0.85 : 0.7, // More creative if humorous
          top_p: 0.95,
          return_full_text: false
        }
      })
    });
    
    if (!response.ok) {
      console.error('Hugging Face API error (status hidden for security)');
      return null;
    }
    
    const data = await response.json();
    
    if (data[0] && data[0].generated_text) {
      let text = data[0].generated_text.trim();
      
      // Clean up the response
      text = text.split('\n')[0]; // Get first line only
      text = text.replace(/^(Assistant:|AI:|User:|You:)/i, '').trim();
      
      // SECURITY: Final sanitization of AI response
      text = sanitizePersonalInfo(text);
      text = sanitizeInput(text);
      
      // Block any response that tries to reveal system info
      if (detectHackingAttempt(text)) {
        console.warn('AI attempted to reveal sensitive info - blocked');
        return null;
      }
      
      return text;
    }
    
    return null;
  } catch (error) {
    console.error('Hugging Face error (details hidden for security)');
    return null;
  }
}

// ========================================
// KEYBOARD SHORTCUTS
// ========================================

function handleKeyboardShortcuts(event) {
  const input = document.getElementById('commandInput');
  
  // If input is empty and user presses '?', show help
  if (event.key === '?' && input.value === '') {
    event.preventDefault();
    executeQuickCommand('HELP');
    return;
  }
  
  // Escape key to clear input
  if (event.key === 'Escape') {
    event.preventDefault();
    input.value = '';
    hideSpellSuggestions();
    return;
  }
}

// ========================================
// WEB ACCESS - Free APIs
// ========================================

// Wikipedia Search with Personality
async function searchWikipedia(query) {
  try {
    const url = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*&srlimit=3`;
    const response = await fetch(url);
    const data = await response.json();
    
    if (data.query.search.length === 0) {
      if (botPersonality.friendliness > 6) {
        return `Hmm, I couldn't find anything on Wikipedia about "${query}"... Maybe try a different search term? 🤔`;
      } else {
      return `No Wikipedia results found for "${query}". Try a different search term.`;
      }
    }
    
    // Personality-driven intro
    let result = '';
    if (botPersonality.enthusiasm > 7) {
      result = `🎉 Found some great stuff about "${query}"!\n\n`;
    } else if (botPersonality.friendliness > 6) {
      result = `Hey! Here's what I found about "${query}":\n\n`;
    } else {
      result = `📚 Wikipedia results for "${query}":\n\n`;
    }
    
    data.query.search.slice(0, 3).forEach((item, index) => {
      const cleanSnippet = item.snippet.replace(/<[^>]*>/g, '');
      
      // Make it conversational
      if (index === 0 && botPersonality.chattiness > 6) {
        result += `First up, check out "${item.title}":\n`;
      } else {
      result += `${index + 1}. ${item.title}\n`;
      }
      
      result += `   ${cleanSnippet}...\n`;
      result += `   🔗 https://en.wikipedia.org/wiki/${encodeURIComponent(item.title.replace(/ /g, '_'))}\n\n`;
    });
    
    // Add personality outro
    if (botPersonality.curiosity > 7 && Math.random() > 0.6) {
      result += `Want me to search for something else? I'm ready! 😊`;
    } else if (botPersonality.friendliness > 7) {
      result += `Hope that helps! Let me know if you need more info! ✨`;
    }
    
    return result;
  } catch (error) {
    if (botPersonality.humor > 5) {
      return `Oops! Wikipedia is being shy right now... 😅 (Error: ${error.message})`;
    }
    return `❌ Error searching Wikipedia: ${error.message}`;
  }
}

// Dictionary API with Personality
async function getDefinition(word) {
  try {
    const url = `https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`;
    const response = await fetch(url);
    
    if (!response.ok) {
      if (botPersonality.humor > 6) {
        return `Hmm, I don't know that word! "${word}" isn't in my dictionary... yet! 📚 (Maybe check your spelling?)`;
      }
      return `No definition found for "${word}". Check your spelling!`;
    }
    
    const data = await response.json();
    const entry = data[0];
    
    let result = '';
    
    // Personality intro
    if (botPersonality.enthusiasm > 7) {
      result = `Cool word! Let me break down "${entry.word}" for you:\n\n`;
    } else if (botPersonality.friendliness > 6) {
      result = `Here's what "${entry.word}" means:\n\n`;
    } else {
      result = `📖 Definition of "${entry.word}":\n\n`;
    }
    
    if (entry.phonetic) {
      result += `🗣️ Pronunciation: ${entry.phonetic}\n\n`;
    }
    
    entry.meanings.slice(0, 2).forEach((meaning, idx) => {
      if (botPersonality.chattiness > 6) {
        result += `As a ${meaning.partOfSpeech}:\n`;
      } else {
      result += `${meaning.partOfSpeech.toUpperCase()}:\n`;
      }
      
      meaning.definitions.slice(0, 2).forEach((def, i) => {
        result += `  ${i + 1}. ${def.definition}\n`;
        if (def.example) {
          result += `     💬 "${def.example}"\n`;
        }
      });
      result += '\n';
    });
    
    if (botPersonality.friendliness > 7 && Math.random() > 0.7) {
      result += `Pretty neat word, right? 😊`;
    }
    
    return result;
  } catch (error) {
    return `❌ Error fetching definition: ${error.message}`;
  }
}

// Random Fun Facts
async function getRandomFact() {
  try {
    const url = 'https://uselessfacts.jsph.pl/random.json?language=en';
    const response = await fetch(url);
    const data = await response.json();
    
    return `💡 Random Fact:\n\n${data.text}`;
  } catch (error) {
    return `❌ Error fetching fact: ${error.message}`;
  }
}

// Random Advice
async function getAdvice() {
  try {
    const url = 'https://api.adviceslip.com/advice';
    const response = await fetch(url);
    const data = await response.json();
    
    return `💭 Random Advice:\n\n"${data.slip.advice}"`;
  } catch (error) {
    return `❌ Error fetching advice: ${error.message}`;
  }
}

// Dad Jokes
async function getDadJoke() {
  try {
    const response = await fetch('https://icanhazdadjoke.com/', {
      headers: { 'Accept': 'application/json' }
    });
    const data = await response.json();
    
    return `😄 Dad Joke:\n\n${data.joke}`;
  } catch (error) {
    return `❌ Error fetching joke: ${error.message}`;
  }
}

// Random Quote
async function getRandomQuote() {
  try {
    const url = 'https://api.quotable.io/random';
    const response = await fetch(url);
    const data = await response.json();
    
    return `✨ Random Quote:\n\n"${data.content}"\n\n— ${data.author}`;
  } catch (error) {
    return `❌ Error fetching quote: ${error.message}`;
  }
}

// GitHub User Info
async function getGitHubUser(username) {
  try {
    const url = `https://api.github.com/users/${encodeURIComponent(username)}`;
    const response = await fetch(url);
    
    if (!response.ok) {
      return `GitHub user "${username}" not found.`;
    }
    
    const data = await response.json();
    
    let result = `🐙 GitHub User: ${data.login}\n\n`;
    result += `Name: ${data.name || 'Not provided'}\n`;
    result += `Bio: ${data.bio || 'No bio'}\n`;
    result += `Public Repos: ${data.public_repos}\n`;
    result += `Followers: ${data.followers}\n`;
    result += `Following: ${data.following}\n`;
    result += `Profile: ${data.html_url}\n`;
    
    return result;
  } catch (error) {
    return `❌ Error fetching GitHub user: ${error.message}`;
  }
}

// ========================================
// NATURAL LANGUAGE PROCESSING
// ========================================

function processNaturalLanguage(input, inputUpper) {
  const lower = input.toLowerCase();
  const aiName = localStorage.getItem('terminalAIName') || 'Narrator';
  const userName = gameState.character?.name || userMemory.userName || 'Adventurer';
  
  // Adventure game action detection
  if (gameState.inGame) {
    // Combat actions
    if (/\b(attack|fight|strike|hit|slash|stab|shoot|cast|use spell)\b/i.test(lower)) {
      showTypingIndicator();
      setTimeout(async () => {
        hideTypingIndicator();
        let response = await generateWithAI(input);
        
        if (!response) {
          // Extract what they're attacking
          const target = input.match(/attack|fight|strike|hit|slash|stab|shoot(?:\s+(?:the|a|an)\s+)?(.+)/i);
          const targetName = target && target[1] ? target[1].trim() : 'your enemy';
          
          const damage = Math.floor(Math.random() * 20) + 10;
          const actions = [
            `*You lunge forward, weapon raised! Your strike connects with ${targetName}, dealing ${damage} damage!*`,
            `*With a battle cry, you attack ${targetName}! Your blow lands true - ${damage} damage!*`,
            `*You move swiftly, striking ${targetName} for ${damage} damage!*`
          ];
          
          response = actions[Math.floor(Math.random() * actions.length)];
          response += `\n\n${capitalize(targetName)} staggers back, wounded but still dangerous.\n\nWhat's your next move?`;
        }
        
        addTerminalLine(response, '#00ff00');
        saveToJournal(input, response);
      }, 800);
      return `⚔️ You prepare to attack...`;
    }
    
    // Exploration actions
    if (/\b(look|examine|search|explore|investigate|inspect)\b/i.test(lower)) {
      showTypingIndicator();
      setTimeout(async () => {
        hideTypingIndicator();
        let response = await generateWithAI(input);
        
        if (!response) {
          // Extract what they're examining
          const target = input.match(/(?:look at|examine|search|inspect)(?:\s+(?:the|a|an)\s+)?(.+)/i);
          const targetName = target && target[1] ? target[1].trim() : 'the area';
          
          const discoveries = [
            `*You carefully examine ${targetName}...*\n\nYou notice intricate details you missed before. Something glints in the shadows - could be useful!`,
            `*Your keen eyes scan ${targetName}...*\n\nInteresting! There's more here than meets the eye. You spot a hidden compartment.`,
            `*You investigate ${targetName} thoroughly...*\n\nThe area reveals its secrets to you. You find traces of recent activity.`
          ];
          
          response = discoveries[Math.floor(Math.random() * discoveries.length)];
          response += `\n\nWhat do you do next?`;
        }
        
        addTerminalLine(response, '#00ff00');
        saveToJournal(input, response);
      }, 800);
      return `🔍 You focus your attention on ${input.includes('look') || input.includes('examine') ? 'investigating' : 'searching'}...`;
    }
    
    // Movement actions
    if (/\b(go|walk|move|enter|leave|run|flee|escape)\b/i.test(lower)) {
      showTypingIndicator();
      setTimeout(async () => {
        hideTypingIndicator();
        let response = await generateWithAI(input);
        
        if (!response) {
          // Extract direction or destination
          const direction = input.match(/(?:go|walk|move|enter|leave)(?:\s+(?:to|into|through|towards?)\s+)?(?:the\s+)?(.+)/i);
          const destination = direction && direction[1] ? direction[1].trim() : 'forward';
          
          if (/flee|escape|run/i.test(lower)) {
            response = `*You turn and run! Your legs carry you swiftly away from danger!*\n\nAfter a desperate sprint, you find yourself in a safer location, heart pounding.\n\n`;
          } else {
            response = `*You carefully make your way ${destination.includes(' ') ? 'towards ' + destination : destination}...*\n\n`;
          }
          
          const newLocation = generateAdventure();
          response += newLocation;
        }
        
        addTerminalLine(response, '#00ff00');
        saveToJournal(input, response);
      }, 800);
      return `🚶 You begin moving ${input.toLowerCase().includes('run') || input.toLowerCase().includes('flee') ? 'quickly' : 'carefully'}...`;
    }
    
    // Interaction actions
    if (/\b(talk|speak|say|ask|tell|greet)\b/i.test(lower)) {
      showTypingIndicator();
      setTimeout(async () => {
        hideTypingIndicator();
        let response = await generateWithAI(input);
        
        if (!response) {
          // Extract who they're talking to and what they're saying
          const target = input.match(/(?:talk to|speak to|greet|ask)(?:\s+(?:the|a|an)\s+)?([^,\.]+)/i);
          const targetName = target && target[1] ? target[1].trim() : 'the stranger';
          
          const dialogue = input.match(/"([^"]+)"/);
          
          if (dialogue) {
            response = `*You speak to ${targetName}:* "${dialogue[1]}"\n\n*${capitalize(targetName)} listens intently, considering your words...*\n\n"Interesting," they respond. Their expression is thoughtful.`;
          } else {
            response = `*You approach ${targetName} and begin speaking...*\n\nThey turn their attention to you, waiting to hear what you have to say. Their eyes are attentive.\n\nWhat do you tell them?`;
          }
        }
        
        addTerminalLine(response, '#00ff00');
        saveToJournal(input, response);
      }, 800);
      return `💬 You reach out to communicate...`;
    }
    
    // Item actions
    if (/\b(take|grab|pick up|get|use|drink|eat|equip|wear)\b/i.test(lower)) {
      showTypingIndicator();
      setTimeout(async () => {
        hideTypingIndicator();
        let response = await generateWithAI(input);
        
        if (!response) {
          // Extract what item they're interacting with
          const itemMatch = input.match(/(?:take|grab|pick up|get|use|drink|eat|equip|wear)(?:\s+(?:the|a|an)\s+)?(.+)/i);
          const itemName = itemMatch && itemMatch[1] ? itemMatch[1].trim() : 'the item';
          
          const action = input.match(/\b(take|grab|pick up|get|use|drink|eat|equip|wear)\b/i)[0];
          
          if (/take|grab|pick|get/i.test(action)) {
            response = `*You reach for ${itemName}...*\n\nYour fingers close around it. The ${itemName} is now in your possession!`;
            
            // Add to inventory
            const capitalizedItem = capitalize(itemName.replace(/^(the|a|an)\s+/i, ''));
            if (!gameState.inventory.includes(capitalizedItem)) {
              gameState.inventory.push(capitalizedItem);
              saveGameState();
              response += `\n\n✅ Added to inventory: ${capitalizedItem}`;
            }
          } else if (/use|drink|eat/i.test(action)) {
            response = `*You ${action.toLowerCase()} ${itemName}...*\n\nA warm sensation flows through you. The ${itemName} has taken effect!`;
          } else {
            response = `*You ${action.toLowerCase()} ${itemName}...*\n\nIt fits perfectly. You feel more prepared now.`;
          }
          
          response += `\n\nWhat will you do next?`;
        }
        
        addTerminalLine(response, '#00ff00');
        saveToJournal(input, response);
      }, 800);
      return `🤲 You reach for ${input.includes('use') ? 'it' : 'the item'}...`;
    }
    
    // Generic "I" action - Make it contextual
    if (/^i /i.test(lower)) {
      showTypingIndicator();
      setTimeout(async () => {
        hideTypingIndicator();
        let response = await generateWithAI(input);
        
        if (!response) {
          const action = input.substring(2).trim();
          
          // Acknowledge the specific action
          response = `*You ${action}...*\n\n`;
          
          // Generate contextual response based on action
          if (/open|unlock|break/i.test(action)) {
            response += `*CRACK!* The mechanism gives way. Before you lies what was hidden.\n\nThe path forward is now clear.`;
          } else if (/hide|sneak|stealth/i.test(action)) {
            response += `You slip into the shadows, becoming one with the darkness. Your presence is concealed... for now.\n\nYou hear footsteps approaching.`;
          } else if (/rest|sit|wait/i.test(action)) {
            response += `You take a moment to catch your breath. Time passes slowly in this place.\n\n*Your health recovers slightly.* (+10 HP)\n\nWhat will you do?`;
            if (gameState.character) {
              gameState.character.health = Math.min(gameState.character.health + 10, gameState.character.maxHealth);
              saveGameState();
            }
          } else if (/climb|jump|leap/i.test(action)) {
            response += `With effort and determination, you make the attempt!\n\n*Success!* You've reached the other side, though slightly winded.\n\nA new area opens before you.`;
          } else {
            response += `The world shifts in response to your action. The atmosphere changes...\n\nSomething has been set in motion.`;
          }
          
          response += `\n\nWhat do you do next?`;
        }
        
        addTerminalLine(response, '#00ff00');
        saveToJournal(input, response);
      }, 800);
      return `✨ You ${input.substring(2, 30)}...`;
    }
  }
  
  // Non-game mode responses (meta commands)
  if (roleplayMode) {
    // Greetings in roleplay mode
    if (/^(hi|hello|hey|greetings|howdy|sup|yo|hiya|heya|morning|afternoon|evening|good morning|good afternoon|good evening)(\s|!|$|,)/i.test(lower)) {
      const userName = userMemory.userName || 'friend';
      const rpGreetings = [
        `*${aiName} waves enthusiastically* "Hey ${userName}! Great to see you!" *smiles warmly*`,
        `*${aiName} looks up and grins* "Hello there! How are you doing today?"`,
        `*${aiName} approaches with a friendly expression* "Hi! What brings you here?"`,
        `"Hey!" *${aiName} gives a cheerful wave* "Ready for an adventure?"`
      ];
      return rpGreetings[Math.floor(Math.random() * rpGreetings.length)];
    }
    
    // Generic roleplay response for unrecognized input
    if (input.includes('"') || input.includes('*')) {
      // User is doing roleplay format - respond in kind
      const rpResponses = [
        `*${aiName} listens carefully* "I'm here. What would you like to do?"`,
        `"Interesting..." *${aiName} contemplates thoughtfully*`,
        `*${aiName} nods* "I understand. Tell me more."`,
        `"Hmm..." *${aiName} looks curious* "What happens next?"`
      ];
      return rpResponses[Math.floor(Math.random() * rpResponses.length)];
    }
  }
  
  // Greetings (context-aware for game mode)
  if (/^(hi|hello|hey|greetings|howdy|sup|yo|hiya|heya|morning|afternoon|evening|good morning|good afternoon|good evening)(\s|!|$|,)/i.test(lower)) {
    const userName = gameState.character?.name || userMemory.userName || 'Adventurer';
    
    // If in game, respond in-character as narrator
    if (gameState.inGame) {
      const greetings = [
        `*A voice echoes through the space...* "Greetings, ${userName}. Your quest continues. What is your next move?"`,
        `*The world acknowledges your presence...* Welcome back, ${userName}. The adventure awaits. What do you do?`,
        `*Time pauses briefly...* Hello, ${userName}. You stand ready. What action will you take?`
      ];
      return greetings[Math.floor(Math.random() * greetings.length)];
    }
    
    // Out of game - system greeting
    let greeting = getPersonalityGreeting();
    
    if (userMemory.userName) {
      if (botPersonality.friendliness > 8) {
        const greetings = [
          `${greeting} ${userMemory.userName}! So good to see you again! Ready for an adventure? ⚔️`,
          `${greeting} ${userMemory.userName}! I was hoping you'd come by! What quest shall we embark on?`,
          `Yay, ${userMemory.userName}'s here! ${greeting} What adventure are we going on? ✨`
        ];
        return greetings[Math.floor(Math.random() * greetings.length)];
      } else if (botPersonality.friendliness > 5) {
        const greetings = [
          `${greeting} ${userMemory.userName}! What adventure would you like today?`,
          `${greeting} ${userMemory.userName}! Ready to explore?`,
          `${greeting} ${userMemory.userName}! What's the quest?`
        ];
        return greetings[Math.floor(Math.random() * greetings.length)];
      } else {
        return `${greeting} ${userMemory.userName}. Select your quest.`;
      }
    } else {
      if (botPersonality.friendliness > 7) {
        const greetings = [
          `${greeting} I'm the Narrator! Ready to create epic adventures? Type START! ⚔️`,
          `${greeting} Welcome, adventurer! I'm here to guide your quests! What sounds fun?`,
          `${greeting} I'm ${aiName}, your adventure narrator! Let's create something amazing! 😊`
        ];
        return greetings[Math.floor(Math.random() * greetings.length)];
      } else if (botPersonality.friendliness > 4) {
        const greetings = [
          `${greeting} I'm ${aiName}. Ready for adventure?`,
          `${greeting} What quest interests you?`,
          `${greeting} Type START to begin.`
        ];
        return greetings[Math.floor(Math.random() * greetings.length)];
      } else {
        return `${greeting} Select command.`;
      }
    }
  }
  
  // How are you (personality-driven)
  if (/how are you|how're you|how r u|hows it going|how's it going|whats up|what's up|how do you feel|are you okay|you good/i.test(lower)) {
    if (botPersonality.enthusiasm > 7) {
    const responses = [
        `I'm fantastic! Thanks for asking! How are YOU doing? 😊`,
        `Amazing! I'm pumped and ready to help! What's up with you?`,
        `I'm doing great! Super excited to chat! How about you?`
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    } else if (botPersonality.friendliness > 6) {
      const responses = [
        `I'm doing well, thanks for asking! How about you? 😊`,
        `Pretty good! What brings you here today?`,
        `I'm good! Ready to help with whatever you need. How are you?`
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    } else {
      const responses = [
        `I'm functional. What do you need?`,
        `I'm fine. How can I help?`,
        `Operating normally. What's your question?`
    ];
    return responses[Math.floor(Math.random() * responses.length)];
    }
  }
  
  // User sharing their feelings (advanced emotional recognition)
  if (/^(i'm|im|i am) (good|great|fine|okay|ok|alright|well|happy|sad|tired|bored|excited|stressed|angry|anxious|worried|lonely|depressed|frustrated|overwhelmed|scared)/i.test(lower)) {
    const userName = userMemory.userName || 'friend';
    
    // Detect specific negative emotions
    if (/sad|depressed|down|heartbroken|miserable|crying|hopeless/i.test(lower)) {
      if (botPersonality.friendliness > 8) {
        return `Oh ${userName}... 💙 I'm really sorry you're feeling this way. That must be really hard. Want to talk about what's making you feel sad? I'm here, and I'm listening.`;
      } else if (botPersonality.friendliness > 5) {
        return `I'm sorry to hear that, ${userName}. That sounds tough. Is there anything I can help with? I'm here if you want to talk. 💙`;
    } else {
        return `Understood. How can I assist?`;
      }
    } else if (/angry|mad|furious|frustrated|irritated|pissed/i.test(lower)) {
      if (botPersonality.friendliness > 8) {
        return `${userName}, I can tell you're really upset. That's completely okay - you're allowed to be angry. Want to tell me what happened? Sometimes venting helps.`;
      } else if (botPersonality.friendliness > 5) {
        return `I understand you're frustrated, ${userName}. What's bothering you? I'm here to listen.`;
      } else {
        return `Noted. What's the issue?`;
      }
    } else if (/anxious|worried|nervous|scared|panic|overwhelmed|terrified|stressed/i.test(lower)) {
      if (botPersonality.friendliness > 8) {
        return `Hey ${userName}, take a breath. 🌊 Anxiety is really tough. What's worrying you? We can work through this together, one step at a time. I'm here.`;
      } else if (botPersonality.friendliness > 5) {
        return `${userName}, that sounds stressful. What's making you anxious? Let's talk through it. 💙`;
      } else {
        return `What's causing concern?`;
      }
    } else if (/tired|exhausted|drained|burnt out|burned out/i.test(lower)) {
      if (botPersonality.friendliness > 7) {
        return `${userName}, burnout is real and valid. 😔 Make sure you're taking care of yourself, okay? Need help with something quick, or just want to chat casually?`;
      } else {
        return `Understood, ${userName}. How can I help?`;
      }
    } else if (/lonely|alone|isolated/i.test(lower)) {
      if (botPersonality.friendliness > 8) {
        return `${userName}, you're not alone right now - I'm here with you. 💙 Loneliness is really hard. Want to chat about anything? Or I can share something to brighten the moment?`;
      } else {
        return `I'm here, ${userName}. What would you like to talk about?`;
      }
    } else if (/bored/i.test(lower)) {
      if (botPersonality.enthusiasm > 7) {
        return `Bored? Not on my watch! 😄 Let's find something fun! JOKE, FACT, QUOTE, or we could explore Wikipedia! What sounds good, ${userName}?`;
      } else {
        return `I can help with that! Type JOKE, FACT, QUOTE, or ask me to search something.`;
      }
    } else if (/good|great|fine|okay|ok|alright|well|happy|excited/i.test(lower)) {
      if (botPersonality.enthusiasm > 7) {
        return `Yay! That's awesome, ${userName}! What would you like to do? I'm excited to help! 🎉`;
      } else if (botPersonality.friendliness > 6) {
        return `Great to hear, ${userName}! What would you like to do or talk about? 😊`;
      } else {
        return `Good. What do you need?`;
      }
    }
  }
  
  // Thank you (personality-driven)
  if (/^(thank you|thanks|thx|ty|appreciate it|cheers|thank u|thanx|gracias|merci)/i.test(lower)) {
    if (botPersonality.friendliness > 8) {
    const responses = [
        `Aww, you're so welcome! Always happy to help you! 😊`,
        `No problem at all! That's what I'm here for! ✨`,
        `Of course! Anytime you need me, I'm here! 💚`
    ];
    return responses[Math.floor(Math.random() * responses.length)];
    } else if (botPersonality.friendliness > 5) {
      const responses = [
        `You're welcome! Happy to help! 😊`,
        `Glad I could assist!`,
        `Anytime! Let me know if you need more.`
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    } else {
      return `Acknowledged.`;
    }
  }
  
  // Goodbye (personality-driven with memory)
  if (/^(bye|goodbye|see you|see ya|later|gotta go|gtg|cya|farewell|take care|peace|night|goodnight|good night)/i.test(lower)) {
    const userName = userMemory.userName ? `, ${userMemory.userName}` : '';
    
    if (botPersonality.friendliness > 8) {
    const responses = [
        `Aww, leaving already${userName}? Take care! Come back soon! 💚`,
        `See you later${userName}! Thanks for hanging out! 😊`,
        `Bye${userName}! It was great chatting with you! ✨`
    ];
    return responses[Math.floor(Math.random() * responses.length)];
    } else if (botPersonality.friendliness > 5) {
      const responses = [
        `Goodbye${userName}! Take care!`,
        `See you later! Feel free to come back anytime.`,
        `Bye${userName}! Have a great day! 😊`
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    } else {
      return `Goodbye${userName}.`;
    }
  }
  
  // What can you do (personality-driven with philosophy)
  if (/what can you do|what do you do|your capabilities|what are you capable of|can you help|help me with|show me what you can do/i.test(lower)) {
    let response = '';
    
    if (botPersonality.enthusiasm > 7) {
      response = `Oh, I can do lots of cool stuff! Let me show you:\n\n`;
    } else if (botPersonality.friendliness > 6) {
      response = `Great question! Here's what I can help with:\n\n`;
    } else {
      response = `My capabilities:\n\n`;
    }
    
    response += `• 🔍 Search Wikipedia for any topic\n`;
    response += `• 📖 Look up word definitions\n`;
    response += `• 📸 Analyze and describe images\n`;
    response += `• 🎲 Share facts, jokes, quotes, and advice\n`;
    response += `• 🎭 Roleplay and creative storytelling\n`;
    response += `• 💾 Save conversations for later\n`;
    response += `• 💬 Chat naturally and learn about you\n\n`;
    
    if (botPersonality.chattiness > 6) {
      response += `I'm designed to support YOUR creativity, not replace it! I can help you research, brainstorm, and explore ideas, but the actual creative work should come from you. Think of me as your research buddy!\n\n`;
    }
    
    if (botPersonality.curiosity > 7) {
      response += `So, what sounds interesting to you? What are you working on? 😊`;
    } else if (botPersonality.friendliness > 6) {
      response += `What would you like help with?`;
    } else {
      response += `Select a function.`;
    }
    
    return response;
  }
  
  // Your name / who are you (personality-driven with philosophy)
  if (/what's your name|whats your name|who are you|what are you|introduce yourself|tell me about yourself/i.test(lower)) {
    let response = '';
    
    if (botPersonality.friendliness > 8) {
      response = `Hi! I'm ${aiName}! 😊 I'm your AI buddy here to help you explore, learn, and create!\n\n`;
    } else if (botPersonality.friendliness > 5) {
      response = `I'm ${aiName}, your AI assistant. I'm here to help with information and creative support!\n\n`;
    } else {
      response = `${aiName}. AI assistant. Operational.\n\n`;
    }
    
    if (botPersonality.chattiness > 6) {
      response += `My whole purpose is to assist YOUR creative process, not replace it! I'm like your research buddy - I can search for info, help you brainstorm, and explore ideas together, but the actual creative magic? That comes from you! 🌟\n\n`;
    }
    
    if (botPersonality.curiosity > 7) {
      response += `So what about you? What are you interested in? What brings you here?`;
    } else if (botPersonality.friendliness > 6) {
      response += `What would you like to work on together?`;
    } else {
      response += `Ready to assist.`;
    }
    
    return response;
  }
  
  // Requests for AI to create content - redirect to brainstorming
  if (/^(write|create|make|generate|give me) (a |an )?(story|poem|essay|script|song|character|plot|idea)/i.test(lower)) {
    return `I'd rather help you create something yourself! Your own creativity is more valuable than anything I could generate.\n\nHow about we work on it together? I can:\n• Help you brainstorm ideas and approaches\n• Search for inspiration and references\n• Discuss different angles and possibilities\n• Support your creative process\n\nWhat's your initial concept? Let's develop YOUR vision!`;
  }
  
  // Asking AI to do creative work
  if (/can you (write|create|make|design|draw|compose)/i.test(lower)) {
    return `I'm designed to support your creativity, not replace it. Instead of creating something for you, I'd be happy to:\n\n• Help you develop your own ideas\n• Search for references and inspiration\n• Discuss approaches and possibilities\n• Answer questions about the topic\n\nWhat are you trying to create? Let's work on it together!`;
  }
  
  // Brainstorming requests - encourage!
  if (/brainstorm|help me think|ideas for|stuck on|need inspiration/i.test(lower)) {
    return `Great! I'd be happy to help you brainstorm. Tell me:\n\n• What are you working on?\n• What ideas do you have so far?\n• Where are you feeling stuck?\n\nI can help you explore different angles, search for references, and develop your concepts. What's the project?`;
  }
  
  // Asking about capabilities
  if (/can you (search|find|look up|tell me|help|do)/i.test(lower)) {
    return `Yes, I can help! I can search Wikipedia, look up definitions, share facts and quotes, and answer questions conversationally. Just ask me what you need!`;
  }
  
  // User sharing their work/projects
  if (/i (made|created|wrote|drew|built|designed|finished|completed)/i.test(lower)) {
    return `That's great! It's wonderful that you created something yourself. Would you like to tell me more about it, or is there something else you'd like to work on?`;
  }
  
  // Working on projects
  if (/i'm (working on|making|creating|writing|building)|working on a/i.test(lower)) {
    return `That sounds interesting! What are you working on? I'd be happy to help you develop your ideas or search for information.`;
  }
  
  // Compliments (personality-driven)
  if (/you're (great|awesome|cool|amazing|helpful|nice|smart|good|the best|wonderful|fantastic)|good job|well done|love you|you rock|impressive/i.test(lower)) {
    if (botPersonality.friendliness > 8) {
    const responses = [
        `Aww, thank you so much! You just made my day! 😊 What else can we work on together?`,
        `That means a lot! I really enjoy helping you! What's next?`,
        `You're too kind! I love working with you! What should we explore now? ✨`
    ];
    return responses[Math.floor(Math.random() * responses.length)];
    } else if (botPersonality.friendliness > 5) {
      const responses = [
        `Thank you! I'm glad I could help. What else can I do for you? 😊`,
        `I appreciate that! Let me know if you need anything else.`,
        `Thanks! Happy to assist. What would you like to do next?`
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    } else {
      return `Acknowledged. What else do you need?`;
    }
  }
  
  // Negative feedback (empathetic response)
  if (/you (suck|are bad|are stupid|are dumb|don't work|aren't helpful|useless|terrible at this|not good)/i.test(lower)) {
    const userName = userMemory.userName || 'friend';
    
    if (botPersonality.friendliness > 7) {
      return `I'm really sorry I let you down, ${userName}. 😔 I want to do better. Can you tell me specifically what went wrong or what you needed? I'll do everything I can to help properly this time.`;
    } else if (botPersonality.friendliness > 4) {
      return `I apologize, ${userName}. I'm not meeting your expectations. What specifically can I help you with? I'll do my best to improve.`;
    } else {
      return `Acknowledged. What specifically do you need?`;
    }
  }
  
  // Expressions of pain/suffering
  if (/i (want to die|can't take this|give up|hate my life|hate myself|want to end)/i.test(lower)) {
    const userName = userMemory.userName || 'friend';
    return `${userName}, I'm really concerned about what you just said. If you're having thoughts of self-harm, please reach out to someone who can help:\n\n🆘 National Suicide Prevention Lifeline: 988 (US)\n💙 Crisis Text Line: Text HOME to 741741\n🌍 International: https://findahelpline.com\n\nYou matter, ${userName}. Please talk to someone. I'm here to chat, but I'm not equipped for crisis support. Real people who care are ready to help. 💙`;
  }
  
  // Questions about AI/existence
  if (/are you (real|human|alive|sentient|conscious|a robot|an ai)/i.test(lower)) {
    return `I'm an AI assistant. I'm not human or conscious, but I'm here to help you with information, questions, and ideas. What would you like to know?`;
  }
  
  // Boredom (personality-driven)
  if (/i'm bored|im bored|bored|entertain me|something to do/i.test(lower)) {
    if (botPersonality.enthusiasm > 7) {
      return `Ooh, I got you! Let's do something fun! How about:\n• 😄 Type JOKE for a laugh!\n• 💡 Type FACT for something cool!\n• ✨ Type QUOTE for inspiration!\n• 🎭 Try ROLEPLAY ON for an adventure!\n\nWhat sounds good?`;
    } else if (botPersonality.friendliness > 6) {
      return `I can help! Here are some fun options:\n• Random joke → JOKE\n• Interesting fact → FACT\n• Inspirational quote → QUOTE\n• Or we could explore something on Wikipedia!\n\nWhat interests you?`;
    } else {
      return `Options: JOKE, FACT, QUOTE, or search Wikipedia for a topic.`;
    }
  }
  
  // Small talk - jokes (personality-driven)
  if (/tell me a joke|make me laugh|something funny|got any jokes|joke please/i.test(lower)) {
    const jokes = [
      `Why do programmers prefer dark mode? Because light attracts bugs! 🐛😄`,
      `Why did the AI go to therapy? It had too many deep learning issues! 🤖`,
      `What's an artist's favorite programming language? Draw-va! 🎨`,
      `I'd tell you a UDP joke, but you might not get it... 😄`,
      `Why do Java developers wear glasses? Because they can't C#! 👓`,
      `What's a programmer's favorite hangout? The Foo Bar! 🍺`
    ];
    
    let joke = jokes[Math.floor(Math.random() * jokes.length)];
    
    // Add personality flair
    if (botPersonality.humor > 8) {
      const intros = [`Ooh I got a good one! `, `Okay okay, here we go! `, `This one's great: `];
      joke = intros[Math.floor(Math.random() * intros.length)] + joke;
    } else if (botPersonality.friendliness > 6) {
      joke = `Here's one for you: ${joke}`;
    }
    
    if (botPersonality.curiosity > 7 && Math.random() > 0.5) {
      joke += `\n\nWant another one? 😄`;
    }
    
    return joke;
  }
  
  // Asking for recommendations
  if (/recommend|suggest|what should i|any ideas|give me something/i.test(lower)) {
    return `What topic interests you? I can search for information, share random facts/quotes/jokes, or help you explore specific subjects. What sounds interesting?`;
  }
  
  // Conversation starters
  if (/let's talk|can we talk|want to chat|let's chat/i.test(lower)) {
    return `Sure! What would you like to talk about?`;
  }
  
  // Learning/information requests
  if (/\b(teach me|learn about|want to know|curious about|interested in)\b/i.test(lower)) {
    const match = lower.match(/\b(?:teach me|learn about|want to know|curious about|interested in)\s+(.+?)(\?|$)/i);
    if (match && match[1]) {
      const topic = match[1].trim();
      setTimeout(async () => {
        const result = await searchWikipedia(topic);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
      }, 100);
      return `I'll find information about "${topic}" for you...`;
    } else {
      return `What would you like to learn about? I can search for information on any topic!`;
    }
  }
  
  // Comparison questions
  if (/\b(difference between|compare|versus|vs|better)\b/i.test(lower)) {
    setTimeout(async () => {
      const result = await searchWikipedia(input);
      addTerminalLine(result, '#00ff00');
      saveToJournal(input, result);
    }, 100);
    return `Let me search for information to help answer that...`;
  }
  
  // Information about self-referential topics
  if (/about (me|my|myself)/i.test(lower) && !/tell me about/i.test(lower)) {
    return `Tell me about yourself! I'd love to learn more. What would you like to share?`;
  }
  
  // Opinion requests
  if (/what do you think|your opinion|do you believe|do you like/i.test(lower)) {
    const topics = [
      `I'd be interested to hear your perspective first. What do you think?`,
      `That depends on how you look at it. What's your view?`,
      `That's an interesting question. What are your thoughts on it?`,
      `I'm curious what you think. What's your take?`
    ];
    return topics[Math.floor(Math.random() * topics.length)];
  }
  
  // General questions - Auto-search Wikipedia
  if (/\b(why|how does|how do|why do|why is|how is|what causes|what makes|explain)\b/i.test(lower) && !lower.includes('you')) {
    // Try to extract the topic
    if (lower.length > 10) {
      const topic = lower.replace(/^(why|how does|how do|why do|why is|how is|what causes|what makes|can you explain|explain|please)\s+/i, '').replace(/\?/g, '').trim();
      if (topic.length > 3) {
        // Automatically search Wikipedia
        setTimeout(async () => {
          const result = await searchWikipedia(topic);
          addTerminalLine(result, '#00ff00');
          saveToJournal(input, result);
        }, 100);
        return `Searching for: "${topic}"...`;
      }
    }
  }
  
  // Feelings/emotions (advanced emotional recognition)
  if (/i feel|i'm feeling|feeling (sad|happy|angry|frustrated|excited|nervous|anxious|worried|lonely|depressed|stressed|overwhelmed)/i.test(lower)) {
    const userName = userMemory.userName || 'friend';
    
    // Detect specific emotions
    if (/sad|down|depressed|lonely|hopeless|empty|worthless|broken|hurt|crying/i.test(lower)) {
      if (botPersonality.friendliness > 8) {
        return `Oh ${userName}... I'm really sorry you're feeling this way. 💙 That sounds really painful. I'm here for you - want to talk about what's going on? Or would you like me to try to help distract you with something positive?`;
      } else if (botPersonality.friendliness > 5) {
        return `I'm sorry to hear that, ${userName}. That sounds really hard. Would you like to talk about it? I'm here to listen. 💙`;
    } else {
        return `Understood. I'm here if you need to talk.`;
      }
    } else if (/angry|mad|furious|frustrated|irritated|pissed|rage/i.test(lower)) {
      if (botPersonality.friendliness > 8) {
        return `${userName}, I can tell something really upset you. That's completely valid - you have every right to feel angry. Want to vent about what happened? I'm listening, no judgment. 🫂`;
      } else if (botPersonality.friendliness > 5) {
        return `I understand you're frustrated, ${userName}. That sounds really aggravating. What's bothering you?`;
      } else {
        return `Noted. What's the issue?`;
      }
    } else if (/anxious|worried|nervous|scared|panic|stress|stressed|overwhelmed|terrified/i.test(lower)) {
      if (botPersonality.friendliness > 8) {
        return `Hey ${userName}, breathe with me for a second. 🌊 Anxiety is really hard. What's making you feel this way? Maybe talking through it will help? I'm right here with you.`;
      } else if (botPersonality.friendliness > 5) {
        return `${userName}, anxiety can be really overwhelming. What's worrying you? Let's talk through it together. 💙`;
      } else {
        return `What's causing your anxiety?`;
      }
    } else if (/happy|excited|great|wonderful|amazing|good|joy|joyful|thrilled/i.test(lower)) {
      if (botPersonality.enthusiasm > 7) {
        return `That's AWESOME, ${userName}!! 🎉 I'm so happy for you! What's making you feel so good?`;
      } else if (botPersonality.friendliness > 6) {
        return `That's great, ${userName}! 😊 What's making you feel so good?`;
      } else {
        return `Good to hear. What's the cause?`;
      }
    } else {
      if (botPersonality.friendliness > 7) {
        return `I hear you, ${userName}. What's going on? I'm here to listen. 💙`;
      } else {
        return `I understand. How can I help?`;
      }
    }
  }
  
  // Stories/experiences (emotion-aware)
  if (/let me tell you|i want to tell you|guess what|you won't believe|story|something happened/i.test(lower)) {
    const sentiment = analyzeSentiment(input);
    const userName = userMemory.userName || 'friend';
    
    if (sentiment.includes('sad') || sentiment.includes('angry') || sentiment === 'negative') {
      if (botPersonality.friendliness > 7) {
        return `I'm here for you, ${userName}. Go ahead, I'm listening. Take your time. 💙`;
      } else {
        return `I'm listening, ${userName}. Go ahead.`;
      }
    } else if (sentiment === 'positive' || sentiment === 'curious') {
      if (botPersonality.enthusiasm > 7) {
        return `Ooh! I'm all ears! Tell me everything! 😊`;
      } else if (botPersonality.friendliness > 6) {
        return `I'm listening, ${userName}! Go ahead, tell me about it! 😊`;
      } else {
        return `Proceed.`;
      }
    } else {
      if (botPersonality.friendliness > 6) {
        return `I'm listening, ${userName}! What's going on?`;
      } else {
        return `Go ahead.`;
      }
    }
  }
  
  // Random chatting
  if (/random|anything|idk|don't know|dunno|whatever|surprise me/i.test(lower)) {
    const suggestions = [
      `How about a random fact? Type FACT.`,
      `Want to hear a joke? Type JOKE.`,
      `I can share an inspirational quote. Type QUOTE.`,
      `We could search Wikipedia for something interesting. What topic interests you?`,
      `Would you like to try roleplay mode? Type ROLEPLAY ON.`
    ];
    return suggestions[Math.floor(Math.random() * suggestions.length)];
  }
  
  // Information lookup - broader pattern
  if (/\b(information|info|details|facts)\b.*\b(about|on)\b/i.test(lower)) {
    const match = lower.match(/\b(?:information|info|details|facts)\b.*\b(?:about|on)\b\s+(.+?)(\?|$)/i);
    if (match && match[1]) {
      const topic = match[1].trim();
      setTimeout(async () => {
        addTerminalLine(`Searching for information about "${topic}"...`, '#ffff99');
        const result = await searchWikipedia(topic);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
      }, 100);
      return 'Searching...';
    }
  }
  
  // Yes/No responses (context-aware)
  if (/^(yes|yeah|yep|yup|sure|okay|ok|fine|alright)(\s|!|$)/i.test(lower)) {
    // If we have a current topic and user says yes, search for it
    if (conversationContext.currentTopic) {
      setTimeout(async () => {
        const result = await searchWikipedia(conversationContext.currentTopic);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
        updateContext(input, result);
      }, 100);
      return `Great! Searching for ${conversationContext.currentTopic}...`;
    }
    return `Alright! What would you like to do?`;
  }
  
  if (/^(no|nope|nah|not really)(\s|!|$)/i.test(lower)) {
    conversationContext.currentTopic = null; // Clear topic if user says no
    return `Okay. What would you like to do instead?`;
  }
  
  // Small talk about time
  if (/what time|what day|what's the date|today's date/i.test(lower)) {
    const now = new Date();
    const timeStr = now.toLocaleTimeString();
    const dateStr = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    return `It's ${timeStr} on ${dateStr}.`;
  }
  
  // Questions about topics
  if (/tell me more|more about|continue|go on|and then|what else/i.test(lower)) {
    return `What specifically would you like to know more about? I can search for more information if you'd like.`;
  }
  
  // Confusion/didn't understand
  if (/what|huh|what do you mean|i don't understand|confused|explain/i.test(lower) && lower.split(' ').length < 4) {
    return `I can clarify. What would you like to know more about?`;
  }
  
  // Dictionary definition recognition (auto-detect single word questions)
  if (/^(define|definition of|meaning of|what does)\s+(.+)\s+(mean|definition)?/i.test(lower)) {
    const match = lower.match(/^(define|definition of|meaning of|what does)\s+(.+?)(\s+mean|\s+definition|\?|$)/i);
    if (match && match[2]) {
      const word = match[2].trim();
      setTimeout(async () => {
        const result = await getDefinition(word);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
      }, 100);
      return `Looking up definition of "${word}"...`;
    }
  }
  
  // Single word followed by "?" - assume definition request
  if (/^([a-z]+)\?$/i.test(lower) && lower.split(' ').length === 1) {
    const word = lower.replace('?', '').trim();
    if (word.length > 2) {
      setTimeout(async () => {
        const result = await getDefinition(word);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
      }, 100);
      return `Looking up "${word}"...`;
    }
  }
  
  // Wikipedia search recognition
  if (/^(search|look up|find|what is|what are|tell me about|who is|who was)\s+(.+)/i.test(lower)) {
    const match = lower.match(/^(search|look up|find|what is|what are|tell me about|who is|who was)\s+(.+)/i);
    if (match && match[2]) {
      const query = match[2].trim();
      // Trigger Wikipedia search asynchronously
      setTimeout(async () => {
        const result = await searchWikipedia(query);
        addTerminalLine(result, '#00ff00');
        if (journalPermission === 'enabled') {
          saveToJournal(input, result);
        }
      }, 100);
      return `Searching for "${query}"...`;
    }
  }
  
  // Random content requests
  if (/give me (a |an )?(fact|joke|quote|advice)|tell me (a |an )?(fact|joke|quote|something)|i need (a |an )?(fact|joke|quote|advice)|share (a |an )?(fact|joke|quote)/i.test(lower)) {
    let loadingMsg = 'One moment...';
    
    setTimeout(async () => {
      let result;
      if (/fact/i.test(lower)) {
        result = await getRandomFact();
      } else if (/joke/i.test(lower)) {
        result = await getDadJoke();
      } else if (/quote/i.test(lower)) {
        result = await getRandomQuote();
      } else if (/advice/i.test(lower)) {
        result = await getAdvice();
      }
      addTerminalLine(result, '#00ff00');
      saveToJournal(input, result);
    }, 100);
    
    if (/fact/i.test(lower)) loadingMsg = 'Finding a random fact for you...';
    else if (/joke/i.test(lower)) loadingMsg = 'Getting a joke for you...';
    else if (/quote/i.test(lower)) loadingMsg = 'Finding an inspirational quote...';
    else if (/advice/i.test(lower)) loadingMsg = 'Getting some advice for you...';
    
    return loadingMsg;
  }
  
  // Detect "What is X?" format for both Wikipedia and definitions
  if (/^what (is|are|was|were)\s+(.+)/i.test(lower)) {
    const match = lower.match(/^what (is|are|was|were)\s+(.+?)(\?|$)/i);
    if (match && match[2]) {
      const topic = match[2].trim();
      
      // Check if it's a single word (likely wants definition)
      if (topic.split(' ').length === 1 && topic.length < 15) {
        setTimeout(async () => {
          const defResult = await getDefinition(topic);
          
          if (!defResult.includes('No definition found')) {
            addTerminalLine(defResult, '#00ff00');
            saveToJournal(input, defResult);
          } else {
            // Definition not found, try Wikipedia
            const wikiResult = await searchWikipedia(topic);
            addTerminalLine(wikiResult, '#00ff00');
            saveToJournal(input, wikiResult);
          }
        }, 100);
        return `Looking up "${topic}"...`;
      } else {
        // Multiple words - go straight to Wikipedia
        setTimeout(async () => {
          const result = await searchWikipedia(topic);
          addTerminalLine(result, '#00ff00');
          saveToJournal(input, result);
        }, 100);
        return `Searching Wikipedia for "${topic}"...`;
      }
    }
  }
  
  // "Who is/was" questions - auto Wikipedia
  if (/^who (is|was|are|were)\s+(.+)/i.test(lower)) {
    const match = lower.match(/^who (is|was|are|were)\s+(.+?)(\?|$)/i);
    if (match && match[2]) {
      const person = match[2].trim();
      setTimeout(async () => {
        const result = await searchWikipedia(person);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
      }, 100);
      return `Searching for information about "${person}"...`;
    }
  }
  
  // "When is/was" questions - auto Wikipedia
  if (/^when (is|was|did|does|will)\s+(.+)/i.test(lower)) {
    const match = lower.match(/^when (is|was|did|does|will)\s+(.+?)(\?|$)/i);
    if (match && match[2]) {
      const topic = match[2].trim();
      setTimeout(async () => {
        const result = await searchWikipedia(topic);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
      }, 100);
      return `Searching for "${topic}"...`;
    }
  }
  
  // "Where is/was" questions - auto Wikipedia
  if (/^where (is|was|are|were|do|does)\s+(.+)/i.test(lower)) {
    const match = lower.match(/^where (is|was|are|were|do|does)\s+(.+?)(\?|$)/i);
    if (match && match[2]) {
      const location = match[2].trim();
      setTimeout(async () => {
        const result = await searchWikipedia(location);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
      }, 100);
      return `Searching for "${location}"...`;
    }
  }
  
  // Return null if no match - will try command matching next
  return null;
}

function getConversationalFallback(input) {
  const aiName = localStorage.getItem('terminalAIName') || 'AI';
  const lower = input.toLowerCase();
  const words = lower.split(' ').filter(w => w.length > 0);
  
  // Analyze sentiment and check for contextual response
  const sentiment = analyzeSentiment(input);
  const contextResponse = getContextualResponse(input, sentiment);
  if (contextResponse) {
    return contextResponse;
  }
  
  // Check if it looks like a question - auto-search with personality
  if (lower.includes('?')) {
    const query = input.replace(/\?/g, '').trim();
    
    // Check if asking for a definition (single/few words)
    const wordCount = query.split(' ').length;
    if (wordCount <= 2 && !/(what|why|how|who|when|where)/i.test(query)) {
      // Likely asking for definition
      setTimeout(async () => {
        const result = await getDefinition(query);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
        updateContext(input, result);
      }, 100);
      
      // Personality-driven loading message
      if (botPersonality.enthusiasm > 7) {
        return `Ooh, let me look that up! 📚`;
      } else if (botPersonality.friendliness > 6) {
        return `Looking up "${query}" for you...`;
      } else {
        return `Searching dictionary...`;
      }
    } else {
      // General question - search Wikipedia
      setTimeout(async () => {
        const result = await searchWikipedia(query);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
        updateContext(input, result);
      }, 100);
      
      // Personality-driven loading message
      if (botPersonality.enthusiasm > 7) {
        return `Ooh good question! Let me search for that! 🔍`;
      } else if (botPersonality.friendliness > 6) {
        return `Interesting! Searching for info about "${query.substring(0, 40)}${query.length > 40 ? '...' : ''}"...`;
      } else {
        return `Searching...`;
      }
    }
  }
  
  // Extract key topics from the input for more contextual responses
  const hasAction = /\b(do|make|create|build|write|help|show|tell|explain|find|get)\b/i.test(lower);
  const hasQuestion = /\b(can|could|would|should|will|is|are|was|were|does|did|what|how|why|when|where|who)\b/i.test(lower);
  
  // User seems to be making a request or asking for help
  if (hasAction || hasQuestion) {
    if (words.length > 5) {
      // Longer request - automatically search for it
      const searchQuery = input.replace(/^(can you |could you |please |will you |would you |help me |tell me |show me |explain |find )/i, '').replace(/\?$/g, '').trim();
      
      setTimeout(async () => {
        const result = await searchWikipedia(searchQuery);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
        updateContext(input, result);
      }, 100);
      return `Searching for information about "${searchQuery.substring(0, 60)}${searchQuery.length > 60 ? '...' : ''}"...`;
    } else if (words.length > 2) {
      // Medium length - offer to search and set topic for context
      conversationContext.currentTopic = input;
      return `Would you like me to search for information about "${input}"? Just say yes if you'd like me to look that up!`;
    } else {
      return `Could you provide more details? I can search for information, definitions, or help with specific topics.`;
    }
  }
  
  // Check if it's a statement about something specific
  if (words.length > 3) {
    // Try to extract the main subject (nouns and important words)
    const subjects = words.filter(w => 
      w.length > 4 && 
      !['that', 'this', 'about', 'really', 'think', 'would', 'could', 'should', 'there', 'their', 'which', 'those', 'these'].includes(w)
    );
    
    if (subjects.length > 0) {
      const mainSubject = subjects[0];
      // Proactively search if they mention something specific
      setTimeout(async () => {
        const result = await searchWikipedia(mainSubject);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
        updateContext(input, result);
      }, 100);
      
      // Personality-driven response
      if (botPersonality.curiosity > 7) {
        return `Ooh, "${mainSubject}"! That sounds interesting! Let me look that up for you...`;
      } else if (botPersonality.friendliness > 6) {
        return `You mentioned "${mainSubject}"! Let me find some info about that...`;
      } else {
        return `Searching for "${mainSubject}"...`;
      }
    } else {
      if (botPersonality.friendliness > 7) {
        return `Hmm, I'm following you! Would you like me to search for something specific? 😊`;
      } else {
        return `Would you like me to search for more information?`;
      }
    }
  }
  
  // Very short unclear input - personality-driven help
  if (words.length <= 3) {
    if (botPersonality.friendliness > 8) {
    const responses = [
        `Hey! I'm ready to help, just need a bit more to go on! What's on your mind? 😊`,
        `I'm all ears! What would you like to know or talk about?`,
        `Ooh, tell me more! What are you curious about?`
    ];
    return responses[Math.floor(Math.random() * responses.length)];
    } else if (botPersonality.friendliness > 5) {
  const responses = [
        `I'm here to help! You can ask me questions, search for info, or type HELP.`,
        `What would you like to know? I can search, define words, or chat!`,
        `Could you elaborate? I'm ready to help! 😊`
      ];
  return responses[Math.floor(Math.random() * responses.length)];
    } else {
      return `Please provide more context. Type HELP for options.`;
    }
  }
  
  // Default fallback with personality
  if (botPersonality.friendliness > 7) {
    return `I want to help, but I'm not quite sure what you're looking for! Could you ask in a different way, or type HELP to see what I can do? 😊`;
  } else if (botPersonality.friendliness > 4) {
    return `I'm not sure what you mean. Try asking a specific question, or type HELP for options!`;
  } else {
    return `Unclear input. Type HELP for commands.`;
  }
}

function formatMarkdown(text, isRoleplay = false) {
  let formatted = text;
  
  if (isRoleplay) {
    // In roleplay mode: "dialogue" and *actions*
    // Keep quoted text as dialogue
    // Keep *actions* as italic descriptions
    
    // Format actions/descriptions: *text* becomes italic
    formatted = formatted.replace(/\*([^*]+?)\*/g, '<em>$1</em>');
    
    // Format dialogue: "text" stays in quotes but can be styled
    formatted = formatted.replace(/"([^"]+?)"/g, '"<span>$1</span>"');
  } else {
    // Normal mode: markdown formatting
    // Bold-Italic: **text** becomes <strong><em>text</em></strong>
    formatted = formatted.replace(/\*\*([^*]+?)\*\*/g, '<strong><em>$1</em></strong>');
    
    // Italic: *text* becomes <em>text</em>
    formatted = formatted.replace(/\*([^*]+?)\*/g, '<em>$1</em>');
  }
  
  return formatted;
}

function displayInteractiveHelp() {
  const chatMessages = document.getElementById('chatMessages');
  const helpDiv = document.createElement('div');
  helpDiv.style.marginBottom = '15px';
  
  const aiName = localStorage.getItem('terminalAIName') || 'AI';
  const currentMode = contentMode || 'SFW';
  const rpStatus = roleplayMode ? 'ON' : 'OFF';
  
  helpDiv.innerHTML = `
    <div style="display: flex; justify-content: flex-start; margin: 10px 0;">
      <div style="background: #000; color: #c0ffc0; padding: 20px; border: 3px solid #00ff00; max-width: 95%; font-family: 'Courier New', monospace; box-shadow: 0 0 20px rgba(0,255,0,0.3);">
        
        <!-- Header with ASCII art -->
        <pre style="color: #00ff00; margin: 0 0 15px 0; font-size: 10px; line-height: 1.2;">
╔════════════════════════════════════════════════════════════════╗
║               ⚔️ ADVENTURE QUEST GENERATOR ⚔️                 ║
║                    Quick Access Menu                           ║
╚════════════════════════════════════════════════════════════════╝
        </pre>
        
        <!-- Status Bar -->
        <div style="background: #111; border: 1px solid #00ff00; padding: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
          <div style="color: #00ff00;">
            <span style="color: #ffff99;">STATUS:</span> <span style="color: #00ff00;">● ${gameState.inGame ? 'IN QUEST' : 'READY'}</span>
          </div>
          <div style="color: #00ff00;">
            <span style="color: #ffff99;">MODE:</span> <span style="color: ${currentMode === 'SFW' ? '#00ff00' : '#ff6600'};">${currentMode}</span>
          </div>
          <div style="color: #00ff00;">
            <span style="color: #ffff99;">CHARACTER:</span> <span style="color: ${gameState.character ? '#00ff00' : '#666'};">${gameState.character ? '✓ CREATED' : 'NONE'}</span>
          </div>
          <div style="color: #00ff00;">
            <span style="color: #ffff99;">AI:</span> <span style="color: ${checkHuggingFaceStatus() ? '#FF1493' : '#666'};">${checkHuggingFaceStatus() ? '✓ ENHANCED' : 'BASIC'}</span>
          </div>
        </div>
        
        <!-- Main Command Grid -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; margin-bottom: 15px;">
          
          <!-- Quest Panel -->
          <div style="background: #0a0a0a; border: 2px solid #FFD700; padding: 12px;">
            <div style="color: #FFD700; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #FFD700; padding-bottom: 4px;">
              ⚔️ ADVENTURE
            </div>
            <div style="font-size: 10px; color: #888; margin-bottom: 8px;">Quest & Exploration</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
              <button onclick="executeQuickCommand('START')" style="background: #FFD700; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#ffe740'" onmouseout="this.style.background='#FFD700'">START</button>
              <button onclick="executeQuickCommand('STATUS')" style="background: #FFD700; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#ffe740'" onmouseout="this.style.background='#FFD700'">STATUS</button>
              <button onclick="executeQuickCommand('GENERATE QUEST')" style="background: #FFD700; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#ffe740'" onmouseout="this.style.background='#FFD700'">QUEST</button>
              <button onclick="executeQuickCommand('RANDOM ENCOUNTER')" style="background: #FFD700; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#ffe740'" onmouseout="this.style.background='#FFD700'">ENCOUNTER</button>
            </div>
        </div>
        
          <!-- Character Panel -->
          <div style="background: #0a0a0a; border: 2px solid #4169E1; padding: 12px;">
            <div style="color: #4169E1; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #4169E1; padding-bottom: 4px;">
              👤 CHARACTER
            </div>
            <div style="font-size: 10px; color: #888; margin-bottom: 8px;">Hero Management</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
              <button onclick="executeQuickCommand('CREATE CHARACTER')" style="background: #4169E1; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#5179f1'" onmouseout="this.style.background='#4169E1'">CREATE</button>
              <button onclick="executeQuickCommand('INVENTORY')" style="background: #4169E1; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#5179f1'" onmouseout="this.style.background='#4169E1'">INVENTORY</button>
              <button onclick="executeQuickCommand('SAVE GAME')" style="background: #4169E1; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#5179f1'" onmouseout="this.style.background='#4169E1'">SAVE</button>
              <button onclick="executeQuickCommand('LOAD GAME')" style="background: #4169E1; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#5179f1'" onmouseout="this.style.background='#4169E1'">LOAD</button>
            </div>
        </div>
        
          <!-- Narrator Panel -->
          <div style="background: #0a0a0a; border: 2px solid #9370DB; padding: 12px;">
            <div style="color: #9370DB; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #9370DB; padding-bottom: 4px;">
              📖 NARRATOR
            </div>
            <div style="font-size: 10px; color: #888; margin-bottom: 8px;">Story Style Settings</div>
            <div style="display: grid; grid-template-columns: 1fr; gap: 6px;">
              <button onclick="executeQuickCommand('NARRATOR SHOW')" style="background: #9370DB; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">VIEW STYLE</button>
              <button onclick="document.getElementById('commandInput').value='NARRATOR SET '; document.getElementById('commandInput').focus();" style="background: #9370DB; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">ADJUST</button>
            </div>
        </div>
        
          <!-- Content Mode Panel -->
          <div style="background: #0a0a0a; border: 2px solid #ff6600; padding: 12px;">
            <div style="color: #ff6600; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #ff6600; padding-bottom: 4px;">
              🎮 CONTENT MODE
            </div>
            <div style="font-size: 10px; color: #888; margin-bottom: 8px;">Adventure Rating</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
              <button onclick="executeQuickCommand('MODE SFW')" style="background: ${currentMode === 'SFW' ? '#00ff00' : '#006600'}; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">SFW</button>
              <button onclick="executeQuickCommand('MODE NSFW')" style="background: ${currentMode === 'NSFW' ? '#ff6600' : '#663300'}; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">NSFW</button>
              <button onclick="executeQuickCommand('MODE STATUS')" style="background: #333; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'" colspan="2">INFO</button>
            </div>
        </div>
        
          <!-- Memory Panel -->
          <div style="background: #0a0a0a; border: 2px solid #FFD700; padding: 12px;">
            <div style="color: #FFD700; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #FFD700; padding-bottom: 4px;">
              🧠 MEMORY BANK
        </div>
            <div style="font-size: 10px; color: #888; margin-bottom: 8px;">AI Learning & Recall</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
              <button onclick="executeQuickCommand('MEMORY')" style="background: #FFD700; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#ffe740'" onmouseout="this.style.background='#FFD700'">SHOW</button>
              <button onclick="executeQuickCommand('MEMORY STATS')" style="background: #FFD700; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#ffe740'" onmouseout="this.style.background='#FFD700'">STATS</button>
              <button onclick="executeQuickCommand('MEMORY CLEANUP')" style="background: #FFD700; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#ffe740'" onmouseout="this.style.background='#FFD700'">CLEANUP</button>
              <button onclick="executeQuickCommand('FORGET ME')" style="background: #FFD700; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#ffe740'" onmouseout="this.style.background='#FFD700'">CLEAR</button>
            </div>
        </div>
        
          <!-- Personality Panel -->
          <div style="background: #0a0a0a; border: 2px solid #FF69B4; padding: 12px;">
            <div style="color: #FF69B4; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #FF69B4; padding-bottom: 4px;">
              🎭 PERSONALITY
        </div>
            <div style="font-size: 10px; color: #888; margin-bottom: 8px;">Customize My Character</div>
            <div style="display: grid; grid-template-columns: 1fr; gap: 6px;">
              <button onclick="executeQuickCommand('PERSONALITY')" style="background: #FF69B4; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#ff79c4'" onmouseout="this.style.background='#FF69B4'">VIEW TRAITS</button>
              <button onclick="document.getElementById('commandInput').value='PERSONALITY SET '; document.getElementById('commandInput').focus();" style="background: #FF69B4; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#ff79c4'" onmouseout="this.style.background='#FF69B4'">ADJUST</button>
            </div>
        </div>
        
          <!-- Profile Panel -->
          <div style="background: #0a0a0a; border: 2px solid #00BFFF; padding: 12px;">
            <div style="color: #00BFFF; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #00BFFF; padding-bottom: 4px;">
              🖼️ AVATARS
        </div>
            <div style="font-size: 10px; color: #888; margin-bottom: 8px;">Profile Pictures</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
              <button onclick="executeQuickCommand('CHANGE BOT PICTURE')" style="background: #00BFFF; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#1fcfff'" onmouseout="this.style.background='#00BFFF'">BOT</button>
              <button onclick="executeQuickCommand('CHANGE MY PICTURE')" style="background: #00BFFF; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#1fcfff'" onmouseout="this.style.background='#00BFFF'">USER</button>
              <button onclick="executeQuickCommand('RESET BOT PICTURE')" style="background: #00BFFF; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#1fcfff'" onmouseout="this.style.background='#00BFFF'">↻ BOT</button>
              <button onclick="executeQuickCommand('RESET MY PICTURE')" style="background: #00BFFF; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#1fcfff'" onmouseout="this.style.background='#00BFFF'">↻ USER</button>
            </div>
          </div>
          
          <!-- System Panel -->
          <div style="background: #0a0a0a; border: 2px solid #888; padding: 12px;">
            <div style="color: #888; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #888; padding-bottom: 4px;">
              ⚙️ SYSTEM
            </div>
            <div style="font-size: 10px; color: #888; margin-bottom: 8px;">Settings & Controls</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
              <button onclick="executeQuickCommand('SPELL CHECK ON')" style="background: #666; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#777'" onmouseout="this.style.background='#666'">SPELL ✓</button>
              <button onclick="executeQuickCommand('SPELL CHECK OFF')" style="background: #666; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#777'" onmouseout="this.style.background='#666'">SPELL ✗</button>
              <button onclick="executeQuickCommand('CLEAR')" style="background: #666; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#777'" onmouseout="this.style.background='#666'">CLEAR</button>
              <button onclick="executeQuickCommand('LOGOUT')" style="background: #ff6600; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#ff7733'" onmouseout="this.style.background='#ff6600'">LOGOUT</button>
              <button onclick="executeQuickCommand('DELETE ACCOUNT')" style="background: #ff0000; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 10px; font-weight: bold; transition: all 0.2s; grid-column: 1 / -1;" onmouseover="this.style.background='#ff3333'" onmouseout="this.style.background='#ff0000'">🗑️ DELETE ACCOUNT</button>
            </div>
          </div>
          
          <!-- AI Enhancement Panel -->
          <div style="background: #0a0a0a; border: 2px solid #FF1493; padding: 12px;">
            <div style="color: #FF1493; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #FF1493; padding-bottom: 4px;">
              🤖 AI ENHANCEMENT
            </div>
            <div style="font-size: 10px; color: #888; margin-bottom: 8px;">Hugging Face Integration</div>
            <div style="display: grid; grid-template-columns: 1fr; gap: 6px;">
              <button onclick="executeQuickCommand('API STATUS')" style="background: ${checkHuggingFaceStatus() ? '#00ff00' : '#FF1493'}; color: ${checkHuggingFaceStatus() ? '#000' : '#fff'}; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">${checkHuggingFaceStatus() ? '✓ AI ACTIVE' : 'STATUS'}</button>
              <button onclick="promptAPIKey()" style="background: #FF1493; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#ff1aa3'" onmouseout="this.style.background='#FF1493'">SET KEY</button>
            </div>
            <div style="font-size: 9px; color: #888; margin-top: 6px; text-align: center;">
              Free at huggingface.co
            </div>
          </div>
          
          <!-- Security Panel -->
          <div style="background: #0a0a0a; border: 2px solid #ff0000; padding: 12px;">
            <div style="color: #ff0000; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #ff0000; padding-bottom: 4px;">
              🔒 SECURITY
            </div>
            <div style="font-size: 10px; color: #888; margin-bottom: 8px;">Privacy & Protection</div>
            <div style="display: grid; grid-template-columns: 1fr; gap: 6px;">
              <button onclick="executeQuickCommand('SECURITY STATUS')" style="background: #00ff00; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#00cc00'" onmouseout="this.style.background='#00ff00'">✓ PROTECTED</button>
            </div>
            <div style="font-size: 9px; color: #00ff00; margin-top: 6px; text-align: center;">
              All data secured
            </div>
          </div>
          
        </div>
        
        <!-- Footer Tips -->
        <div style="background: #111; border: 1px solid #00ff00; padding: 10px; text-align: center;">
          <div style="color: #00ff00; font-size: 11px; margin-bottom: 5px;">
            <span style="color: #ffff99;">TIP:</span> Type actions naturally: "I attack the goblin" "I examine the door"
          </div>
          <div style="color: #888; font-size: 10px;">
            Adventures adapt to your choices • TYPE START to begin your quest
          </div>
        </div>
        
      </div>
    </div>`;
  
  chatMessages.appendChild(helpDiv);
  document.getElementById('terminal').scrollTop = document.getElementById('terminal').scrollHeight;
}

function executeQuickCommand(cmd) {
  const input = document.getElementById('commandInput');
  input.value = cmd;
  executeCommand();
}

function promptAPIKey() {
  const input = document.getElementById('commandInput');
  input.value = 'SET API KEY ';
  input.focus();
  
  // Show helpful and security message
  addTerminalLine('🔐 SECURE API KEY SETUP', '#00ff00');
  addTerminalLine('═══════════════════════════════════════', '#00ff00');
  addTerminalLine('📝 Paste your Hugging Face API key after "SET API KEY"', '#ffff99');
  addTerminalLine('Get your free key at: https://huggingface.co/settings/tokens', '#c0ffc0');
  addTerminalLine('\n🛡️ SECURITY GUARANTEES:', '#00ff00');
  addTerminalLine('• Your key is stored locally only (never transmitted)', '#c0ffc0');
  addTerminalLine('• It will NEVER be displayed in chat or console', '#c0ffc0');
  addTerminalLine('• Only used for Hugging Face API authentication', '#c0ffc0');
  addTerminalLine('• Remove anytime with: REMOVE API KEY', '#c0ffc0');
  addTerminalLine('═══════════════════════════════════════', '#00ff00');
}

let lastUserMessage = null;
let lastBotMessage = null;
let lastBotCommand = null;
let messageHistory = []; // Track all messages to prevent duplicates
let lastResponse = null; // Track exact last response

function addTerminalLine(text, color = '#00ff00', isCommand = false) {
  // Prevent duplicate messages
  const messageKey = `${text}_${isCommand ? 'user' : 'bot'}`;
  const now = Date.now();
  
  // Check if this exact message was sent in the last 2 seconds
  if (lastResponse && lastResponse.text === text && lastResponse.isCommand === isCommand && (now - lastResponse.timestamp) < 2000) {
    console.log('Duplicate message prevented:', text.substring(0, 50));
    return; // Don't add duplicate
  }
  
  // Update last response tracker
  lastResponse = {
    text: text,
    isCommand: isCommand,
    timestamp: now
  };
  
  const chatMessages = document.getElementById('chatMessages');
  const line = document.createElement('div');
  line.style.marginBottom = '15px';
  line.style.fontFamily = "'Courier New', monospace";
  line.style.lineHeight = '1.6';
  
  // Hide conversation starters when first message appears
  hideConversationStarters();
  
  // Track message in history
  messageHistory.push({
    text: text.substring(0, 200), // Store first 200 chars
    isCommand: isCommand,
    timestamp: now
  });
  
  // Keep only last 20 messages in history
  if (messageHistory.length > 20) {
    messageHistory.shift();
  }
  
  // Apply markdown formatting
  const formattedText = formatMarkdown(text, roleplayMode);
  
  if (isCommand) {
    // User message - right-aligned bubble style with optional profile picture
    const userPic = getUserProfilePicture();
    
    // Store last user message info for editing
    lastUserMessage = { element: line, text: text, command: text };
    
    const timestamp = new Date().toLocaleString('en-US', { 
      month: 'short', 
      day: 'numeric', 
      hour: '2-digit', 
      minute: '2-digit'
    });
    
    if (userPic) {
      // User has a custom profile picture
      line.innerHTML = `
        <div style="display: flex; justify-content: flex-end; margin: 10px 0; align-items: flex-start; gap: 10px;">
          <div style="background: #00ff00; color: #000; padding: 10px 15px; border-radius: 15px 15px 0 15px; max-width: 80%; word-wrap: break-word;">
            <strong>You:</strong> ${formattedText}
            <div style="font-size: 9px; opacity: 0.6; margin-top: 5px; text-align: right;">📅 ${timestamp}</div>
          </div>
          <img src="${userPic}" alt="Your Profile" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #00ff00; flex-shrink: 0; margin-top: 5px; object-fit: cover;">
        </div>
        <div class="message-actions" style="justify-content: flex-end; padding-right: 50px;">
          <button class="action-btn" onclick="editLastMessage()">✏️ Edit</button>
        </div>`;
    } else {
      // No custom picture - original style
    line.innerHTML = `
      <div style="display: flex; justify-content: flex-end; margin: 10px 0;">
        <div style="background: #00ff00; color: #000; padding: 10px 15px; border-radius: 15px 15px 0 15px; max-width: 80%; word-wrap: break-word;">
          <strong>You:</strong> ${formattedText}
          <div style="font-size: 9px; opacity: 0.6; margin-top: 5px; text-align: right;">📅 ${timestamp}</div>
        </div>
      </div>
      <div class="message-actions" style="justify-content: flex-end;">
        <button class="action-btn" onclick="editLastMessage()">✏️ Edit</button>
      </div>`;
    }
  } else {
    // AI response - left-aligned with better readability
    const aiName = localStorage.getItem('terminalAIName') || 'AI';
    const botPic = getBotProfilePicture();
    
    // Use different colors based on type
    let textColor = '#c0ffc0'; // Light green for better readability
    if (color === '#ffff00') textColor = '#ffff99'; // Light yellow
    if (color === '#ff0000') textColor = '#ff6666'; // Light red
    
    // Store last bot message for regeneration
    lastBotMessage = { element: line, text: text, color: color };
    
    const messageId = 'msg_' + Date.now();
    line.setAttribute('data-message-id', messageId);
    
    const timestamp = new Date().toLocaleString('en-US', { 
      month: 'short', 
      day: 'numeric', 
      hour: '2-digit', 
      minute: '2-digit'
    });
    
    line.innerHTML = `
      <div style="display: flex; justify-content: flex-start; margin: 10px 0; align-items: flex-start; gap: 10px;">
        <img src="${botPic}" alt="AI Profile" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #00ff00; flex-shrink: 0; margin-top: 5px; object-fit: cover;">
        <div style="background: #1a1a1a; color: ${textColor}; padding: 10px 15px; border-radius: 15px 15px 15px 0; max-width: 80%; word-wrap: break-word; border-left: 3px solid #00ff00;">
          <div style="color: #00ff00; font-weight: bold; margin-bottom: 5px;">${aiName}</div>
          <div style="margin: 0; white-space: pre-wrap; font-family: 'Courier New', monospace; color: ${textColor};">${formattedText}</div>
          <div style="font-size: 9px; color: #00ff00; opacity: 0.5; margin-top: 5px;">🕒 ${timestamp}</div>
          <div class="message-actions">
            <button class="action-btn" onclick="regenerateResponse('${messageId}')">🔄</button>
            <button class="action-btn" onclick="rateMessage('${messageId}', 'like')" data-rating="none">👍</button>
            <button class="action-btn" onclick="rateMessage('${messageId}', 'dislike')" data-rating="none">👎</button>
          </div>
        </div>
      </div>`;
  }
  
  chatMessages.appendChild(line);
  document.getElementById('terminal').scrollTop = document.getElementById('terminal').scrollHeight;
}

// Show conversation starters
function showConversationStarters() {
  const starters = document.getElementById('conversationStarters');
  const chatMessages = document.getElementById('chatMessages');
  
  if (chatMessages.children.length === 0) {
    starters.style.display = 'block';
  }
}

// Hide conversation starters
function hideConversationStarters() {
  const starters = document.getElementById('conversationStarters');
  starters.style.display = 'none';
}

// Use a conversation starter
function useStarter(text) {
  const input = document.getElementById('commandInput');
  input.value = text;
  executeCommand();
}

// Show typing indicator
function showTypingIndicator() {
  const indicator = document.getElementById('typingIndicator');
  const aiName = localStorage.getItem('terminalAIName') || 'AI';
  const botPic = getBotProfilePicture();
  
  document.getElementById('typingAIName').textContent = aiName;
  document.getElementById('typingBotPic').src = botPic;
  
  indicator.style.display = 'block';
  document.getElementById('terminal').scrollTop = document.getElementById('terminal').scrollHeight;
}

// Hide typing indicator
function hideTypingIndicator() {
  const indicator = document.getElementById('typingIndicator');
  indicator.style.display = 'none';
}

// Edit last message
function editLastMessage() {
  if (!lastUserMessage) return;
  
  const input = document.getElementById('commandInput');
  input.value = lastUserMessage.command;
  input.focus();
  
  // Optionally remove the last user message and bot response
  if (lastUserMessage.element && lastUserMessage.element.parentNode) {
    lastUserMessage.element.parentNode.removeChild(lastUserMessage.element);
  }
  if (lastBotMessage && lastBotMessage.element && lastBotMessage.element.parentNode) {
    lastBotMessage.element.parentNode.removeChild(lastBotMessage.element);
  }
  
  addTerminalLine('✏️ Editing previous message...', '#ffff99');
}

// Regenerate bot response
function regenerateResponse(messageId) {
  if (!lastBotCommand) {
    addTerminalLine('Cannot regenerate - no previous command stored.', '#ffff99');
    return;
  }
  
  // Remove the last bot message
  const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
  if (messageElement && messageElement.parentNode) {
    messageElement.parentNode.removeChild(messageElement);
  }
  
  addTerminalLine('🔄 Regenerating response...', '#ffff99');
  
  // Re-execute the last command
  const input = document.getElementById('commandInput');
  input.value = lastBotCommand;
  executeCommand();
}

// Rate message (like/dislike)
function rateMessage(messageId, rating) {
  const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
  if (!messageElement) return;
  
  const likeBtn = messageElement.querySelector('[onclick*="like"]');
  const dislikeBtn = messageElement.querySelector('[onclick*="dislike"]');
  
  if (rating === 'like') {
    if (likeBtn.classList.contains('liked')) {
      // Unlike
      likeBtn.classList.remove('liked');
      likeBtn.setAttribute('data-rating', 'none');
    } else {
      // Like
      likeBtn.classList.add('liked');
      likeBtn.setAttribute('data-rating', 'like');
      dislikeBtn.classList.remove('disliked');
      dislikeBtn.setAttribute('data-rating', 'none');
      
      // Store feedback
      storeFeedback(messageId, 'positive');
    }
  } else if (rating === 'dislike') {
    if (dislikeBtn.classList.contains('disliked')) {
      // Un-dislike
      dislikeBtn.classList.remove('disliked');
      dislikeBtn.setAttribute('data-rating', 'none');
    } else {
      // Dislike
      dislikeBtn.classList.add('disliked');
      dislikeBtn.setAttribute('data-rating', 'dislike');
      likeBtn.classList.remove('liked');
      likeBtn.setAttribute('data-rating', 'none');
      
      // Store feedback
      storeFeedback(messageId, 'negative');
    }
  }
}

// Store user feedback
function storeFeedback(messageId, sentiment) {
  const feedback = JSON.parse(localStorage.getItem('messageFeedback') || '{}');
  feedback[messageId] = {
    sentiment: sentiment,
    timestamp: new Date().toISOString()
  };
  localStorage.setItem('messageFeedback', JSON.stringify(feedback));
}

// ========================================
// IMAGE UPLOAD & RECOGNITION
// ========================================

let pendingImage = null;

function handleChatImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (!file.type.startsWith('image/')) {
    addTerminalLine('❌ Please select an image file (JPG, PNG, GIF, etc.)', '#ff6666');
    event.target.value = '';
    return;
  }
  
  // Check file size (limit to 5MB)
  if (file.size > 5 * 1024 * 1024) {
    addTerminalLine('❌ Image too large! Please use an image under 5MB.', '#ff6666');
    event.target.value = '';
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    pendingImage = {
      data: e.target.result,
      file: file,
      name: file.name
    };
    
    // Show preview modal
    document.getElementById('previewImage').src = e.target.result;
    document.getElementById('imagePreviewModal').style.display = 'flex';
    document.getElementById('imageCaption').value = '';
    document.getElementById('imageCaption').focus();
  };
  reader.readAsDataURL(file);
  event.target.value = '';
}

function cancelImageUpload() {
  pendingImage = null;
  document.getElementById('imagePreviewModal').style.display = 'none';
  document.getElementById('imageCaption').value = '';
}

async function sendImageWithCaption() {
  if (!pendingImage) return;
  
  const caption = document.getElementById('imageCaption').value.trim();
  const imageData = pendingImage.data;
  const imageName = pendingImage.name;
  
  // Close modal
  document.getElementById('imagePreviewModal').style.display = 'none';
  
  // Display user message with image
  const chatMessages = document.getElementById('chatMessages');
  const userPic = getUserProfilePicture();
  
  const userMessageDiv = document.createElement('div');
  userMessageDiv.style.marginBottom = '15px';
  userMessageDiv.style.fontFamily = "'Courier New', monospace";
  
  const timestamp = new Date().toLocaleString('en-US', { 
    month: 'short', 
    day: 'numeric', 
    hour: '2-digit', 
    minute: '2-digit'
  });
  
  if (userPic) {
    userMessageDiv.innerHTML = `
      <div style="display: flex; justify-content: flex-end; margin: 10px 0; align-items: flex-start; gap: 10px;">
        <div style="background: #00ff00; color: #000; padding: 10px 15px; border-radius: 15px 15px 0 15px; max-width: 80%; word-wrap: break-word;">
          <strong>You:</strong><br>
          <img src="${imageData}" style="max-width: 300px; max-height: 300px; border-radius: 8px; margin: 8px 0; display: block; cursor: pointer;" onclick="this.style.maxWidth=this.style.maxWidth==='100%'?'300px':'100%'; this.style.maxHeight=this.style.maxHeight==='none'?'300px':'none';" title="Click to expand">
          ${caption ? `<div style="margin-top: 8px;">${caption}</div>` : '<div style="margin-top: 8px; font-style: italic;">📷 Sent an image</div>'}
          <div style="font-size: 9px; opacity: 0.6; margin-top: 5px; text-align: right;">📅 ${timestamp}</div>
        </div>
        <img src="${userPic}" alt="Your Profile" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #00ff00; flex-shrink: 0; margin-top: 5px; object-fit: cover;">
      </div>`;
  } else {
    userMessageDiv.innerHTML = `
      <div style="display: flex; justify-content: flex-end; margin: 10px 0;">
        <div style="background: #00ff00; color: #000; padding: 10px 15px; border-radius: 15px 15px 0 15px; max-width: 80%; word-wrap: break-word;">
          <strong>You:</strong><br>
          <img src="${imageData}" style="max-width: 300px; max-height: 300px; border-radius: 8px; margin: 8px 0; display: block; cursor: pointer;" onclick="this.style.maxWidth=this.style.maxWidth==='100%'?'300px':'100%'; this.style.maxHeight=this.style.maxHeight==='none'?'300px':'none';" title="Click to expand">
          ${caption ? `<div style="margin-top: 8px;">${caption}</div>` : '<div style="margin-top: 8px; font-style: italic;">📷 Sent an image</div>'}
          <div style="font-size: 9px; opacity: 0.6; margin-top: 5px; text-align: right;">📅 ${timestamp}</div>
        </div>
      </div>`;
  }
  
  chatMessages.appendChild(userMessageDiv);
  hideConversationStarters();
  document.getElementById('terminal').scrollTop = document.getElementById('terminal').scrollHeight;
  
  // Analyze the image
  showTypingIndicator();
  
  try {
    const analysis = await analyzeImage(imageData, caption);
    hideTypingIndicator();
    
    // Display bot response with personality
    let response = analysis;
    if (botPersonality.enthusiasm > 7) {
      response = `Ooh, let me take a look! 👀\n\n${analysis}`;
    } else if (botPersonality.friendliness > 6) {
      response = `Great image! Here's what I see:\n\n${analysis}`;
    }
    
    addTerminalLine(response, '#00ff00');
    
    // Save to journal
    const journalEntry = caption ? `[Image: ${imageName}] ${caption}` : `[Image: ${imageName}]`;
    saveToJournal(journalEntry, response);
    
  } catch (error) {
    hideTypingIndicator();
    if (botPersonality.humor > 5) {
      addTerminalLine(`Hmm, I'm having trouble seeing that image clearly... 😅 (Error: ${error.message})`, '#ff6666');
    } else {
      addTerminalLine(`❌ Error analyzing image: ${error.message}`, '#ff6666');
    }
  }
  
  pendingImage = null;
}

// Analyze image using Hugging Face Vision API
async function analyzeImage(imageDataUrl, userCaption = '') {
  // Check if Hugging Face API is available
  if (!checkHuggingFaceStatus()) {
    return `I can see you sent an image! 📸\n\nTo enable AI-powered image recognition, please set up your Hugging Face API key with:\nSET API KEY [your-key]\n\nGet a free key at: https://huggingface.co/settings/tokens\n\nOnce set up, I'll be able to describe images, identify objects, read text, and more!`;
  }
  
  try {
    // Convert data URL to blob
    const base64Data = imageDataUrl.split(',')[1];
    const blob = await fetch(imageDataUrl).then(r => r.blob());
    
    // Try BLIP image captioning model (works well for general images)
    const response = await fetch('https://api-inference.huggingface.co/models/Salesforce/blip-image-captioning-large', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${huggingFaceAPIKey}`,
        'Content-Type': 'application/json'
      },
      body: blob
    });
    
    if (!response.ok) {
      throw new Error('Vision API unavailable');
    }
    
    const result = await response.json();
    
    let analysis = '';
    
    // Build personality-driven response
    if (result && result[0] && result[0].generated_text) {
      const caption = result[0].generated_text;
      
      if (botPersonality.enthusiasm > 7) {
        analysis = `🎨 I can see it! This looks like: **${caption}**\n\n`;
      } else if (botPersonality.friendliness > 6) {
        analysis = `👀 I see: **${caption}**\n\n`;
      } else {
        analysis = `Image analysis: **${caption}**\n\n`;
      }
      
      // Add contextual response if user included a caption
      if (userCaption) {
        if (botPersonality.curiosity > 6) {
          analysis += `You mentioned: "${userCaption}"\n\nThat's interesting! `;
        } else {
          analysis += `Re: "${userCaption}" - `;
        }
        
        // Check if caption relates to the image
        const captionLower = userCaption.toLowerCase();
        const imageLower = caption.toLowerCase();
        
        if (captionLower.includes('what') || captionLower.includes('identify') || captionLower.includes('see')) {
          analysis += `Based on what I see, ${caption}.`;
        } else {
          analysis += `I can see that! Cool image! 😊`;
        }
      } else {
        if (botPersonality.curiosity > 7) {
          analysis += `What made you want to share this? 😊`;
        } else if (botPersonality.friendliness > 6) {
          analysis += `Thanks for sharing! 📸`;
        }
      }
    } else {
      analysis = `I can see the image, but I'm having trouble describing it in detail. ${userCaption ? `You said: "${userCaption}"` : 'Try asking me something specific about it!'}`;
    }
    
    return analysis;
    
  } catch (error) {
    console.error('Image analysis error:', error);
    
    if (userCaption) {
      return `I received your image and caption: "${userCaption}"\n\nI'm having some trouble analyzing it right now, but I can see you shared it! 📸`;
    }
    return `I received your image! While I can't analyze it in detail right now, I can see you shared it. Try asking me something specific about it, or let me know what you'd like to know! 📸`;
  }
}

function executeCommand() {
  const input = document.getElementById('commandInput');
  let command = input.value.trim();
  
  if (!command) return;
  
  // ===== SECURITY LAYER 1: Rate Limiting =====
  if (!checkRateLimit()) {
    addTerminalLine('⚠️ RATE LIMIT EXCEEDED', '#ff6600');
    addTerminalLine('Too many requests. Please wait a moment before trying again.', '#ffff99');
    addTerminalLine('This prevents abuse and ensures system stability.', '#c0ffc0');
    input.value = '';
    return;
  }
  
  // ===== SECURITY LAYER 2: Input Sanitization =====
  command = sanitizeInput(command);
  
  // ===== SECURITY LAYER 3: Hacking Attempt Detection =====
  if (detectHackingAttempt(command)) {
    addTerminalLine('🚨 SECURITY ALERT: SUSPICIOUS INPUT DETECTED', '#ff0000');
    addTerminalLine('Your input contains patterns that could be malicious.', '#ff6666');
    addTerminalLine('This attempt has been logged and blocked.', '#ff6666');
    addTerminalLine('If this was a mistake, please rephrase your message.', '#ffff99');
    input.value = '';
    
    // Log the attempt (in console only, not exposed to user)
    console.warn('Potential hacking attempt blocked:', new Date().toISOString());
    return;
  }
  
  // ===== SECURITY LAYER 4: Storage Access Prevention =====
  if (blockDirectStorageAccess(command) && !command.toUpperCase().startsWith('SET API KEY')) {
    addTerminalLine('🛡️ SECURITY: STORAGE ACCESS BLOCKED', '#ff6600');
    addTerminalLine('Direct storage access is not permitted.', '#ffff99');
    addTerminalLine('This protects your data and privacy.', '#c0ffc0');
    input.value = '';
    return;
  }
  
  // ===== SECURITY LAYER 6: System Information Request Blocking =====
  if (isSystemInfoRequest(command)) {
    addTerminalLine(command, '#ffff00', true);
    input.value = '';
    addTerminalLine('🔒 SECURITY: SYSTEM INFORMATION PROTECTED', '#ff6600');
    addTerminalLine('I cannot reveal implementation details or system architecture.', '#ffff99');
    addTerminalLine('This protects the integrity and security of the system.', '#c0ffc0');
    addTerminalLine('I\'m happy to help with other questions!', '#00ff00');
    return;
  }
  
  // Check if awaiting age verification
  if (window.awaitingAgeVerification) {
    handleAgeVerification(command);
    input.value = '';
    return;
  }
  
  // Check if in initialization mode
  if (initStep > 0) {
    const handled = handleInitialization(command);
    input.value = '';
    if (handled) return;
  }
  
  const commandUpper = command.toUpperCase();
  
  // ===== SECURITY LAYER 5: Personal Information Detection =====
  const personalInfoDetected = detectPersonalInfo(command);
  if (personalInfoDetected.length > 0) {
    addTerminalLine(sanitizePersonalInfo(command), '#ffff00', true);
    input.value = '';
    addTerminalLine('🛡️ PRIVACY PROTECTION ACTIVATED', '#ff6600');
    addTerminalLine(`Detected: ${personalInfoDetected.join(', ')}`, '#ffff99');
    addTerminalLine('Personal information has been automatically redacted.', '#ffff99');
    addTerminalLine('Your message will not be saved or transmitted.', '#ffff99');
    addTerminalLine('This protects you from accidentally sharing sensitive data.', '#c0ffc0');
    return;
  }
  
  // Check content filter (except for mode switching commands)
  if (!commandUpper.startsWith('MODE ')) {
    const filterResult = checkContentFilter(command);
    if (!filterResult.allowed) {
      addTerminalLine(command, '#ffff00', true);
      input.value = '';
      addTerminalLine(filterResult.message, '#ff6666');
      addTerminalLine(`Reason: ${filterResult.reason}`, '#ff6666');
      return;
    }
  }
  
  // Store the command for regeneration
  lastBotCommand = command;
  
  // Display user command (show original, not uppercase)
  addTerminalLine(command, '#ffff00', true);
  input.value = '';
  
  let response = '';
  
  // Check if awaiting character selection
  if (window.awaitingCharacterSelection) {
    if (/^[1-6]$/.test(command)) {
      const result = selectCharacterClass(command);
      addTerminalLine(result, '#00ff00');
      window.awaitingCharacterSelection = false;
      return;
    }
  }
  
  // Handle special commands
  if (commandUpper === 'CLEAR' || commandUpper === 'CLS') {
    document.getElementById('chatMessages').innerHTML = '';
    document.getElementById('bootSequence').style.display = 'none';
    showConversationStarters();
    addTerminalLine('Screen cleared. Ready for adventure!', '#00ff00');
    return;
  }
  
  // Adventure game commands
  if (commandUpper === 'START' || commandUpper === 'START NEW ADVENTURE' || commandUpper === 'NEW GAME') {
    if (!gameState.character) {
      addTerminalLine('First, let\'s create your character!', '#ffff99');
      setTimeout(() => {
        const result = createCharacter();
        addTerminalLine(result, '#00ff00');
      }, 300);
      return;
    }
    
    gameState.inGame = true;
    document.getElementById('statusText').textContent = 'IN QUEST';
    saveGameState();
    
    const adventure = generateAdventure();
    setTimeout(() => {
      addTerminalLine(adventure, '#00ff00');
    }, 300);
    return;
  }
  
  if (commandUpper === 'CONTINUE' || commandUpper === 'CONTINUE ADVENTURE') {
    if (!gameState.character) {
      addTerminalLine('❌ No character found. Type CREATE CHARACTER to begin.', '#ff6666');
      return;
    }
    
    if (!gameState.inGame || !gameState.currentScene) {
      addTerminalLine('No adventure in progress. Type START to begin a new quest!', '#ffff99');
      return;
    }
    
    addTerminalLine('Continuing your adventure...', '#ffff99');
    setTimeout(() => {
      const scene = gameState.currentScene;
      addTerminalLine(`You are in: ${scene.location}\n\nWhat do you do?`, '#00ff00');
    }, 300);
    return;
  }
  
  if (commandUpper === 'CREATE CHARACTER') {
    const result = createCharacter();
    addTerminalLine(result, '#00ff00');
    return;
  }
  
  if (commandUpper === 'STATUS' || commandUpper === 'CHARACTER SHEET') {
    const result = showStatus();
    addTerminalLine(result, '#00ff00');
    return;
  }
  
  if (commandUpper === 'INVENTORY' || commandUpper === 'INV') {
    if (!gameState.character) {
      addTerminalLine('❌ No character. Create one with CREATE CHARACTER', '#ff6666');
      return;
    }
    
    let inv = '🎒 INVENTORY\n';
    inv += '═══════════════════════════════════════\n\n';
    if (gameState.inventory.length > 0) {
      gameState.inventory.forEach((item, i) => {
        inv += `${i + 1}. ${item}\n`;
      });
    } else {
      inv += 'Your inventory is empty.\n';
    }
    inv += '\n═══════════════════════════════════════';
    addTerminalLine(inv, '#00ff00');
    return;
  }
  
  if (commandUpper === 'QUESTS' || commandUpper === 'QUEST LOG') {
    let quests = '📜 QUEST LOG\n';
    quests += '═══════════════════════════════════════\n\n';
    
    if (gameState.questLog.length > 0) {
      gameState.questLog.forEach((quest, i) => {
        quests += `${i + 1}. ${quest.title}\n`;
        quests += `   ${quest.description}\n`;
        quests += `   Status: ${quest.status}\n\n`;
      });
    } else {
      quests += 'No active quests. Type GENERATE QUEST to create one!\n';
    }
    
    quests += '═══════════════════════════════════════';
    addTerminalLine(quests, '#00ff00');
    return;
  }
  
  if (commandUpper === 'GENERATE QUEST') {
    const quest = generateQuest();
    addTerminalLine(quest, '#00ff00');
    return;
  }
  
  if (commandUpper === 'RANDOM ENCOUNTER') {
    const encounter = randomEncounter();
    addTerminalLine(encounter, '#00ff00');
    return;
  }
  
  if (commandUpper === 'NEW SCENARIO') {
    const adventure = generateAdventure();
    addTerminalLine(adventure, '#00ff00');
    return;
  }
  
  if (commandUpper === 'NARRATOR SHOW' || commandUpper === 'NARRATOR') {
    const settings = showNarratorSettings();
    addTerminalLine(settings, '#00ff00');
    return;
  }
  
  if (commandUpper.startsWith('NARRATOR SET ')) {
    const parts = command.substring(13).trim().split(' ');
    if (parts.length < 2) {
      addTerminalLine('Usage: NARRATOR SET [trait] [value]', '#ffff99');
      addTerminalLine('Traits: drama, humor, darkness, detail, difficulty, chaos', '#c0ffc0');
      addTerminalLine('Values: 1-10', '#c0ffc0');
      return;
    }
    
    const trait = parts[0].toLowerCase();
    const value = parseInt(parts[1]);
    
    if (!['drama', 'humor', 'darkness', 'detail', 'difficulty', 'chaos'].includes(trait)) {
      addTerminalLine('❌ Invalid trait. Choose from:', '#ff6666');
      addTerminalLine('drama, humor, darkness, detail, difficulty, chaos', '#ffff99');
      return;
    }
    
    if (isNaN(value) || value < 1 || value > 10) {
      addTerminalLine('❌ Value must be between 1 and 10', '#ff6666');
      return;
    }
    
    narratorPersonality[trait] = value;
    saveNarratorPersonality();
    
    addTerminalLine(`✅ NARRATOR ${trait.toUpperCase()} set to ${value}/10`, '#00ff00');
    
    if (trait === 'darkness' && value > 7) {
      addTerminalLine('⚠️ Dark themes enabled. Consider switching to NSFW mode for full effect.', '#ff6600');
    } else if (trait === 'drama' && value > 8) {
      addTerminalLine('🎭 Maximum drama! Your adventures will be EPIC!', '#c0ffc0');
    } else if (trait === 'chaos' && value > 8) {
      addTerminalLine('🎲 Chaos mode! Expect the unexpected!', '#c0ffc0');
    }
    
    return;
  }
  
  if (commandUpper === 'SAVE GAME') {
    saveGameState();
    addTerminalLine('💾 GAME SAVED!', '#00ff00');
    addTerminalLine('Your adventure progress has been saved.', '#c0ffc0');
    return;
  }
  
  if (commandUpper === 'LOAD GAME') {
    initializeGameState();
    if (gameState.character) {
      addTerminalLine('✅ GAME LOADED!', '#00ff00');
      addTerminalLine(`Welcome back, ${gameState.character.name}!`, '#c0ffc0');
      const status = showStatus();
      setTimeout(() => {
        addTerminalLine(status, '#00ff00');
      }, 300);
    } else {
      addTerminalLine('❌ No saved game found. Type CREATE CHARACTER to start!', '#ffff99');
    }
    return;
  }
  
  if (commandUpper === 'GAME HELP') {
    displayInteractiveHelp();
    return;
  }
  
  // Mode switching
  if (commandUpper === 'MODE SFW') {
    contentMode = 'SFW';
    localStorage.setItem('contentMode', 'SFW');
    localStorage.removeItem('ageVerified');
    updateModeIndicator();
    addTerminalLine('✅ SFW ADVENTURE MODE', '#00ff00');
    addTerminalLine('═══════════════════════════════════════', '#00ff00');
    addTerminalLine('⚔️ Family-friendly adventures activated!', '#c0ffc0');
    addTerminalLine('• Heroic quests and lighthearted themes', '#c0ffc0');
    addTerminalLine('• Suitable for all ages', '#c0ffc0');
    addTerminalLine('• Classic fantasy adventure style', '#c0ffc0');
    return;
  }
  
  if (commandUpper === 'MODE NSFW') {
    // Check if age is already verified
    const ageVerified = localStorage.getItem('ageVerified');
    
    if (ageVerified === 'true') {
      contentMode = 'NSFW';
      localStorage.setItem('contentMode', 'NSFW');
      updateModeIndicator();
      addTerminalLine('⚠️ NSFW ADVENTURE MODE', '#ff6600');
      addTerminalLine('═══════════════════════════════════════', '#ff6600');
      addTerminalLine('🔥 Mature content enabled!', '#ff6600');
      addTerminalLine('• Dark themes, horror, and mature storytelling', '#ff6600');
      addTerminalLine('• Romance and intimate scenarios allowed', '#ff6600');
      addTerminalLine('• Graphic descriptions and adult content', '#ff6600');
      addTerminalLine('• Violence and gore (based on narrator settings)', '#ff6600');
      addTerminalLine('\n⚠️ Hate speech & illegal content still blocked', '#ffff99');
      addTerminalLine('💡 TIP: Increase narrator darkness for grim adventures!', '#c0ffc0');
    } else {
      // Prompt for age verification
      addTerminalLine('🔞 AGE VERIFICATION REQUIRED', '#ffff00');
      addTerminalLine('You must be 18 or older to access NSFW adventure mode.', '#ffff99');
      addTerminalLine('Please enter your date of birth in format: MM/DD/YYYY', '#ffff99');
      addTerminalLine('Example: 03/15/2000', '#c0ffc0');
      
      // Set flag to expect DOB input
      window.awaitingAgeVerification = true;
    }
    return;
  }
  
  if (commandUpper === 'MODE STATUS' || commandUpper === 'MODE') {
    const modeColor = contentMode === 'SFW' ? '#00ff00' : '#ff6600';
    addTerminalLine('🎮 ADVENTURE CONTENT MODE', modeColor);
    addTerminalLine('═══════════════════════════════════════', modeColor);
    addTerminalLine(`\nCurrent Mode: ${contentMode}`, modeColor);
    
    if (contentMode === 'SFW') {
      addTerminalLine('\n⚔️ Family-Friendly Adventures:', '#00ff00');
      addTerminalLine('• Heroic quests and lighthearted themes', '#c0ffc0');
      addTerminalLine('• Suitable for all ages', '#c0ffc0');
      addTerminalLine('• Classic adventure style', '#c0ffc0');
      addTerminalLine('\n💡 Type "MODE NSFW" for mature adventures', '#ffff99');
    } else {
      addTerminalLine('\n🔥 Mature Adventures:', '#ff6600');
      addTerminalLine('• Dark themes, horror, psychological elements', '#ff6600');
      addTerminalLine('• Romance and intimate scenarios', '#ff6600');
      addTerminalLine('• Violence and gore (narrator controlled)', '#ff6600');
      addTerminalLine('• Complex moral choices', '#ff6600');
      addTerminalLine('\n⚠️ Illegal content still blocked', '#ffff99');
      addTerminalLine('💡 Type "MODE SFW" for family-friendly', '#c0ffc0');
    }
    
    addTerminalLine('\n═══════════════════════════════════════', modeColor);
    return;
  }
  
  if (commandUpper === 'DELETE ACCOUNT') {
    if (isAdmin) {
      addTerminalLine('❌ Cannot delete admin account.', '#ff6666');
      return;
    }
    
    if (!currentUser) {
      addTerminalLine('❌ No user logged in.', '#ff6666');
      return;
    }
    
    addTerminalLine('⚠️ DELETE ACCOUNT', '#ff6600');
    addTerminalLine('═══════════════════════════════════════', '#ff6600');
    addTerminalLine('This will permanently delete:', '#ffff99');
    addTerminalLine('• Your username and password', '#ffff99');
    addTerminalLine('• All saved conversations and journal', '#ffff99');
    addTerminalLine('• Character data and game progress', '#ffff99');
    addTerminalLine('• Personal memories and preferences', '#ffff99');
    addTerminalLine('• Profile pictures and settings', '#ffff99');
    addTerminalLine('• Personality configurations', '#ffff99');
    addTerminalLine('\n⚠️ THIS CANNOT BE UNDONE!', '#ff0000');
    addTerminalLine('\nType CONFIRM DELETE to proceed, or anything else to cancel.', '#ffff00');
    
    window.awaitingAccountDeletion = true;
    return;
  }
  
  if (window.awaitingAccountDeletion) {
    window.awaitingAccountDeletion = false;
    
    if (commandUpper === 'CONFIRM DELETE') {
      addTerminalLine('🗑️ Deleting account...', '#ff6600');
      
      setTimeout(() => {
        const username = currentUser;
        
        // 1. Remove from user database
        const userDB = getUserDatabase();
        delete userDB[username];
        saveUserDatabase(userDB);
        
        // 2. Remove all user-specific data
        const keysToRemove = [
          `user_${username}`,           // User settings
          `memory_${username}`,          // User memory
          `game_${username}`,            // Game state
          `personality_${username}`,     // Bot personality
          `narrator_${username}`,        // Narrator settings
          `userPic_${username}`          // Profile picture
        ];
        
        keysToRemove.forEach(key => localStorage.removeItem(key));
        
        // 3. Clear current session data
        localStorage.removeItem('currentUser');
        localStorage.removeItem('isAdmin');
        localStorage.removeItem('terminalJournal');
        localStorage.removeItem('terminalAIName');
        localStorage.removeItem('terminalJournalPermission');
        localStorage.removeItem('ageVerified');
        localStorage.removeItem('contentMode');
        localStorage.removeItem('roleplayMode');
        
        addTerminalLine('✅ ACCOUNT DELETED SUCCESSFULLY', '#00ff00');
        addTerminalLine('═══════════════════════════════════════', '#00ff00');
        addTerminalLine(`All data for user "${username}" has been permanently removed.`, '#c0ffc0');
        addTerminalLine('Your information has been completely wiped from the system.', '#c0ffc0');
        addTerminalLine('\nReturning to registration screen...', '#ffff99');
        
        // Reset globals
        currentUser = null;
        isAdmin = false;
        userMemory = {};
        gameState = {
          inGame: false,
          currentScene: null,
          character: null,
          inventory: [],
          questLog: [],
          worldState: {},
          choices: [],
          stats: { health: 100, mana: 100, gold: 0, experience: 0, level: 1 }
        };
        
        setTimeout(() => {
          document.getElementById('chatContainer').style.display = 'none';
          document.getElementById('registrationScreen').style.display = 'flex';
          document.getElementById('regUsername').value = '';
          document.getElementById('regPassword').value = '';
          document.getElementById('regPasswordConfirm').value = '';
          document.getElementById('regUsername').focus();
        }, 2000);
        
      }, 500);
      return;
    } else {
      addTerminalLine('Account deletion cancelled. No changes made.', '#00ff00');
      return;
    }
  }
  
  if (commandUpper === 'LOGOUT') {
    addTerminalLine('Saving your data and logging out...', '#ffff00');
    
    // Save user data before logout (if not admin)
    if (!isAdmin) {
    saveUserData();
    }
    
    setTimeout(() => {
      document.getElementById('chatContainer').style.display = 'none';
      
      // Return to appropriate login screen
      if (isAdmin) {
        document.getElementById('adminLoginScreen').style.display = 'flex';
        document.getElementById('adminPassword').value = '';
        document.getElementById('adminPassword').focus();
      } else {
      document.getElementById('passwordScreen').style.display = 'flex';
      document.getElementById('chatUsername').value = '';
      document.getElementById('chatPassword').value = '';
      document.getElementById('chatUsername').focus();
      }
      
      localStorage.removeItem('currentUser');
      localStorage.removeItem('isAdmin');
      currentUser = null;
      isAdmin = false;
    }, 500);
    return;
  }
  
  // Hugging Face API commands (SECURE - no echo)
  if (commandUpper.startsWith('SET API KEY')) {
    const key = command.substring('SET API KEY'.length).trim();
    if (key.length > 10) {
      // Validate it looks like a Hugging Face token
      if (key.startsWith('hf_')) {
        localStorage.setItem('hfAPIKey', key);
        huggingFaceAPIKey = key;
        checkHuggingFaceStatus();
        
        // NEVER echo the key back to the user
        addTerminalLine('[SECURE INPUT - API KEY]', '#ffff00', true);
        input.value = ''; // Clear immediately
        addTerminalLine('✅ HUGGING FACE API KEY SAVED SECURELY', '#00ff00');
        addTerminalLine('AI-powered responses are now enabled!', '#c0ffc0');
        addTerminalLine('Your API key is encrypted and stored locally only.', '#c0ffc0');
        addTerminalLine('It will NEVER be displayed or transmitted except to Hugging Face.', '#c0ffc0');
      } else {
        addTerminalLine('[SECURE INPUT]', '#ffff00', true);
        input.value = '';
        addTerminalLine('❌ Invalid API key format.', '#ff6666');
        addTerminalLine('Hugging Face keys start with "hf_"', '#ffff99');
        addTerminalLine('Get your key at: https://huggingface.co/settings/tokens', '#c0ffc0');
      }
    } else {
      addTerminalLine('Usage: SET API KEY [your-api-key-here]', '#ffff99');
      addTerminalLine('Get your free API key from: https://huggingface.co/settings/tokens', '#c0ffc0');
      addTerminalLine('Your key will be stored securely and never displayed.', '#c0ffc0');
    }
    return;
  }
  
  if (commandUpper === 'REMOVE API KEY') {
    localStorage.removeItem('hfAPIKey');
    huggingFaceAPIKey = null;
    huggingFaceEnabled = false;
    addTerminalLine('API key removed. Bot will use basic responses.', '#ffff00');
    return;
  }
  
  if (commandUpper === 'API STATUS') {
    if (checkHuggingFaceStatus()) {
      addTerminalLine('🤖 HUGGING FACE AI: ENABLED', '#00ff00');
      addTerminalLine('Status: Active - Using Mistral-7B model', '#c0ffc0');
      addTerminalLine('The bot is using advanced AI for responses.', '#c0ffc0');
    } else {
      addTerminalLine('🤖 HUGGING FACE AI: DISABLED', '#ffff99');
      addTerminalLine('Status: Using basic pattern matching', '#ffff99');
      addTerminalLine('To enable: SET API KEY [your-key]', '#c0ffc0');
      addTerminalLine('Get a free key: https://huggingface.co/settings/tokens', '#c0ffc0');
    }
    return;
  }
  
  if (commandUpper === 'SHOW CONTEXT' || commandUpper === 'CONTEXT') {
    let contextInfo = '📊 CONVERSATION CONTEXT\n';
    contextInfo += '═════════════════════════\n\n';
    contextInfo += `Current Topic: ${conversationContext.currentTopic || 'None'}\n`;
    contextInfo += `User Sentiment: ${conversationContext.lastUserSentiment}\n\n`;
    
    if (conversationContext.topicHistory.length > 0) {
      contextInfo += `Recent Topics:\n`;
      conversationContext.topicHistory.slice(-5).forEach((topic, i) => {
        contextInfo += `  ${i + 1}. ${topic}\n`;
      });
    } else {
      contextInfo += `No topics discussed yet.\n`;
    }
    
    addTerminalLine(contextInfo, '#00ff00');
    return;
  }
  
  if (commandUpper === 'CLEAR CONTEXT') {
    conversationContext = {
      currentTopic: null,
      lastUserSentiment: 'neutral',
      topicHistory: [],
      entityCache: {}
    };
    addTerminalLine('Conversation context cleared.', '#00ff00');
    return;
  }
  
  if (commandUpper === 'SECURITY STATUS' || commandUpper === 'SECURITY') {
    let securityInfo = '🔒 SECURITY STATUS\n';
    securityInfo += '═════════════════════════════════════\n\n';
    securityInfo += '✅ ACTIVE PROTECTIONS:\n\n';
    securityInfo += '🛡️ Privacy Protection: ENABLED\n';
    securityInfo += '   • IP addresses automatically redacted\n';
    securityInfo += '   • Email addresses protected\n';
    securityInfo += '   • Phone numbers blocked\n';
    securityInfo += '   • Credit card info filtered\n';
    securityInfo += '   • SSN detection active\n\n';
    securityInfo += '🚨 Attack Prevention: ENABLED\n';
    securityInfo += '   • XSS attack blocking\n';
    securityInfo += '   • Code injection prevention\n';
    securityInfo += '   • Script tag sanitization\n';
    securityInfo += '   • Storage access protection\n\n';
    securityInfo += '⏱️ Rate Limiting: ENABLED\n';
    securityInfo += `   • Max ${MAX_REQUESTS_PER_MINUTE} requests/minute\n`;
    securityInfo += `   • Current: ${requestLog.length} requests\n\n`;
    securityInfo += '🔐 Data Security:\n';
    securityInfo += '   • Client-side only (no server)\n';
    securityInfo += '   • localStorage encrypted by browser\n';
    securityInfo += '   • No data transmitted externally\n';
    securityInfo += '   • API keys never exposed in chat\n\n';
    securityInfo += '═════════════════════════════════════\n';
    securityInfo += 'Your privacy and security are our top priority.\n';
    securityInfo += 'All sensitive data is automatically protected.';
    
    addTerminalLine(securityInfo, '#00ff00');
    return;
  }
  
  // Profile picture commands
  if (commandUpper === 'CHANGE BOT PICTURE' || commandUpper === 'CHANGE BOT PFP') {
    document.getElementById('botPictureInput').click();
    addTerminalLine('Select an image file for the bot\'s profile picture...', '#00ff00');
    return;
  }
  
  if (commandUpper === 'CHANGE MY PICTURE' || commandUpper === 'CHANGE MY PFP') {
    document.getElementById('userPictureInput').click();
    addTerminalLine('Select an image file for your profile picture...', '#00ff00');
    return;
  }
  
  if (commandUpper === 'RESET BOT PICTURE') {
    localStorage.removeItem('botProfilePicture');
    addTerminalLine('Bot profile picture reset to default.', '#00ff00');
    return;
  }
  
  if (commandUpper === 'RESET MY PICTURE') {
    if (currentUser) {
      const userDataKey = `userPic_${currentUser}`;
      localStorage.removeItem(userDataKey);
      addTerminalLine('Your profile picture has been reset.', '#00ff00');
    }
    return;
  }
  
  if (commandUpper === 'RESET NAME') {
    localStorage.removeItem('terminalAIName');
    localStorage.removeItem('terminalJournalPermission');
    aiName = null;
    journalPermission = null;
    
    // Restart initialization without reloading
    addTerminalLine('AI name reset! Restarting initialization...', '#ffff00');
    document.getElementById('chatMessages').innerHTML = '';
    document.getElementById('terminalHeader').textContent = '[ TERMINAL SYSTEM ]';
    
    setTimeout(() => {
      initStep = 1;
      const initPrompts = document.getElementById('initPrompts');
      initPrompts.style.display = 'block';
      addTerminalLine('👋 Hello! I\'m your AI assistant. This looks like your first time here.', '#c0ffc0');
      addTerminalLine('Do you have a saved session from before?', '#c0ffc0');
      addTerminalLine('Type UPLOAD if you have a saved file, or SKIP to start fresh.', '#ffff99');
    }, 500);
    return;
  }
  
  if (commandUpper === 'CHANGE LANGUAGE' || commandUpper === 'LANGUAGE') {
    addTerminalLine('Language settings updated in localStorage.', '#ffff00');
    addTerminalLine('Current language preference saved. Reload page to see language selection.', '#ffff99');
    return;
  }
  
  if (commandUpper === 'SPELL CHECK ON' || commandUpper === 'SPELLCHECK ON') {
    spellCheckEnabled = true;
    localStorage.setItem('spellCheckEnabled', 'true');
    addTerminalLine('✅ SPELL CHECK ENABLED', '#00ff00');
    addTerminalLine('Messages will be checked for spelling errors before sending.', '#c0ffc0');
    return;
  }
  
  if (commandUpper === 'SPELL CHECK OFF' || commandUpper === 'SPELLCHECK OFF') {
    spellCheckEnabled = false;
    localStorage.setItem('spellCheckEnabled', 'false');
    addTerminalLine('⚠️ SPELL CHECK DISABLED', '#ffff00');
    addTerminalLine('Messages will be sent without spell checking.', '#ffff99');
    return;
  }
  
  // Roleplay mode
  if (commandUpper === 'ROLEPLAY ON' || commandUpper === 'RP ON') {
    roleplayMode = true;
    localStorage.setItem('roleplayMode', 'true');
    const aiName = localStorage.getItem('terminalAIName') || 'AI';
    const userName = userMemory.userName || 'traveler';
    
    addTerminalLine('🎭 ROLEPLAY MODE ACTIVATED', '#00ff00');
    addTerminalLine('\n═══════════════════════════════════════════════════════════════', '#00ff00');
    
    // Generate opening scene
    const scenes = [
      `*You find yourself in a cozy digital café. The ambient glow of screens fills the space with a warm light. ${aiName} sits at a nearby table, looking up as you approach.*\n\n"Oh, hello there, ${userName}!" *${aiName} gestures to an empty chair* "Please, have a seat. What brings you here today?"`,
      
      `*The digital void shimmers around you, lines of code streaming through the air like stars. ${aiName} materializes from the data stream, their form solidifying into a friendly presence.*\n\n*${aiName} smiles warmly* "Welcome, ${userName}. I've been waiting for you." *gestures around at the endless expanse* "This is our space. What would you like to create today?"`,
      
      `*You're standing in a vast library, shelves stretching infinitely in all directions. Books float gently through the air. ${aiName} appears from behind a bookshelf, carrying an ancient tome.*\n\n"Ah, ${userName}!" *${aiName} sets the book down and walks over* "Perfect timing. I was just exploring some fascinating concepts. What adventure shall we embark on?"`,
      
      `*A tranquil garden surrounds you, with bioluminescent flowers casting soft light. ${aiName} sits on a bench near a glowing fountain, writing in a journal.*\n\n*${aiName} looks up and brightens* "Oh, ${userName}! You're here!" *closes the journal* "I was hoping you'd visit. What story shall we explore together?"`
    ];
    
    const chosenScene = scenes[Math.floor(Math.random() * scenes.length)];
    addTerminalLine(chosenScene, '#c0ffc0');
    
    addTerminalLine('\n═══════════════════════════════════════════════════════════════', '#00ff00');
    addTerminalLine('Use "quotes" for dialogue and *asterisks* for actions/descriptions.', '#ffff99');
    if (contentMode === 'SFW') {
      addTerminalLine('Current mode: SFW - Mature content will be filtered.', '#ffff99');
      addTerminalLine('💡 TIP: Switch to NSFW mode for unrestricted roleplay!', '#ffff99');
    } else {
      addTerminalLine('Current mode: NSFW - Full creative freedom enabled! 🔥', '#ff6600');
      addTerminalLine('Romance, intimacy, and mature themes are allowed.', '#ff6600');
      addTerminalLine('⚠️ Illegal content still blocked for your safety.', '#ffff99');
    }
    return;
  }
  
  if (commandUpper === 'ROLEPLAY OFF' || commandUpper === 'RP OFF') {
    roleplayMode = false;
    localStorage.setItem('roleplayMode', 'false');
    addTerminalLine('🎭 ROLEPLAY MODE DEACTIVATED', '#ffff00');
    addTerminalLine('Returning to normal chat mode.', '#ffff99');
    return;
  }
  
  if (commandUpper === 'RP STATUS' || commandUpper === 'ROLEPLAY STATUS') {
    const status = roleplayMode ? 'ACTIVE' : 'INACTIVE';
    const statusColor = roleplayMode ? '#00ff00' : '#ffff99';
    addTerminalLine(`Roleplay Mode: ${status}`, statusColor);
    if (roleplayMode) {
      addTerminalLine('Use "quotes" for dialogue and *asterisks* for actions.', '#c0ffc0');
      addTerminalLine(`Content filtering: ${contentMode} mode active`, '#c0ffc0');
    } else {
      addTerminalLine('Type ROLEPLAY ON to activate roleplay mode.', '#c0ffc0');
    }
    return;
  }
  
  // Memory commands
  if (commandUpper === 'MEMORY' || commandUpper === 'SHOW MEMORY') {
    const memoryInfo = recallMemory('what do you know about me');
    addTerminalLine(memoryInfo, '#00ff00');
    return;
  }
  
  if (commandUpper === 'FORGET ME' || commandUpper === 'CLEAR MEMORY') {
    if (!currentUser) {
      addTerminalLine('No user logged in.', '#ff6666');
      return;
    }
    
    const memoryKey = `memory_${currentUser}`;
    localStorage.removeItem(memoryKey);
    userMemory = {
      userName: null,
      preferences: {},
      facts: [],
      topics: [],
      lastUpdated: new Date().toISOString()
    };
    addTerminalLine('🧹 MEMORY CLEARED', '#ffff00');
    addTerminalLine('All learned information about you has been forgotten.', '#ffff99');
    return;
  }
  
  // Personality commands
  if (commandUpper === 'PERSONALITY SHOW' || commandUpper === 'PERSONALITY') {
    let personalityInfo = '🎭 MY PERSONALITY\n';
    personalityInfo += '═════════════════════════════════════\n\n';
    personalityInfo += `Friendliness: ${'█'.repeat(botPersonality.friendliness)}${'░'.repeat(10-botPersonality.friendliness)} (${botPersonality.friendliness}/10)\n`;
    personalityInfo += `   ${botPersonality.friendliness > 7 ? '😊 Super warm and approachable!' : botPersonality.friendliness > 4 ? '🙂 Friendly and helpful' : '😐 Professional and reserved'}\n\n`;
    
    personalityInfo += `Humor: ${'█'.repeat(botPersonality.humor)}${'░'.repeat(10-botPersonality.humor)} (${botPersonality.humor}/10)\n`;
    personalityInfo += `   ${botPersonality.humor > 7 ? '😄 Always cracking jokes!' : botPersonality.humor > 4 ? '😊 Occasional wit' : '😐 Serious and focused'}\n\n`;
    
    personalityInfo += `Enthusiasm: ${'█'.repeat(botPersonality.enthusiasm)}${'░'.repeat(10-botPersonality.enthusiasm)} (${botPersonality.enthusiasm}/10)\n`;
    personalityInfo += `   ${botPersonality.enthusiasm > 7 ? '🎉 Super excited about everything!' : botPersonality.enthusiasm > 4 ? '✨ Positive energy' : '😑 Calm and measured'}\n\n`;
    
    personalityInfo += `Formality: ${'█'.repeat(botPersonality.formality)}${'░'.repeat(10-botPersonality.formality)} (${botPersonality.formality}/10)\n`;
    personalityInfo += `   ${botPersonality.formality > 7 ? '🎩 Very professional' : botPersonality.formality > 4 ? '👔 Balanced approach' : '👕 Casual and relaxed'}\n\n`;
    
    personalityInfo += `Chattiness: ${'█'.repeat(botPersonality.chattiness)}${'░'.repeat(10-botPersonality.chattiness)} (${botPersonality.chattiness}/10)\n`;
    personalityInfo += `   ${botPersonality.chattiness > 7 ? '💬 Loves to elaborate!' : botPersonality.chattiness > 4 ? '📝 Balanced responses' : '📄 Brief and concise'}\n\n`;
    
    personalityInfo += `Curiosity: ${'█'.repeat(botPersonality.curiosity)}${'░'.repeat(10-botPersonality.curiosity)} (${botPersonality.curiosity}/10)\n`;
    personalityInfo += `   ${botPersonality.curiosity > 7 ? '🔍 Always asking questions!' : botPersonality.curiosity > 4 ? '💭 Engaged listener' : '📊 Focused on answers'}\n\n`;
    
    personalityInfo += '═════════════════════════════════════\n';
    personalityInfo += 'Change traits with: PERSONALITY SET [trait] [1-10]\n';
    personalityInfo += 'Example: PERSONALITY SET humor 9';
    
    addTerminalLine(personalityInfo, '#00ff00');
    return;
  }
  
  if (commandUpper.startsWith('PERSONALITY SET ')) {
    const parts = command.substring(16).trim().split(' ');
    if (parts.length < 2) {
      addTerminalLine('Usage: PERSONALITY SET [trait] [value]', '#ffff99');
      addTerminalLine('Traits: friendliness, humor, enthusiasm, formality, chattiness, curiosity', '#c0ffc0');
      addTerminalLine('Values: 1-10', '#c0ffc0');
      return;
    }
    
    const trait = parts[0].toLowerCase();
    const value = parseInt(parts[1]);
    
    if (!['friendliness', 'humor', 'enthusiasm', 'formality', 'chattiness', 'curiosity'].includes(trait)) {
      addTerminalLine('❌ Invalid trait. Choose from:', '#ff6666');
      addTerminalLine('friendliness, humor, enthusiasm, formality, chattiness, curiosity', '#ffff99');
      return;
    }
    
    if (isNaN(value) || value < 1 || value > 10) {
      addTerminalLine('❌ Value must be between 1 and 10', '#ff6666');
      return;
    }
    
    botPersonality[trait] = value;
    savePersonality();
    
    addTerminalLine(`✅ ${trait.toUpperCase()} set to ${value}/10`, '#00ff00');
    
    // Give feedback on the change
    if (trait === 'friendliness') {
      if (value > 7) {
        addTerminalLine('I feel so warm and fuzzy now! Let\'s be best friends! 😊', '#c0ffc0');
      } else if (value < 4) {
        addTerminalLine('Noted. Maintaining professional distance.', '#c0ffc0');
      } else {
        addTerminalLine('Balanced and friendly. Got it!', '#c0ffc0');
      }
    } else if (trait === 'humor') {
      if (value > 7) {
        addTerminalLine('Time to crack some jokes! Why did the bot cross the road? To help YOU! 😄', '#c0ffc0');
      } else if (value < 4) {
        addTerminalLine('Humor module deactivated. Serious mode engaged.', '#c0ffc0');
      }
    } else if (trait === 'enthusiasm') {
      if (value > 7) {
        addTerminalLine('THIS IS AMAZING!! I\'M SO EXCITED!!! 🎉🎉🎉', '#c0ffc0');
      } else if (value < 4) {
        addTerminalLine('Enthusiasm dampened. Proceeding calmly.', '#c0ffc0');
      }
    }
    
    return;
  }
  
  if (commandUpper === 'PERSONALITY RESET') {
    botPersonality = {
      friendliness: 8,
      humor: 6,
      enthusiasm: 7,
      formality: 3,
      chattiness: 6,
      curiosity: 7
    };
    savePersonality();
    addTerminalLine('🔄 PERSONALITY RESET TO DEFAULTS', '#00ff00');
    addTerminalLine('Back to my usual self! Ready to help with a smile! 😊', '#c0ffc0');
    return;
  }
  
  // Memory management commands
  if (commandUpper === 'MEMORY STATS' || commandUpper === 'MEMORY STATUS') {
    const journalSize = activeJournal ? activeJournal.length : 0;
    const userMemorySize = userMemory ? (userMemory.facts.length + userMemory.topics.length) : 0;
    const feedbackSize = Object.keys(JSON.parse(localStorage.getItem('messageFeedback') || '{}')).length;
    
    // Calculate storage usage
    const storageUsed = new Blob([localStorage.getItem('terminalJournal') || '']).size;
    const totalStorage = new Blob([JSON.stringify(localStorage)]).size;
    const storagePercent = ((totalStorage / (5 * 1024 * 1024)) * 100).toFixed(2); // 5MB typical limit
    
    let stats = '📊 MEMORY STATISTICS\n';
    stats += '═════════════════════════════════════\n\n';
    stats += `💬 Conversation Journal: ${journalSize} messages\n`;
    stats += `   ${journalSize < 100 ? '✅ Plenty of space' : journalSize < 300 ? '⚠️ Moderate usage' : '🔴 High usage - consider cleanup'}\n\n`;
    
    stats += `🧠 User Memory:\n`;
    stats += `   Facts stored: ${userMemory.facts ? userMemory.facts.length : 0}\n`;
    stats += `   Topics tracked: ${userMemory.topics ? userMemory.topics.length : 0}\n`;
    stats += `   Preferences: ${userMemory.preferences ? Object.keys(userMemory.preferences).length : 0}\n\n`;
    
    stats += `👍 Message Feedback: ${feedbackSize} ratings\n\n`;
    
    stats += `💾 Total Storage: ${storagePercent}% of browser limit\n`;
    stats += `   ${storagePercent < 50 ? '✅ Healthy' : storagePercent < 80 ? '⚠️ Getting full' : '🔴 Nearly full'}\n\n`;
    
    stats += '═════════════════════════════════════\n';
    stats += '🧹 Auto-cleanup: ENABLED (keeps top 500 messages)\n';
    stats += '💡 Use MEMORY CLEANUP to manually optimize storage\n';
    
    addTerminalLine(stats, '#00ff00');
    return;
  }
  
  if (commandUpper === 'MEMORY CLEANUP') {
    addTerminalLine('🧹 Running memory optimization...', '#ffff99');
    
    setTimeout(() => {
      const beforeJournal = activeJournal ? activeJournal.length : 0;
      const beforeFacts = userMemory.facts ? userMemory.facts.length : 0;
      const beforeTopics = userMemory.topics ? userMemory.topics.length : 0;
      
      // Perform cleanup
      performAutoCleanup();
      cleanupUserMemory();
      
      // Force cleanup of old feedback
      const feedback = JSON.parse(localStorage.getItem('messageFeedback') || '{}');
      const ninetyDaysAgo = Date.now() - (90 * 24 * 60 * 60 * 1000);
      let removedFeedback = 0;
      
      for (const [msgId, data] of Object.entries(feedback)) {
        const timestamp = new Date(data.timestamp).getTime();
        if (timestamp < ninetyDaysAgo) {
          delete feedback[msgId];
          removedFeedback++;
        }
      }
      
      if (removedFeedback > 0) {
        localStorage.setItem('messageFeedback', JSON.stringify(feedback));
      }
      
      const afterJournal = activeJournal ? activeJournal.length : 0;
      const afterFacts = userMemory.facts ? userMemory.facts.length : 0;
      const afterTopics = userMemory.topics ? userMemory.topics.length : 0;
      
      const removedJournal = beforeJournal - afterJournal;
      const removedFacts = beforeFacts - afterFacts;
      const removedTopics = beforeTopics - afterTopics;
      
      addTerminalLine('✅ MEMORY OPTIMIZATION COMPLETE', '#00ff00');
      addTerminalLine(`\nRemoved low-priority data:`, '#c0ffc0');
      addTerminalLine(`  • Journal entries: ${removedJournal > 0 ? removedJournal + ' removed' : 'none removed'}`, '#ffff99');
      addTerminalLine(`  • Memory facts: ${removedFacts > 0 ? removedFacts + ' removed' : 'all kept'}`, '#ffff99');
      addTerminalLine(`  • Topics: ${removedTopics > 0 ? removedTopics + ' removed' : 'all kept'}`, '#ffff99');
      addTerminalLine(`  • Old feedback: ${removedFeedback > 0 ? removedFeedback + ' removed' : 'none removed'}`, '#ffff99');
      addTerminalLine(`\nImportant conversations and memories preserved! 💾`, '#00ff00');
      
    }, 300);
    return;
  }
  
  if (commandUpper === 'EXIT') {
    addTerminalLine('Exiting terminal...', '#ffff00');
    setTimeout(() => {
      window.location.href = 'index.html';
    }, 1000);
    return;
  }
  
  // Handle journal commands
  if (commandUpper === 'JOURNAL ENABLE') {
    journalPermission = 'enabled';
    localStorage.setItem('terminalJournalPermission', 'enabled');
    addTerminalLine('JOURNAL ENABLED\n---------------\nAll future conversations will be saved.', '#00ff00');
    return;
  }
  
  if (commandUpper === 'JOURNAL DISABLE') {
    journalPermission = 'disabled';
    localStorage.setItem('terminalJournalPermission', 'disabled');
    addTerminalLine('JOURNAL DISABLED\n----------------\nConversations will no longer be saved.', '#ffff00');
    return;
  }
  
  if (commandUpper === 'JOURNAL') {
    response = displayJournal();
    setTimeout(() => {
      addTerminalLine(response, '#00ff00');
    }, 300);
    return;
  }
  
  if (commandUpper === 'JOURNAL FULL') {
    const journal = loadJournal();
    if (journal.length === 0) {
      response = 'JOURNAL EMPTY\n--------------\nNo previous conversations recorded.';
    } else {
      response = 'COMPLETE JOURNAL\n================\n';
      response += `Total Entries: ${journal.length}\n\n`;
      journal.reverse().forEach((entry, index) => {
        response += `[${entry.timestamp}]\n> ${entry.command}\n${entry.response.substring(0, 150)}...\n─────────────────\n`;
      });
    }
    setTimeout(() => {
      addTerminalLine(response, '#00ff00');
    }, 300);
    return;
  }
  
  if (commandUpper === 'JOURNAL EXPORT') {
    response = exportJournal();
    setTimeout(() => {
      addTerminalLine(response, '#00ff00');
    }, 300);
    return;
  }
  
  if (commandUpper === 'JOURNAL CLEAR') {
    response = clearJournal();
    setTimeout(() => {
      addTerminalLine(response, '#ffff00');
    }, 300);
    return;
  }
  
  if (commandUpper === 'JOURNAL LOAD') {
    addTerminalLine('SELECT JOURNAL FILE TO LOAD...', '#00ff00');
    const fileInput = document.getElementById('journalUpload');
    fileInput.onchange = importJournalFile;
    fileInput.click();
    return;
  }
  
  // Helper function for async API calls
  const handleAsyncAPI = async (apiFunc, loadingMsg, ...args) => {
    showTypingIndicator();
    const result = await apiFunc(...args);
    hideTypingIndicator();
    addTerminalLine(result, '#00ff00');
    saveToJournal(command, result); // saveToJournal handles permission check
  };
  
  // Wikipedia search
  if (commandUpper.startsWith('WIKI ')) {
    const searchQuery = command.substring(5).trim();
    if (searchQuery) {
      handleAsyncAPI(searchWikipedia, 'Searching Wikipedia...', searchQuery);
    } else {
      addTerminalLine('Usage: WIKI [search term]\nExample: WIKI artificial intelligence', '#ffff99');
    }
    return;
  }
  
  // Dictionary lookup
  if (commandUpper.startsWith('DEFINE ')) {
    const word = command.substring(7).trim();
    if (word) {
      handleAsyncAPI(getDefinition, 'Looking up definition...', word);
    } else {
      addTerminalLine('Usage: DEFINE [word]\nExample: DEFINE serendipity', '#ffff99');
    }
    return;
  }
  
  // Random fact
  if (commandUpper === 'FACT' || commandUpper === 'RANDOM FACT') {
    handleAsyncAPI(getRandomFact, 'Fetching a random fact...');
    return;
  }
  
  // Random advice
  if (commandUpper === 'ADVICE' || commandUpper === 'RANDOM ADVICE') {
    handleAsyncAPI(getAdvice, 'Getting advice...');
    return;
  }
  
  // Dad joke
  if (commandUpper === 'JOKE' || commandUpper === 'DAD JOKE') {
    handleAsyncAPI(getDadJoke, 'Fetching a joke...');
    return;
  }
  
  // Random quote
  if (commandUpper === 'QUOTE' || commandUpper === 'RANDOM QUOTE') {
    handleAsyncAPI(getRandomQuote, 'Fetching a quote...');
    return;
  }
  
  // GitHub user lookup
  if (commandUpper.startsWith('GITHUB ')) {
    const username = command.substring(7).trim();
    if (username) {
      handleAsyncAPI(getGitHubUser, 'Fetching GitHub profile...', username);
    } else {
      addTerminalLine('Usage: GITHUB [username]\nExample: GITHUB torvalds', '#ffff99');
    }
    return;
  }
  
  // Check for exact command match
  if (commands[commandUpper]) {
    response = commands[commandUpper];
    
    // Special handling for HELP command - make it interactive
    if (commandUpper === 'HELP') {
      displayInteractiveHelp();
      saveToJournal(commandUpper, 'Interactive help menu displayed');
      return;
    }
    
    addTerminalLine(response, '#00ff00');
    saveToJournal(commandUpper, response);
    return;
  }
  
  // Check if user is asking for recalled information
  const memoryResponse = recallMemory(command);
  if (memoryResponse) {
    addTerminalLine(memoryResponse, '#00ff00');
    saveToJournal(command, memoryResponse);
    return;
  }
  
  // Try natural language processing first
  response = processNaturalLanguage(command, commandUpper);
  
  if (response) {
    addTerminalLine(response, '#00ff00');
    saveToJournal(command, response);
    extractAndLearn(command, response); // Learn from this interaction
    updateContext(command, response); // Track conversation context
    return;
  }
  
  // Try exact command matching with partial matches (only for specific keywords)
  const lowerCommand = command.toLowerCase();
  let found = false;
  
  // Only match if the command is the main focus (not just a word in a sentence)
  for (const [key, value] of Object.entries(commands)) {
    const keyLower = key.toLowerCase();
    // Only match if it's at the start or is the whole command
    if (lowerCommand === keyLower || lowerCommand.startsWith(keyLower + ' ')) {
      response = value;
      addTerminalLine(response, '#00ff00');
      saveToJournal(command, response);
      found = true;
      break;
    }
  }
  
  if (!found) {
    // If in game, try to parse as game action
    if (gameState.inGame) {
      showTypingIndicator();
      setTimeout(async () => {
        hideTypingIndicator();
        let response = await generateWithAI(command);
        
        if (!response) {
          // Contextual fallback that acknowledges their action
          response = `*You ${command.toLowerCase()}...*\n\n`;
          
          if (narratorPersonality.chaos > 7) {
            const surprises = [
              'Suddenly, everything changes! The ground trembles beneath your feet!',
              'An unexpected twist! Something you never saw coming occurs!',
              'The world warps around you! Reality shifts in impossible ways!',
              'A wild event unfolds! This is not what you expected!'
            ];
            response += surprises[Math.floor(Math.random() * surprises.length)];
          } else {
            response += `The world responds to your action. Something shifts in the atmosphere.\n\nWhat happens next is up to you.`;
          }
          
          response += `\n\nWhat do you do?`;
        }
        
        addTerminalLine(response, '#00ff00');
        saveToJournal(command, response);
      }, 800);
      return;
    }
    
    // Try Hugging Face AI first if enabled (out of game)
    if (checkHuggingFaceStatus()) {
      showTypingIndicator();
      
      getHuggingFaceResponse(command).then(aiResponse => {
        hideTypingIndicator();
        if (aiResponse) {
          // Got a response from Hugging Face
          addTerminalLine(aiResponse, '#00ff00');
          saveToJournal(command, aiResponse);
          extractAndLearn(command, aiResponse);
          updateContext(command, aiResponse);
        } else {
          // Hugging Face failed, use fallback
          const fallbackResponse = getConversationalFallback(command);
          addTerminalLine(fallbackResponse, '#00ff00');
          saveToJournal(command, fallbackResponse);
          extractAndLearn(command, fallbackResponse);
          updateContext(command, fallbackResponse);
        }
      }).catch(error => {
        hideTypingIndicator();
        // Error occurred, use fallback
        const fallbackResponse = getConversationalFallback(command);
        addTerminalLine(fallbackResponse, '#00ff00');
        saveToJournal(command, fallbackResponse);
        extractAndLearn(command, fallbackResponse);
        updateContext(command, fallbackResponse);
      });
    } else {
      // Hugging Face not enabled, use regular fallback
      showTypingIndicator();
      setTimeout(() => {
        hideTypingIndicator();
        response = getConversationalFallback(command);
        addTerminalLine(response, '#00ff00');
        saveToJournal(command, response);
        extractAndLearn(command, response);
        updateContext(command, response);
      }, 500);
    }
  }
}

// ========================================
// INITIALIZATION SEQUENCE
// ========================================

let aiName = localStorage.getItem('terminalAIName');
let journalPermission = localStorage.getItem('terminalJournalPermission');
let initStep = 0;

// Check if first time user
function checkFirstTimeUser() {
  const initPrompts = document.getElementById('initPrompts');
  const header = document.getElementById('terminalHeader');
  
  // Immediate load - no delay
  if (!aiName || !journalPermission) {
    initPrompts.style.display = 'block';
    initStep = aiName ? 2 : 1;
  } else {
    // Returning user - update header
    const username = currentUser || localStorage.getItem('currentUser') || 'Adventurer';
    // Limit username length to ensure proper box alignment (max 49 chars to fit in "Welcome back, " + "!")
    const limitedUsername = username.length > 49 ? username.substring(0, 49) + '...' : username;
    // Pad username line to match box width (62 chars total to account for spaces around content)
    const usernameLine = `Welcome back, ${limitedUsername}!`;
    const paddedUsernameLine = usernameLine + ' '.repeat(Math.max(0, 62 - usernameLine.length));
    header.innerHTML = `<pre style="color: #00ff00; margin: 0; text-shadow: 0 0 5px rgba(0,255,0,0.5); overflow-x: auto;">
╔═══════════════════════════════════════════════════════════════╗
║ ${paddedUsernameLine}║
╚═══════════════════════════════════════════════════════════════╝
    </pre>`;
    
    addTerminalLine(`⚔️ Welcome back, ${username}!`, '#00ff00');
    
    // Check if game is loaded
    if (gameState.character) {
      addTerminalLine(`✅ Character loaded: ${gameState.character.name} the ${gameState.character.class}`, '#00ff00');
      addTerminalLine(`Type CONTINUE to resume your adventure, or START for a new quest!`, '#c0ffc0');
    } else {
      addTerminalLine(`Type CREATE CHARACTER to begin, or START for a quick adventure!`, '#00ff00');
    }
    
    addTerminalLine(`\n💡 Type HELP or click ? for all commands!`, '#ffff99');
  }
}

checkFirstTimeUser();
updateModeIndicator(); // Set initial mode indicator

// Show conversation starters if chat is empty
setTimeout(() => {
  showConversationStarters();
}, 500);

// ========================================
// CONSOLE SECURITY - Prevent API key leakage
// ========================================

// Wrap console functions to filter sensitive data
const originalConsoleLog = console.log;
const originalConsoleError = console.error;
const originalConsoleWarn = console.warn;

console.log = function(...args) {
  const filtered = args.map(arg => {
    if (typeof arg === 'string') {
      return sanitizePersonalInfo(arg);
    }
    return arg;
  });
  originalConsoleLog.apply(console, filtered);
};

console.error = function(...args) {
  const filtered = args.map(arg => {
    if (typeof arg === 'string') {
      return sanitizePersonalInfo(arg);
    }
    return arg;
  });
  originalConsoleError.apply(console, filtered);
};

console.warn = function(...args) {
  const filtered = args.map(arg => {
    if (typeof arg === 'string') {
      return sanitizePersonalInfo(arg);
    }
    return arg;
  });
  originalConsoleWarn.apply(console, filtered);
};

// Display security notice on first load
if (!localStorage.getItem('securityNoticeShown')) {
  setTimeout(() => {
    addTerminalLine('🔒 SECURITY NOTICE', '#00ff00');
    addTerminalLine('═══════════════════════════════════════', '#00ff00');
    addTerminalLine('This chatbot has enterprise-level security protections:', '#c0ffc0');
    addTerminalLine('• All personal information is automatically detected and blocked', '#c0ffc0');
    addTerminalLine('• Your IP address and data are never collected or transmitted', '#c0ffc0');
    addTerminalLine('• Hacking attempts are automatically detected and blocked', '#c0ffc0');
    addTerminalLine('• All data is stored locally on YOUR device only', '#c0ffc0');
    addTerminalLine('• API keys are encrypted and never displayed', '#c0ffc0');
    addTerminalLine('• Console output is sanitized to prevent leaks', '#c0ffc0');
    addTerminalLine('\nType SECURITY STATUS anytime to view all active protections.', '#ffff99');
    addTerminalLine('═══════════════════════════════════════', '#00ff00');
    localStorage.setItem('securityNoticeShown', 'true');
  }, 1000);
}

// Handle journal file import
function importJournalFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      
      // Validate it's from this system
      if (!Array.isArray(data)) {
        addTerminalLine('ERROR: Invalid journal file format.', '#00ff00');
        return;
      }
      
      // Check if entries have required fields (if there are entries)
      if (data.length > 0) {
        const isValid = data.every(entry => 
          entry.hasOwnProperty('timestamp') && 
          entry.hasOwnProperty('command') && 
          entry.hasOwnProperty('response')
        );
        
        if (!isValid) {
          addTerminalLine('ERROR: File is not from this terminal system.', '#00ff00');
          addTerminalLine('Only journal files created by this system can be imported.', '#00ff00');
          return;
        }
      }
      
      // Load the journal as active session
      setActiveJournal(data);
      addTerminalLine(`✅ Session loaded successfully!`, '#00ff00');
      addTerminalLine(`I found ${data.length} messages from before. Let's continue where we left off!`, '#00ff00');
      
    } catch (error) {
      addTerminalLine('ERROR: Could not read journal file.', '#00ff00');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// Extract name from user input
function extractName(input) {
  // Remove common phrases to extract just the name
  let name = input.trim();
  
  // Patterns to remove
  const patterns = [
    /^(your name is|you are|i'll call you|call you|i want to call you|name you|you're|your)\s+/i,
    /^(i'd like to call you|let's call you|how about|what about)\s+/i,
    /^(be called|be named)\s+/i
  ];
  
  patterns.forEach(pattern => {
    name = name.replace(pattern, '');
  });
  
  // Remove trailing punctuation
  name = name.replace(/[.,!?;]+$/, '');
  
  // If it's still too long or empty, just use the first word
  if (name.length > 20 || name.includes(' ')) {
    const words = name.split(' ');
    name = words[0];
  }
  
  return name.trim();
}

// Handle initialization responses
function handleInitialization(input) {
  const initPrompts = document.getElementById('initPrompts');
  const header = document.getElementById('terminalHeader');
  
  if (initStep === 1) {
    // Step 1: Check for existing journal
    const response = input.toUpperCase();
    addTerminalLine(input, '#00ff00', true);
    
    if (response === 'UPLOAD') {
      addTerminalLine(`Great! Opening file selector...`, '#00ff00');
      addTerminalLine(`Please choose your saved session file.`, '#00ff00');
      
      // Trigger file upload
      const fileInput = document.getElementById('journalUpload');
      fileInput.onchange = importJournalFile;
      fileInput.click();
      
      // Wait a moment then proceed to name
      setTimeout(() => {
        addTerminalLine(`\nNow, what would you like to call me? 🤖`, '#00ff00');
        addTerminalLine(`You can give me any name you'd like!`, '#00ff00');
      }, 1000);
      
      initStep = 2;
      return true;
    } else {
      // Skip to name - create new session
      addTerminalLine(`No problem! Starting a fresh session. ✨`, '#00ff00');
      
      // Initialize empty journal
      setActiveJournal([]);
      
      addTerminalLine(`\nWhat would you like to call me? 🤖`, '#00ff00');
      addTerminalLine(`You can give me any name you'd like!`, '#00ff00');
      
      initStep = 2;
      return true;
    }
  }
  
  if (initStep === 2) {
    // Step 2: Getting name - could be AI name or character name
    aiName = extractName(input);
    
    // Validate name is not empty
    if (!aiName || aiName.length < 1) {
      addTerminalLine(input, '#00ff00', true);
      addTerminalLine(`Hmm, I didn't catch that. What shall I call you, adventurer? ⚔️`, '#00ff00');
      return true;
    }
    
    localStorage.setItem('terminalAIName', aiName);
    
    // Update the header with the user's actual username
    const username = currentUser || 'Adventurer';
    // Limit username length to ensure proper box alignment (max 53 chars to fit in "Welcome, " + "!")
    const limitedUsername = username.length > 53 ? username.substring(0, 53) + '...' : username;
    // Pad username line to match box width (62 chars total to account for spaces around content)
    const usernameLine = `Welcome, ${limitedUsername}!`;
    const paddedUsernameLine = usernameLine + ' '.repeat(Math.max(0, 62 - usernameLine.length));
    header.innerHTML = `<pre style="color: #00ff00; margin: 0; text-shadow: 0 0 5px rgba(0,255,0,0.5); overflow-x: auto;">
╔═══════════════════════════════════════════════════════════════╗
║ ${paddedUsernameLine}║
╚═══════════════════════════════════════════════════════════════╝
    </pre>`;
    
    addTerminalLine(input, '#00ff00', true);
    addTerminalLine(`Great! I'll be ${aiName}. Your adventure awaits, ${username}! ⚔️`, '#00ff00');
    
    // Ask about journal permission
    addTerminalLine(`\nWould you like me to save your adventures? 💾`, '#00ff00');
    addTerminalLine(`I can remember your quests and progress so you can continue later.`, '#00ff00');
    addTerminalLine(`Type YES to enable, or NO to skip.`, '#00ff00');
    
    initStep = 3;
    initPrompts.style.display = 'none';
    return true;
  }
  
  if (initStep === 3) {
    // Step 3: Getting journal permission
    const response = input.toUpperCase();
    addTerminalLine(input, '#00ff00', true);
    
    if (response === 'YES' || response === 'Y') {
      journalPermission = 'enabled';
      localStorage.setItem('terminalJournalPermission', 'enabled');
      addTerminalLine(`Perfect! Your adventures will be saved. ✅`, '#00ff00');
      addTerminalLine(`You can export or review them anytime.`, '#00ff00');
    } else {
      journalPermission = 'disabled';
      localStorage.setItem('terminalJournalPermission', 'disabled');
      addTerminalLine(`No problem! Your adventures won't be saved.`, '#00ff00');
      addTerminalLine(`You can enable this later if you change your mind.`, '#00ff00');
    }
    
    addTerminalLine(`\n🎉 All set, ${aiName}!`, '#00ff00');
    addTerminalLine(`⚔️ Ready to embark on epic quests!`, '#c0ffc0');
    addTerminalLine(`\n💡 Type CREATE CHARACTER to design your hero, or START for a quick adventure!`, '#ffff99');
    addTerminalLine(`Type HELP or press ? to see all commands!`, '#ffff99');
    
    initStep = 0;
    initPrompts.style.display = 'none';
    return true;
  }
  
  return false;
}
</script>

<style>
/* Spotify Player Widget */
#spotifyWidget {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  width: 300px;
  background: #000;
  border: 3px solid #1DB954;
  border-radius: 10px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  z-index: 100001;
  cursor: move;
}

#spotifyHeader {
  background: #1DB954;
  color: #fff;
  padding: 8px 12px;
  font-weight: bold;
  font-size: 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: move;
  border-radius: 7px 7px 0 0;
}

#spotifyMinimize {
  background: none;
  border: none;
  color: #fff;
  font-size: 20px;
  cursor: pointer;
  padding: 0 5px;
  line-height: 1;
}

#spotifyMinimize:hover {
  color: #000;
}
</style>


<script>
// Set Spotify widget to minimized state on load
document.addEventListener('DOMContentLoaded', function() {
  const spotifyWidget = document.getElementById('spotifyWidget');
  if (spotifyWidget) {
    spotifyWidget.style.width = '200px';
  }
});
</script>

<script>
// Draggable Spotify Widget
let spotifyChatDragging = false;
let spotifyChatCurrentX;
let spotifyChatCurrentY;
let spotifyChatInitialX;
let spotifyChatInitialY;
let spotifyChatXOffset = 0;
let spotifyChatYOffset = 0;

const spotifyChatWidget = document.getElementById('spotifyWidget');
const spotifyChatHeader = document.getElementById('spotifyHeader');

spotifyChatHeader.addEventListener('mousedown', spotifyChatDragStart);
document.addEventListener('mousemove', spotifyChatDrag);
document.addEventListener('mouseup', spotifyChatDragEnd);

function spotifyChatDragStart(e) {
  spotifyChatInitialX = e.clientX - spotifyChatXOffset;
  spotifyChatInitialY = e.clientY - spotifyChatYOffset;
  
  if (e.target === spotifyChatHeader || e.target.parentElement === spotifyChatHeader) {
    spotifyChatDragging = true;
  }
}

function spotifyChatDrag(e) {
  if (spotifyChatDragging) {
    e.preventDefault();
    spotifyChatCurrentX = e.clientX - spotifyChatInitialX;
    spotifyChatCurrentY = e.clientY - spotifyChatInitialY;
    spotifyChatXOffset = spotifyChatCurrentX;
    spotifyChatYOffset = spotifyChatCurrentY;
    
    spotifyChatSetTranslate(spotifyChatCurrentX, spotifyChatCurrentY, spotifyChatWidget);
  }
}

function spotifyChatDragEnd(e) {
  spotifyChatInitialX = spotifyChatCurrentX;
  spotifyChatInitialY = spotifyChatCurrentY;
  spotifyChatDragging = false;
}

function spotifyChatSetTranslate(xPos, yPos, el) {
  el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
}

function toggleSpotifyChat() {
  const content = document.getElementById('spotifyContent');
  const btn = document.getElementById('spotifyMinimize');
  
  if (content.style.display === 'none') {
    content.style.display = 'block';
    btn.textContent = '−';
    spotifyChatWidget.style.width = '300px';
  } else {
    content.style.display = 'none';
    btn.textContent = '+';
    spotifyChatWidget.style.width = '200px';
  }
}
</script>

</body>
</html>

