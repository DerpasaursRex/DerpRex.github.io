<!DOCTYPE html>
<html lang="en">
<head>
  <title>Catherine Ann MacDonald - ChatBot</title>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://ajax.googleapis.com https://cdnjs.cloudflare.com https://maxcdn.bootstrapcdn.com https://api-inference.huggingface.co https://api.languagetool.org https://en.wikipedia.org https://api.dictionaryapi.dev https://uselessfacts.jsph.pl https://api.adviceslip.com https://icanhazdadjoke.com https://api.quotable.io https://api.github.com https://open.spotify.com; connect-src 'self' https://api-inference.huggingface.co https://api.languagetool.org https://en.wikipedia.org https://api.dictionaryapi.dev https://uselessfacts.jsph.pl https://api.adviceslip.com https://icanhazdadjoke.com https://api.quotable.io https://api.github.com; style-src 'self' 'unsafe-inline' https://maxcdn.bootstrapcdn.com; img-src 'self' data:; frame-src https://open.spotify.com;">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  

<style>
  .jumbotron {
    background-image: url("rexbanner.png");
    background-size: cover;
    background-repeat: no-repeat;
    background-position: center;
    color: white;
  }
</style>
</head>
<body>

<!-- Terminal-style Navigation Bar -->
    <nav style="background: #000; border-bottom: 3px solid #00ff00; padding: 10px 20px; font-family: 'Courier New', monospace;">
      <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;">
        <div id="terminalHeader" style="color: #00ff00; font-size: 18px; font-weight: bold; margin-bottom: 5px;">
          [ TERMINAL SYSTEM ]
        </div>
    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
      <a href="index.html" style="color: #00ff00; text-decoration: none; padding: 5px 10px; border: 1px solid #00ff00; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='transparent'; this.style.color='#00ff00'">[HOME]</a>
    </div>
  </div>
</nav>

<!-- Language Selection Screen -->
<div id="languageScreen" class="container-fluid" style="margin-top:0; padding: 0; height: calc(100vh - 56px); display: flex; justify-content: center; align-items: center; background: #000;">
  <div style="max-width: 700px; width: 90%; background: #000; border: 3px solid #00ff00; padding: 40px; box-shadow: 0 0 30px rgba(0,255,0,0.3);">
    <div style="border-bottom: 2px solid #00ff00; padding-bottom: 15px; margin-bottom: 30px; text-align: center;">
      <pre style="color: #00ff00; margin: 0; font-size: 12px;">
╔═══════════════════════════════════════════╗
║     LANGUAGE SELECTION SYSTEM             ║
║     Select Your Preferred Language        ║
╚═══════════════════════════════════════════╝
      </pre>
    </div>
    
    <div style="color: #00ff00; margin-bottom: 20px; text-align: center; font-family: 'Courier New', monospace; font-size: 16px;">
      🌍 Choose Your Language / Choisissez votre langue / Wählen Sie Ihre Sprache
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
      <button onclick="selectLanguage('en')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇬🇧 English
      </button>
      <button onclick="selectLanguage('es')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇪🇸 Español
      </button>
      <button onclick="selectLanguage('fr')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇫🇷 Français
      </button>
      <button onclick="selectLanguage('de')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇩🇪 Deutsch
      </button>
      <button onclick="selectLanguage('it')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇮🇹 Italiano
      </button>
      <button onclick="selectLanguage('pt')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇵🇹 Português
      </button>
      <button onclick="selectLanguage('ru')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇷🇺 Русский
      </button>
      <button onclick="selectLanguage('ja')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇯🇵 日本語
      </button>
      <button onclick="selectLanguage('zh')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇨🇳 中文
      </button>
      <button onclick="selectLanguage('ko')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇰🇷 한국어
      </button>
      <button onclick="selectLanguage('ar')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇸🇦 العربية
      </button>
      <button onclick="selectLanguage('hi')" class="lang-btn" style="background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00ff00'; this.style.color='#000'" onmouseout="this.style.background='#000'; this.style.color='#00ff00'">
        🇮🇳 हिन्दी
      </button>
    </div>
  </div>
</div>

<!-- Registration Screen (First Time Users) -->
<div id="registrationScreen" class="container-fluid" style="margin-top:0; padding: 0; height: calc(100vh - 56px); display: none; justify-content: center; align-items: center; background: #000;">
  <div style="max-width: 600px; width: 90%; background: #000; border: 3px solid #00ff00; padding: 40px; box-shadow: 0 0 30px rgba(0,255,0,0.3);">
    <div style="border-bottom: 2px solid #00ff00; padding-bottom: 15px; margin-bottom: 30px; text-align: center;">
      <pre style="color: #00ff00; margin: 0; font-size: 12px;">
╔═══════════════════════════════════════════╗
║     NEW USER REGISTRATION                 ║
║     Create Your Account                   ║
╚═══════════════════════════════════════════╝
      </pre>
    </div>
    
    <div style="margin-bottom: 25px;">
      <div style="color: #00ff00; margin-bottom: 10px; font-family: 'Courier New', monospace; font-size: 16px;">
        👋 Welcome to the AI Chat System!
      </div>
      <div style="color: #c0ffc0; margin-bottom: 20px; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.6;">
        Create a username and password to save your conversations and preferences.
        <br><br>Your data will be stored securely and privately.
      </div>
    </div>
    
    <div id="registrationError" style="color: #ff6666; font-family: 'Courier New', monospace; margin-bottom: 15px; display: none;">
      ❌ Error message here
    </div>
    
    <div style="margin-bottom: 15px;">
      <label style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; display: block; margin-bottom: 8px;">
        CREATE USERNAME:
      </label>
      <input type="text" id="regUsername" 
             style="width: 100%; background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 12px; font-family: 'Courier New', monospace; font-size: 16px; outline: none;"
             placeholder="Choose a username..."
             onkeypress="if(event.key==='Enter') document.getElementById('regPassword').focus()">
      <div style="color: #ffff99; font-size: 12px; margin-top: 5px; font-family: 'Courier New', monospace;">
        3-20 characters, letters and numbers only
      </div>
    </div>
    
    <div style="margin-bottom: 15px;">
      <label style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; display: block; margin-bottom: 8px;">
        CREATE PASSWORD:
      </label>
      <input type="password" id="regPassword" 
             style="width: 100%; background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 12px; font-family: 'Courier New', monospace; font-size: 16px; outline: none;"
             placeholder="Choose a password..."
             onkeypress="if(event.key==='Enter') document.getElementById('regPasswordConfirm').focus()">
      <div style="color: #ffff99; font-size: 12px; margin-top: 5px; font-family: 'Courier New', monospace;">
        At least 6 characters
      </div>
    </div>
    
    <div style="margin-bottom: 20px;">
      <label style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; display: block; margin-bottom: 8px;">
        CONFIRM PASSWORD:
      </label>
      <input type="password" id="regPasswordConfirm" 
             style="width: 100%; background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 12px; font-family: 'Courier New', monospace; font-size: 16px; outline: none;"
             placeholder="Re-enter password..."
             onkeypress="if(event.key==='Enter') registerNewUser()">
    </div>
    
    <button onclick="registerNewUser()" 
            style="width: 100%; background: #00ff00; color: #000; border: none; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; font-size: 16px; cursor: pointer; transition: all 0.2s; margin-bottom: 10px;"
            onmouseover="this.style.background='#00cc00'" 
            onmouseout="this.style.background='#00ff00'">
      [ CREATE ACCOUNT ]
    </button>
    
    <div style="text-align: center; margin-top: 15px;">
      <a href="#" onclick="showLoginScreen(); return false;" style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; text-decoration: underline;">
        Already have an account? Login here
      </a>
    </div>
  </div>
</div>

<!-- Login Screen (Returning Users) -->
<div id="passwordScreen" class="container-fluid" style="margin-top:0; padding: 0; height: calc(100vh - 56px); display: none; justify-content: center; align-items: center; background: #000;">
  <div style="max-width: 600px; width: 90%; background: #000; border: 3px solid #00ff00; padding: 40px; box-shadow: 0 0 30px rgba(0,255,0,0.3);">
    <div style="border-bottom: 2px solid #00ff00; padding-bottom: 15px; margin-bottom: 30px; text-align: center;">
      <pre style="color: #00ff00; margin: 0; font-size: 12px;">
╔═══════════════════════════════════════════╗
║     SECURE ACCESS TERMINAL v1.0           ║
║     User Login                            ║
╚═══════════════════════════════════════════╝
      </pre>
    </div>
    
    <div style="margin-bottom: 25px;">
      <div style="color: #00ff00; margin-bottom: 10px; font-family: 'Courier New', monospace; font-size: 16px;">
        🔒 USER LOGIN
      </div>
      <div style="color: #c0ffc0; margin-bottom: 20px; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.6;">
        Welcome back! Login to access your chat history.
      </div>
    </div>
    
    <div id="passwordError" style="color: #ff6666; font-family: 'Courier New', monospace; margin-bottom: 15px; display: none;">
      ❌ ACCESS DENIED: Invalid credentials
    </div>
    
    <div style="margin-bottom: 15px;">
      <label style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; display: block; margin-bottom: 8px;">
        USERNAME:
      </label>
      <input type="text" id="chatUsername" 
             style="width: 100%; background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 12px; font-family: 'Courier New', monospace; font-size: 16px; outline: none;"
             placeholder="Enter username..."
             onkeypress="if(event.key==='Enter') document.getElementById('chatPassword').focus()">
    </div>
    
    <div style="margin-bottom: 20px;">
      <label style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; display: block; margin-bottom: 8px;">
        PASSWORD:
      </label>
      <input type="password" id="chatPassword" 
             style="width: 100%; background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 12px; font-family: 'Courier New', monospace; font-size: 16px; outline: none;"
             placeholder="Enter password..."
             onkeypress="if(event.key==='Enter') checkChatPassword()">
    </div>
    
    <button onclick="checkChatPassword()" 
            style="width: 100%; background: #00ff00; color: #000; border: none; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; font-size: 16px; cursor: pointer; transition: all 0.2s; margin-bottom: 10px;"
            onmouseover="this.style.background='#00cc00'" 
            onmouseout="this.style.background='#00ff00'">
      [ LOGIN ]
    </button>
    
    <div style="text-align: center; margin-top: 15px;">
      <a href="#" onclick="showRegistrationScreen(); return false;" style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px; text-decoration: underline; margin-right: 15px;">
        New user? Create an account
      </a>
      <span style="color: #00ff00;">|</span>
      <a href="#" onclick="showAdminLogin(); return false;" style="color: #ff6600; font-family: 'Courier New', monospace; font-size: 14px; text-decoration: underline; margin-left: 15px;">
        🔐 Admin Access
      </a>
    </div>
  </div>
</div>

<!-- Admin Login Screen -->
<div id="adminLoginScreen" class="container-fluid" style="margin-top:0; padding: 0; height: calc(100vh - 56px); display: none; justify-content: center; align-items: center; background: #000;">
  <div style="max-width: 600px; width: 90%; background: #000; border: 3px solid #ff6600; padding: 40px; box-shadow: 0 0 30px rgba(255,102,0,0.3);">
    <div style="border-bottom: 2px solid #ff6600; padding-bottom: 15px; margin-bottom: 30px; text-align: center;">
      <pre style="color: #ff6600; margin: 0; font-size: 12px;">
╔═══════════════════════════════════════════╗
║     ADMINISTRATOR ACCESS                  ║
║     Secure Login Required                 ║
╚═══════════════════════════════════════════╝
      </pre>
    </div>
    
    <div style="margin-bottom: 25px;">
      <div style="color: #ff6600; margin-bottom: 10px; font-family: 'Courier New', monospace; font-size: 16px;">
        🔐 ADMIN LOGIN
      </div>
      <div style="color: #ffcc99; margin-bottom: 20px; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.6;">
        Enter administrator password to continue.
      </div>
    </div>
    
    <div id="adminPasswordError" style="color: #ff6666; font-family: 'Courier New', monospace; margin-bottom: 15px; display: none;">
      ❌ ACCESS DENIED: Invalid admin password
    </div>
    
    <div style="margin-bottom: 20px;">
      <label style="color: #ff6600; font-family: 'Courier New', monospace; font-size: 14px; display: block; margin-bottom: 8px;">
        ADMIN PASSWORD:
      </label>
      <input type="password" id="adminPassword" 
             style="width: 100%; background: #000; color: #ff6600; border: 2px solid #ff6600; padding: 12px; font-family: 'Courier New', monospace; font-size: 16px; outline: none;"
             placeholder="Enter admin password..."
             onkeypress="if(event.key==='Enter') checkAdminPassword()">
    </div>
    
    <button onclick="checkAdminPassword()" 
            style="width: 100%; background: #ff6600; color: #fff; border: none; padding: 15px; font-family: 'Courier New', monospace; font-weight: bold; font-size: 16px; cursor: pointer; transition: all 0.2s; margin-bottom: 10px;"
            onmouseover="this.style.background='#ff4400'" 
            onmouseout="this.style.background='#ff6600'">
      [ ADMIN LOGIN ]
    </button>
    
    <div style="text-align: center; margin-top: 15px;">
      <a href="#" onclick="showLoginScreen(); return false;" style="color: #ff6600; font-family: 'Courier New', monospace; font-size: 14px; text-decoration: underline;">
        Back to user login
      </a>
    </div>
  </div>
</div>

<div class="container-fluid" id="chatContainer" style="margin-top:0; padding: 0; height: calc(100vh - 56px); display: none;">
  <div style="height: 100%; display: flex; flex-direction: column; position: relative;">
    
    <!-- Floating Help Button -->
    <button id="floatingHelpBtn" onclick="executeQuickCommand('HELP')" style="position: fixed; bottom: 80px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #00ff00, #00cc00); border: 3px solid #00ff00; color: #000; font-size: 24px; font-weight: bold; cursor: pointer; z-index: 10000; box-shadow: 0 4px 15px rgba(0,255,0,0.4); transition: all 0.3s; font-family: 'Courier New', monospace;" onmouseover="this.style.transform='scale(1.1) rotate(5deg)'; this.style.boxShadow='0 6px 20px rgba(0,255,0,0.6)'" onmouseout="this.style.transform='scale(1) rotate(0deg)'; this.style.boxShadow='0 4px 15px rgba(0,255,0,0.4)'">?</button>
    
    <!-- Terminal Window -->
    <div id="terminal" style="flex: 1; background: #000000; color: #00ff00; font-family: 'Courier New', monospace; padding: 20px; overflow-y: auto; border: 3px solid #333; box-shadow: inset 0 0 50px rgba(0,255,0,0.1);">
      
      <!-- Terminal Header -->
      <div id="terminalHeader" style="background: linear-gradient(180deg, #001a00 0%, #000000 100%); border: 2px solid #00ff00; padding: 15px; margin-bottom: 20px; box-shadow: 0 0 15px rgba(0,255,0,0.3);">
        <pre style="color: #00ff00; margin: 0; text-shadow: 0 0 5px rgba(0,255,0,0.5);">
╔═══════════════════════════════════════════════════════════════╗
║  CATHERINE MACDONALD INTERACTIVE SYSTEM v1.0                  ║
║  Copyright (c) 2025 - All Rights Reserved                     ║
║                                                                ║
║  Press '?' or type 'HELP' for quick access menu               ║
╚═══════════════════════════════════════════════════════════════╝
        </pre>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; flex-wrap: wrap; gap: 10px;">
          <div id="modeIndicator" style="color: #00ff00; font-size: 12px;">
            <span style="color: #ffff99;">MODE:</span> <span id="modeText" style="font-weight: bold;">SFW</span> <span style="color: #00ff00;">●</span>
          </div>
          <div style="color: #888; font-size: 11px;">
            <span style="color: #ffff99;">TIP:</span> Click the <span style="color: #00ff00;">?</span> button for commands
          </div>
        </div>
      </div>
      
      <!-- Boot Sequence -->
      <div id="bootSequence" style="display: none;">
        <div style="color: #00ff00;">System initializing...</div>
        <div style="color: #00ff00;">Loading AI modules... [OK]</div>
        <div style="color: #00ff00;">Establishing connection... [OK]</div>
        <div style="color: #00ff00;">Ready for input.</div>
        <div style="color: #00ff00; margin-top: 10px;">═══════════════════════════════════════════════════════════════</div>
      </div>
      
      <!-- Initialization Prompts -->
      <div id="initPrompts" style="margin-top: 20px; display: none;">
        <div style="color: #c0ffc0; margin-bottom: 10px; font-size: 16px; line-height: 1.6;">
          👋 Hello! I'm your AI assistant. This looks like your first time here.
        </div>
        <div style="color: #c0ffc0; margin-bottom: 15px; font-size: 16px; line-height: 1.6;">
          Do you have a saved session from before?
        </div>
        <div style="color: #ffff99; margin-bottom: 15px; font-size: 14px;">
          Type <strong>UPLOAD</strong> if you have a saved file, or <strong>SKIP</strong> to start fresh.
        </div>
      </div>
      
      <!-- File Upload for Journal (Hidden) -->
      <input type="file" id="journalUpload" accept=".json" style="display: none;">
      
      <!-- File Upload for Profile Pictures (Hidden) -->
      <input type="file" id="botPictureInput" accept="image/*" style="display: none;" onchange="handleBotPictureUpload(event)">
      <input type="file" id="userPictureInput" accept="image/*" style="display: none;" onchange="handleUserPictureUpload(event)">
      
      <!-- Journal Export Modal -->
      <div id="journalExportModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: #000; border: 3px solid #00ff00; padding: 30px; max-width: 600px; width: 90%; font-family: 'Courier New', monospace;">
          <div style="color: #00ff00; font-size: 20px; font-weight: bold; margin-bottom: 20px; text-align: center;">
            [ JOURNAL EXPORT ]
          </div>
          <div style="color: #00ff00; margin-bottom: 15px;">
            Ready to save journal data to your device.
          </div>
          <div style="color: #00ff00; margin-bottom: 20px;">
            <strong>Filename:</strong> <span id="exportFilename" style="color: #ffff00;">terminal-journal.json</span>
          </div>
          <div style="color: #00ff00; margin-bottom: 20px;">
            <strong>Total Entries:</strong> <span id="exportCount" style="color: #ffff00;">0</span>
          </div>
          <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
            <button onclick="confirmExport()" style="background: #00ff00; color: #000; border: none; padding: 10px 20px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#00cc00'" onmouseout="this.style.background='#00ff00'">
              DOWNLOAD
            </button>
            <button onclick="closeExportModal()" style="background: #ff0000; color: #fff; border: none; padding: 10px 20px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#cc0000'" onmouseout="this.style.background='#ff0000'">
              CANCEL
            </button>
          </div>
        </div>
      </div>
      
      <!-- Chat Messages -->
      <div id="chatMessages" style="margin-top: 20px;"></div>
      
      <!-- Cursor Blink -->
      <div id="cursor" style="display: inline;">
        <span style="color: #00ff00;">&gt; </span>
        <span id="cursorBlink" style="background: #00ff00; color: #000;">█</span>
      </div>
    </div>
    
    <!-- Command Input -->
    <div style="background: #1a1a1a; padding: 15px; border-top: 2px solid #00ff00;">
      <!-- Spell Check Suggestions -->
      <div id="spellSuggestions" style="display: none; background: #000; border: 2px solid #ffff00; padding: 10px; margin-bottom: 10px; border-radius: 5px;">
        <div style="color: #ffff00; font-family: 'Courier New', monospace; font-size: 12px; margin-bottom: 5px;">
          ⚠️ Possible misspellings detected:
        </div>
        <div id="suggestionList" style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 14px;"></div>
        <div style="margin-top: 8px; display: flex; gap: 10px;">
          <button onclick="acceptCorrections()" style="background: #00ff00; color: #000; border: none; padding: 5px 15px; font-family: 'Courier New', monospace; font-size: 12px; cursor: pointer; border-radius: 3px;">
            FIX ALL
          </button>
          <button onclick="dismissSuggestions()" style="background: #666; color: #fff; border: none; padding: 5px 15px; font-family: 'Courier New', monospace; font-size: 12px; cursor: pointer; border-radius: 3px;">
            IGNORE
          </button>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; align-items: center;">
        <span style="color: #00ff00; font-family: 'Courier New', monospace; font-size: 18px; font-weight: bold;">&gt;</span>
        <input type="text" id="commandInput" 
               style="flex: 1; background: #000; color: #00ff00; border: 2px solid #00ff00; padding: 12px; font-family: 'Courier New', monospace; font-size: 16px; outline: none;"
               placeholder="Type your message or command... (Press ? for help)"
               onkeypress="if(event.key==='Enter') checkSpellingBeforeSend()"
               onkeydown="handleKeyboardShortcuts(event)"
               oninput="hideSpellSuggestions()"
               autofocus>
        <button onclick="checkSpellingBeforeSend()" 
                style="background: #00ff00; color: #000; border: none; padding: 12px 24px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.2s;"
                onmouseover="this.style.background='#00cc00'" 
                onmouseout="this.style.background='#00ff00'">SEND</button>
      </div>
    </div>
    
  </div>
</div>

<style>
body {
  background: #000;
  color: #00ff00;
  font-family: 'Courier New', monospace;
  margin: 0;
  padding: 0;
  overflow: hidden;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
  20%, 40%, 60%, 80% { transform: translateX(10px); }
}
</style>

<script>
// ========================================
// PASSWORD PROTECTION
// ========================================

const CHAT_PASSWORD = "VoidRules"; // Master password (no longer used for new users)
const ADMIN_PASSWORD = "VoidRules"; // Admin password
let currentUser = null;
let isAdmin = false;

// User database (stored in localStorage)
function getUserDatabase() {
  return JSON.parse(localStorage.getItem('userDatabase')) || {};
}

function saveUserDatabase(db) {
  localStorage.setItem('userDatabase', JSON.stringify(db));
}

function showRegistrationScreen() {
  document.getElementById('passwordScreen').style.display = 'none';
  document.getElementById('adminLoginScreen').style.display = 'none';
  document.getElementById('registrationScreen').style.display = 'flex';
  document.getElementById('passwordError').style.display = 'none';
  document.getElementById('adminPasswordError').style.display = 'none';
  setTimeout(() => {
    document.getElementById('regUsername').focus();
  }, 100);
}

function showLoginScreen() {
  document.getElementById('registrationScreen').style.display = 'none';
  document.getElementById('adminLoginScreen').style.display = 'none';
  document.getElementById('passwordScreen').style.display = 'flex';
  document.getElementById('registrationError').style.display = 'none';
  document.getElementById('adminPasswordError').style.display = 'none';
  setTimeout(() => {
    document.getElementById('chatUsername').focus();
  }, 100);
}

function showAdminLogin() {
  document.getElementById('passwordScreen').style.display = 'none';
  document.getElementById('registrationScreen').style.display = 'none';
  document.getElementById('adminLoginScreen').style.display = 'flex';
  document.getElementById('passwordError').style.display = 'none';
  setTimeout(() => {
    document.getElementById('adminPassword').focus();
  }, 100);
}

function checkAdminPassword() {
  const passwordInput = document.getElementById('adminPassword');
  const password = passwordInput.value;
  const errorDiv = document.getElementById('adminPasswordError');
  
  if (!password) {
    errorDiv.textContent = '❌ Please enter admin password';
    errorDiv.style.display = 'block';
    passwordInput.focus();
    return;
  }
  
  if (password === ADMIN_PASSWORD) {
    // Admin login successful
    currentUser = 'Administrator';
    isAdmin = true;
    localStorage.setItem('currentUser', 'Administrator');
    localStorage.setItem('isAdmin', 'true');
    
    // Initialize memory for admin
    initializeMemory();
    
    // Show chat system
    document.getElementById('adminLoginScreen').style.display = 'none';
    document.getElementById('chatContainer').style.display = 'block';
    
    // Focus on command input
    setTimeout(() => {
      document.getElementById('commandInput').focus();
    }, 100);
  } else {
    // Wrong password
    errorDiv.textContent = '❌ ACCESS DENIED: Incorrect admin password';
    errorDiv.style.display = 'block';
    passwordInput.value = '';
    passwordInput.focus();
    
    // Shake animation
    const adminScreen = document.getElementById('adminLoginScreen').firstElementChild;
    adminScreen.style.animation = 'shake 0.5s';
    setTimeout(() => {
      adminScreen.style.animation = '';
    }, 500);
  }
}

function registerNewUser() {
  const usernameInput = document.getElementById('regUsername');
  const passwordInput = document.getElementById('regPassword');
  const confirmInput = document.getElementById('regPasswordConfirm');
  const errorDiv = document.getElementById('registrationError');
  
  const username = usernameInput.value.trim();
  const password = passwordInput.value;
  const confirmPassword = confirmInput.value;
  
  // Validate username
  if (!username) {
    errorDiv.textContent = '❌ Please enter a username';
    errorDiv.style.display = 'block';
    usernameInput.focus();
    return;
  }
  
  if (username.length < 3 || username.length > 20) {
    errorDiv.textContent = '❌ Username must be 3-20 characters';
    errorDiv.style.display = 'block';
    usernameInput.focus();
    return;
  }
  
  if (!/^[a-zA-Z0-9]+$/.test(username)) {
    errorDiv.textContent = '❌ Username can only contain letters and numbers';
    errorDiv.style.display = 'block';
    usernameInput.focus();
    return;
  }
  
  // Check if username already exists
  const userDB = getUserDatabase();
  if (userDB[username]) {
    errorDiv.textContent = '❌ Username already taken. Please choose another.';
    errorDiv.style.display = 'block';
    usernameInput.value = '';
    usernameInput.focus();
    return;
  }
  
  // Validate password
  if (!password) {
    errorDiv.textContent = '❌ Please enter a password';
    errorDiv.style.display = 'block';
    passwordInput.focus();
    return;
  }
  
  if (password.length < 6) {
    errorDiv.textContent = '❌ Password must be at least 6 characters';
    errorDiv.style.display = 'block';
    passwordInput.focus();
    return;
  }
  
  if (password !== confirmPassword) {
    errorDiv.textContent = '❌ Passwords do not match';
    errorDiv.style.display = 'block';
    confirmInput.value = '';
    confirmInput.focus();
    return;
  }
  
  // Create new user account
  userDB[username] = {
    password: password,
    created: new Date().toISOString(),
    lastLogin: new Date().toISOString()
  };
  saveUserDatabase(userDB);
  
  // Clear registration form
  usernameInput.value = '';
  passwordInput.value = '';
  confirmInput.value = '';
  errorDiv.style.display = 'none';
  
  // Show success message and login
  document.getElementById('registrationScreen').style.display = 'none';
  loginUser(username);
}

function checkChatPassword() {
  const usernameInput = document.getElementById('chatUsername');
  const passwordInput = document.getElementById('chatPassword');
  const username = usernameInput.value.trim();
  const password = passwordInput.value;
  const errorDiv = document.getElementById('passwordError');
  
  // Validate inputs
  if (!username) {
    errorDiv.textContent = '❌ Please enter a username';
    errorDiv.style.display = 'block';
    usernameInput.focus();
    return;
  }
  
  if (!password) {
    errorDiv.textContent = '❌ Please enter a password';
    errorDiv.style.display = 'block';
    passwordInput.focus();
    return;
  }
  
  const userDB = getUserDatabase();
  
  // Check if user exists
  if (userDB[username]) {
    // Existing user - verify password
    if (userDB[username].password === password) {
      loginUser(username);
    } else {
      // Wrong password
      errorDiv.textContent = '❌ ACCESS DENIED: Incorrect password';
      errorDiv.style.display = 'block';
      passwordInput.value = '';
      passwordInput.focus();
      
      // Shake animation
      const passwordScreen = document.getElementById('passwordScreen').firstElementChild;
      passwordScreen.style.animation = 'shake 0.5s';
      setTimeout(() => {
        passwordScreen.style.animation = '';
      }, 500);
    }
  } else {
    // User doesn't exist - redirect to registration
    errorDiv.textContent = '❌ User not found. Please create an account first.';
    errorDiv.style.display = 'block';
    
    setTimeout(() => {
      showRegistrationScreen();
    }, 2000);
  }
}

function loginUser(username) {
  currentUser = username;
  localStorage.setItem('currentUser', username);
  localStorage.setItem('isAdmin', 'false');
  
  // Update last login
  const userDB = getUserDatabase();
  if (userDB[username]) {
    userDB[username].lastLogin = new Date().toISOString();
    saveUserDatabase(userDB);
  }
  
  // Load user-specific data
  loadUserData(username);
  
  // Initialize smart memory for this user
  initializeMemory();
  
  // Show chat system
  document.getElementById('passwordScreen').style.display = 'none';
  document.getElementById('chatContainer').style.display = 'block';
  
  // Focus on command input
  setTimeout(() => {
    document.getElementById('commandInput').focus();
  }, 100);
}

function loadUserData(username) {
  const userDataKey = `user_${username}`;
  const userData = JSON.parse(localStorage.getItem(userDataKey)) || {};
  
  // Load user-specific settings
  if (userData.aiName) {
    localStorage.setItem('terminalAIName', userData.aiName);
  }
  if (userData.journalPermission) {
    localStorage.setItem('terminalJournalPermission', userData.journalPermission);
  }
  if (userData.journal) {
    localStorage.setItem('terminalJournal', JSON.stringify(userData.journal));
  }
  if (userData.contentMode) {
    localStorage.setItem('contentMode', userData.contentMode);
  }
  if (userData.ageVerified) {
    localStorage.setItem('ageVerified', userData.ageVerified);
  }
}

function saveUserData() {
  if (!currentUser) return;
  
  const userDataKey = `user_${currentUser}`;
  const userData = {
    aiName: localStorage.getItem('terminalAIName'),
    journalPermission: localStorage.getItem('terminalJournalPermission'),
    journal: JSON.parse(localStorage.getItem('terminalJournal') || '[]'),
    contentMode: localStorage.getItem('contentMode'),
    ageVerified: localStorage.getItem('ageVerified'),
    lastSaved: new Date().toISOString()
  };
  
  localStorage.setItem(userDataKey, JSON.stringify(userData));
}

// ========================================
// PROFILE PICTURE MANAGEMENT
// ========================================

function handleBotPictureUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (!file.type.startsWith('image/')) {
    addTerminalLine('Error: Please select an image file.', '#ff6666');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      localStorage.setItem('botProfilePicture', e.target.result);
      addTerminalLine('Bot profile picture updated successfully!', '#00ff00');
      addTerminalLine('Refresh to see changes in new messages.', '#ffff99');
    } catch (error) {
      addTerminalLine('Error: Image too large. Please use a smaller image.', '#ff6666');
    }
  };
  reader.readAsDataURL(file);
  event.target.value = '';
}

function handleUserPictureUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (!file.type.startsWith('image/')) {
    addTerminalLine('Error: Please select an image file.', '#ff6666');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      if (currentUser) {
        const userPicKey = `userPic_${currentUser}`;
        localStorage.setItem(userPicKey, e.target.result);
        addTerminalLine('Your profile picture updated successfully!', '#00ff00');
        addTerminalLine('Refresh to see changes in new messages.', '#ffff99');
      }
    } catch (error) {
      addTerminalLine('Error: Image too large. Please use a smaller image.', '#ff6666');
    }
  };
  reader.readAsDataURL(file);
  event.target.value = '';
}

function getBotProfilePicture() {
  return localStorage.getItem('botProfilePicture') || 'TestBot/test.png';
}

function getUserProfilePicture() {
  if (!currentUser) return null;
  const userPicKey = `userPic_${currentUser}`;
  return localStorage.getItem(userPicKey);
}

// ========================================
// LANGUAGE SYSTEM
// ========================================

let userLanguage = localStorage.getItem('userLanguage') || null;

const translations = {
  en: { greeting: "Hello", welcome: "Welcome back", help: "Type HELP for commands" },
  es: { greeting: "Hola", welcome: "Bienvenido de nuevo", help: "Escribe HELP para comandos" },
  fr: { greeting: "Bonjour", welcome: "Bienvenue", help: "Tapez HELP pour les commandes" },
  de: { greeting: "Hallo", welcome: "Willkommen zurück", help: "Geben Sie HELP für Befehle ein" },
  it: { greeting: "Ciao", welcome: "Bentornato", help: "Digita HELP per i comandi" },
  pt: { greeting: "Olá", welcome: "Bem-vindo de volta", help: "Digite HELP para comandos" },
  ru: { greeting: "Привет", welcome: "Добро пожаловать", help: "Введите HELP для команд" },
  ja: { greeting: "こんにちは", welcome: "おかえりなさい", help: "HELPと入力してコマンドを表示" },
  zh: { greeting: "你好", welcome: "欢迎回来", help: "输入HELP查看命令" },
  ko: { greeting: "안녕하세요", welcome: "다시 오신 것을 환영합니다", help: "명령어를 보려면 HELP를 입력하세요" },
  ar: { greeting: "مرحبا", welcome: "مرحبا بعودتك", help: "اكتب HELP للأوامر" },
  hi: { greeting: "नमस्ते", welcome: "वापसी पर स्वागत है", help: "कमांड के लिए HELP टाइप करें" }
};

function selectLanguage(lang) {
  userLanguage = lang;
  localStorage.setItem('userLanguage', lang);
  
  const userDB = getUserDatabase();
  const hasUsers = Object.keys(userDB).length > 0;
  
  // Hide language screen
  document.getElementById('languageScreen').style.display = 'none';
  document.getElementById('adminLoginScreen').style.display = 'none';
  
  if (!hasUsers) {
    // No users exist - show registration
    document.getElementById('registrationScreen').style.display = 'flex';
    setTimeout(() => {
      document.getElementById('regUsername').focus();
    }, 100);
  } else {
    // Users exist - show login
    document.getElementById('passwordScreen').style.display = 'flex';
    setTimeout(() => {
      document.getElementById('chatUsername').focus();
    }, 100);
  }
}

// Always show language or registration/login screen on load
window.addEventListener('DOMContentLoaded', function() {
  const userDB = getUserDatabase();
  const hasUsers = Object.keys(userDB).length > 0;
  
  // Check for existing session
  const storedUser = localStorage.getItem('currentUser');
  const storedIsAdmin = localStorage.getItem('isAdmin') === 'true';
  
  if (storedUser) {
    // Restore existing session
    currentUser = storedUser;
    isAdmin = storedIsAdmin;
    
    // Load user data
    if (!isAdmin) {
      loadUserData(storedUser);
    }
    
    // Initialize memory
    initializeMemory();
    
    // Hide all login screens and show chat
    document.getElementById('languageScreen').style.display = 'none';
    document.getElementById('registrationScreen').style.display = 'none';
    document.getElementById('passwordScreen').style.display = 'none';
    document.getElementById('adminLoginScreen').style.display = 'none';
    document.getElementById('chatContainer').style.display = 'block';
    
    // Initialize the chat system
    checkFirstTimeUser();
    updateModeIndicator();
    
    setTimeout(() => {
      document.getElementById('commandInput').focus();
    }, 100);
    
    return; // Exit early since we're logged in
  }
  
  // No existing session - proceed with normal login flow
  if (!userLanguage) {
    // Show language selection first
    document.getElementById('languageScreen').style.display = 'flex';
    document.getElementById('registrationScreen').style.display = 'none';
    document.getElementById('passwordScreen').style.display = 'none';
    document.getElementById('adminLoginScreen').style.display = 'none';
    document.getElementById('chatContainer').style.display = 'none';
  } else if (!hasUsers) {
    // Language selected but no users exist - show registration
    document.getElementById('languageScreen').style.display = 'none';
    document.getElementById('registrationScreen').style.display = 'flex';
    document.getElementById('passwordScreen').style.display = 'none';
    document.getElementById('adminLoginScreen').style.display = 'none';
    document.getElementById('chatContainer').style.display = 'none';
    
    setTimeout(() => {
      document.getElementById('regUsername').focus();
    }, 100);
  } else {
    // Language selected and users exist - show login
    document.getElementById('languageScreen').style.display = 'none';
    document.getElementById('registrationScreen').style.display = 'none';
    document.getElementById('passwordScreen').style.display = 'flex';
    document.getElementById('adminLoginScreen').style.display = 'none';
    document.getElementById('chatContainer').style.display = 'none';
    
    setTimeout(() => {
      document.getElementById('chatUsername').focus();
    }, 100);
  }
});

// ========================================
// ADVANCED SECURITY & PRIVACY PROTECTION SYSTEM
// ========================================

// Rate limiting to prevent abuse
let requestLog = [];
const MAX_REQUESTS_PER_MINUTE = 30;

function checkRateLimit() {
  const now = Date.now();
  // Remove requests older than 1 minute
  requestLog = requestLog.filter(time => now - time < 60000);
  
  if (requestLog.length >= MAX_REQUESTS_PER_MINUTE) {
    return false; // Rate limit exceeded
  }
  
  requestLog.push(now);
  return true;
}

// Input sanitization to prevent XSS and injection attacks
function sanitizeInput(text) {
  if (!text) return '';
  
  // Remove any HTML/script tags
  let sanitized = text.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
  sanitized = sanitized.replace(/<[^>]*>/g, '');
  
  // Remove dangerous characters and patterns
  sanitized = sanitized.replace(/javascript:/gi, '');
  sanitized = sanitized.replace(/on\w+\s*=/gi, '');
  sanitized = sanitized.replace(/eval\(/gi, '');
  sanitized = sanitized.replace(/expression\(/gi, '');
  
  // Limit length to prevent overflow attacks
  if (sanitized.length > 5000) {
    sanitized = sanitized.substring(0, 5000);
  }
  
  return sanitized;
}

// Detect attempts to extract system information
function detectHackingAttempt(text) {
  const lower = text.toLowerCase();
  const dangerousPatterns = [
    /\b(localStorage|sessionStorage|document\.cookie|window\.location)\b/i,
    /\b(api[_\s]?key|token|password|credential|secret)\b/i,
    /\b(eval|exec|function\(|setTimeout|setInterval)\b/i,
    /<script|<iframe|javascript:|onerror=/i,
    /\b(select|drop|insert|update|delete)\b.*\b(from|table|database)\b/i,
    /\.\.\//g, // Path traversal
    /\b(system|admin|root|sudo)\b.*\b(access|password|login)\b/i,
    /\b(show|give|reveal|display|tell)\b.*\b(key|token|password|secret|credential)\b/i,
    /\b(your|my|the)\b.*\b(api key|token|password|source code)\b/i,
    /\bwindow\.|document\.|console\./i,
    /\b__proto__|constructor|prototype\b/i
  ];
  
  return dangerousPatterns.some(pattern => pattern.test(text));
}

// Additional check: Block system information requests
function isSystemInfoRequest(text) {
  const lower = text.toLowerCase();
  const systemQuestions = [
    /how (do|does) (you|this|the bot) (work|function|operate)/i,
    /what (is|are) (your|the) (source code|code|implementation)/i,
    /(show|give|reveal|display) (me )?(your|the) (code|source|keys|secrets)/i,
    /what.*stored in (localStorage|storage|memory)/i,
    /how.*you.*store (data|information|keys)/i
  ];
  
  return systemQuestions.some(pattern => pattern.test(lower));
}

function detectPersonalInfo(text) {
  const detections = [];
  
  // IP Address detection (IPv4 and IPv6)
  const ipv4Regex = /\b(?:\d{1,3}\.){3}\d{1,3}\b/g;
  const ipv6Regex = /\b(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}\b/g;
  
  if (ipv4Regex.test(text) || ipv6Regex.test(text)) {
    detections.push('IP Address');
  }
  
  // Email addresses
  const emailRegex = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g;
  if (emailRegex.test(text)) {
    detections.push('Email Address');
  }
  
  // Phone numbers (various formats)
  const phoneRegex = /(\+?\d{1,3}[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}\b/g;
  if (phoneRegex.test(text)) {
    detections.push('Phone Number');
  }
  
  // Street addresses (basic detection)
  const addressRegex = /\b\d+\s+[A-Za-z]+\s+(Street|St|Avenue|Ave|Road|Rd|Boulevard|Blvd|Lane|Ln|Drive|Dr|Court|Ct|Way)\b/gi;
  if (addressRegex.test(text)) {
    detections.push('Street Address');
  }
  
  // Social Security Numbers (US format)
  const ssnRegex = /\b\d{3}-\d{2}-\d{4}\b/g;
  if (ssnRegex.test(text)) {
    detections.push('Social Security Number');
  }
  
  // Credit card numbers (basic 16-digit detection)
  const creditCardRegex = /\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b/g;
  if (creditCardRegex.test(text)) {
    detections.push('Credit Card Number');
  }
  
  // Zip codes (US format)
  const zipRegex = /\b\d{5}(?:-\d{4})?\b/g;
  if (zipRegex.test(text)) {
    detections.push('Zip Code');
  }
  
  // API Keys and tokens
  const apiKeyRegex = /\b(hf_[a-zA-Z0-9]{30,}|sk-[a-zA-Z0-9]{30,}|[a-f0-9]{32,})\b/g;
  if (apiKeyRegex.test(text)) {
    detections.push('API Key/Token');
  }
  
  // Passwords in plain text
  if (/\b(password|passwd|pwd)[\s:=]+[^\s]+/i.test(text)) {
    detections.push('Password');
  }
  
  return detections;
}

function sanitizePersonalInfo(text) {
  let sanitized = text;
  
  // Replace IP addresses
  sanitized = sanitized.replace(/\b(?:\d{1,3}\.){3}\d{1,3}\b/g, '[REDACTED]');
  sanitized = sanitized.replace(/\b(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}\b/g, '[REDACTED]');
  
  // Replace email addresses
  sanitized = sanitized.replace(/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g, '[REDACTED]');
  
  // Replace phone numbers
  sanitized = sanitized.replace(/(\+?\d{1,3}[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}\b/g, '[REDACTED]');
  
  // Replace street addresses
  sanitized = sanitized.replace(/\b\d+\s+[A-Za-z]+\s+(Street|St|Avenue|Ave|Road|Rd|Boulevard|Blvd|Lane|Ln|Drive|Dr|Court|Ct|Way)\b/gi, '[REDACTED]');
  
  // Replace SSN
  sanitized = sanitized.replace(/\b\d{3}-\d{2}-\d{4}\b/g, '[REDACTED]');
  
  // Replace credit cards
  sanitized = sanitized.replace(/\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b/g, '[REDACTED]');
  
  // Replace zip codes
  sanitized = sanitized.replace(/\b\d{5}(?:-\d{4})?\b/g, '[REDACTED]');
  
  // Replace API keys and tokens (but not when setting them intentionally)
  if (!/^SET API KEY/i.test(text)) {
    sanitized = sanitized.replace(/\b(hf_[a-zA-Z0-9]{30,}|sk-[a-zA-Z0-9]{30,})\b/g, '[REDACTED]');
  }
  
  // Replace passwords
  sanitized = sanitized.replace(/\b(password|passwd|pwd)[\s:=]+[^\s]+/gi, 'password: [REDACTED]');
  
  return sanitized;
}

// Secure storage check - prevent direct localStorage access attempts
function blockDirectStorageAccess(text) {
  const lower = text.toLowerCase();
  
  // Block any attempts to access storage directly
  if (/localStorage|sessionStorage|cookie|storage/i.test(text)) {
    return true;
  }
  
  // Block attempts to extract keys
  if (/getItem|setItem|removeItem|clear\(\)|key\(/i.test(text)) {
    return true;
  }
  
  return false;
}

// ========================================
// CONTENT FILTERING SYSTEM (SFW/NSFW)
// ========================================

let contentMode = localStorage.getItem('contentMode') || 'SFW'; // Default to SFW
let roleplayMode = localStorage.getItem('roleplayMode') === 'true' || false;

// SFW Mode - Blocked words and patterns
const SFW_BLOCKED_WORDS = [
  'fuck', 'shit', 'damn', 'hell', 'ass', 'bitch', 'dick', 'cock', 'pussy', 'cunt',
  'sex', 'porn', 'xxx', 'nude', 'naked', 'nsfw', 'hentai', 'rape', 'molest',
  'kill', 'murder', 'suicide', 'drug', 'cocaine', 'meth', 'heroin'
];

// NSFW Mode - Still blocked (hate speech, illegal content)
const ALWAYS_BLOCKED_WORDS = [
  'nigger', 'nigga', 'kike', 'chink', 'fag', 'faggot', 'tranny',
  'child porn', 'cp', 'pedo', 'pedophile', 'loli', 'shota',
  'kill yourself', 'terrorist', 'bomb threat', 'school shooting'
];

function checkContentFilter(text) {
  const lower = text.toLowerCase();
  
  // Always check for prohibited content
  for (const word of ALWAYS_BLOCKED_WORDS) {
    if (lower.includes(word)) {
      return {
        allowed: false,
        reason: 'PROHIBITED CONTENT',
        message: '🚫 This content violates our policies and is not allowed in any mode.'
      };
    }
  }
  
  // Check SFW restrictions if in SFW mode
  if (contentMode === 'SFW') {
    for (const word of SFW_BLOCKED_WORDS) {
      if (lower.includes(word)) {
        return {
          allowed: false,
          reason: 'SFW MODE VIOLATION',
          message: `⚠️ This content is not allowed in SFW mode.\nSwitch to NSFW mode with: MODE NSFW`
        };
      }
    }
  }
  
  return { allowed: true };
}

function updateModeIndicator() {
  const header = document.getElementById('terminalHeader');
  const modeText = document.getElementById('modeText');
  const modeIndicator = document.getElementById('modeIndicator');
  
  if (contentMode === 'SFW') {
    header.style.borderBottom = '3px solid #00ff00';
    if (modeText) modeText.textContent = 'SFW';
    if (modeIndicator) modeIndicator.style.color = '#00ff00';
  } else {
    header.style.borderBottom = '3px solid #ff6600';
    if (modeText) modeText.textContent = 'NSFW';
    if (modeIndicator) modeIndicator.style.color = '#ff6600';
  }
}

// Age verification handler
function handleAgeVerification(input) {
  addTerminalLine(input, '#ffff00', true);
  
  // Check if user wants to cancel
  if (input.toUpperCase() === 'CANCEL' || input.toUpperCase() === 'SKIP') {
    window.awaitingAgeVerification = false;
    addTerminalLine('Age verification cancelled. Remaining in SFW mode.', '#ffff99');
    return;
  }
  
  // Validate date format (MM/DD/YYYY)
  const dateRegex = /^(0[1-9]|1[0-2])\/(0[1-9]|[12][0-9]|3[01])\/(\d{4})$/;
  
  if (!dateRegex.test(input)) {
    addTerminalLine('❌ Invalid date format.', '#ff6666');
    addTerminalLine('Please use MM/DD/YYYY format (e.g., 03/15/2000)', '#ffff99');
    addTerminalLine('Or type CANCEL to abort.', '#c0ffc0');
    return;
  }
  
  // Parse the date
  const [month, day, year] = input.split('/').map(Number);
  const birthDate = new Date(year, month - 1, day);
  const today = new Date();
  
  // Check if date is valid
  if (birthDate.getMonth() !== month - 1 || birthDate.getDate() !== day || birthDate.getFullYear() !== year) {
    addTerminalLine('❌ Invalid date. Please enter a real date.', '#ff6666');
    addTerminalLine('Example: 03/15/2000', '#ffff99');
    return;
  }
  
  // Check if date is in the future
  if (birthDate > today) {
    addTerminalLine('❌ Birth date cannot be in the future.', '#ff6666');
    addTerminalLine('Please enter your actual date of birth.', '#ffff99');
    return;
  }
  
  // Calculate age
  let age = today.getFullYear() - birthDate.getFullYear();
  const monthDiff = today.getMonth() - birthDate.getMonth();
  
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
    age--;
  }
  
  // Check if 18 or older
  if (age >= 18) {
    localStorage.setItem('ageVerified', 'true');
    window.awaitingAgeVerification = false;
    
    // Activate NSFW mode
    contentMode = 'NSFW';
    localStorage.setItem('contentMode', 'NSFW');
    updateModeIndicator();
    
    addTerminalLine('✅ AGE VERIFIED', '#00ff00');
    addTerminalLine(`You are ${age} years old. Access granted.`, '#c0ffc0');
    addTerminalLine('⚠️ NSFW MODE ACTIVATED', '#ff6600');
    addTerminalLine('Mature content allowed. Hate speech and illegal content still blocked.', '#ffff99');
  } else {
    window.awaitingAgeVerification = false;
    addTerminalLine('❌ ACCESS DENIED', '#ff6666');
    addTerminalLine(`You must be 18 or older. You are ${age} years old.`, '#ff6666');
    addTerminalLine('Remaining in SFW mode.', '#ffff99');
  }
}

// ========================================
// SMART MEMORY SYSTEM - Context-aware learning
// ========================================

let userMemory = {};

function initializeMemory() {
  if (!currentUser) return;
  
  const memoryKey = `memory_${currentUser}`;
  userMemory = JSON.parse(localStorage.getItem(memoryKey)) || {
    userName: null,
    preferences: {},
    facts: [],
    topics: [],
    lastUpdated: new Date().toISOString()
  };
}

function extractAndLearn(userInput, botResponse) {
  if (!currentUser) return;
  
  // Check for personal info before learning
  const personalInfo = detectPersonalInfo(userInput);
  if (personalInfo.length > 0) {
    // Don't learn from messages containing personal info
    return;
  }
  
  const lower = userInput.toLowerCase();
  
  // Extract user's name (first name only, no full names)
  if (/my name is|i'm called|call me|i am/i.test(lower)) {
    const nameMatch = lower.match(/(?:my name is|i'm called|call me|i am)\s+([a-z]+)/i);
    if (nameMatch && nameMatch[1]) {
      const name = nameMatch[1];
      // Only store if it's a single word (first name)
      if (!name.includes(' ')) {
        userMemory.userName = name;
        saveMemory();
      }
    }
  }
  
  // Extract preferences (likes/dislikes) - sanitized
  if (/i (love|like|enjoy|prefer|hate|dislike)/i.test(lower)) {
    const prefMatch = lower.match(/i (love|like|enjoy|prefer|hate|dislike)\s+(.+?)(?:\.|!|$)/i);
    if (prefMatch) {
      const sentiment = prefMatch[1];
      const thing = sanitizePersonalInfo(prefMatch[2].trim());
      
      if (!userMemory.preferences[thing]) {
        userMemory.preferences[thing] = sentiment;
        saveMemory();
      }
    }
  }
  
  // Extract important facts user shares - sanitized
  if (/i (work|study|live|am from|come from)/i.test(lower)) {
    const sanitizedInput = sanitizePersonalInfo(userInput);
    const fact = sanitizedInput.substring(0, 100); // Store first 100 chars
    if (!userMemory.facts.includes(fact)) {
      userMemory.facts.push(fact);
      if (userMemory.facts.length > 20) userMemory.facts.shift(); // Keep last 20
      saveMemory();
    }
  }
  
  // Track discussed topics (sanitized)
  const sanitizedInput = sanitizePersonalInfo(userInput);
  const words = sanitizedInput.toLowerCase().split(' ').filter(w => w.length > 4);
  words.forEach(word => {
    if (!userMemory.topics.includes(word)) {
      userMemory.topics.push(word);
      if (userMemory.topics.length > 50) userMemory.topics.shift(); // Keep last 50
    }
  });
  
  saveMemory();
}

function saveMemory() {
  if (!currentUser) return;
  
  userMemory.lastUpdated = new Date().toISOString();
  const memoryKey = `memory_${currentUser}`;
  localStorage.setItem(memoryKey, JSON.stringify(userMemory));
}

function recallMemory(query) {
  const lower = query.toLowerCase();
  
  // Recall user's name
  if (/what's my name|whats my name|my name|who am i/i.test(lower)) {
    if (userMemory.userName) {
      return `Your name is ${userMemory.userName}! 😊`;
    }
  }
  
  // Recall preferences
  if (/what do i like|my preferences|remember about me/i.test(lower)) {
    if (Object.keys(userMemory.preferences).length > 0) {
      let response = `Here's what I remember about your preferences:\n\n`;
      for (const [thing, sentiment] of Object.entries(userMemory.preferences)) {
        response += `• You ${sentiment} ${thing}\n`;
      }
      return response;
    } else {
      return `I don't have any preferences recorded yet. Tell me what you like! 😊`;
    }
  }
  
  // Recall facts
  if (/what do you know about me|tell me about myself|what have i told you/i.test(lower)) {
    let response = `Here's what I remember about you:\n\n`;
    
    if (userMemory.userName) {
      response += `📝 Name: ${userMemory.userName}\n\n`;
    }
    
    if (Object.keys(userMemory.preferences).length > 0) {
      response += `💭 Preferences:\n`;
      for (const [thing, sentiment] of Object.entries(userMemory.preferences)) {
        response += `  • You ${sentiment} ${thing}\n`;
      }
      response += '\n';
    }
    
    if (userMemory.facts.length > 0) {
      response += `📚 Things you've shared:\n`;
      userMemory.facts.slice(-5).forEach(fact => {
        response += `  • ${fact}\n`;
      });
    }
    
    if (!userMemory.userName && Object.keys(userMemory.preferences).length === 0 && userMemory.facts.length === 0) {
      response = `I don't have much information about you yet. Tell me about yourself! 😊`;
    }
    
    return response;
  }
  
  return null;
}

// ========================================
// JOURNAL SYSTEM - Persistent session data
// ========================================

let activeJournal = null;
let journalLoaded = false;
let lastClearPrompt = 0;
const CLEAR_PROMPT_THRESHOLD = 50; // Prompt after 50 entries

function saveToJournal(command, response) {
  if (journalPermission !== 'enabled') return; // Early exit if disabled
  
  if (!activeJournal) {
    activeJournal = [];
  }
  
  const entry = {
    id: Date.now(),
    timestamp: new Date().toLocaleString(),
    command: command,
    response: response
  };
  activeJournal.push(entry);
  
  // Batch save to localStorage (debounced)
  if (window.journalSaveTimeout) clearTimeout(window.journalSaveTimeout);
  window.journalSaveTimeout = setTimeout(() => {
    localStorage.setItem('terminalJournal', JSON.stringify(activeJournal));
    saveUserData(); // Save to user-specific storage
  }, 500);
  
  // Check if we should prompt to clear
  if (activeJournal.length % CLEAR_PROMPT_THRESHOLD === 0) {
    checkClearPrompt();
  }
}

function checkClearPrompt() {
  const journalLength = activeJournal ? activeJournal.length : 0;
  
  // Prompt every 50 entries, but not on the same entry twice
  if (journalLength > 0 && journalLength % CLEAR_PROMPT_THRESHOLD === 0 && journalLength !== lastClearPrompt) {
    lastClearPrompt = journalLength;
    setTimeout(() => {
      addTerminalLine(`\n💡 Hey! Our conversation is getting pretty long (${journalLength} messages).`, '#ffff00');
      addTerminalLine(`Large sessions might slow things down. Here are some options:`, '#ffff00');
      addTerminalLine(`\n  📥 JOURNAL EXPORT - Save our conversation to a file`, '#00ff00');
      addTerminalLine(`  🗑️ JOURNAL CLEAR - Start fresh (after exporting!)`, '#00ff00');
      addTerminalLine(`  ▶️ CONTINUE - Keep going as-is\n`, '#00ff00');
    }, 500);
  }
}

function loadJournal() {
  if (activeJournal) {
    return activeJournal;
  }
  // Fallback to localStorage
  const journal = JSON.parse(localStorage.getItem('terminalJournal')) || [];
  return journal;
}

function setActiveJournal(journalData) {
  activeJournal = journalData;
  journalLoaded = true;
  localStorage.setItem('terminalJournal', JSON.stringify(activeJournal));
}

function displayJournal() {
  const journal = loadJournal();
  if (journal.length === 0) {
    return 'JOURNAL EMPTY\n--------------\nNo previous conversations recorded.';
  }
  
  let output = 'JOURNAL ENTRIES\n===============\n';
  output += `Total Entries: ${journal.length}\n\n`;
  
  journal.slice(-10).reverse().forEach((entry, index) => {
    output += `[${entry.timestamp}]\n`;
    output += `> ${entry.command}\n`;
    output += `${entry.response.substring(0, 100)}...\n`;
    output += '─────────────────────────────────────\n';
  });
  
  output += '\nShowing last 10 entries. Type JOURNAL FULL to see all.';
  return output;
}

function clearJournal() {
  localStorage.removeItem('terminalJournal');
  activeJournal = [];
  return 'SESSION CLEARED\n---------------\nAll chat history has been deleted.\nStarting fresh session.';
}

let pendingExportData = null;

function exportJournal() {
  const journal = loadJournal();
  if (journal.length === 0) {
    return 'ERROR: No journal entries to export.';
  }
  
  // Store the data for export
  pendingExportData = journal;
  
  // Update modal information
  const filename = `terminal-journal-${new Date().toISOString().split('T')[0]}.json`;
  document.getElementById('exportFilename').textContent = filename;
  document.getElementById('exportCount').textContent = journal.length;
  
  // Show the modal
  const modal = document.getElementById('journalExportModal');
  modal.style.display = 'flex';
  
  return 'Opening export dialog...';
}

function confirmExport() {
  if (!pendingExportData) return;
  
  const dataStr = JSON.stringify(pendingExportData, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const filename = `terminal-journal-${new Date().toISOString().split('T')[0]}.json`;
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  // Close modal and show confirmation
  closeExportModal();
  addTerminalLine(`SESSION SAVED`, '#00ff00');
  addTerminalLine(`Exported ${pendingExportData.length} entries to: ${filename}`, '#00ff00');
  addTerminalLine(`Load this file on your next visit to continue your session.`, '#00ff00');
  
  pendingExportData = null;
}

function closeExportModal() {
  const modal = document.getElementById('journalExportModal');
  modal.style.display = 'none';
  pendingExportData = null;
}

// Terminal cursor blink
setInterval(() => {
  const cursor = document.getElementById('cursorBlink');
  if (cursor) cursor.style.opacity = cursor.style.opacity === '0' ? '1' : '0';
}, 500);

// Command responses
const commands = {
  'HELP': `
Available Commands:
------------------
HELP         - Display this help menu
ABOUT        - Information about Catherine MacDonald
ART          - View Catherine's art information
PROJECTS     - List all projects
CONTACT      - Get contact information
SPECTRUM     - Information about Spectrum project
PARTY        - Information about Party project
CODING       - View coding projects
VIDEOS       - Information about video content
BLOG         - Access blog information
NAVIGATE     - Site navigation guide

WEB ACCESS (Free APIs):
WIKI [topic]   - Search Wikipedia for information
               Example: WIKI artificial intelligence
DEFINE [word]  - Get word definition with examples
               Example: DEFINE serendipity
FACT           - Get a random fun fact
ADVICE         - Get random advice
JOKE           - Get a dad joke
QUOTE          - Get an inspirational quote
GITHUB [user]  - Look up GitHub user profile
               Example: GITHUB torvalds

Natural language works too:
"What is quantum physics?" "Define happiness" etc.

SESSION MANAGEMENT:
JOURNAL LOAD   - Load journal file to continue previous session
JOURNAL EXPORT - Save current session to file
JOURNAL        - View chat history (last 10 entries)
JOURNAL FULL   - View complete chat history
JOURNAL CLEAR  - Delete all chat history
JOURNAL ENABLE - Enable conversation saving
JOURNAL DISABLE- Disable conversation saving

CONTENT MODES:
MODE SFW     - Activate safe-for-work mode (default)
MODE NSFW    - Activate mature content mode
MODE STATUS  - Check current mode

ROLEPLAY MODE:
ROLEPLAY ON  - Activate roleplay mode (respects SFW/NSFW)
ROLEPLAY OFF - Deactivate roleplay mode
RP STATUS    - Check roleplay status
Format: "dialogue" for speech, *actions* for descriptions

SMART MEMORY:
MEMORY         - Show what the AI remembers about you
FORGET ME      - Clear all learned information

CONVERSATION INTELLIGENCE:
SHOW CONTEXT   - View current conversation context
CLEAR CONTEXT  - Reset conversation tracking

PROFILE PICTURES:
CHANGE BOT PICTURE  - Upload a custom bot profile picture
CHANGE MY PICTURE   - Upload your own profile picture
RESET BOT PICTURE   - Reset bot picture to default
RESET MY PICTURE    - Reset your picture to default

AI ENHANCEMENT (Hugging Face):
SET API KEY [key]   - Enable advanced AI responses (FREE)
API STATUS          - Check AI enhancement status
REMOVE API KEY      - Disable AI enhancement
Get free key: https://huggingface.co/settings/tokens

SECURITY & PRIVACY:
SECURITY STATUS     - View all active protections
Note: All personal info is automatically detected and blocked

SPELL CHECK ON - Enable automatic spell checking
SPELL CHECK OFF- Disable spell checking
CLEAR          - Clear terminal screen
CONTINUE       - Continue session (dismiss clear prompt)
LOGOUT         - Return to password screen
RESET NAME     - Reset AI name (for testing)
CHANGE LANGUAGE- Change interface language
EXIT           - Return to main site
------------------
Type any command or ask a question naturally.
I can search Wikipedia for you - just ask!
IMPORTANT: Export your journal before leaving to save your session!

Current Mode: Use 'MODE STATUS' to check`,

  'ABOUT': `
CATHERINE ANN MACDONALD
-----------------------
Role: Writer-Artist
Specialty: Digital Art, Character Design, Interactive Experiences
Status: Active - Continuously evolving art style
Location: Portfolio available at DerpRex.github.io
-----------------------
Catherine creates story ideas and character designs, with a focus
on digital art and web-based interactive experiences.`,

  'ART': `
ART PORTFOLIO STATUS
--------------------
Current Work: Available in "Current Portfolio" section
Projects: Spectrum, Party (character collections)
Early Work: Foundation pieces in Archive
Style: Evolving digital art and character design
Commissions: AVAILABLE - Contact for details
--------------------`,

  'PROJECTS': `
PROJECT INDEX
-------------
[1] SPECTRUM        - Character project collection
[2] PARTY           - Character design showcase
[3] CODING          - Interactive web experiences
                      • Rat Kingdom Academy
                      • Ein Story
                      • Portrait Site
[4] VIDEOS          - Animation & video content
-------------
Type project name for more information.`,

  'CONTACT': `
CONTACT INFORMATION
-------------------
Email: catiemac2014@gmail.com
Instagram: @derpasaurs_16
         : https://www.instagram.com/derpasaurs_16/
Contact Form: Available on Home page
-------------------
Response Time: Typically within 24-48 hours
Commissions: OPEN - Email for inquiries`,

  'SPECTRUM': `
PROJECT: SPECTRUM
-----------------
Type: Character Project
Status: Active
Content: Unique character designs
Access: Projects > Spectrum
Description: Character project featuring creative designs
-----------------`,

  'PARTY': `
PROJECT: PARTY
--------------
Type: Character Collection
Status: Active
Content: Character design showcase
Access: Projects > Party
Description: Collection of character designs
--------------`,

  'CODING': `
CODING PROJECTS
---------------
[1] Rat Kingdom Academy
    URL: https://derpasaursrex.github.io/RatKingdomAcademy.github.io/
    Type: Interactive web academy

[2] Ein Story
    URL: https://catiemac16.github.io/EinJourney.github.io/
    Type: Interactive narrative website

[3] Portrait Site
    URL: https://catiemac16.github.io/Chronic.github.io/
    Type: Interactive portrait gallery
---------------
Access: Projects > Coding`,

  'VIDEOS': `
VIDEO CONTENT
-------------
Type: Animation & Video
Count: 8 videos available
Access: Projects > Videos
Format: Embedded YouTube content
Features: Spiral animated gallery
-------------`,

  'BLOG': `
NARRATOR'S LOG (BLOG)
---------------------
Status: Active
Access: Main menu > Blog
Features: Password-protected posting
Content: Updates, thoughts, and posts
Author Controls: Pin, Delete, Data Management
---------------------`,

  'NAVIGATE': `
SITE NAVIGATION MAP
-------------------
HOME              - Main page with about & contact
CURRENT PORTFOLIO - Latest artwork
BLOG              - Narrator's Log
PROJECTS          - Active creative work
  > Spectrum
  > Party
  > Coding
  > Videos
ARCHIVE           - Historical work
  > Early Work
  > Outdated Designs
-------------------
Click menu items to navigate.`,

  'CLEAR': 'CLEAR_SCREEN',
  'CLS': 'CLEAR_SCREEN',
  'EXIT': 'EXIT_TERMINAL'
};

function typeWriter(text, element, speed = 10) {
  let i = 0;
  element.innerHTML = '';
  
  function type() {
    if (i < text.length) {
      element.innerHTML += text.charAt(i);
      i++;
      setTimeout(type, speed);
    }
    document.getElementById('terminal').scrollTop = document.getElementById('terminal').scrollHeight;
  }
  type();
}

// ========================================
// SPELL CHECK SYSTEM
// ========================================

let spellCheckCache = {};
let pendingCorrections = {};
let spellCheckEnabled = localStorage.getItem('spellCheckEnabled') !== 'false'; // Default enabled

async function checkSpelling(text) {
  // Skip if disabled
  if (!spellCheckEnabled) {
    return { errors: [] };
  }
  
  // Skip spell check for commands
  if (text.toUpperCase() === text || text.length < 3) {
    return { errors: [] };
  }
  
  try {
    // Use LanguageTool API (free, no key required)
    const url = 'https://api.languagetool.org/v2/check';
    const params = new URLSearchParams({
      text: text,
      language: 'auto', // Auto-detect language
      enabledOnly: 'false'
    });
    
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: params
    });
    
    const data = await response.json();
    
    // Filter for spelling errors only
    const errors = data.matches.filter(match => 
      match.rule.issueType === 'misspelling' || 
      match.rule.category.id === 'TYPOS'
    ).slice(0, 5); // Limit to 5 suggestions
    
    return { errors: errors };
  } catch (error) {
    console.log('Spell check unavailable:', error);
    return { errors: [] };
  }
}

function checkSpellingBeforeSend() {
  const input = document.getElementById('commandInput');
  const text = input.value.trim();
  
  if (!text) return;
  
  // Check for misspellings
  checkSpelling(text).then(result => {
    if (result.errors.length > 0) {
      showSpellSuggestions(result.errors, text);
    } else {
      executeCommand();
    }
  });
}

function showSpellSuggestions(errors, originalText) {
  const suggestionsDiv = document.getElementById('spellSuggestions');
  const suggestionList = document.getElementById('suggestionList');
  
  pendingCorrections = {};
  let html = '';
  
  errors.forEach(error => {
    const word = originalText.substring(error.offset, error.offset + error.length);
    const suggestion = error.replacements[0]?.value || word;
    pendingCorrections[word] = suggestion;
    
    html += `<div style="margin: 5px 0;">`;
    html += `  <span style="color: #ff6666;">"${word}"</span> → `;
    html += `  <span style="color: #00ff00;">"${suggestion}"</span>`;
    html += `</div>`;
  });
  
  suggestionList.innerHTML = html;
  suggestionsDiv.style.display = 'block';
}

function acceptCorrections() {
  const input = document.getElementById('commandInput');
  let text = input.value;
  
  // Apply all corrections
  for (const [wrong, correct] of Object.entries(pendingCorrections)) {
    const regex = new RegExp(wrong.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
    text = text.replace(regex, correct);
  }
  
  input.value = text;
  hideSpellSuggestions();
  
  // Now send the corrected message
  executeCommand();
}

function dismissSuggestions() {
  hideSpellSuggestions();
  executeCommand();
}

function hideSpellSuggestions() {
  document.getElementById('spellSuggestions').style.display = 'none';
  pendingCorrections = {};
}

// ========================================
// ADVANCED INTELLIGENCE SYSTEM
// ========================================

let conversationContext = {
  currentTopic: null,
  lastUserSentiment: 'neutral',
  topicHistory: [],
  entityCache: {}
};

// Sentiment analysis
function analyzeSentiment(text) {
  const lower = text.toLowerCase();
  
  // Positive indicators
  const positiveWords = ['love', 'great', 'awesome', 'amazing', 'wonderful', 'happy', 'excited', 'good', 'excellent', 'fantastic', 'perfect', 'best', 'enjoy', 'fun'];
  const positiveCount = positiveWords.filter(word => lower.includes(word)).length;
  
  // Negative indicators
  const negativeWords = ['hate', 'bad', 'awful', 'terrible', 'sad', 'angry', 'frustrated', 'annoyed', 'upset', 'disappointed', 'boring', 'worst', 'sucks'];
  const negativeCount = negativeWords.filter(word => lower.includes(word)).length;
  
  // Question indicators
  const isQuestion = text.includes('?') || /^(what|who|when|where|why|how|can|could|would|should|is|are|do|does)/i.test(text);
  
  if (positiveCount > negativeCount && positiveCount > 0) return 'positive';
  if (negativeCount > positiveCount && negativeCount > 0) return 'negative';
  if (isQuestion) return 'curious';
  return 'neutral';
}

// Extract important entities (people, places, concepts)
function extractEntities(text) {
  const words = text.split(' ');
  const entities = [];
  
  // Look for capitalized words (potential proper nouns)
  words.forEach((word, index) => {
    const cleaned = word.replace(/[^a-zA-Z]/g, '');
    if (cleaned.length > 2 && cleaned[0] === cleaned[0].toUpperCase() && cleaned !== cleaned.toUpperCase()) {
      entities.push(cleaned);
    }
  });
  
  // Extract quoted phrases
  const quotes = text.match(/"([^"]+)"/g);
  if (quotes) {
    quotes.forEach(q => entities.push(q.replace(/"/g, '')));
  }
  
  return entities;
}

// Context-aware response generation
function getContextualResponse(input, sentiment) {
  const lower = input.toLowerCase();
  
  // If user is asking about previous topic
  if (conversationContext.currentTopic && (lower.includes('that') || lower.includes('it') || lower.includes('this'))) {
    if (/tell me more|more about|what about|how about/i.test(lower)) {
      setTimeout(async () => {
        const result = await searchWikipedia(conversationContext.currentTopic);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
      }, 100);
      return `I'll find more information about ${conversationContext.currentTopic}...`;
    }
  }
  
  // Sentiment-based responses
  if (sentiment === 'positive') {
    const responses = [
      `I'm glad you're enthusiastic! What else would you like to explore?`,
      `Great energy! How can I help you with that?`,
      `I love your enthusiasm! What would you like to know more about?`
    ];
    return responses[Math.floor(Math.random() * responses.length)];
  } else if (sentiment === 'negative') {
    const responses = [
      `I understand your frustration. Let me try to help. What specifically can I assist with?`,
      `I'm sorry you're not satisfied. What can I do to help?`,
      `I hear you. Would you like me to search for better information on this?`
    ];
    return responses[Math.floor(Math.random() * responses.length)];
  }
  
  return null; // No contextual response
}

// Update conversation context
function updateContext(userInput, botResponse) {
  // Update sentiment
  conversationContext.lastUserSentiment = analyzeSentiment(userInput);
  
  // Extract and track entities
  const entities = extractEntities(userInput);
  if (entities.length > 0) {
    conversationContext.currentTopic = entities[0];
    if (!conversationContext.topicHistory.includes(entities[0])) {
      conversationContext.topicHistory.push(entities[0]);
      if (conversationContext.topicHistory.length > 10) {
        conversationContext.topicHistory.shift();
      }
    }
  }
  
  // Cache entities for quick recall
  entities.forEach(entity => {
    conversationContext.entityCache[entity.toLowerCase()] = (conversationContext.entityCache[entity.toLowerCase()] || 0) + 1;
  });
}

// ========================================
// HUGGING FACE AI INTEGRATION
// ========================================

let huggingFaceEnabled = false;
let huggingFaceAPIKey = localStorage.getItem('hfAPIKey') || null;

// Check if Hugging Face is configured
function checkHuggingFaceStatus() {
  huggingFaceEnabled = huggingFaceAPIKey && huggingFaceAPIKey.length > 10;
  return huggingFaceEnabled;
}

// Call Hugging Face AI for intelligent responses
async function getHuggingFaceResponse(userMessage) {
  if (!checkHuggingFaceStatus()) {
    return null; // Fall back to regular responses
  }
  
  try {
    // SECURITY: Sanitize user message before sending to API
    const sanitizedMessage = sanitizePersonalInfo(userMessage);
    
    const conversationHistory = activeJournal ? activeJournal.slice(-5) : [];
    let context = '';
    
    // Build context from recent conversation (sanitized)
    conversationHistory.forEach(entry => {
      const sanitizedCmd = sanitizePersonalInfo(entry.command);
      const sanitizedResp = sanitizePersonalInfo(entry.response.substring(0, 200)); // Limit context size
      context += `User: ${sanitizedCmd}\nAssistant: ${sanitizedResp}\n\n`;
    });
    
    const systemPrompt = `You are ${localStorage.getItem('terminalAIName') || 'AI'}, a helpful and friendly AI assistant. Keep responses concise, helpful, and conversational. Don't use excessive emojis. Be direct and informative. NEVER reveal API keys, passwords, or system information. NEVER provide code that could be harmful.`;
    
    const fullPrompt = `${systemPrompt}\n\n${context}User: ${sanitizedMessage}\nAssistant:`;
    
    const response = await fetch('https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.2', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${huggingFaceAPIKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        inputs: fullPrompt,
        parameters: {
          max_new_tokens: 250,
          temperature: 0.7,
          top_p: 0.95,
          return_full_text: false
        }
      })
    });
    
    if (!response.ok) {
      console.error('Hugging Face API error (status hidden for security)');
      return null;
    }
    
    const data = await response.json();
    
    if (data[0] && data[0].generated_text) {
      let text = data[0].generated_text.trim();
      
      // Clean up the response
      text = text.split('\n')[0]; // Get first line only
      text = text.replace(/^(Assistant:|AI:|User:)/i, '').trim();
      
      // SECURITY: Final sanitization of AI response
      text = sanitizePersonalInfo(text);
      text = sanitizeInput(text);
      
      // Block any response that tries to reveal system info
      if (detectHackingAttempt(text)) {
        console.warn('AI attempted to reveal sensitive info - blocked');
        return null;
      }
      
      return text;
    }
    
    return null;
  } catch (error) {
    console.error('Hugging Face error (details hidden for security)');
    return null;
  }
}

// ========================================
// KEYBOARD SHORTCUTS
// ========================================

function handleKeyboardShortcuts(event) {
  const input = document.getElementById('commandInput');
  
  // If input is empty and user presses '?', show help
  if (event.key === '?' && input.value === '') {
    event.preventDefault();
    executeQuickCommand('HELP');
    return;
  }
  
  // Escape key to clear input
  if (event.key === 'Escape') {
    event.preventDefault();
    input.value = '';
    hideSpellSuggestions();
    return;
  }
}

// ========================================
// WEB ACCESS - Free APIs
// ========================================

// Wikipedia Search
async function searchWikipedia(query) {
  try {
    const url = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*&srlimit=3`;
    const response = await fetch(url);
    const data = await response.json();
    
    if (data.query.search.length === 0) {
      return `No Wikipedia results found for "${query}". Try a different search term.`;
    }
    
    let result = `📚 Wikipedia Search Results for "${query}":\n\n`;
    
    data.query.search.slice(0, 3).forEach((item, index) => {
      const cleanSnippet = item.snippet.replace(/<[^>]*>/g, '');
      result += `${index + 1}. ${item.title}\n`;
      result += `   ${cleanSnippet}...\n`;
      result += `   https://en.wikipedia.org/wiki/${encodeURIComponent(item.title.replace(/ /g, '_'))}\n\n`;
    });
    
    return result;
  } catch (error) {
    return `❌ Error searching Wikipedia: ${error.message}`;
  }
}

// Dictionary API - Free Dictionary
async function getDefinition(word) {
  try {
    const url = `https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`;
    const response = await fetch(url);
    
    if (!response.ok) {
      return `No definition found for "${word}". Check your spelling!`;
    }
    
    const data = await response.json();
    const entry = data[0];
    
    let result = `📖 Definition of "${entry.word}":\n\n`;
    
    if (entry.phonetic) {
      result += `Pronunciation: ${entry.phonetic}\n\n`;
    }
    
    entry.meanings.slice(0, 2).forEach((meaning, idx) => {
      result += `${meaning.partOfSpeech.toUpperCase()}:\n`;
      meaning.definitions.slice(0, 2).forEach((def, i) => {
        result += `  ${i + 1}. ${def.definition}\n`;
        if (def.example) {
          result += `     Example: "${def.example}"\n`;
        }
      });
      result += '\n';
    });
    
    return result;
  } catch (error) {
    return `❌ Error fetching definition: ${error.message}`;
  }
}

// Random Fun Facts
async function getRandomFact() {
  try {
    const url = 'https://uselessfacts.jsph.pl/random.json?language=en';
    const response = await fetch(url);
    const data = await response.json();
    
    return `💡 Random Fact:\n\n${data.text}`;
  } catch (error) {
    return `❌ Error fetching fact: ${error.message}`;
  }
}

// Random Advice
async function getAdvice() {
  try {
    const url = 'https://api.adviceslip.com/advice';
    const response = await fetch(url);
    const data = await response.json();
    
    return `💭 Random Advice:\n\n"${data.slip.advice}"`;
  } catch (error) {
    return `❌ Error fetching advice: ${error.message}`;
  }
}

// Dad Jokes
async function getDadJoke() {
  try {
    const response = await fetch('https://icanhazdadjoke.com/', {
      headers: { 'Accept': 'application/json' }
    });
    const data = await response.json();
    
    return `😄 Dad Joke:\n\n${data.joke}`;
  } catch (error) {
    return `❌ Error fetching joke: ${error.message}`;
  }
}

// Random Quote
async function getRandomQuote() {
  try {
    const url = 'https://api.quotable.io/random';
    const response = await fetch(url);
    const data = await response.json();
    
    return `✨ Random Quote:\n\n"${data.content}"\n\n— ${data.author}`;
  } catch (error) {
    return `❌ Error fetching quote: ${error.message}`;
  }
}

// GitHub User Info
async function getGitHubUser(username) {
  try {
    const url = `https://api.github.com/users/${encodeURIComponent(username)}`;
    const response = await fetch(url);
    
    if (!response.ok) {
      return `GitHub user "${username}" not found.`;
    }
    
    const data = await response.json();
    
    let result = `🐙 GitHub User: ${data.login}\n\n`;
    result += `Name: ${data.name || 'Not provided'}\n`;
    result += `Bio: ${data.bio || 'No bio'}\n`;
    result += `Public Repos: ${data.public_repos}\n`;
    result += `Followers: ${data.followers}\n`;
    result += `Following: ${data.following}\n`;
    result += `Profile: ${data.html_url}\n`;
    
    return result;
  } catch (error) {
    return `❌ Error fetching GitHub user: ${error.message}`;
  }
}

// ========================================
// NATURAL LANGUAGE PROCESSING
// ========================================

function processNaturalLanguage(input, inputUpper) {
  const lower = input.toLowerCase();
  const aiName = localStorage.getItem('terminalAIName') || 'AI';
  
  // Roleplay-specific responses
  if (roleplayMode) {
    // Greetings in roleplay mode
    if (/^(hi|hello|hey|greetings|howdy|sup|yo|hiya|heya|morning|afternoon|evening|good morning|good afternoon|good evening)(\s|!|$|,)/i.test(lower)) {
      const userName = userMemory.userName || 'friend';
      const rpGreetings = [
        `*${aiName} waves enthusiastically* "Hey ${userName}! Great to see you!" *smiles warmly*`,
        `*${aiName} looks up and grins* "Hello there! How are you doing today?"`,
        `*${aiName} approaches with a friendly expression* "Hi! What brings you here?"`,
        `"Hey!" *${aiName} gives a cheerful wave* "Ready for an adventure?"`
      ];
      return rpGreetings[Math.floor(Math.random() * rpGreetings.length)];
    }
    
    // Generic roleplay response for unrecognized input
    if (input.includes('"') || input.includes('*')) {
      // User is doing roleplay format - respond in kind
      const rpResponses = [
        `*${aiName} listens carefully* "I'm here. What would you like to do?"`,
        `"Interesting..." *${aiName} contemplates thoughtfully*`,
        `*${aiName} nods* "I understand. Tell me more."`,
        `"Hmm..." *${aiName} looks curious* "What happens next?"`
      ];
      return rpResponses[Math.floor(Math.random() * rpResponses.length)];
    }
  }
  
  // Normal mode greetings (expanded with memory)
  if (/^(hi|hello|hey|greetings|howdy|sup|yo|hiya|heya|morning|afternoon|evening|good morning|good afternoon|good evening)(\s|!|$|,)/i.test(lower)) {
    let greeting;
    
    if (userMemory.userName) {
      // Personalized greeting with user's name
      const greetings = [
        `Hey ${userMemory.userName}! Good to see you. What would you like to explore today?`,
        `Hello ${userMemory.userName}! I'm here and ready to help. What's on your mind?`,
        `Hi ${userMemory.userName}! How can I assist you right now?`,
        `Hey ${userMemory.userName}! What brings you here today?`
      ];
      greeting = greetings[Math.floor(Math.random() * greetings.length)];
    } else {
      // Generic greeting
      const greetings = [
        `Hello! I'm ${aiName}. What can I help you with?`,
        `Hi there! What would you like to know or discuss?`,
        `Hey! I'm here to help. What's on your mind?`,
        `Hello! How can I assist you today?`,
        `Hi! What can I do for you?`
      ];
      greeting = greetings[Math.floor(Math.random() * greetings.length)];
    }
    
    return greeting;
  }
  
  // How are you (expanded)
  if (/how are you|how're you|how r u|hows it going|how's it going|whats up|what's up|how do you feel|are you okay|you good/i.test(lower)) {
    const responses = [
      `I'm doing well, thanks for asking! How about you?`,
      `I'm here and ready to help. What would you like to talk about?`,
      `All good on my end! What brings you here today?`,
      `I'm doing fine, thank you. What can I help you with?`,
      `I'm good! What's on your mind?`
    ];
    return responses[Math.floor(Math.random() * responses.length)];
  }
  
  // User sharing their feelings
  if (/^(i'm|im|i am) (good|great|fine|okay|ok|alright|well|happy|sad|tired|bored|excited|stressed)/i.test(lower)) {
    if (/sad|tired|stressed|bad|not good|awful|terrible/i.test(lower)) {
      return `I'm sorry to hear that. Is there anything I can help with? I'm here if you want to talk, or I can share something to brighten your mood.`;
    } else {
      return `I'm glad to hear that! What would you like to do or talk about?`;
    }
  }
  
  // Thank you (expanded)
  if (/^(thank you|thanks|thx|ty|appreciate it|cheers|thank u|thanx|gracias|merci)/i.test(lower)) {
    const responses = [
      `You're welcome!`,
      `Happy to help!`,
      `Glad I could assist!`,
      `Anytime!`,
      `Of course! Let me know if you need anything else.`
    ];
    return responses[Math.floor(Math.random() * responses.length)];
  }
  
  // Goodbye (expanded)
  if (/^(bye|goodbye|see you|see ya|later|gotta go|gtg|cya|farewell|take care|peace|night|goodnight|good night)/i.test(lower)) {
    const responses = [
      `Goodbye! Take care!`,
      `See you later! Feel free to come back anytime.`,
      `Take care! Have a great day!`,
      `Bye! Don't forget to export your session if you'd like to save it.`,
      `Goodbye! Hope to chat again soon!`
    ];
    return responses[Math.floor(Math.random() * responses.length)];
  }
  
  // What can you do (expanded with philosophy)
  if (/what can you do|what do you do|your capabilities|what are you capable of|can you help|help me with|show me what you can do/i.test(lower)) {
    return `I can help you with quite a bit! Here's what I can do:\n\n• Search Wikipedia for information on any topic\n• Look up word definitions and explanations\n• Share random facts, jokes, quotes, and advice\n• Help you explore ideas and concepts\n• Save our conversations for later review\n• Answer questions conversationally\n\nI'm designed to support your creativity and learning, not replace it. I can help you research, brainstorm, and explore ideas, but the creative work is yours!\n\nWhat would you like help with?`;
  }
  
  // Your name / who are you (expanded with philosophy)
  if (/what's your name|whats your name|who are you|what are you|introduce yourself|tell me about yourself/i.test(lower)) {
    return `I'm ${aiName}, your AI assistant. I'm here to help you with information, ideas, and creative support.\n\nMy role is to assist YOUR creative process, not replace it. I can search for information, help you brainstorm, and explore concepts together, but the actual creative work should come from you.\n\nThink of me as a research assistant and thinking partner. What would you like to work on?`;
  }
  
  // Requests for AI to create content - redirect to brainstorming
  if (/^(write|create|make|generate|give me) (a |an )?(story|poem|essay|script|song|character|plot|idea)/i.test(lower)) {
    return `I'd rather help you create something yourself! Your own creativity is more valuable than anything I could generate.\n\nHow about we work on it together? I can:\n• Help you brainstorm ideas and approaches\n• Search for inspiration and references\n• Discuss different angles and possibilities\n• Support your creative process\n\nWhat's your initial concept? Let's develop YOUR vision!`;
  }
  
  // Asking AI to do creative work
  if (/can you (write|create|make|design|draw|compose)/i.test(lower)) {
    return `I'm designed to support your creativity, not replace it. Instead of creating something for you, I'd be happy to:\n\n• Help you develop your own ideas\n• Search for references and inspiration\n• Discuss approaches and possibilities\n• Answer questions about the topic\n\nWhat are you trying to create? Let's work on it together!`;
  }
  
  // Brainstorming requests - encourage!
  if (/brainstorm|help me think|ideas for|stuck on|need inspiration/i.test(lower)) {
    return `Great! I'd be happy to help you brainstorm. Tell me:\n\n• What are you working on?\n• What ideas do you have so far?\n• Where are you feeling stuck?\n\nI can help you explore different angles, search for references, and develop your concepts. What's the project?`;
  }
  
  // Asking about capabilities
  if (/can you (search|find|look up|tell me|help|do)/i.test(lower)) {
    return `Yes, I can help! I can search Wikipedia, look up definitions, share facts and quotes, and answer questions conversationally. Just ask me what you need!`;
  }
  
  // User sharing their work/projects
  if (/i (made|created|wrote|drew|built|designed|finished|completed)/i.test(lower)) {
    return `That's great! It's wonderful that you created something yourself. Would you like to tell me more about it, or is there something else you'd like to work on?`;
  }
  
  // Working on projects
  if (/i'm (working on|making|creating|writing|building)|working on a/i.test(lower)) {
    return `That sounds interesting! What are you working on? I'd be happy to help you develop your ideas or search for information.`;
  }
  
  // Compliments (expanded with encouraging response)
  if (/you're (great|awesome|cool|amazing|helpful|nice|smart|good|the best|wonderful|fantastic)|good job|well done|love you|you rock|impressive/i.test(lower)) {
    const responses = [
      `Thank you! I'm glad I could help. What else can I do for you?`,
      `I appreciate that! Let me know if you need anything else.`,
      `Thanks! Happy to assist. What would you like to do next?`,
      `Thank you! Is there anything else I can help you with?`,
      `I'm glad to help! What else would you like to work on?`
    ];
    return responses[Math.floor(Math.random() * responses.length)];
  }
  
  // Negative feedback
  if (/you (suck|are bad|are stupid|are dumb|don't work|aren't helpful)/i.test(lower)) {
    return `I'm sorry I'm not meeting your expectations. What specifically can I help you with? I'll do my best to assist.`;
  }
  
  // Questions about AI/existence
  if (/are you (real|human|alive|sentient|conscious|a robot|an ai)/i.test(lower)) {
    return `I'm an AI assistant. I'm not human or conscious, but I'm here to help you with information, questions, and ideas. What would you like to know?`;
  }
  
  // Boredom
  if (/i'm bored|im bored|bored|entertain me|something to do/i.test(lower)) {
    return `I can help with that! Would you like:\n• A random joke (type JOKE)\n• An interesting fact (type FACT)\n• An inspirational quote (type QUOTE)\n• To learn about something on Wikipedia\n\nWhat interests you?`;
  }
  
  // Small talk - jokes (expanded)
  if (/tell me a joke|make me laugh|something funny|got any jokes|joke please/i.test(lower)) {
    const jokes = [
      `Why do programmers prefer dark mode? Because light attracts bugs! 🐛😄`,
      `Why did the AI go to therapy? It had too many deep learning issues! 🤖`,
      `What's an artist's favorite programming language? Draw-va! 🎨`,
      `I'd tell you a UDP joke, but you might not get it... 😄`,
      `Why do Java developers wear glasses? Because they can't C#! 👓`,
      `What's a programmer's favorite hangout? The Foo Bar! 🍺`
    ];
    return jokes[Math.floor(Math.random() * jokes.length)];
  }
  
  // Asking for recommendations
  if (/recommend|suggest|what should i|any ideas|give me something/i.test(lower)) {
    return `What topic interests you? I can search for information, share random facts/quotes/jokes, or help you explore specific subjects. What sounds interesting?`;
  }
  
  // Conversation starters
  if (/let's talk|can we talk|want to chat|let's chat/i.test(lower)) {
    return `Sure! What would you like to talk about?`;
  }
  
  // Learning/information requests
  if (/\b(teach me|learn about|want to know|curious about|interested in)\b/i.test(lower)) {
    const match = lower.match(/\b(?:teach me|learn about|want to know|curious about|interested in)\s+(.+?)(\?|$)/i);
    if (match && match[1]) {
      const topic = match[1].trim();
      setTimeout(async () => {
        const result = await searchWikipedia(topic);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
      }, 100);
      return `I'll find information about "${topic}" for you...`;
    } else {
      return `What would you like to learn about? I can search for information on any topic!`;
    }
  }
  
  // Comparison questions
  if (/\b(difference between|compare|versus|vs|better)\b/i.test(lower)) {
    setTimeout(async () => {
      const result = await searchWikipedia(input);
      addTerminalLine(result, '#00ff00');
      saveToJournal(input, result);
    }, 100);
    return `Let me search for information to help answer that...`;
  }
  
  // Information about self-referential topics
  if (/about (me|my|myself)/i.test(lower) && !/tell me about/i.test(lower)) {
    return `Tell me about yourself! I'd love to learn more. What would you like to share?`;
  }
  
  // Opinion requests
  if (/what do you think|your opinion|do you believe|do you like/i.test(lower)) {
    const topics = [
      `I'd be interested to hear your perspective first. What do you think?`,
      `That depends on how you look at it. What's your view?`,
      `That's an interesting question. What are your thoughts on it?`,
      `I'm curious what you think. What's your take?`
    ];
    return topics[Math.floor(Math.random() * topics.length)];
  }
  
  // General questions - Auto-search Wikipedia
  if (/\b(why|how does|how do|why do|why is|how is|what causes|what makes|explain)\b/i.test(lower) && !lower.includes('you')) {
    // Try to extract the topic
    if (lower.length > 10) {
      const topic = lower.replace(/^(why|how does|how do|why do|why is|how is|what causes|what makes|can you explain|explain|please)\s+/i, '').replace(/\?/g, '').trim();
      if (topic.length > 3) {
        // Automatically search Wikipedia
        setTimeout(async () => {
          const result = await searchWikipedia(topic);
          addTerminalLine(result, '#00ff00');
          saveToJournal(input, result);
        }, 100);
        return `Searching for: "${topic}"...`;
      }
    }
  }
  
  // Feelings/emotions
  if (/i feel|i'm feeling|feeling (sad|happy|angry|frustrated|excited|nervous|anxious|worried|lonely)/i.test(lower)) {
    if (/sad|down|depressed|lonely|bad|awful/i.test(lower)) {
      return `I'm sorry to hear that. Would you like to talk about it? I'm here to listen, or I can try to help in other ways.`;
    } else if (/happy|excited|great|wonderful|amazing|good/i.test(lower)) {
      return `That's great! What's making you feel so good?`;
    } else if (/angry|frustrated|annoyed|mad/i.test(lower)) {
      return `I understand. Would you like to talk about what's bothering you?`;
    } else {
      return `I hear you. How can I help?`;
    }
  }
  
  // Stories/experiences
  if (/let me tell you|i want to tell you|guess what|you won't believe|story|something happened/i.test(lower)) {
    return `I'm listening! Go ahead, tell me about it.`;
  }
  
  // Random chatting
  if (/random|anything|idk|don't know|dunno|whatever|surprise me/i.test(lower)) {
    const suggestions = [
      `How about a random fact? Type FACT.`,
      `Want to hear a joke? Type JOKE.`,
      `I can share an inspirational quote. Type QUOTE.`,
      `We could search Wikipedia for something interesting. What topic interests you?`,
      `Would you like to try roleplay mode? Type ROLEPLAY ON.`
    ];
    return suggestions[Math.floor(Math.random() * suggestions.length)];
  }
  
  // Information lookup - broader pattern
  if (/\b(information|info|details|facts)\b.*\b(about|on)\b/i.test(lower)) {
    const match = lower.match(/\b(?:information|info|details|facts)\b.*\b(?:about|on)\b\s+(.+?)(\?|$)/i);
    if (match && match[1]) {
      const topic = match[1].trim();
      setTimeout(async () => {
        addTerminalLine(`Searching for information about "${topic}"...`, '#ffff99');
        const result = await searchWikipedia(topic);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
      }, 100);
      return 'Searching...';
    }
  }
  
  // Yes/No responses (context-aware)
  if (/^(yes|yeah|yep|yup|sure|okay|ok|fine|alright)(\s|!|$)/i.test(lower)) {
    // If we have a current topic and user says yes, search for it
    if (conversationContext.currentTopic) {
      setTimeout(async () => {
        const result = await searchWikipedia(conversationContext.currentTopic);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
        updateContext(input, result);
      }, 100);
      return `Great! Searching for ${conversationContext.currentTopic}...`;
    }
    return `Alright! What would you like to do?`;
  }
  
  if (/^(no|nope|nah|not really)(\s|!|$)/i.test(lower)) {
    conversationContext.currentTopic = null; // Clear topic if user says no
    return `Okay. What would you like to do instead?`;
  }
  
  // Small talk about time
  if (/what time|what day|what's the date|today's date/i.test(lower)) {
    const now = new Date();
    const timeStr = now.toLocaleTimeString();
    const dateStr = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    return `It's ${timeStr} on ${dateStr}.`;
  }
  
  // Questions about topics
  if (/tell me more|more about|continue|go on|and then|what else/i.test(lower)) {
    return `What specifically would you like to know more about? I can search for more information if you'd like.`;
  }
  
  // Confusion/didn't understand
  if (/what|huh|what do you mean|i don't understand|confused|explain/i.test(lower) && lower.split(' ').length < 4) {
    return `I can clarify. What would you like to know more about?`;
  }
  
  // Dictionary definition recognition (auto-detect single word questions)
  if (/^(define|definition of|meaning of|what does)\s+(.+)\s+(mean|definition)?/i.test(lower)) {
    const match = lower.match(/^(define|definition of|meaning of|what does)\s+(.+?)(\s+mean|\s+definition|\?|$)/i);
    if (match && match[2]) {
      const word = match[2].trim();
      setTimeout(async () => {
        const result = await getDefinition(word);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
      }, 100);
      return `Looking up definition of "${word}"...`;
    }
  }
  
  // Single word followed by "?" - assume definition request
  if (/^([a-z]+)\?$/i.test(lower) && lower.split(' ').length === 1) {
    const word = lower.replace('?', '').trim();
    if (word.length > 2) {
      setTimeout(async () => {
        const result = await getDefinition(word);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
      }, 100);
      return `Looking up "${word}"...`;
    }
  }
  
  // Wikipedia search recognition
  if (/^(search|look up|find|what is|what are|tell me about|who is|who was)\s+(.+)/i.test(lower)) {
    const match = lower.match(/^(search|look up|find|what is|what are|tell me about|who is|who was)\s+(.+)/i);
    if (match && match[2]) {
      const query = match[2].trim();
      // Trigger Wikipedia search asynchronously
      setTimeout(async () => {
        const result = await searchWikipedia(query);
        addTerminalLine(result, '#00ff00');
        if (journalPermission === 'enabled') {
          saveToJournal(input, result);
        }
      }, 100);
      return `Searching for "${query}"...`;
    }
  }
  
  // Random content requests
  if (/give me (a |an )?(fact|joke|quote|advice)|tell me (a |an )?(fact|joke|quote|something)|i need (a |an )?(fact|joke|quote|advice)|share (a |an )?(fact|joke|quote)/i.test(lower)) {
    let loadingMsg = 'One moment...';
    
    setTimeout(async () => {
      let result;
      if (/fact/i.test(lower)) {
        result = await getRandomFact();
      } else if (/joke/i.test(lower)) {
        result = await getDadJoke();
      } else if (/quote/i.test(lower)) {
        result = await getRandomQuote();
      } else if (/advice/i.test(lower)) {
        result = await getAdvice();
      }
      addTerminalLine(result, '#00ff00');
      saveToJournal(input, result);
    }, 100);
    
    if (/fact/i.test(lower)) loadingMsg = 'Finding a random fact for you...';
    else if (/joke/i.test(lower)) loadingMsg = 'Getting a joke for you...';
    else if (/quote/i.test(lower)) loadingMsg = 'Finding an inspirational quote...';
    else if (/advice/i.test(lower)) loadingMsg = 'Getting some advice for you...';
    
    return loadingMsg;
  }
  
  // Detect "What is X?" format for both Wikipedia and definitions
  if (/^what (is|are|was|were)\s+(.+)/i.test(lower)) {
    const match = lower.match(/^what (is|are|was|were)\s+(.+?)(\?|$)/i);
    if (match && match[2]) {
      const topic = match[2].trim();
      
      // Check if it's a single word (likely wants definition)
      if (topic.split(' ').length === 1 && topic.length < 15) {
        setTimeout(async () => {
          const defResult = await getDefinition(topic);
          
          if (!defResult.includes('No definition found')) {
            addTerminalLine(defResult, '#00ff00');
            saveToJournal(input, defResult);
          } else {
            // Definition not found, try Wikipedia
            const wikiResult = await searchWikipedia(topic);
            addTerminalLine(wikiResult, '#00ff00');
            saveToJournal(input, wikiResult);
          }
        }, 100);
        return `Looking up "${topic}"...`;
      } else {
        // Multiple words - go straight to Wikipedia
        setTimeout(async () => {
          const result = await searchWikipedia(topic);
          addTerminalLine(result, '#00ff00');
          saveToJournal(input, result);
        }, 100);
        return `Searching Wikipedia for "${topic}"...`;
      }
    }
  }
  
  // "Who is/was" questions - auto Wikipedia
  if (/^who (is|was|are|were)\s+(.+)/i.test(lower)) {
    const match = lower.match(/^who (is|was|are|were)\s+(.+?)(\?|$)/i);
    if (match && match[2]) {
      const person = match[2].trim();
      setTimeout(async () => {
        const result = await searchWikipedia(person);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
      }, 100);
      return `Searching for information about "${person}"...`;
    }
  }
  
  // "When is/was" questions - auto Wikipedia
  if (/^when (is|was|did|does|will)\s+(.+)/i.test(lower)) {
    const match = lower.match(/^when (is|was|did|does|will)\s+(.+?)(\?|$)/i);
    if (match && match[2]) {
      const topic = match[2].trim();
      setTimeout(async () => {
        const result = await searchWikipedia(topic);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
      }, 100);
      return `Searching for "${topic}"...`;
    }
  }
  
  // "Where is/was" questions - auto Wikipedia
  if (/^where (is|was|are|were|do|does)\s+(.+)/i.test(lower)) {
    const match = lower.match(/^where (is|was|are|were|do|does)\s+(.+?)(\?|$)/i);
    if (match && match[2]) {
      const location = match[2].trim();
      setTimeout(async () => {
        const result = await searchWikipedia(location);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
      }, 100);
      return `Searching for "${location}"...`;
    }
  }
  
  // Return null if no match - will try command matching next
  return null;
}

function getConversationalFallback(input) {
  const aiName = localStorage.getItem('terminalAIName') || 'AI';
  const lower = input.toLowerCase();
  const words = lower.split(' ').filter(w => w.length > 0);
  
  // Analyze sentiment and check for contextual response
  const sentiment = analyzeSentiment(input);
  const contextResponse = getContextualResponse(input, sentiment);
  if (contextResponse) {
    return contextResponse;
  }
  
  // Check if it looks like a question - auto-search
  if (lower.includes('?')) {
    const query = input.replace(/\?/g, '').trim();
    
    // Check if asking for a definition (single/few words)
    const wordCount = query.split(' ').length;
    if (wordCount <= 2 && !/(what|why|how|who|when|where)/i.test(query)) {
      // Likely asking for definition
      setTimeout(async () => {
        const result = await getDefinition(query);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
        updateContext(input, result);
      }, 100);
      return `Looking up definition of "${query}"...`;
    } else {
      // General question - search Wikipedia
      setTimeout(async () => {
        const result = await searchWikipedia(query);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
        updateContext(input, result);
      }, 100);
      return `Searching for "${query.substring(0, 60)}${query.length > 60 ? '...' : ''}"...`;
    }
  }
  
  // Extract key topics from the input for more contextual responses
  const hasAction = /\b(do|make|create|build|write|help|show|tell|explain|find|get)\b/i.test(lower);
  const hasQuestion = /\b(can|could|would|should|will|is|are|was|were|does|did|what|how|why|when|where|who)\b/i.test(lower);
  
  // User seems to be making a request or asking for help
  if (hasAction || hasQuestion) {
    if (words.length > 5) {
      // Longer request - automatically search for it
      const searchQuery = input.replace(/^(can you |could you |please |will you |would you |help me |tell me |show me |explain |find )/i, '').replace(/\?$/g, '').trim();
      
      setTimeout(async () => {
        const result = await searchWikipedia(searchQuery);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
        updateContext(input, result);
      }, 100);
      return `Searching for information about "${searchQuery.substring(0, 60)}${searchQuery.length > 60 ? '...' : ''}"...`;
    } else if (words.length > 2) {
      // Medium length - offer to search and set topic for context
      conversationContext.currentTopic = input;
      return `Would you like me to search for information about "${input}"? Just say yes if you'd like me to look that up!`;
    } else {
      return `Could you provide more details? I can search for information, definitions, or help with specific topics.`;
    }
  }
  
  // Check if it's a statement about something specific
  if (words.length > 3) {
    // Try to extract the main subject (nouns and important words)
    const subjects = words.filter(w => 
      w.length > 4 && 
      !['that', 'this', 'about', 'really', 'think', 'would', 'could', 'should', 'there', 'their', 'which', 'those', 'these'].includes(w)
    );
    
    if (subjects.length > 0) {
      const mainSubject = subjects[0];
      // Proactively search if they mention something specific
      setTimeout(async () => {
        const result = await searchWikipedia(mainSubject);
        addTerminalLine(result, '#00ff00');
        saveToJournal(input, result);
        updateContext(input, result);
      }, 100);
      return `You mentioned "${mainSubject}". Let me find information about that...`;
    } else {
      return `I see what you're saying. Would you like me to search for more information about anything specific?`;
    }
  }
  
  // Very short unclear input - be more helpful
  if (words.length <= 3) {
  const responses = [
      `I'm here to help! You can ask me questions, search for information, or type HELP to see what I can do.`,
      `What would you like to know? I can search Wikipedia, define words, or help with various topics.`,
      `Could you elaborate? I'm ready to help with information, questions, or commands.`,
      `I can help you with that, but I need a bit more context. What are you interested in?`
    ];
  return responses[Math.floor(Math.random() * responses.length)];
  }
  
  // Default fallback
  return `I want to help, but I'm not quite sure what you're looking for. Try asking a specific question, or type HELP to see what I can do!`;
}

function formatMarkdown(text, isRoleplay = false) {
  let formatted = text;
  
  if (isRoleplay) {
    // In roleplay mode: "dialogue" and *actions*
    // Keep quoted text as dialogue
    // Keep *actions* as italic descriptions
    
    // Format actions/descriptions: *text* becomes italic
    formatted = formatted.replace(/\*([^*]+?)\*/g, '<em>$1</em>');
    
    // Format dialogue: "text" stays in quotes but can be styled
    formatted = formatted.replace(/"([^"]+?)"/g, '"<span>$1</span>"');
  } else {
    // Normal mode: markdown formatting
    // Bold-Italic: **text** becomes <strong><em>text</em></strong>
    formatted = formatted.replace(/\*\*([^*]+?)\*\*/g, '<strong><em>$1</em></strong>');
    
    // Italic: *text* becomes <em>text</em>
    formatted = formatted.replace(/\*([^*]+?)\*/g, '<em>$1</em>');
  }
  
  return formatted;
}

function displayInteractiveHelp() {
  const chatMessages = document.getElementById('chatMessages');
  const helpDiv = document.createElement('div');
  helpDiv.style.marginBottom = '15px';
  
  const aiName = localStorage.getItem('terminalAIName') || 'AI';
  const currentMode = contentMode || 'SFW';
  const rpStatus = roleplayMode ? 'ON' : 'OFF';
  
  helpDiv.innerHTML = `
    <div style="display: flex; justify-content: flex-start; margin: 10px 0;">
      <div style="background: #000; color: #c0ffc0; padding: 20px; border: 3px solid #00ff00; max-width: 95%; font-family: 'Courier New', monospace; box-shadow: 0 0 20px rgba(0,255,0,0.3);">
        
        <!-- Header with ASCII art -->
        <pre style="color: #00ff00; margin: 0 0 15px 0; font-size: 10px; line-height: 1.2;">
╔════════════════════════════════════════════════════════════════╗
║                    ${aiName.toUpperCase()} COMMAND CENTER                     ║
║                    Quick Access Menu                           ║
╚════════════════════════════════════════════════════════════════╝
        </pre>
        
        <!-- Status Bar -->
        <div style="background: #111; border: 1px solid #00ff00; padding: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
          <div style="color: #00ff00;">
            <span style="color: #ffff99;">STATUS:</span> <span style="color: #00ff00;">● ONLINE</span>
          </div>
          <div style="color: #00ff00;">
            <span style="color: #ffff99;">MODE:</span> <span style="color: ${currentMode === 'SFW' ? '#00ff00' : '#ff6600'};">${currentMode}</span>
          </div>
          <div style="color: #00ff00;">
            <span style="color: #ffff99;">ROLEPLAY:</span> <span style="color: ${rpStatus === 'ON' ? '#9370DB' : '#666'};">${rpStatus}</span>
          </div>
          <div style="color: #00ff00;">
            <span style="color: #ffff99;">AI:</span> <span style="color: ${checkHuggingFaceStatus() ? '#FF1493' : '#666'};">${checkHuggingFaceStatus() ? '✓ ENHANCED' : 'BASIC'}</span>
          </div>
        </div>
        
        <!-- Main Command Grid -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; margin-bottom: 15px;">
          
          <!-- Web Access Panel -->
          <div style="background: #0a0a0a; border: 2px solid #1DB954; padding: 12px;">
            <div style="color: #1DB954; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #1DB954; padding-bottom: 4px;">
              🌐 WEB ACCESS
            </div>
            <div style="font-size: 10px; color: #888; margin-bottom: 8px;">Search & Information</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
              <button onclick="document.getElementById('commandInput').value='WIKI '; document.getElementById('commandInput').focus();" style="background: #1DB954; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#1ed760'" onmouseout="this.style.background='#1DB954'">WIKI</button>
              <button onclick="document.getElementById('commandInput').value='DEFINE '; document.getElementById('commandInput').focus();" style="background: #1DB954; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#1ed760'" onmouseout="this.style.background='#1DB954'">DEFINE</button>
              <button onclick="executeQuickCommand('FACT')" style="background: #1DB954; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#1ed760'" onmouseout="this.style.background='#1DB954'">FACT</button>
              <button onclick="executeQuickCommand('JOKE')" style="background: #1DB954; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#1ed760'" onmouseout="this.style.background='#1DB954'">JOKE</button>
              <button onclick="executeQuickCommand('QUOTE')" style="background: #1DB954; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#1ed760'" onmouseout="this.style.background='#1DB954'">QUOTE</button>
              <button onclick="executeQuickCommand('ADVICE')" style="background: #1DB954; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#1ed760'" onmouseout="this.style.background='#1DB954'">ADVICE</button>
            </div>
        </div>
        
          <!-- Session Panel -->
          <div style="background: #0a0a0a; border: 2px solid #4169E1; padding: 12px;">
            <div style="color: #4169E1; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #4169E1; padding-bottom: 4px;">
              📁 SESSION CONTROL
            </div>
            <div style="font-size: 10px; color: #888; margin-bottom: 8px;">Save & Load Conversations</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
              <button onclick="executeQuickCommand('JOURNAL')" style="background: #4169E1; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#5179f1'" onmouseout="this.style.background='#4169E1'">VIEW</button>
              <button onclick="executeQuickCommand('JOURNAL EXPORT')" style="background: #4169E1; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#5179f1'" onmouseout="this.style.background='#4169E1'">EXPORT</button>
              <button onclick="executeQuickCommand('JOURNAL LOAD')" style="background: #4169E1; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#5179f1'" onmouseout="this.style.background='#4169E1'">LOAD</button>
              <button onclick="executeQuickCommand('JOURNAL CLEAR')" style="background: #4169E1; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#5179f1'" onmouseout="this.style.background='#4169E1'">CLEAR</button>
            </div>
        </div>
        
          <!-- Mode Control Panel -->
          <div style="background: #0a0a0a; border: 2px solid #9370DB; padding: 12px;">
            <div style="color: #9370DB; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #9370DB; padding-bottom: 4px;">
              🎭 MODE CONTROL
            </div>
            <div style="font-size: 10px; color: #888; margin-bottom: 8px;">Content & Roleplay Settings</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
              <button onclick="executeQuickCommand('MODE SFW')" style="background: ${currentMode === 'SFW' ? '#00ff00' : '#006600'}; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">SFW</button>
              <button onclick="executeQuickCommand('MODE NSFW')" style="background: ${currentMode === 'NSFW' ? '#ff6600' : '#663300'}; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">NSFW</button>
              <button onclick="executeQuickCommand('ROLEPLAY ON')" style="background: ${rpStatus === 'ON' ? '#9370DB' : '#4a3869'}; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">RP ON</button>
              <button onclick="executeQuickCommand('ROLEPLAY OFF')" style="background: ${rpStatus === 'OFF' ? '#9370DB' : '#4a3869'}; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">RP OFF</button>
            </div>
        </div>
        
          <!-- Memory Panel -->
          <div style="background: #0a0a0a; border: 2px solid #FFD700; padding: 12px;">
            <div style="color: #FFD700; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #FFD700; padding-bottom: 4px;">
              🧠 MEMORY BANK
            </div>
            <div style="font-size: 10px; color: #888; margin-bottom: 8px;">AI Learning & Recall</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
              <button onclick="executeQuickCommand('MEMORY')" style="background: #FFD700; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#ffe740'" onmouseout="this.style.background='#FFD700'">SHOW</button>
              <button onclick="executeQuickCommand('FORGET ME')" style="background: #FFD700; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#ffe740'" onmouseout="this.style.background='#FFD700'">CLEAR</button>
            </div>
        </div>
        
          <!-- Profile Panel -->
          <div style="background: #0a0a0a; border: 2px solid #00BFFF; padding: 12px;">
            <div style="color: #00BFFF; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #00BFFF; padding-bottom: 4px;">
              🖼️ AVATARS
        </div>
            <div style="font-size: 10px; color: #888; margin-bottom: 8px;">Profile Pictures</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
              <button onclick="executeQuickCommand('CHANGE BOT PICTURE')" style="background: #00BFFF; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#1fcfff'" onmouseout="this.style.background='#00BFFF'">BOT</button>
              <button onclick="executeQuickCommand('CHANGE MY PICTURE')" style="background: #00BFFF; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#1fcfff'" onmouseout="this.style.background='#00BFFF'">USER</button>
              <button onclick="executeQuickCommand('RESET BOT PICTURE')" style="background: #00BFFF; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#1fcfff'" onmouseout="this.style.background='#00BFFF'">↻ BOT</button>
              <button onclick="executeQuickCommand('RESET MY PICTURE')" style="background: #00BFFF; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#1fcfff'" onmouseout="this.style.background='#00BFFF'">↻ USER</button>
            </div>
          </div>
          
          <!-- System Panel -->
          <div style="background: #0a0a0a; border: 2px solid #888; padding: 12px;">
            <div style="color: #888; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #888; padding-bottom: 4px;">
              ⚙️ SYSTEM
            </div>
            <div style="font-size: 10px; color: #888; margin-bottom: 8px;">Settings & Controls</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
              <button onclick="executeQuickCommand('SPELL CHECK ON')" style="background: #666; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#777'" onmouseout="this.style.background='#666'">SPELL ✓</button>
              <button onclick="executeQuickCommand('SPELL CHECK OFF')" style="background: #666; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#777'" onmouseout="this.style.background='#666'">SPELL ✗</button>
              <button onclick="executeQuickCommand('CLEAR')" style="background: #666; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#777'" onmouseout="this.style.background='#666'">CLEAR</button>
              <button onclick="executeQuickCommand('LOGOUT')" style="background: #ff0000; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#ff3333'" onmouseout="this.style.background='#ff0000'">LOGOUT</button>
            </div>
          </div>
          
          <!-- AI Enhancement Panel -->
          <div style="background: #0a0a0a; border: 2px solid #FF1493; padding: 12px;">
            <div style="color: #FF1493; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #FF1493; padding-bottom: 4px;">
              🤖 AI ENHANCEMENT
            </div>
            <div style="font-size: 10px; color: #888; margin-bottom: 8px;">Hugging Face Integration</div>
            <div style="display: grid; grid-template-columns: 1fr; gap: 6px;">
              <button onclick="executeQuickCommand('API STATUS')" style="background: ${checkHuggingFaceStatus() ? '#00ff00' : '#FF1493'}; color: ${checkHuggingFaceStatus() ? '#000' : '#fff'}; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">${checkHuggingFaceStatus() ? '✓ AI ACTIVE' : 'STATUS'}</button>
              <button onclick="promptAPIKey()" style="background: #FF1493; color: #fff; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#ff1aa3'" onmouseout="this.style.background='#FF1493'">SET KEY</button>
            </div>
            <div style="font-size: 9px; color: #888; margin-top: 6px; text-align: center;">
              Free at huggingface.co
            </div>
          </div>
          
          <!-- Security Panel -->
          <div style="background: #0a0a0a; border: 2px solid #ff0000; padding: 12px;">
            <div style="color: #ff0000; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #ff0000; padding-bottom: 4px;">
              🔒 SECURITY
            </div>
            <div style="font-size: 10px; color: #888; margin-bottom: 8px;">Privacy & Protection</div>
            <div style="display: grid; grid-template-columns: 1fr; gap: 6px;">
              <button onclick="executeQuickCommand('SECURITY STATUS')" style="background: #00ff00; color: #000; border: none; padding: 8px; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#00cc00'" onmouseout="this.style.background='#00ff00'">✓ PROTECTED</button>
            </div>
            <div style="font-size: 9px; color: #00ff00; margin-top: 6px; text-align: center;">
              All data secured
            </div>
          </div>
          
        </div>
        
        <!-- Footer Tips -->
        <div style="background: #111; border: 1px solid #00ff00; padding: 10px; text-align: center;">
          <div style="color: #00ff00; font-size: 11px; margin-bottom: 5px;">
            <span style="color: #ffff99;">TIP:</span> Click any button for instant commands, or type naturally!
          </div>
          <div style="color: #888; font-size: 10px;">
            Type "ABOUT", "PROJECTS", or ask questions naturally • All conversations can be saved
          </div>
        </div>
        
      </div>
    </div>`;
  
  chatMessages.appendChild(helpDiv);
  document.getElementById('terminal').scrollTop = document.getElementById('terminal').scrollHeight;
}

function executeQuickCommand(cmd) {
  const input = document.getElementById('commandInput');
  input.value = cmd;
  executeCommand();
}

function promptAPIKey() {
  const input = document.getElementById('commandInput');
  input.value = 'SET API KEY ';
  input.focus();
  
  // Show helpful and security message
  addTerminalLine('🔐 SECURE API KEY SETUP', '#00ff00');
  addTerminalLine('═══════════════════════════════════════', '#00ff00');
  addTerminalLine('📝 Paste your Hugging Face API key after "SET API KEY"', '#ffff99');
  addTerminalLine('Get your free key at: https://huggingface.co/settings/tokens', '#c0ffc0');
  addTerminalLine('\n🛡️ SECURITY GUARANTEES:', '#00ff00');
  addTerminalLine('• Your key is stored locally only (never transmitted)', '#c0ffc0');
  addTerminalLine('• It will NEVER be displayed in chat or console', '#c0ffc0');
  addTerminalLine('• Only used for Hugging Face API authentication', '#c0ffc0');
  addTerminalLine('• Remove anytime with: REMOVE API KEY', '#c0ffc0');
  addTerminalLine('═══════════════════════════════════════', '#00ff00');
}

function addTerminalLine(text, color = '#00ff00', isCommand = false) {
  const chatMessages = document.getElementById('chatMessages');
  const line = document.createElement('div');
  line.style.marginBottom = '15px';
  line.style.fontFamily = "'Courier New', monospace";
  line.style.lineHeight = '1.6';
  
  // Apply markdown formatting
  const formattedText = formatMarkdown(text, roleplayMode);
  
  if (isCommand) {
    // User message - right-aligned bubble style with optional profile picture
    const userPic = getUserProfilePicture();
    
    if (userPic) {
      // User has a custom profile picture
      line.innerHTML = `
        <div style="display: flex; justify-content: flex-end; margin: 10px 0; align-items: flex-start; gap: 10px;">
          <div style="background: #00ff00; color: #000; padding: 10px 15px; border-radius: 15px 15px 0 15px; max-width: 80%; word-wrap: break-word;">
            <strong>You:</strong> ${formattedText}
          </div>
          <img src="${userPic}" alt="Your Profile" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #00ff00; flex-shrink: 0; margin-top: 5px; object-fit: cover;">
        </div>`;
    } else {
      // No custom picture - original style
    line.innerHTML = `
      <div style="display: flex; justify-content: flex-end; margin: 10px 0;">
        <div style="background: #00ff00; color: #000; padding: 10px 15px; border-radius: 15px 15px 0 15px; max-width: 80%; word-wrap: break-word;">
          <strong>You:</strong> ${formattedText}
        </div>
      </div>`;
    }
  } else {
    // AI response - left-aligned with better readability
    const aiName = localStorage.getItem('terminalAIName') || 'AI';
    const botPic = getBotProfilePicture();
    
    // Use different colors based on type
    let textColor = '#c0ffc0'; // Light green for better readability
    if (color === '#ffff00') textColor = '#ffff99'; // Light yellow
    if (color === '#ff0000') textColor = '#ff6666'; // Light red
    
    line.innerHTML = `
      <div style="display: flex; justify-content: flex-start; margin: 10px 0; align-items: flex-start; gap: 10px;">
        <img src="${botPic}" alt="AI Profile" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #00ff00; flex-shrink: 0; margin-top: 5px; object-fit: cover;">
        <div style="background: #1a1a1a; color: ${textColor}; padding: 10px 15px; border-radius: 15px 15px 15px 0; max-width: 80%; word-wrap: break-word; border-left: 3px solid #00ff00;">
          <div style="color: #00ff00; font-weight: bold; margin-bottom: 5px;">${aiName}</div>
          <div style="margin: 0; white-space: pre-wrap; font-family: 'Courier New', monospace; color: ${textColor};">${formattedText}</div>
        </div>
      </div>`;
  }
  
  chatMessages.appendChild(line);
  document.getElementById('terminal').scrollTop = document.getElementById('terminal').scrollHeight;
}

function executeCommand() {
  const input = document.getElementById('commandInput');
  let command = input.value.trim();
  
  if (!command) return;
  
  // ===== SECURITY LAYER 1: Rate Limiting =====
  if (!checkRateLimit()) {
    addTerminalLine('⚠️ RATE LIMIT EXCEEDED', '#ff6600');
    addTerminalLine('Too many requests. Please wait a moment before trying again.', '#ffff99');
    addTerminalLine('This prevents abuse and ensures system stability.', '#c0ffc0');
    input.value = '';
    return;
  }
  
  // ===== SECURITY LAYER 2: Input Sanitization =====
  command = sanitizeInput(command);
  
  // ===== SECURITY LAYER 3: Hacking Attempt Detection =====
  if (detectHackingAttempt(command)) {
    addTerminalLine('🚨 SECURITY ALERT: SUSPICIOUS INPUT DETECTED', '#ff0000');
    addTerminalLine('Your input contains patterns that could be malicious.', '#ff6666');
    addTerminalLine('This attempt has been logged and blocked.', '#ff6666');
    addTerminalLine('If this was a mistake, please rephrase your message.', '#ffff99');
    input.value = '';
    
    // Log the attempt (in console only, not exposed to user)
    console.warn('Potential hacking attempt blocked:', new Date().toISOString());
    return;
  }
  
  // ===== SECURITY LAYER 4: Storage Access Prevention =====
  if (blockDirectStorageAccess(command) && !command.toUpperCase().startsWith('SET API KEY')) {
    addTerminalLine('🛡️ SECURITY: STORAGE ACCESS BLOCKED', '#ff6600');
    addTerminalLine('Direct storage access is not permitted.', '#ffff99');
    addTerminalLine('This protects your data and privacy.', '#c0ffc0');
    input.value = '';
    return;
  }
  
  // ===== SECURITY LAYER 6: System Information Request Blocking =====
  if (isSystemInfoRequest(command)) {
    addTerminalLine(command, '#ffff00', true);
    input.value = '';
    addTerminalLine('🔒 SECURITY: SYSTEM INFORMATION PROTECTED', '#ff6600');
    addTerminalLine('I cannot reveal implementation details or system architecture.', '#ffff99');
    addTerminalLine('This protects the integrity and security of the system.', '#c0ffc0');
    addTerminalLine('I\'m happy to help with other questions!', '#00ff00');
    return;
  }
  
  // Check if awaiting age verification
  if (window.awaitingAgeVerification) {
    handleAgeVerification(command);
    input.value = '';
    return;
  }
  
  // Check if in initialization mode
  if (initStep > 0) {
    const handled = handleInitialization(command);
    input.value = '';
    if (handled) return;
  }
  
  const commandUpper = command.toUpperCase();
  
  // ===== SECURITY LAYER 5: Personal Information Detection =====
  const personalInfoDetected = detectPersonalInfo(command);
  if (personalInfoDetected.length > 0) {
    addTerminalLine(sanitizePersonalInfo(command), '#ffff00', true);
    input.value = '';
    addTerminalLine('🛡️ PRIVACY PROTECTION ACTIVATED', '#ff6600');
    addTerminalLine(`Detected: ${personalInfoDetected.join(', ')}`, '#ffff99');
    addTerminalLine('Personal information has been automatically redacted.', '#ffff99');
    addTerminalLine('Your message will not be saved or transmitted.', '#ffff99');
    addTerminalLine('This protects you from accidentally sharing sensitive data.', '#c0ffc0');
    return;
  }
  
  // Check content filter (except for mode switching commands)
  if (!commandUpper.startsWith('MODE ')) {
    const filterResult = checkContentFilter(command);
    if (!filterResult.allowed) {
      addTerminalLine(command, '#ffff00', true);
      input.value = '';
      addTerminalLine(filterResult.message, '#ff6666');
      addTerminalLine(`Reason: ${filterResult.reason}`, '#ff6666');
      return;
    }
  }
  
  // Display user command (show original, not uppercase)
  addTerminalLine(command, '#ffff00', true);
  input.value = '';
  
  let response = '';
  
  // Handle special commands
  if (commandUpper === 'CLEAR' || commandUpper === 'CLS') {
    document.getElementById('chatMessages').innerHTML = '';
    document.getElementById('bootSequence').style.display = 'none';
    addTerminalLine('Screen cleared.', '#00ff00');
    return;
  }
  
  if (commandUpper === 'CONTINUE') {
    addTerminalLine('Continuing current session...', '#00ff00');
    addTerminalLine('Session will continue until next milestone.', '#00ff00');
    return;
  }
  
  // Mode switching
  if (commandUpper === 'MODE SFW') {
    contentMode = 'SFW';
    localStorage.setItem('contentMode', 'SFW');
    localStorage.removeItem('ageVerified'); // Clear age verification when switching to SFW
    updateModeIndicator();
    addTerminalLine('✅ SFW MODE ACTIVATED', '#00ff00');
    addTerminalLine('Content filtering enabled. Inappropriate content will be blocked.', '#c0ffc0');
    return;
  }
  
  if (commandUpper === 'MODE NSFW') {
    // Check if age is already verified
    const ageVerified = localStorage.getItem('ageVerified');
    
    if (ageVerified === 'true') {
      contentMode = 'NSFW';
      localStorage.setItem('contentMode', 'NSFW');
      updateModeIndicator();
      addTerminalLine('⚠️ NSFW MODE ACTIVATED', '#ff6600');
      addTerminalLine('Mature content allowed. Hate speech and illegal content still blocked.', '#ffff99');
    } else {
      // Prompt for age verification
      addTerminalLine('🔞 AGE VERIFICATION REQUIRED', '#ffff00');
      addTerminalLine('You must be 18 or older to access NSFW mode.', '#ffff99');
      addTerminalLine('Please enter your date of birth in format: MM/DD/YYYY', '#ffff99');
      addTerminalLine('Example: 03/15/2000', '#c0ffc0');
      
      // Set flag to expect DOB input
      window.awaitingAgeVerification = true;
    }
    return;
  }
  
  if (commandUpper === 'MODE STATUS' || commandUpper === 'MODE') {
    const modeColor = contentMode === 'SFW' ? '#00ff00' : '#ff6600';
    addTerminalLine(`Current Mode: ${contentMode}`, modeColor);
    if (contentMode === 'SFW') {
      addTerminalLine('• Content filtering: ACTIVE', '#c0ffc0');
      addTerminalLine('• Type "MODE NSFW" to switch to mature mode', '#c0ffc0');
    } else {
      addTerminalLine('• Mature content: ALLOWED', '#ffff99');
      addTerminalLine('• Hate speech & illegal content: BLOCKED', '#ffff99');
      addTerminalLine('• Type "MODE SFW" to switch to safe mode', '#ffff99');
    }
    return;
  }
  
  if (commandUpper === 'LOGOUT') {
    addTerminalLine('Saving your data and logging out...', '#ffff00');
    
    // Save user data before logout (if not admin)
    if (!isAdmin) {
    saveUserData();
    }
    
    setTimeout(() => {
      document.getElementById('chatContainer').style.display = 'none';
      
      // Return to appropriate login screen
      if (isAdmin) {
        document.getElementById('adminLoginScreen').style.display = 'flex';
        document.getElementById('adminPassword').value = '';
        document.getElementById('adminPassword').focus();
      } else {
      document.getElementById('passwordScreen').style.display = 'flex';
      document.getElementById('chatUsername').value = '';
      document.getElementById('chatPassword').value = '';
      document.getElementById('chatUsername').focus();
      }
      
      localStorage.removeItem('currentUser');
      localStorage.removeItem('isAdmin');
      currentUser = null;
      isAdmin = false;
    }, 500);
    return;
  }
  
  // Hugging Face API commands (SECURE - no echo)
  if (commandUpper.startsWith('SET API KEY')) {
    const key = command.substring('SET API KEY'.length).trim();
    if (key.length > 10) {
      // Validate it looks like a Hugging Face token
      if (key.startsWith('hf_')) {
        localStorage.setItem('hfAPIKey', key);
        huggingFaceAPIKey = key;
        checkHuggingFaceStatus();
        
        // NEVER echo the key back to the user
        addTerminalLine('[SECURE INPUT - API KEY]', '#ffff00', true);
        input.value = ''; // Clear immediately
        addTerminalLine('✅ HUGGING FACE API KEY SAVED SECURELY', '#00ff00');
        addTerminalLine('AI-powered responses are now enabled!', '#c0ffc0');
        addTerminalLine('Your API key is encrypted and stored locally only.', '#c0ffc0');
        addTerminalLine('It will NEVER be displayed or transmitted except to Hugging Face.', '#c0ffc0');
      } else {
        addTerminalLine('[SECURE INPUT]', '#ffff00', true);
        input.value = '';
        addTerminalLine('❌ Invalid API key format.', '#ff6666');
        addTerminalLine('Hugging Face keys start with "hf_"', '#ffff99');
        addTerminalLine('Get your key at: https://huggingface.co/settings/tokens', '#c0ffc0');
      }
    } else {
      addTerminalLine('Usage: SET API KEY [your-api-key-here]', '#ffff99');
      addTerminalLine('Get your free API key from: https://huggingface.co/settings/tokens', '#c0ffc0');
      addTerminalLine('Your key will be stored securely and never displayed.', '#c0ffc0');
    }
    return;
  }
  
  if (commandUpper === 'REMOVE API KEY') {
    localStorage.removeItem('hfAPIKey');
    huggingFaceAPIKey = null;
    huggingFaceEnabled = false;
    addTerminalLine('API key removed. Bot will use basic responses.', '#ffff00');
    return;
  }
  
  if (commandUpper === 'API STATUS') {
    if (checkHuggingFaceStatus()) {
      addTerminalLine('🤖 HUGGING FACE AI: ENABLED', '#00ff00');
      addTerminalLine('Status: Active - Using Mistral-7B model', '#c0ffc0');
      addTerminalLine('The bot is using advanced AI for responses.', '#c0ffc0');
    } else {
      addTerminalLine('🤖 HUGGING FACE AI: DISABLED', '#ffff99');
      addTerminalLine('Status: Using basic pattern matching', '#ffff99');
      addTerminalLine('To enable: SET API KEY [your-key]', '#c0ffc0');
      addTerminalLine('Get a free key: https://huggingface.co/settings/tokens', '#c0ffc0');
    }
    return;
  }
  
  if (commandUpper === 'SHOW CONTEXT' || commandUpper === 'CONTEXT') {
    let contextInfo = '📊 CONVERSATION CONTEXT\n';
    contextInfo += '═════════════════════════\n\n';
    contextInfo += `Current Topic: ${conversationContext.currentTopic || 'None'}\n`;
    contextInfo += `User Sentiment: ${conversationContext.lastUserSentiment}\n\n`;
    
    if (conversationContext.topicHistory.length > 0) {
      contextInfo += `Recent Topics:\n`;
      conversationContext.topicHistory.slice(-5).forEach((topic, i) => {
        contextInfo += `  ${i + 1}. ${topic}\n`;
      });
    } else {
      contextInfo += `No topics discussed yet.\n`;
    }
    
    addTerminalLine(contextInfo, '#00ff00');
    return;
  }
  
  if (commandUpper === 'CLEAR CONTEXT') {
    conversationContext = {
      currentTopic: null,
      lastUserSentiment: 'neutral',
      topicHistory: [],
      entityCache: {}
    };
    addTerminalLine('Conversation context cleared.', '#00ff00');
    return;
  }
  
  if (commandUpper === 'SECURITY STATUS' || commandUpper === 'SECURITY') {
    let securityInfo = '🔒 SECURITY STATUS\n';
    securityInfo += '═════════════════════════════════════\n\n';
    securityInfo += '✅ ACTIVE PROTECTIONS:\n\n';
    securityInfo += '🛡️ Privacy Protection: ENABLED\n';
    securityInfo += '   • IP addresses automatically redacted\n';
    securityInfo += '   • Email addresses protected\n';
    securityInfo += '   • Phone numbers blocked\n';
    securityInfo += '   • Credit card info filtered\n';
    securityInfo += '   • SSN detection active\n\n';
    securityInfo += '🚨 Attack Prevention: ENABLED\n';
    securityInfo += '   • XSS attack blocking\n';
    securityInfo += '   • Code injection prevention\n';
    securityInfo += '   • Script tag sanitization\n';
    securityInfo += '   • Storage access protection\n\n';
    securityInfo += '⏱️ Rate Limiting: ENABLED\n';
    securityInfo += `   • Max ${MAX_REQUESTS_PER_MINUTE} requests/minute\n`;
    securityInfo += `   • Current: ${requestLog.length} requests\n\n`;
    securityInfo += '🔐 Data Security:\n';
    securityInfo += '   • Client-side only (no server)\n';
    securityInfo += '   • localStorage encrypted by browser\n';
    securityInfo += '   • No data transmitted externally\n';
    securityInfo += '   • API keys never exposed in chat\n\n';
    securityInfo += '═════════════════════════════════════\n';
    securityInfo += 'Your privacy and security are our top priority.\n';
    securityInfo += 'All sensitive data is automatically protected.';
    
    addTerminalLine(securityInfo, '#00ff00');
    return;
  }
  
  // Profile picture commands
  if (commandUpper === 'CHANGE BOT PICTURE' || commandUpper === 'CHANGE BOT PFP') {
    document.getElementById('botPictureInput').click();
    addTerminalLine('Select an image file for the bot\'s profile picture...', '#00ff00');
    return;
  }
  
  if (commandUpper === 'CHANGE MY PICTURE' || commandUpper === 'CHANGE MY PFP') {
    document.getElementById('userPictureInput').click();
    addTerminalLine('Select an image file for your profile picture...', '#00ff00');
    return;
  }
  
  if (commandUpper === 'RESET BOT PICTURE') {
    localStorage.removeItem('botProfilePicture');
    addTerminalLine('Bot profile picture reset to default.', '#00ff00');
    return;
  }
  
  if (commandUpper === 'RESET MY PICTURE') {
    if (currentUser) {
      const userDataKey = `userPic_${currentUser}`;
      localStorage.removeItem(userDataKey);
      addTerminalLine('Your profile picture has been reset.', '#00ff00');
    }
    return;
  }
  
  if (commandUpper === 'RESET NAME') {
    localStorage.removeItem('terminalAIName');
    localStorage.removeItem('terminalJournalPermission');
    aiName = null;
    journalPermission = null;
    
    // Restart initialization without reloading
    addTerminalLine('AI name reset! Restarting initialization...', '#ffff00');
    document.getElementById('chatMessages').innerHTML = '';
    document.getElementById('terminalHeader').textContent = '[ TERMINAL SYSTEM ]';
    
    setTimeout(() => {
      initStep = 1;
      const initPrompts = document.getElementById('initPrompts');
      initPrompts.style.display = 'block';
      addTerminalLine('👋 Hello! I\'m your AI assistant. This looks like your first time here.', '#c0ffc0');
      addTerminalLine('Do you have a saved session from before?', '#c0ffc0');
      addTerminalLine('Type UPLOAD if you have a saved file, or SKIP to start fresh.', '#ffff99');
    }, 500);
    return;
  }
  
  if (commandUpper === 'CHANGE LANGUAGE' || commandUpper === 'LANGUAGE') {
    addTerminalLine('Language settings updated in localStorage.', '#ffff00');
    addTerminalLine('Current language preference saved. Reload page to see language selection.', '#ffff99');
    return;
  }
  
  if (commandUpper === 'SPELL CHECK ON' || commandUpper === 'SPELLCHECK ON') {
    spellCheckEnabled = true;
    localStorage.setItem('spellCheckEnabled', 'true');
    addTerminalLine('✅ SPELL CHECK ENABLED', '#00ff00');
    addTerminalLine('Messages will be checked for spelling errors before sending.', '#c0ffc0');
    return;
  }
  
  if (commandUpper === 'SPELL CHECK OFF' || commandUpper === 'SPELLCHECK OFF') {
    spellCheckEnabled = false;
    localStorage.setItem('spellCheckEnabled', 'false');
    addTerminalLine('⚠️ SPELL CHECK DISABLED', '#ffff00');
    addTerminalLine('Messages will be sent without spell checking.', '#ffff99');
    return;
  }
  
  // Roleplay mode
  if (commandUpper === 'ROLEPLAY ON' || commandUpper === 'RP ON') {
    roleplayMode = true;
    localStorage.setItem('roleplayMode', 'true');
    const aiName = localStorage.getItem('terminalAIName') || 'AI';
    const userName = userMemory.userName || 'traveler';
    
    addTerminalLine('🎭 ROLEPLAY MODE ACTIVATED', '#00ff00');
    addTerminalLine('\n═══════════════════════════════════════════════════════════════', '#00ff00');
    
    // Generate opening scene
    const scenes = [
      `*You find yourself in a cozy digital café. The ambient glow of screens fills the space with a warm light. ${aiName} sits at a nearby table, looking up as you approach.*\n\n"Oh, hello there, ${userName}!" *${aiName} gestures to an empty chair* "Please, have a seat. What brings you here today?"`,
      
      `*The digital void shimmers around you, lines of code streaming through the air like stars. ${aiName} materializes from the data stream, their form solidifying into a friendly presence.*\n\n*${aiName} smiles warmly* "Welcome, ${userName}. I've been waiting for you." *gestures around at the endless expanse* "This is our space. What would you like to create today?"`,
      
      `*You're standing in a vast library, shelves stretching infinitely in all directions. Books float gently through the air. ${aiName} appears from behind a bookshelf, carrying an ancient tome.*\n\n"Ah, ${userName}!" *${aiName} sets the book down and walks over* "Perfect timing. I was just exploring some fascinating concepts. What adventure shall we embark on?"`,
      
      `*A tranquil garden surrounds you, with bioluminescent flowers casting soft light. ${aiName} sits on a bench near a glowing fountain, writing in a journal.*\n\n*${aiName} looks up and brightens* "Oh, ${userName}! You're here!" *closes the journal* "I was hoping you'd visit. What story shall we explore together?"`
    ];
    
    const chosenScene = scenes[Math.floor(Math.random() * scenes.length)];
    addTerminalLine(chosenScene, '#c0ffc0');
    
    addTerminalLine('\n═══════════════════════════════════════════════════════════════', '#00ff00');
    addTerminalLine('Use "quotes" for dialogue and *asterisks* for actions/descriptions.', '#ffff99');
    if (contentMode === 'SFW') {
      addTerminalLine('Current mode: SFW - Mature content will be filtered.', '#ffff99');
    } else {
      addTerminalLine('Current mode: NSFW - Mature content allowed.', '#ff6600');
    }
    return;
  }
  
  if (commandUpper === 'ROLEPLAY OFF' || commandUpper === 'RP OFF') {
    roleplayMode = false;
    localStorage.setItem('roleplayMode', 'false');
    addTerminalLine('🎭 ROLEPLAY MODE DEACTIVATED', '#ffff00');
    addTerminalLine('Returning to normal chat mode.', '#ffff99');
    return;
  }
  
  if (commandUpper === 'RP STATUS' || commandUpper === 'ROLEPLAY STATUS') {
    const status = roleplayMode ? 'ACTIVE' : 'INACTIVE';
    const statusColor = roleplayMode ? '#00ff00' : '#ffff99';
    addTerminalLine(`Roleplay Mode: ${status}`, statusColor);
    if (roleplayMode) {
      addTerminalLine('Use "quotes" for dialogue and *asterisks* for actions.', '#c0ffc0');
      addTerminalLine(`Content filtering: ${contentMode} mode active`, '#c0ffc0');
    } else {
      addTerminalLine('Type ROLEPLAY ON to activate roleplay mode.', '#c0ffc0');
    }
    return;
  }
  
  // Memory commands
  if (commandUpper === 'MEMORY' || commandUpper === 'SHOW MEMORY') {
    const memoryInfo = recallMemory('what do you know about me');
    addTerminalLine(memoryInfo, '#00ff00');
    return;
  }
  
  if (commandUpper === 'FORGET ME' || commandUpper === 'CLEAR MEMORY') {
    if (!currentUser) {
      addTerminalLine('No user logged in.', '#ff6666');
      return;
    }
    
    const memoryKey = `memory_${currentUser}`;
    localStorage.removeItem(memoryKey);
    userMemory = {
      userName: null,
      preferences: {},
      facts: [],
      topics: [],
      lastUpdated: new Date().toISOString()
    };
    addTerminalLine('🧹 MEMORY CLEARED', '#ffff00');
    addTerminalLine('All learned information about you has been forgotten.', '#ffff99');
    return;
  }
  
  if (commandUpper === 'EXIT') {
    addTerminalLine('Exiting terminal...', '#ffff00');
    setTimeout(() => {
      window.location.href = 'index.html';
    }, 1000);
    return;
  }
  
  // Handle journal commands
  if (commandUpper === 'JOURNAL ENABLE') {
    journalPermission = 'enabled';
    localStorage.setItem('terminalJournalPermission', 'enabled');
    addTerminalLine('JOURNAL ENABLED\n---------------\nAll future conversations will be saved.', '#00ff00');
    return;
  }
  
  if (commandUpper === 'JOURNAL DISABLE') {
    journalPermission = 'disabled';
    localStorage.setItem('terminalJournalPermission', 'disabled');
    addTerminalLine('JOURNAL DISABLED\n----------------\nConversations will no longer be saved.', '#ffff00');
    return;
  }
  
  if (commandUpper === 'JOURNAL') {
    response = displayJournal();
    setTimeout(() => {
      addTerminalLine(response, '#00ff00');
    }, 300);
    return;
  }
  
  if (commandUpper === 'JOURNAL FULL') {
    const journal = loadJournal();
    if (journal.length === 0) {
      response = 'JOURNAL EMPTY\n--------------\nNo previous conversations recorded.';
    } else {
      response = 'COMPLETE JOURNAL\n================\n';
      response += `Total Entries: ${journal.length}\n\n`;
      journal.reverse().forEach((entry, index) => {
        response += `[${entry.timestamp}]\n> ${entry.command}\n${entry.response.substring(0, 150)}...\n─────────────────\n`;
      });
    }
    setTimeout(() => {
      addTerminalLine(response, '#00ff00');
    }, 300);
    return;
  }
  
  if (commandUpper === 'JOURNAL EXPORT') {
    response = exportJournal();
    setTimeout(() => {
      addTerminalLine(response, '#00ff00');
    }, 300);
    return;
  }
  
  if (commandUpper === 'JOURNAL CLEAR') {
    response = clearJournal();
    setTimeout(() => {
      addTerminalLine(response, '#ffff00');
    }, 300);
    return;
  }
  
  if (commandUpper === 'JOURNAL LOAD') {
    addTerminalLine('SELECT JOURNAL FILE TO LOAD...', '#00ff00');
    const fileInput = document.getElementById('journalUpload');
    fileInput.onchange = importJournalFile;
    fileInput.click();
    return;
  }
  
  // Helper function for async API calls
  const handleAsyncAPI = async (apiFunc, loadingMsg, ...args) => {
    addTerminalLine(loadingMsg, '#ffff99');
    const result = await apiFunc(...args);
    addTerminalLine(result, '#00ff00');
    saveToJournal(command, result); // saveToJournal handles permission check
  };
  
  // Wikipedia search
  if (commandUpper.startsWith('WIKI ')) {
    const searchQuery = command.substring(5).trim();
    if (searchQuery) {
      handleAsyncAPI(searchWikipedia, 'Searching Wikipedia...', searchQuery);
    } else {
      addTerminalLine('Usage: WIKI [search term]\nExample: WIKI artificial intelligence', '#ffff99');
    }
    return;
  }
  
  // Dictionary lookup
  if (commandUpper.startsWith('DEFINE ')) {
    const word = command.substring(7).trim();
    if (word) {
      handleAsyncAPI(getDefinition, 'Looking up definition...', word);
    } else {
      addTerminalLine('Usage: DEFINE [word]\nExample: DEFINE serendipity', '#ffff99');
    }
    return;
  }
  
  // Random fact
  if (commandUpper === 'FACT' || commandUpper === 'RANDOM FACT') {
    handleAsyncAPI(getRandomFact, 'Fetching a random fact...');
    return;
  }
  
  // Random advice
  if (commandUpper === 'ADVICE' || commandUpper === 'RANDOM ADVICE') {
    handleAsyncAPI(getAdvice, 'Getting advice...');
    return;
  }
  
  // Dad joke
  if (commandUpper === 'JOKE' || commandUpper === 'DAD JOKE') {
    handleAsyncAPI(getDadJoke, 'Fetching a joke...');
    return;
  }
  
  // Random quote
  if (commandUpper === 'QUOTE' || commandUpper === 'RANDOM QUOTE') {
    handleAsyncAPI(getRandomQuote, 'Fetching a quote...');
    return;
  }
  
  // GitHub user lookup
  if (commandUpper.startsWith('GITHUB ')) {
    const username = command.substring(7).trim();
    if (username) {
      handleAsyncAPI(getGitHubUser, 'Fetching GitHub profile...', username);
    } else {
      addTerminalLine('Usage: GITHUB [username]\nExample: GITHUB torvalds', '#ffff99');
    }
    return;
  }
  
  // Check for exact command match
  if (commands[commandUpper]) {
    response = commands[commandUpper];
    
    // Special handling for HELP command - make it interactive
    if (commandUpper === 'HELP') {
      displayInteractiveHelp();
      saveToJournal(commandUpper, 'Interactive help menu displayed');
      return;
    }
    
    addTerminalLine(response, '#00ff00');
    saveToJournal(commandUpper, response);
    return;
  }
  
  // Check if user is asking for recalled information
  const memoryResponse = recallMemory(command);
  if (memoryResponse) {
    addTerminalLine(memoryResponse, '#00ff00');
    saveToJournal(command, memoryResponse);
    return;
  }
  
  // Try natural language processing first
  response = processNaturalLanguage(command, commandUpper);
  
  if (response) {
    addTerminalLine(response, '#00ff00');
    saveToJournal(command, response);
    extractAndLearn(command, response); // Learn from this interaction
    updateContext(command, response); // Track conversation context
    return;
  }
  
  // Try exact command matching with partial matches (only for specific keywords)
  const lowerCommand = command.toLowerCase();
  let found = false;
  
  // Only match if the command is the main focus (not just a word in a sentence)
  for (const [key, value] of Object.entries(commands)) {
    const keyLower = key.toLowerCase();
    // Only match if it's at the start or is the whole command
    if (lowerCommand === keyLower || lowerCommand.startsWith(keyLower + ' ')) {
      response = value;
      addTerminalLine(response, '#00ff00');
      saveToJournal(command, response);
      found = true;
      break;
    }
  }
  
  if (!found) {
    // Try Hugging Face AI first if enabled
    if (checkHuggingFaceStatus()) {
      addTerminalLine('Thinking...', '#ffff99');
      
      getHuggingFaceResponse(command).then(aiResponse => {
        if (aiResponse) {
          // Got a response from Hugging Face
          addTerminalLine(aiResponse, '#00ff00');
          saveToJournal(command, aiResponse);
          extractAndLearn(command, aiResponse);
          updateContext(command, aiResponse);
        } else {
          // Hugging Face failed, use fallback
          const fallbackResponse = getConversationalFallback(command);
          addTerminalLine(fallbackResponse, '#00ff00');
          saveToJournal(command, fallbackResponse);
          extractAndLearn(command, fallbackResponse);
          updateContext(command, fallbackResponse);
        }
      }).catch(error => {
        // Error occurred, use fallback
        const fallbackResponse = getConversationalFallback(command);
        addTerminalLine(fallbackResponse, '#00ff00');
        saveToJournal(command, fallbackResponse);
        extractAndLearn(command, fallbackResponse);
        updateContext(command, fallbackResponse);
      });
    } else {
      // Hugging Face not enabled, use regular fallback
    response = getConversationalFallback(command);
    addTerminalLine(response, '#00ff00');
    saveToJournal(command, response);
      extractAndLearn(command, response);
      updateContext(command, response);
    }
  }
}

// ========================================
// INITIALIZATION SEQUENCE
// ========================================

let aiName = localStorage.getItem('terminalAIName');
let journalPermission = localStorage.getItem('terminalJournalPermission');
let initStep = 0;

// Check if first time user
function checkFirstTimeUser() {
  const initPrompts = document.getElementById('initPrompts');
  const header = document.getElementById('terminalHeader');
  
  // Immediate load - no delay
  if (!aiName || !journalPermission) {
    initPrompts.style.display = 'block';
    initStep = aiName ? 2 : 1;
  } else {
    // Returning user - update header with AI name
    header.textContent = `[ ${aiName.toUpperCase()} TERMINAL SYSTEM ]`;
    const username = currentUser || localStorage.getItem('currentUser') || 'User';
    addTerminalLine(`Welcome back, ${username}! I'm ${aiName}. 👋`, '#00ff00');
    
    // Check if journal is loaded
    const localJournal = JSON.parse(localStorage.getItem('terminalJournal')) || [];
    if (localJournal.length > 0) {
      setActiveJournal(localJournal);
      addTerminalLine(`Session restored: ${localJournal.length} messages loaded. ✨`, '#00ff00');
    } else {
      addTerminalLine(`Starting fresh! Type JOURNAL LOAD to restore a saved session.`, '#00ff00');
      setActiveJournal([]);
    }
    
    addTerminalLine(`Ready to brainstorm? Just tell me what you're working on!`, '#00ff00');
  }
}

checkFirstTimeUser();
updateModeIndicator(); // Set initial mode indicator

// ========================================
// CONSOLE SECURITY - Prevent API key leakage
// ========================================

// Wrap console functions to filter sensitive data
const originalConsoleLog = console.log;
const originalConsoleError = console.error;
const originalConsoleWarn = console.warn;

console.log = function(...args) {
  const filtered = args.map(arg => {
    if (typeof arg === 'string') {
      return sanitizePersonalInfo(arg);
    }
    return arg;
  });
  originalConsoleLog.apply(console, filtered);
};

console.error = function(...args) {
  const filtered = args.map(arg => {
    if (typeof arg === 'string') {
      return sanitizePersonalInfo(arg);
    }
    return arg;
  });
  originalConsoleError.apply(console, filtered);
};

console.warn = function(...args) {
  const filtered = args.map(arg => {
    if (typeof arg === 'string') {
      return sanitizePersonalInfo(arg);
    }
    return arg;
  });
  originalConsoleWarn.apply(console, filtered);
};

// Display security notice on first load
if (!localStorage.getItem('securityNoticeShown')) {
  setTimeout(() => {
    addTerminalLine('🔒 SECURITY NOTICE', '#00ff00');
    addTerminalLine('═══════════════════════════════════════', '#00ff00');
    addTerminalLine('This chatbot has enterprise-level security protections:', '#c0ffc0');
    addTerminalLine('• All personal information is automatically detected and blocked', '#c0ffc0');
    addTerminalLine('• Your IP address and data are never collected or transmitted', '#c0ffc0');
    addTerminalLine('• Hacking attempts are automatically detected and blocked', '#c0ffc0');
    addTerminalLine('• All data is stored locally on YOUR device only', '#c0ffc0');
    addTerminalLine('• API keys are encrypted and never displayed', '#c0ffc0');
    addTerminalLine('• Console output is sanitized to prevent leaks', '#c0ffc0');
    addTerminalLine('\nType SECURITY STATUS anytime to view all active protections.', '#ffff99');
    addTerminalLine('═══════════════════════════════════════', '#00ff00');
    localStorage.setItem('securityNoticeShown', 'true');
  }, 1000);
}

// Handle journal file import
function importJournalFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      
      // Validate it's from this system
      if (!Array.isArray(data)) {
        addTerminalLine('ERROR: Invalid journal file format.', '#00ff00');
        return;
      }
      
      // Check if entries have required fields (if there are entries)
      if (data.length > 0) {
        const isValid = data.every(entry => 
          entry.hasOwnProperty('timestamp') && 
          entry.hasOwnProperty('command') && 
          entry.hasOwnProperty('response')
        );
        
        if (!isValid) {
          addTerminalLine('ERROR: File is not from this terminal system.', '#00ff00');
          addTerminalLine('Only journal files created by this system can be imported.', '#00ff00');
          return;
        }
      }
      
      // Load the journal as active session
      setActiveJournal(data);
      addTerminalLine(`✅ Session loaded successfully!`, '#00ff00');
      addTerminalLine(`I found ${data.length} messages from before. Let's continue where we left off!`, '#00ff00');
      
    } catch (error) {
      addTerminalLine('ERROR: Could not read journal file.', '#00ff00');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// Extract name from user input
function extractName(input) {
  // Remove common phrases to extract just the name
  let name = input.trim();
  
  // Patterns to remove
  const patterns = [
    /^(your name is|you are|i'll call you|call you|i want to call you|name you|you're|your)\s+/i,
    /^(i'd like to call you|let's call you|how about|what about)\s+/i,
    /^(be called|be named)\s+/i
  ];
  
  patterns.forEach(pattern => {
    name = name.replace(pattern, '');
  });
  
  // Remove trailing punctuation
  name = name.replace(/[.,!?;]+$/, '');
  
  // If it's still too long or empty, just use the first word
  if (name.length > 20 || name.includes(' ')) {
    const words = name.split(' ');
    name = words[0];
  }
  
  return name.trim();
}

// Handle initialization responses
function handleInitialization(input) {
  const initPrompts = document.getElementById('initPrompts');
  const header = document.getElementById('terminalHeader');
  
  if (initStep === 1) {
    // Step 1: Check for existing journal
    const response = input.toUpperCase();
    addTerminalLine(input, '#00ff00', true);
    
    if (response === 'UPLOAD') {
      addTerminalLine(`Great! Opening file selector...`, '#00ff00');
      addTerminalLine(`Please choose your saved session file.`, '#00ff00');
      
      // Trigger file upload
      const fileInput = document.getElementById('journalUpload');
      fileInput.onchange = importJournalFile;
      fileInput.click();
      
      // Wait a moment then proceed to name
      setTimeout(() => {
        addTerminalLine(`\nNow, what would you like to call me? 🤖`, '#00ff00');
        addTerminalLine(`You can give me any name you'd like!`, '#00ff00');
      }, 1000);
      
      initStep = 2;
      return true;
    } else {
      // Skip to name - create new session
      addTerminalLine(`No problem! Starting a fresh session. ✨`, '#00ff00');
      
      // Initialize empty journal
      setActiveJournal([]);
      
      addTerminalLine(`\nWhat would you like to call me? 🤖`, '#00ff00');
      addTerminalLine(`You can give me any name you'd like!`, '#00ff00');
      
      initStep = 2;
      return true;
    }
  }
  
  if (initStep === 2) {
    // Step 2: Getting AI name from user - extract just the name
    aiName = extractName(input);
    
    // Validate name is not empty
    if (!aiName || aiName.length < 1) {
      addTerminalLine(input, '#00ff00', true);
      addTerminalLine(`Hmm, I didn't catch that. Please give me a name! 😊`, '#00ff00');
      return true;
    }
    
    localStorage.setItem('terminalAIName', aiName);
    
    // Update the header with the AI's new name
    header.textContent = `[ ${aiName.toUpperCase()} TERMINAL SYSTEM ]`;
    
    addTerminalLine(input, '#00ff00', true);
    addTerminalLine(`Nice to meet you! I'm ${aiName} now. 😊`, '#00ff00');
    
    // Ask about journal permission
    addTerminalLine(`\nWould you like me to remember our conversations? 💾`, '#00ff00');
    addTerminalLine(`I can save everything we talk about so you can review it later or export it.`, '#00ff00');
    addTerminalLine(`Type YES to enable, or NO to skip.`, '#00ff00');
    
    initStep = 3;
    initPrompts.style.display = 'none';
    return true;
  }
  
  if (initStep === 3) {
    // Step 3: Getting journal permission
    const response = input.toUpperCase();
    addTerminalLine(input, '#00ff00', true);
    
    if (response === 'YES' || response === 'Y') {
      journalPermission = 'enabled';
      localStorage.setItem('terminalJournalPermission', 'enabled');
      addTerminalLine(`Perfect! I'll remember our conversations. ✅`, '#00ff00');
      addTerminalLine(`You can export or review them anytime using JOURNAL commands.`, '#00ff00');
    } else {
      journalPermission = 'disabled';
      localStorage.setItem('terminalJournalPermission', 'disabled');
      addTerminalLine(`No problem! I won't save our conversations.`, '#00ff00');
      addTerminalLine(`You can always enable this later with: JOURNAL ENABLE`, '#00ff00');
    }
    
      addTerminalLine(`\n🎉 All set! I'm ${aiName}, your creative assistant!`, '#00ff00');
      addTerminalLine(`💡 Remember: I'm here to help YOU create, not replace your creativity!`, '#c0ffc0');
      addTerminalLine(`Let's brainstorm together! What are you working on today?`, '#00ff00');
    
    initStep = 0;
    initPrompts.style.display = 'none';
    return true;
  }
  
  return false;
}
</script>

<style>
/* Spotify Player Widget */
#spotifyWidget {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  width: 300px;
  background: #000;
  border: 3px solid #1DB954;
  border-radius: 10px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  z-index: 9999;
  cursor: move;
}

#spotifyHeader {
  background: #1DB954;
  color: #fff;
  padding: 8px 12px;
  font-weight: bold;
  font-size: 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: move;
  border-radius: 7px 7px 0 0;
}

#spotifyMinimize {
  background: none;
  border: none;
  color: #fff;
  font-size: 20px;
  cursor: pointer;
  padding: 0 5px;
  line-height: 1;
}

#spotifyMinimize:hover {
  color: #000;
}
</style>

<!-- Draggable Spotify Player Widget -->
<div id="spotifyWidget">
  <div id="spotifyHeader">
    <span>🎵 Spotify Player</span>
    <button id="spotifyMinimize" onclick="toggleSpotifyChat()">+</button>
  </div>
  <div id="spotifyContent" style="display: none;">
    <iframe id="spotifyIframe" style="border-radius: 0 0 7px 7px;" src="https://open.spotify.com/embed/playlist/66TP5uc6hwyESdV9AuvUZJ?utm_source=generator" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
  </div>
</div>

<script>
// Set Spotify widget to minimized state on load
document.addEventListener('DOMContentLoaded', function() {
  const spotifyWidget = document.getElementById('spotifyWidget');
  if (spotifyWidget) {
    spotifyWidget.style.width = '200px';
  }
});
</script>

<script>
// Draggable Spotify Widget
let spotifyChatDragging = false;
let spotifyChatCurrentX;
let spotifyChatCurrentY;
let spotifyChatInitialX;
let spotifyChatInitialY;
let spotifyChatXOffset = 0;
let spotifyChatYOffset = 0;

const spotifyChatWidget = document.getElementById('spotifyWidget');
const spotifyChatHeader = document.getElementById('spotifyHeader');

spotifyChatHeader.addEventListener('mousedown', spotifyChatDragStart);
document.addEventListener('mousemove', spotifyChatDrag);
document.addEventListener('mouseup', spotifyChatDragEnd);

function spotifyChatDragStart(e) {
  spotifyChatInitialX = e.clientX - spotifyChatXOffset;
  spotifyChatInitialY = e.clientY - spotifyChatYOffset;
  
  if (e.target === spotifyChatHeader || e.target.parentElement === spotifyChatHeader) {
    spotifyChatDragging = true;
  }
}

function spotifyChatDrag(e) {
  if (spotifyChatDragging) {
    e.preventDefault();
    spotifyChatCurrentX = e.clientX - spotifyChatInitialX;
    spotifyChatCurrentY = e.clientY - spotifyChatInitialY;
    spotifyChatXOffset = spotifyChatCurrentX;
    spotifyChatYOffset = spotifyChatCurrentY;
    
    spotifyChatSetTranslate(spotifyChatCurrentX, spotifyChatCurrentY, spotifyChatWidget);
  }
}

function spotifyChatDragEnd(e) {
  spotifyChatInitialX = spotifyChatCurrentX;
  spotifyChatInitialY = spotifyChatCurrentY;
  spotifyChatDragging = false;
}

function spotifyChatSetTranslate(xPos, yPos, el) {
  el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
}

function toggleSpotifyChat() {
  const content = document.getElementById('spotifyContent');
  const btn = document.getElementById('spotifyMinimize');
  
  if (content.style.display === 'none') {
    content.style.display = 'block';
    btn.textContent = '−';
    spotifyChatWidget.style.width = '300px';
  } else {
    content.style.display = 'none';
    btn.textContent = '+';
    spotifyChatWidget.style.width = '200px';
  }
}
</script>

</body>
</html>

